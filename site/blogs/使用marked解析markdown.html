<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用 marked 解析 markdown | 博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="marked 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。
最简单直接的一种使用方式：
123var marked = require(&apos;marked&apos;);console.log(marked(&apos;I am using __markdown__.&apos;));// Outputs: &amp;lt;p&amp;gt;I am using &amp;lt;strong&amp;gt">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 marked 解析 markdown">
<meta property="og:url" content="http://yibuyisheng.github.io/blogs/site/blogs/使用marked解析markdown.html">
<meta property="og:site_name" content="博客">
<meta property="og:description" content="marked 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。
最简单直接的一种使用方式：
123var marked = require(&apos;marked&apos;);console.log(marked(&apos;I am using __markdown__.&apos;));// Outputs: &amp;lt;p&amp;gt;I am using &amp;lt;strong&amp;gt">
<meta property="og:updated_time" content="2016-06-15T10:44:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 marked 解析 markdown">
<meta name="twitter:description" content="marked 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。
最简单直接的一种使用方式：
123var marked = require(&apos;marked&apos;);console.log(marked(&apos;I am using __markdown__.&apos;));// Outputs: &amp;lt;p&amp;gt;I am using &amp;lt;strong&amp;gt">
  
    <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blogs/site/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blogs/site/" id="logo">博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blogs/site/" id="subtitle">偶尔玩玩 Java 的前端工程师</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blogs/site/">Home</a>
        
          <a class="main-nav-link" href="/blogs/site/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yibuyisheng.github.io/blogs/site"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-使用marked解析markdown" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blogs/site/blogs/使用marked解析markdown.html" class="article-date">
  <time datetime="2016-05-20T05:49:00.000Z" itemprop="datePublished">2016-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      使用 marked 解析 markdown
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/chjj/marked" target="_blank" rel="external">marked</a> 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。</p>
<p>最简单直接的一种使用方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div><div class="line"><span class="built_in">console</span>.log(marked(<span class="string">'I am using __markdown__.'</span>));</div><div class="line"><span class="comment">// Outputs: &lt;p&gt;I am using &lt;strong&gt;markdown&lt;/strong&gt;.&lt;/p&gt;</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<p> marked 库主要提供了一个 marked 函数，该函数声明为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">type OptionsType = &#123;</div><div class="line">    highlight: (function(code: string, lang: string, callback: function(err: Error, code: string)))=,</div><div class="line">    renderer: marked.Renderer=,</div><div class="line">    gfm: boolean=,</div><div class="line">    tables: boolean=,</div><div class="line">    breaks: boolean=,</div><div class="line">    pedantic: boolean=,</div><div class="line">    sanitize: boolean=,</div><div class="line">    smartLists: boolean=</div><div class="line">&#125;;</div><div class="line">marked(markdownString: string, options: OptionsType=, callback: Function=): string;</div></pre></td></tr></table></figure>
<p>其中，marked 可以通过 renderer 配置提供了自定义解析途径。</p>
<p>renderer 配置对应的是一个 marked.Renderer 类，此类主要包含了如下的钩子方法：</p>
<ul>
<li>code(string code, string language)</li>
<li>blockquote(string quote)</li>
<li>html(string html)</li>
<li>heading(string text, number level)</li>
<li>hr()</li>
<li>list(string body, boolean ordered)</li>
<li>listitem(string text)</li>
<li>paragraph(string text)</li>
<li>table(string header, string body)</li>
<li>tablerow(string content)</li>
<li>tablecell(string content, object flags)</li>
<li>strong(string text)</li>
<li>em(string text)</li>
<li>codespan(string code)</li>
<li>br()</li>
<li>del(string text)</li>
<li>link(string href, string title, string text)</li>
<li>image(string href, string title, string text)</li>
</ul>
<p>所有的这些方法，都可以在 renderer 实例上面覆盖掉。marked 在解析到 markdown 标记的时候，都会去调用相应的钩子方法，而钩子方法的返回结果，就会是该标记最终的解析结果。这样一来，就生成了自定义的解析结果。</p>
<p>marked 还有一个重要的配置：highlight，可以对代码块进行解析，配合相应的 css ，达到语法高亮效果。</p>
<p>以上就是 marked 最基本最核心的用法了。</p>
<p>其实本文的重点是记录在使用过程中遇到的一些坑，下面进入重点。</p>
<h1 id="markdown-缩进问题"><a href="#markdown-缩进问题" class="headerlink" title="markdown 缩进问题"></a>markdown 缩进问题</h1><p>在 markdown 的语法中，标题下面（换行之后）标记是不能缩进的，而列表项下面的标记是可以缩进的。</p>
<p>现在前端开发，经常会使用一些模板引擎，比如 <a href="https://github.com/ecomfe/etpl" target="_blank" rel="external">ETPL</a> ，这些模板，一般都会提供过滤器的功能。以 ETPL 为例，可以在 js 代码中这样添加一个过滤器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> etpl = <span class="built_in">require</span>(<span class="string">'etpl'</span>);</div><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div><div class="line">etpl.addFilter(<span class="string">'markdown'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">source, useExtra</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> marked(source);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>此时在对应的模板中，就可以使用该过滤器了：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- filter: markdown() --&gt;</span></div><div class="line">    ### 标题</div><div class="line"></div><div class="line">    内容</div><div class="line">    <span class="comment">&lt;!-- /filter --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>此时，解析出来的样子会让人瞠目结舌：过滤器里面的 markdown 标记根本不会被解析掉，整个 markdown 标记块会被当成代码块。</p>
<p>为什么会这样呢？</p>
<p>如果打印一下 markdown 过滤器处理函数中的 source 参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> etpl = <span class="built_in">require</span>(<span class="string">'etpl'</span>);</div><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div><div class="line">etpl.addFilter(<span class="string">'markdown'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">source, useExtra</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(source);</div><div class="line">    <span class="keyword">return</span> marked(source);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>可以发现，打印出来的内容会是这个样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;</div><div class="line">    ### 标题</div><div class="line"></div><div class="line">    内容</div><div class="line">    &quot;</div></pre></td></tr></table></figure>
<p>第一行没啥内容，第二行并没有顶行，而是有缩进的，然后最后一行没实际内容，只有一个缩进。</p>
<p>这明显跟 markdown 语法有冲突，必须要进行如下处理：</p>
<ul>
<li>1、第一行和最后一行没啥实际内容，可以去掉；</li>
<li>2、检测第一行前面的缩进空格数（这里假定缩进用的是空格），记录下来，假设为 <code>n</code> ；</li>
<li>3、将每一行前面的 <code>n</code> 个空格去掉。</li>
</ul>
<p>具体的代码实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> etpl = <span class="built_in">require</span>(<span class="string">'etpl'</span>);</div><div class="line"><span class="keyword">var</span> marked = <span class="built_in">require</span>(<span class="string">'marked'</span>);</div><div class="line">etpl.addFilter(<span class="string">'markdown'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">source, useExtra</span>) </span>&#123;</div><div class="line">    source = source.replace(<span class="regexp">/(^\n+|\n+$)/g</span>, <span class="string">''</span>);</div><div class="line">    <span class="keyword">var</span> uselessSpaceCount = source.match(<span class="regexp">/^\s*/</span>)[<span class="number">0</span>].length;</div><div class="line">    source = source.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'^ &#123;'</span> + uselessSpaceCount + <span class="string">'&#125;'</span>, <span class="string">'gm'</span>), <span class="string">''</span>);</div><div class="line">    <span class="keyword">return</span> marked(source);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="HTML-标签"><a href="#HTML-标签" class="headerlink" title="HTML 标签"></a>HTML 标签</h1><p>有的时候，可能想给 markdown 标记的某一块加上背景色，比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- filter: markdown() --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"background-red"</span>&gt;</span></div><div class="line">### 标题</div><div class="line"></div><div class="line">内容</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- /filter --&gt;</span></div></pre></td></tr></table></figure>
<p>这样写又会崩溃了， div 内部的 markdown 标记并不会被解析！</p>
<p>解决方法就是把 div 放过滤器外边吧：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"background-red"</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- filter: markdown() --&gt;</span></div><div class="line">### 标题</div><div class="line"></div><div class="line">内容</div><div class="line"><span class="comment">&lt;!-- /filter --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yibuyisheng.github.io/blogs/site/blogs/site//blogs/使用marked解析markdown.html" data-id="ciwqiy02w00180407hicg4bc1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blogs/site/tags/ETPL/">ETPL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blogs/site/tags/markdown/">markdown</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blogs/site/blogs/oracle安装.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          oracle 安装
        
      </div>
    </a>
  
  
    <a href="/blogs/site/blogs/实现第一个 vscode 扩展.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">实现第一个 vscode 扩展</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/CSS/">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/ECMAScript-6/">ECMAScript 6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/ETPL/">ETPL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/React/">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/Redux/">Redux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/Reflux/">Reflux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/babel/">babel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/vscode/">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blogs/site/tags/数据库/">数据库</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blogs/site/tags/CSS/" style="font-size: 17.5px;">CSS</a> <a href="/blogs/site/tags/ECMAScript-6/" style="font-size: 15px;">ECMAScript 6</a> <a href="/blogs/site/tags/ETPL/" style="font-size: 12.5px;">ETPL</a> <a href="/blogs/site/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/blogs/site/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/blogs/site/tags/Oracle/" style="font-size: 10px;">Oracle</a> <a href="/blogs/site/tags/React/" style="font-size: 10px;">React</a> <a href="/blogs/site/tags/Redux/" style="font-size: 10px;">Redux</a> <a href="/blogs/site/tags/Reflux/" style="font-size: 10px;">Reflux</a> <a href="/blogs/site/tags/babel/" style="font-size: 10px;">babel</a> <a href="/blogs/site/tags/markdown/" style="font-size: 12.5px;">markdown</a> <a href="/blogs/site/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/blogs/site/tags/数据库/" style="font-size: 10px;">数据库</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blogs/site/archives/2014/10/">October 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blogs/site/blogs/当心，babel 处理 Symbol 的麻烦.html">当心，babel 处理 Symbol 的麻烦</a>
          </li>
        
          <li>
            <a href="/blogs/site/blogs/Redux 使用初探.html">Redux 使用初探</a>
          </li>
        
          <li>
            <a href="/blogs/site/blogs/如何展示表单控件.html">如何展示表单控件</a>
          </li>
        
          <li>
            <a href="/blogs/site/blogs/HTTP请求重发.html">HTTP请求重发</a>
          </li>
        
          <li>
            <a href="/blogs/site/blogs/karma-入门.html">karma 入门</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 yibuyisheng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blogs/site/" class="mobile-nav-link">Home</a>
  
    <a href="/blogs/site/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blogs/site/fancybox/jquery.fancybox.css">
  <script src="/blogs/site/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blogs/site/js/script.js"></script>

  </div>
</body>
</html>