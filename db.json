{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/10.jpg","path":"images/10.jpg","modified":0,"renderable":0},{"_id":"source/images/13.png","path":"images/13.png","modified":0,"renderable":0},{"_id":"source/images/6.png","path":"images/6.png","modified":0,"renderable":0},{"_id":"source/images/8.jpg","path":"images/8.jpg","modified":0,"renderable":0},{"_id":"source/images/1.jpg","path":"images/1.jpg","modified":0,"renderable":0},{"_id":"source/images/11.jpg","path":"images/11.jpg","modified":0,"renderable":0},{"_id":"source/images/7.png","path":"images/7.png","modified":0,"renderable":0},{"_id":"source/images/3.jpg","path":"images/3.jpg","modified":0,"renderable":0},{"_id":"source/images/14.png","path":"images/14.png","modified":0,"renderable":0},{"_id":"source/images/12.png","path":"images/12.png","modified":0,"renderable":0},{"_id":"source/images/16.png","path":"images/16.png","modified":0,"renderable":0},{"_id":"source/images/4.jpg","path":"images/4.jpg","modified":0,"renderable":0},{"_id":"source/images/5.jpg","path":"images/5.jpg","modified":0,"renderable":0},{"_id":"source/images/9.jpg","path":"images/9.jpg","modified":0,"renderable":0},{"_id":"themes/indigo/source/css/style.less","path":"css/style.less","modified":0,"renderable":1},{"_id":"themes/indigo/source/img/brand.jpg","path":"img/brand.jpg","modified":0,"renderable":1},{"_id":"themes/indigo/source/img/cc.png","path":"img/cc.png","modified":0,"renderable":1},{"_id":"themes/indigo/source/img/img-err.png","path":"img/img-err.png","modified":0,"renderable":1},{"_id":"themes/indigo/source/img/img-loading.png","path":"img/img-loading.png","modified":0,"renderable":1},{"_id":"themes/indigo/source/img/logo.jpg","path":"img/logo.jpg","modified":0,"renderable":1},{"_id":"themes/indigo/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/indigo/source/js/search.js","path":"js/search.js","modified":0,"renderable":1},{"_id":"source/images/2016-12-15/form.png","path":"images/2016-12-15/form.png","modified":0,"renderable":0},{"_id":"source/images/2.jpg","path":"images/2.jpg","modified":0,"renderable":0},{"_id":"source/images/15.png","path":"images/15.png","modified":0,"renderable":0},{"_id":"source/images/17.png","path":"images/17.png","modified":0,"renderable":0},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.eot","path":"css/fonts/roboto/Roboto-Bold.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.woff","path":"css/fonts/roboto/Roboto-Bold.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.eot","path":"css/fonts/roboto/Roboto-Light.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.woff2","path":"css/fonts/roboto/Roboto-Bold.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.eot","path":"css/fonts/roboto/Roboto-Medium.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.woff","path":"css/fonts/roboto/Roboto-Light.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.woff2","path":"css/fonts/roboto/Roboto-Light.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.eot","path":"css/fonts/roboto/Roboto-Regular.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.woff","path":"css/fonts/roboto/Roboto-Medium.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.woff2","path":"css/fonts/roboto/Roboto-Medium.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.eot","path":"css/fonts/roboto/Roboto-Thin.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.woff","path":"css/fonts/roboto/Roboto-Regular.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.woff2","path":"css/fonts/roboto/Roboto-Regular.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.woff","path":"css/fonts/roboto/Roboto-Thin.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.woff2","path":"css/fonts/roboto/Roboto-Thin.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/FontAwesome.otf","path":"css/fonts/fontawesome/FontAwesome.otf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.eot","path":"css/fonts/fontawesome/fontawesome-webfont.eot","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.woff","path":"css/fonts/fontawesome/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.woff2","path":"css/fonts/fontawesome/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.ttf","path":"css/fonts/roboto/Roboto-Bold.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.ttf","path":"css/fonts/roboto/Roboto-Light.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.ttf","path":"css/fonts/roboto/Roboto-Medium.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.ttf","path":"css/fonts/roboto/Roboto-Regular.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.ttf","path":"css/fonts/roboto/Roboto-Thin.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.ttf","path":"css/fonts/fontawesome/fontawesome-webfont.ttf","modified":0,"renderable":1},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.svg","path":"css/fonts/fontawesome/fontawesome-webfont.svg","modified":0,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"aac0adc453efa16c20a75957cba19a23e5623919","modified":1481812804000},{"_id":"themes/indigo/README.md","hash":"c07f8d00a117cb1f7c1bc480d4d2b3d129340959","modified":1465445947000},{"_id":"themes/indigo/_config.yml","hash":"6905e8204edf1c20e715ec955affedf0b2992baf","modified":1465445947000},{"_id":"themes/indigo/package.json","hash":"8ab2c2ef5c47df0f84961bfae0d8ddd990774f95","modified":1465445947000},{"_id":"source/_posts/CSS border-image.md","hash":"bb4010a1385f275f248fb80decbcc59b6309f1dd","modified":1465987482000},{"_id":"source/_posts/CSS border-radius.md","hash":"20a6e1972b76d0349cab25f8580633b034288bd3","modified":1465987490000},{"_id":"source/_posts/CSS 变形.md","hash":"9550a31993e49f1b60a21279332ef0fc3fe78f16","modified":1465987496000},{"_id":"source/_posts/CSS 空心字.md","hash":"fca20ab0bf10d86fa3d6ee212fb1cdfb4e18c3ec","modified":1465987503000},{"_id":"source/_posts/CSS 语法速查.md","hash":"8b4133e7937f4c2fcde73311d70ce50b5b227090","modified":1465987509000},{"_id":"source/_posts/ES6 简单特性概览.md","hash":"c40ad2c75c42527f91ed00681f2032d5b732a263","modified":1467345387000},{"_id":"source/_posts/HTTP请求重发.md","hash":"8a7a252b80ea024d13bafcd93c93ee4fca63bea4","modified":1467965245000},{"_id":"source/_posts/Reflux 使用进化日记.md","hash":"d18941936b0cf7bcbbce772e39f5a692f3dbeebb","modified":1465987587000},{"_id":"source/_posts/filedownload.md","hash":"5b16cc833f8a23e57fb69d1ba3cac4482143727a","modified":1466179952000},{"_id":"source/_posts/karma-入门.md","hash":"9f256fa312048b9617ecf6bb4eadaa71594bbddb","modified":1467345385000},{"_id":"source/_posts/oracle安装.md","hash":"ca770791cab509f3b09bb8dc2d3bfd2473ccab73","modified":1465987536000},{"_id":"source/_posts/web 前端外部点击事件的实现.md","hash":"8c2e755f15b0da4b0d5a8509460025f28a5c7873","modified":1465987576000},{"_id":"source/_posts/一个 JavaScript.md","hash":"a580fecb96462161fbac3bef6a96bec5b37534a6","modified":1465987603000},{"_id":"source/_posts/一些 core javascript 的基础知识.md","hash":"16765ad422eca07d97446cadc18da0152c3bb3e4","modified":1465987611000},{"_id":"source/_posts/使用 CSS background 构造一个棋盘.md","hash":"42def4bd12f12f8ac1d94bd077d1da6849f7a7d5","modified":1465987617000},{"_id":"source/_posts/使用 marked 解析 markdown 之缩进.md","hash":"a528f123f69fdd929ae1c7a4c29ee2344aa7ffc1","modified":1466168170000},{"_id":"source/_posts/使用marked解析markdown.md","hash":"8c99c0f16d4fea609c2e40ef94425f409e7d6cf5","modified":1465987470000},{"_id":"source/_posts/受保护的对象.md","hash":"f0ab76f2e0f1e4fb44dcacf57e726d5a0dc0a78b","modified":1467345417000},{"_id":"source/_posts/如何展示表单控件.md","hash":"8f08bc1a049a5f8f06edb1eb327a9737b2f8093a","modified":1481815722000},{"_id":"source/_posts/实现第一个 vscode 扩展.md","hash":"1ace42b91861a9b495a12f7474aa397535f01cd2","modified":1465987627000},{"_id":"source/_posts/爬虫与编码.md","hash":"f3463ec16bac295b88e0134e91839e6461acb5b1","modified":1465379541000},{"_id":"source/_posts/生成器（ generator ）.md","hash":"ed752e732ce1ef73e9ef874491799fb11e3fe25c","modified":1465987650000},{"_id":"source/_posts/百度 EFE 前端框架学习笔记（ef）.md","hash":"032237625bee619e6e8676f8c281f522f6aa1473","modified":1465987670000},{"_id":"source/_posts/百度 EFE 前端框架学习笔记（er）.md","hash":"f661698ab4853b5a0ac6b2ae434f49956dba2374","modified":1465987677000},{"_id":"source/_posts/百度 EFE 前端框架学习笔记（esui）.md","hash":"5058281429299815d84c98202be971a7364a64f3","modified":1465987684000},{"_id":"source/_posts/记一次坑爹的对接经历.md","hash":"c6a32b0944ad60c82eb2364434ca9d28d5a8c1c4","modified":1465987692000},{"_id":"source/demos/-webkit-border-image.html","hash":"c1bba9ee59820500fe64cdf804c199c8f2c0c1b7","modified":1465443940000},{"_id":"source/demos/border-image.html","hash":"ad3fc4b07fa7c772733525294d0b55ea58d5fcc4","modified":1465443783000},{"_id":"source/demos/border-radius.html","hash":"465733cc0acda1f510f114499dc0128342847d7c","modified":1465443547000},{"_id":"source/demos/css background.html","hash":"5cfe1e77ab3a06b3d593edb9b18ed3cad51b2032","modified":1465444168000},{"_id":"source/demos/css skew.html","hash":"078325170188d7f42b2f6fc35ac90087ea2a8093","modified":1465441857000},{"_id":"source/demos/envelope.html","hash":"6f59d00b990f239801c5d63a7cfe9d21a329b6da","modified":1465444066000},{"_id":"source/demos/half ellipse.html","hash":"b57e4fffe5e52369a92d24bca1f8340108b10f8e","modified":1465443629000},{"_id":"source/demos/marching ants borders.html","hash":"5d530bf3d8f99a618230f63b7e7858d1c097e4b1","modified":1465444218000},{"_id":"source/demos/transform-origin.html","hash":"077d1294072f91ba7b58f5fd016147655fecade0","modified":1465442856000},{"_id":"source/demos/transform-style.html","hash":"26a1a8e77f4a5a1a5a67b86c4524f96c75c2a9d0","modified":1465443004000},{"_id":"source/demos/空心字1.html","hash":"7ebf535e719320e138713935d58d44163cd8c902","modified":1465443323000},{"_id":"source/demos/空心字2.html","hash":"5b9605ae592390398e125e6cb22bfd34ced66731","modified":1465443414000},{"_id":"source/images/.DS_Store","hash":"7c6ae36f572ae6ee7ad0ba74083e1e3d1b2b27db","modified":1481812804000},{"_id":"source/images/10.jpg","hash":"906e7332b1198b78316d5436ce674f44700cdaae","modified":1465273954000},{"_id":"source/images/13.png","hash":"30227705d6c65db3d0a0079a329a5664e8432a91","modified":1465273954000},{"_id":"source/images/6.png","hash":"2540ef82a10707d536ec9f8313a1e529b0b97ed4","modified":1465273954000},{"_id":"source/images/8.jpg","hash":"320024a19a4402847e231090c0872b82aa899f74","modified":1465273954000},{"_id":"themes/indigo/layout/archive.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1465445947000},{"_id":"themes/indigo/layout/category.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1465445947000},{"_id":"themes/indigo/layout/demo.ejs","hash":"18a1f7cc1fc0ec59cd048289ad4fad17a5b056b5","modified":1465445947000},{"_id":"themes/indigo/layout/index.ejs","hash":"aa1b4456907bdb43e629be3931547e2d29ac58c8","modified":1465445947000},{"_id":"themes/indigo/layout/layout.ejs","hash":"fc36f206a97bf65eacead631a0dbf043dcf356ac","modified":1465445947000},{"_id":"themes/indigo/layout/page.ejs","hash":"7d80e4e36b14d30a7cd2ac1f61376d9ebf264e8b","modified":1465445947000},{"_id":"themes/indigo/layout/post.ejs","hash":"a05fd1a27e1c54c9dbab9e69a257a299b0f549cc","modified":1465445947000},{"_id":"themes/indigo/layout/tag.ejs","hash":"2703b07cc8ac64ae46d1d263f4653013c7e1666b","modified":1465445947000},{"_id":"source/images/1.jpg","hash":"d3f71673e7e0a5785559bf18a45a6074d2267c4c","modified":1465273954000},{"_id":"source/images/11.jpg","hash":"9fbcbe6b096df4d0b0ae1b28610a25f2f390c07e","modified":1465273954000},{"_id":"source/images/7.png","hash":"f9de759cf2d5ef2271049ed537b7a95a70c00a82","modified":1465273954000},{"_id":"source/images/3.jpg","hash":"a5f9496f1e6dbd3141f3881d4676dfdaf13202ec","modified":1465273954000},{"_id":"themes/indigo/layout/_partial/footer.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1465445947000},{"_id":"themes/indigo/screenshots/hexo-theme-pad.png","hash":"d7c897b32e7eab0146bb2530433c9b8b7571d59c","modified":1465445947000},{"_id":"themes/indigo/screenshots/hexo-theme-phone-1.png","hash":"9b30409ec4c9b94b5582346323ed2c8e26dbc4c0","modified":1465445947000},{"_id":"themes/indigo/screenshots/hexo-theme-phone-2.png","hash":"b6807228992222a8fa095a940a41f40f841a5f6e","modified":1465445947000},{"_id":"source/demos/2016-12-15/form1.html","hash":"2f07df0a5a6fe2de25a310ae15bc2067132c554d","modified":1481815071000},{"_id":"source/demos/2016-12-15/form2.html","hash":"16f3c8dc983bcc13002a21bc55d8109defe394ab","modified":1481815222000},{"_id":"source/images/14.png","hash":"e2bd55a46b10ddbf4b45d5bb24906036fe344347","modified":1465980327000},{"_id":"source/images/12.png","hash":"aa0e49edbef374addd722cdce1af04b4c6d590bd","modified":1465273954000},{"_id":"source/images/16.png","hash":"53c16941b5c8b35a3c4c8d59d72a71513e7dbb07","modified":1465982717000},{"_id":"source/images/2016-12-15/.DS_Store","hash":"32b7ffe64136d3226289ae9ef39f051ef7590c64","modified":1481812937000},{"_id":"source/images/4.jpg","hash":"cc17a1b9d9265f1aedda29cfd15b24798caafb79","modified":1465273954000},{"_id":"source/images/5.jpg","hash":"b20a459406751349285f5f09b535efc054e6d9e3","modified":1465273954000},{"_id":"source/images/9.jpg","hash":"b20a459406751349285f5f09b535efc054e6d9e3","modified":1465273954000},{"_id":"themes/indigo/layout/_partial/after-footer.ejs","hash":"3b160eaaefb7a493d9dc96c932f06f0ee2772f7d","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/archive-post.ejs","hash":"60a468dcf37c9f313090c9fe569278b6c846891f","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/archive.ejs","hash":"7f632fcfde543ea87a9a70fafabebf76ef21e9e0","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/article.ejs","hash":"75a0ff40e5bd63b2492bf30b7fa6ee8bd8afe0e2","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/cnzz.ejs","hash":"03f75c55cb78686603a430fa42c63805872fb902","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/google-analytics.ejs","hash":"f921e7f9223d7c95165e0f835f353b2938e40c45","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/head.ejs","hash":"5c4db4d00e7d93ba275f3cf700615eecd2a6be9e","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/header.ejs","hash":"417ede6f9721045f0c7a1d0c6c480cebc2811273","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/loading.ejs","hash":"bc4cb19b20de55a0332647f4dca9684184383685","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/mathjax.ejs","hash":"c3394a1257a4f2cf30644016d9dc43e3a44d61dc","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/menu.ejs","hash":"3905d8869ba4aa19e635fedd0819152f6bdb996a","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/script.ejs","hash":"555527d72e538897defd0cc7c9b8bf4dc3166153","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/search.ejs","hash":"1c8e7a1d512f4b81431f03eb80b0b331229799bb","modified":1465445947000},{"_id":"themes/indigo/source/css/style.less","hash":"bc2bcbf43091599ab63edc79413f9d08e8fb061f","modified":1465445947000},{"_id":"themes/indigo/source/img/brand.jpg","hash":"0e237f1b433851c156e1f1cdaeb044054b3b9879","modified":1465445947000},{"_id":"themes/indigo/source/img/cc.png","hash":"ebce75a62b40976a72d43f0bd937d859ac24d87c","modified":1465445947000},{"_id":"themes/indigo/source/img/img-err.png","hash":"23a63ea26eb3c1d5e677d9883cf36cc1a1a1228b","modified":1465445947000},{"_id":"themes/indigo/source/img/img-loading.png","hash":"a9cd5cd11866824f31e3d1c5e23badfeb3f73031","modified":1465445947000},{"_id":"themes/indigo/source/img/logo.jpg","hash":"a089e42acab93864d33e16801b0ac5dc1617c373","modified":1465445947000},{"_id":"themes/indigo/source/js/main.js","hash":"e3ccf70da521a03a581b1dd23b0cbea9b4f023a9","modified":1465445947000},{"_id":"themes/indigo/source/js/search.js","hash":"a7046c9d279b0519715348dffc62d2f879cb485f","modified":1465445947000},{"_id":"source/images/2016-12-15/form.png","hash":"d84c6ceba237cd7d810d3198dcbc6f75546b7a53","modified":1481812761000},{"_id":"source/images/2.jpg","hash":"a09b477549ff2523dd0185f1259243f83a7a65bd","modified":1465273954000},{"_id":"themes/indigo/screenshots/hexo-theme-pc.png","hash":"497742866f4b550c05e9cb0d353c08b4f9e9d171","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/category.ejs","hash":"d4f0e36f9a2167e91082dbd7d52425a06d2bebbf","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/comment.ejs","hash":"cc86872859e924cebd35cb2acdd0c79c074c48d0","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/date.ejs","hash":"f17cbe521405a8b3a699a4477f8816eb8a86d92e","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/nav.ejs","hash":"6c359ca773dee87ecf7a1553a31a9418c900583a","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/duoshuo.ejs","hash":"e8399025ed3b980aedb821c92855889f5f12fd5b","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/share.ejs","hash":"6b2ab0a9a67732ba18bc8520f0ff6805457bb427","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/tag.ejs","hash":"33181dbf9c126b3354a2e6a83605c40674b222b7","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/tags.ejs","hash":"91e94dcd997acb71ac688993715390c7e48b89c1","modified":1465445947000},{"_id":"themes/indigo/layout/_partial/post/title.ejs","hash":"cfb58029f04ffaa3a45e807a848ac077b987d7c4","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/archives.less","hash":"05e2a6ec8ac4d8cf50d050509442276122fcf43b","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/article.less","hash":"49b0a5c85adbb8000a2318b06a26e8cc7dc4b79e","modified":1467965601000},{"_id":"themes/indigo/source/css/_partial/gotop.less","hash":"b7db31b9bc563c10b9e3cf3e6d9cfddfeb3e805a","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/header.less","hash":"ca7e3c0d6b1b77f572ce25d87f482a1a36cb579c","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/highlight.less","hash":"a43d79dee0f667d85bcddee23ad43e736e133ee3","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/layout.less","hash":"d7bfa678f162afb9cffbb5f197c072dc2058794a","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/loading.less","hash":"c32656b8d51fca9b3bfa95f1aa44b51ade203e18","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/postlist.less","hash":"7c7f5314bc20ec1a8d20269671a8b858f9e21d67","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/roboto.less","hash":"2e0469ed8161d5672d903ca1a8027cd65fe007f1","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/search.less","hash":"d73a12ca56cd710a13cb61074958c82a5cb95d63","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/share.less","hash":"ee3e78323e52aa7e8b8c3f66324ca141a69ecb6a","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/tags.less","hash":"6a256bfa57547ede5e05dfa61878f582780db6ad","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/variable.less","hash":"7b30ad46ae89cc2bbd8b27bff1443909ee596010","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/waves.less","hash":"61019c991dff98a380314b88c6f875d693c3e7e1","modified":1465445947000},{"_id":"themes/indigo/source/css/_partial/fontawesome.less","hash":"9d9b1946357a653adebc29859ad0de70adcc27dd","modified":1465445947000},{"_id":"source/images/15.png","hash":"712606992cd950f17b5d6c8b9c1466e08fb80ba7","modified":1465982426000},{"_id":"source/images/17.png","hash":"b41e4c632feb67ff33de38afbb47d0a2cd17c36f","modified":1465983124000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.eot","hash":"a76cd602f5188b9fbd4ba7443dcb9c064e3dbf10","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.woff","hash":"ee99cd87a59a9a5d4092c83232bb3eec67547425","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.eot","hash":"42fe156996197e5eb0c0264c5d1bb3b4681f4595","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.woff2","hash":"933b866d09c2b087707a98dab64b3888865eeb96","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.eot","hash":"1517f4b6e1c5d0e5198f937557253aac8fab0416","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.woff","hash":"6300f659be9e834ab263efe2fb3c581d48b1e7b2","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.woff2","hash":"bbdc28b887400fcb340b504ec2904993af42a5d7","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.eot","hash":"77ae3e980ec03863ebe2587a8ef9ddfd06941db0","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.woff","hash":"d45f84922131364989ad6578c7a06b6b4fc22c34","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.woff2","hash":"6cc1b73571af9e827c4e7e91418f476703cd4c4b","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.eot","hash":"0790a51a848dbe7292c98f9d0459218bf1a8ffdd","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.woff","hash":"74734dde8d94e7268170f9b994dedfbdcb5b3a15","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.woff2","hash":"ed1558b0541f5e01ce48c7db1588371b990eec19","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.woff","hash":"fbc3e71d456c96667d8082ab910e3946ef89240b","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.woff2","hash":"2449e3dac5ddb7c3da8bb07450493b62d052758c","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/FontAwesome.otf","hash":"1b22f17fdc38070de50e6d1ab3a32da71aa2d819","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.eot","hash":"965ce8f688fedbeed504efd498bc9c1622d12362","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.woff","hash":"6d7e6a5fc802b13694d8820fc0138037c0977d2e","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.woff2","hash":"97e438cc545714309882fbceadbf344fcaddcec5","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Bold.ttf","hash":"47327df0f35e7cd7c8645874897a7449697544ae","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Light.ttf","hash":"e321c183e2b75ee19813892b7bac8d7c411cb88a","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Medium.ttf","hash":"6060ca726b9760b76f7c347dce9d2fa1fe42ec92","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Regular.ttf","hash":"824b5480c977a8166e177e5357d13164ccc45f47","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/roboto/Roboto-Thin.ttf","hash":"173ed64528b4d010a76d8d38deb1d7e7eed58eda","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.ttf","hash":"61d8d967807ef12598d81582fa95b9f600c3ee01","modified":1465445947000},{"_id":"themes/indigo/source/css/fonts/fontawesome/fontawesome-webfont.svg","hash":"c0522272bbaef2acb3d341912754d6ea2d0ecfc0","modified":1465445947000},{"_id":"public/demos/-webkit-border-image.html","hash":"eb794c59acc6b2f749c93382f0638010fb79e9d6","modified":1481815957697},{"_id":"public/demos/border-image.html","hash":"fe6ab016b561b822eb9ff7977f6389b0d563a8ed","modified":1481815957720},{"_id":"public/demos/border-radius.html","hash":"fe6c99602af9c2f50e927f73af1e88dc1bb1387f","modified":1481815958005},{"_id":"public/demos/css background.html","hash":"ddbeacc9053e20a74bb00e464d6f6dc4d1d73118","modified":1481815958017},{"_id":"public/demos/css skew.html","hash":"61887c7c66bc7687bd5c5bfa9b56aa7047763745","modified":1481815958017},{"_id":"public/demos/envelope.html","hash":"81e4b6601501999d9bc47f90d4135fe7536756d6","modified":1481815958018},{"_id":"public/demos/half ellipse.html","hash":"6dd487332ace60c479d307128da6fb4fac6c906a","modified":1481815958018},{"_id":"public/demos/marching ants borders.html","hash":"4423e1f579e3bbddbfc005cb655d21f5cf960b37","modified":1481815958018},{"_id":"public/demos/transform-origin.html","hash":"6922800dbf48280e672be8c504b60efa44bb3fdc","modified":1481815958018},{"_id":"public/demos/transform-style.html","hash":"ed1356c17f9e25750060aae51043c692109a3f0f","modified":1481815958018},{"_id":"public/demos/空心字1.html","hash":"d584cd759659d682898279247c47658235399915","modified":1481815958018},{"_id":"public/demos/空心字2.html","hash":"ce237c37194a8c60ae8c0510a2514cdda11b0454","modified":1481815958018},{"_id":"public/demos/2016-12-15/form1.html","hash":"fd7a77dbadf2d8c4c20ff0a68f8f5432a7976458","modified":1481815958018},{"_id":"public/demos/2016-12-15/form2.html","hash":"103e70c0deb36f61b7b45f666c859f8dde60bfb1","modified":1481815958018},{"_id":"public/atom.xml","hash":"a5e47137c3b703de32cfef6186b617cdf26fbc94","modified":1481815958019},{"_id":"public/content.json","hash":"73b323eabfd195b13f9009aca26e9742820ea742","modified":1481815958019},{"_id":"public/blogs/如何展示表单控件.html","hash":"e67ef52f22d902e8a1f34ea36779c9efa2dc7cc1","modified":1481815958030},{"_id":"public/blogs/HTTP请求重发.html","hash":"9af659f49684db742afbe3eb0218eec1172ac488","modified":1481815958030},{"_id":"public/blogs/使用 marked 解析 markdown 之缩进.html","hash":"014229ea88b62d9f809eb644e75a9fe6e8f9cfb9","modified":1481815958030},{"_id":"public/blogs/oracle安装.html","hash":"1a2d1a566ca16a1e363eaa6889dee244b9f101d9","modified":1481815958030},{"_id":"public/blogs/爬虫与编码.html","hash":"1063fd3d6ea8d2abb770ff187a59215be4fd5dc6","modified":1481815958031},{"_id":"public/blogs/CSS 语法速查.html","hash":"d584235029db198e8d702de2141978aaf92ff7f6","modified":1481815958031},{"_id":"public/blogs/CSS 空心字.html","hash":"e30574ea7e638e8e4185a6996f5daf390f85a900","modified":1481815958031},{"_id":"public/blogs/CSS 变形.html","hash":"ccd251eff20de179342b63f668a938e0e4e04e3b","modified":1481815958031},{"_id":"public/blogs/CSS border-image.html","hash":"a6e5cb36e0ac3d675748f4437dbebb6f221deb6a","modified":1481815958031},{"_id":"public/blogs/CSS border-radius.html","hash":"f546a209bbfab2cb6600e2fa4b380703952fa7ef","modified":1481815958031},{"_id":"public/blogs/使用 CSS background 构造一个棋盘.html","hash":"e611f93d29d99b9cc32c06141131fbf9c64c322d","modified":1481815958031},{"_id":"public/blogs/百度 EFE 前端框架学习笔记（ef）.html","hash":"7ace091ed54e99cfdc14ddb53700b0d8efa02480","modified":1481815958031},{"_id":"public/blogs/web 前端外部点击事件的实现.html","hash":"d9c833f1929aefd7f29051584928ee859b317cc5","modified":1481815958031},{"_id":"public/archives/index.html","hash":"54a093ff91824f1baa971fec4a63ab219886b328","modified":1481815958031},{"_id":"public/archives/page/2/index.html","hash":"d4a64f4c11f52459ff766e26376fc13ad6f03a04","modified":1481815958031},{"_id":"public/archives/page/3/index.html","hash":"8c07d2731cef675bc3cdb52872e27a222bf9f26d","modified":1481815958031},{"_id":"public/archives/2014/index.html","hash":"24b84e69cb3be24fd2d00c7f231c382bef16bf55","modified":1481815958031},{"_id":"public/archives/2014/10/index.html","hash":"9140649d0786e2b8e78f2a13de5ad3f999293170","modified":1481815958031},{"_id":"public/archives/2015/index.html","hash":"ee29e7eb23e62d96acf8ebc941f29d9b196ba3c4","modified":1481815958031},{"_id":"public/archives/2015/page/2/index.html","hash":"a408782ab686c3e13eccb2e941fcd1573c72c9a7","modified":1481815958031},{"_id":"public/archives/2015/05/index.html","hash":"f77a4b485b563863f77492f2124588b3e5f2e6f2","modified":1481815958032},{"_id":"public/archives/2015/06/index.html","hash":"f12e0ea4331f3bd817cb446f98b95084aeff95f1","modified":1481815958032},{"_id":"public/archives/2015/07/index.html","hash":"cfadc296611d2fa3a19900ce34a02584fb9c82b3","modified":1481815958032},{"_id":"public/archives/2015/08/index.html","hash":"54505eaec6303aa32bc4d5d06237af78aad7ef1f","modified":1481815958032},{"_id":"public/archives/2015/09/index.html","hash":"9161af1a93fbd78e9451d9c3c1eeb66ffd989401","modified":1481815958032},{"_id":"public/archives/2015/10/index.html","hash":"d1e5c07422c8863124300211ff75df3c4cdfd55a","modified":1481815958032},{"_id":"public/archives/2016/index.html","hash":"250343b3bee7ae3c01ed0389e16398322679ea4a","modified":1481815958032},{"_id":"public/archives/2016/01/index.html","hash":"0c4263764005c3721c70fe3fd3f3fc4a5cacb330","modified":1481815958032},{"_id":"public/archives/2016/05/index.html","hash":"26bb787993ace359103206da4089a451e76ace8a","modified":1481815958032},{"_id":"public/archives/2016/06/index.html","hash":"5219a901c83f2fe8c5b9ec1a3f75b8e0f788359c","modified":1481815958032},{"_id":"public/archives/2016/07/index.html","hash":"251abd378c2f97e887392a57152415aadbfcdff4","modified":1481815958032},{"_id":"public/archives/2016/12/index.html","hash":"077c21c4e22e43bd1ab406fc658d763d4070689d","modified":1481815958032},{"_id":"public/page/3/index.html","hash":"3f5d21bd9ca2d7dbc801286132f2022a4c9b34e4","modified":1481815958032},{"_id":"public/tags/CSS/index.html","hash":"c0646e3d4bbe545ed7a0f5d5462ee659305c0d63","modified":1481815958032},{"_id":"public/tags/JavaScript/index.html","hash":"e7813a84cca6f352e49cf01153e2dae5ba9e2c97","modified":1481815958032},{"_id":"public/tags/ECMAScript-6/index.html","hash":"b4a2282146dda2e7e540a3ce1d571b972cc60864","modified":1481815958032},{"_id":"public/tags/HTTP/index.html","hash":"aa6079a7c28ccbe6fab4c7ffa94e70966015984b","modified":1481815958033},{"_id":"public/tags/Reflux/index.html","hash":"47481c1ae3cd61bf0489cc9e28e5a54f2f4e4cc7","modified":1481815958033},{"_id":"public/tags/React/index.html","hash":"3a03b0629f0ba1c6d7515805942cbaac5909d021","modified":1481815958033},{"_id":"public/tags/Oracle/index.html","hash":"ba47f95577d0bb622faa02d5b9105dda4d58f1f8","modified":1481815958033},{"_id":"public/tags/数据库/index.html","hash":"0c1c2f2d3ec9f71ef183ba1e9cedf8b7795be889","modified":1481815958033},{"_id":"public/tags/markdown/index.html","hash":"64ae6eb2cfc639a7572c495cc191f50cb5297f80","modified":1481815958033},{"_id":"public/tags/ETPL/index.html","hash":"8949236943e7b08f25120aeebab9ed95214c32e2","modified":1481815958033},{"_id":"public/tags/vscode/index.html","hash":"bec771e8fd63ca59dd0999014263a0a556e5e3a3","modified":1481815958033},{"_id":"public/blogs/karma-入门.html","hash":"3ee35b502ce874302b70c6113f9e77b1ef5e78c1","modified":1481815958033},{"_id":"public/blogs/受保护的对象.html","hash":"4a0ee9536dff506ad18f67ee259bb72a3644a635","modified":1481815958033},{"_id":"public/blogs/filedownload.html","hash":"02d60732734ea156392badf34fed6ff78f70e7f2","modified":1481815958033},{"_id":"public/blogs/使用marked解析markdown.html","hash":"2f0a7a5f4d50dd4db954fc5f47e2a1dcaf9f603b","modified":1481815958033},{"_id":"public/blogs/实现第一个 vscode 扩展.html","hash":"31bb02abc9fad6f21dd7e5289fdecf41708cd5be","modified":1481815958033},{"_id":"public/blogs/ES6 简单特性概览.html","hash":"32c501b5156cf1a507500e7caff245d8bea1e294","modified":1481815958033},{"_id":"public/blogs/一个 JavaScript.html","hash":"2ba160cd66123fe36441e5fdd5314cbe7bcf7b35","modified":1481815958033},{"_id":"public/blogs/生成器（ generator ）.html","hash":"b1e8a622af97d4e03fd8382750d36f0d5bd6be6f","modified":1481815958033},{"_id":"public/blogs/百度 EFE 前端框架学习笔记（esui）.html","hash":"8c01e0798524739d838b8c958d9f953b6b16505b","modified":1481815958033},{"_id":"public/blogs/百度 EFE 前端框架学习笔记（er）.html","hash":"1eaabd5d8028e63e401509a4d099b80f77b1ac8f","modified":1481815958033},{"_id":"public/blogs/Reflux 使用进化日记.html","hash":"dd60feb9d6eebf4f5ce425213716634efabd2b32","modified":1481815958033},{"_id":"public/blogs/记一次坑爹的对接经历.html","hash":"bae2fd68c10cc523c1c8cbdee6e2f75d68d02def","modified":1481815958034},{"_id":"public/blogs/一些 core javascript 的基础知识.html","hash":"2a881c907232a95bdea9f38fa7332fa32d0f01bb","modified":1481815958034},{"_id":"public/index.html","hash":"e8a9e61fbe574c789e0659d4eb681b24cfc55e70","modified":1481815958034},{"_id":"public/page/2/index.html","hash":"d509d778bd8317c2e1b4a33b207e8b4ba7e4ef60","modified":1481815958034},{"_id":"public/images/10.jpg","hash":"906e7332b1198b78316d5436ce674f44700cdaae","modified":1481815958050},{"_id":"public/images/13.png","hash":"30227705d6c65db3d0a0079a329a5664e8432a91","modified":1481815958050},{"_id":"public/images/6.png","hash":"2540ef82a10707d536ec9f8313a1e529b0b97ed4","modified":1481815958050},{"_id":"public/images/8.jpg","hash":"320024a19a4402847e231090c0872b82aa899f74","modified":1481815958050},{"_id":"public/img/brand.jpg","hash":"0e237f1b433851c156e1f1cdaeb044054b3b9879","modified":1481815958051},{"_id":"public/img/cc.png","hash":"ebce75a62b40976a72d43f0bd937d859ac24d87c","modified":1481815958053},{"_id":"public/img/img-err.png","hash":"23a63ea26eb3c1d5e677d9883cf36cc1a1a1228b","modified":1481815958053},{"_id":"public/img/img-loading.png","hash":"a9cd5cd11866824f31e3d1c5e23badfeb3f73031","modified":1481815958053},{"_id":"public/img/logo.jpg","hash":"a089e42acab93864d33e16801b0ac5dc1617c373","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Bold.eot","hash":"a76cd602f5188b9fbd4ba7443dcb9c064e3dbf10","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Light.eot","hash":"42fe156996197e5eb0c0264c5d1bb3b4681f4595","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Bold.woff2","hash":"933b866d09c2b087707a98dab64b3888865eeb96","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Medium.eot","hash":"1517f4b6e1c5d0e5198f937557253aac8fab0416","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Bold.woff","hash":"ee99cd87a59a9a5d4092c83232bb3eec67547425","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Light.woff","hash":"6300f659be9e834ab263efe2fb3c581d48b1e7b2","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Regular.eot","hash":"77ae3e980ec03863ebe2587a8ef9ddfd06941db0","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Light.woff2","hash":"bbdc28b887400fcb340b504ec2904993af42a5d7","modified":1481815958053},{"_id":"public/css/fonts/roboto/Roboto-Thin.eot","hash":"0790a51a848dbe7292c98f9d0459218bf1a8ffdd","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Medium.woff","hash":"d45f84922131364989ad6578c7a06b6b4fc22c34","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Medium.woff2","hash":"6cc1b73571af9e827c4e7e91418f476703cd4c4b","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Regular.woff","hash":"74734dde8d94e7268170f9b994dedfbdcb5b3a15","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Regular.woff2","hash":"ed1558b0541f5e01ce48c7db1588371b990eec19","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Thin.woff2","hash":"2449e3dac5ddb7c3da8bb07450493b62d052758c","modified":1481815958054},{"_id":"public/css/fonts/roboto/Roboto-Thin.woff","hash":"fbc3e71d456c96667d8082ab910e3946ef89240b","modified":1481815958054},{"_id":"public/images/1.jpg","hash":"d3f71673e7e0a5785559bf18a45a6074d2267c4c","modified":1481815958107},{"_id":"public/images/11.jpg","hash":"9fbcbe6b096df4d0b0ae1b28610a25f2f390c07e","modified":1481815958107},{"_id":"public/images/7.png","hash":"f9de759cf2d5ef2271049ed537b7a95a70c00a82","modified":1481815958108},{"_id":"public/images/3.jpg","hash":"a5f9496f1e6dbd3141f3881d4676dfdaf13202ec","modified":1481815958108},{"_id":"public/images/2016-12-15/form.png","hash":"d84c6ceba237cd7d810d3198dcbc6f75546b7a53","modified":1481815958108},{"_id":"public/css/fonts/fontawesome/fontawesome-webfont.woff","hash":"6d7e6a5fc802b13694d8820fc0138037c0977d2e","modified":1481815958109},{"_id":"public/css/fonts/fontawesome/fontawesome-webfont.woff2","hash":"97e438cc545714309882fbceadbf344fcaddcec5","modified":1481815958110},{"_id":"public/css/fonts/roboto/Roboto-Bold.ttf","hash":"47327df0f35e7cd7c8645874897a7449697544ae","modified":1481815958109},{"_id":"public/css/fonts/roboto/Roboto-Light.ttf","hash":"e321c183e2b75ee19813892b7bac8d7c411cb88a","modified":1481815958109},{"_id":"public/css/fonts/fontawesome/FontAwesome.otf","hash":"1b22f17fdc38070de50e6d1ab3a32da71aa2d819","modified":1481815958108},{"_id":"public/css/fonts/fontawesome/fontawesome-webfont.eot","hash":"965ce8f688fedbeed504efd498bc9c1622d12362","modified":1481815958109},{"_id":"public/css/fonts/roboto/Roboto-Medium.ttf","hash":"6060ca726b9760b76f7c347dce9d2fa1fe42ec92","modified":1481815958109},{"_id":"public/css/fonts/roboto/Roboto-Regular.ttf","hash":"824b5480c977a8166e177e5357d13164ccc45f47","modified":1481815958109},{"_id":"public/css/fonts/roboto/Roboto-Thin.ttf","hash":"173ed64528b4d010a76d8d38deb1d7e7eed58eda","modified":1481815958109},{"_id":"public/js/main.js","hash":"e3ccf70da521a03a581b1dd23b0cbea9b4f023a9","modified":1481815958116},{"_id":"public/js/search.js","hash":"a7046c9d279b0519715348dffc62d2f879cb485f","modified":1481815958117},{"_id":"public/images/12.png","hash":"aa0e49edbef374addd722cdce1af04b4c6d590bd","modified":1481815958117},{"_id":"public/images/14.png","hash":"e2bd55a46b10ddbf4b45d5bb24906036fe344347","modified":1481815958117},{"_id":"public/images/16.png","hash":"53c16941b5c8b35a3c4c8d59d72a71513e7dbb07","modified":1481815958117},{"_id":"public/images/5.jpg","hash":"b20a459406751349285f5f09b535efc054e6d9e3","modified":1481815958117},{"_id":"public/images/4.jpg","hash":"cc17a1b9d9265f1aedda29cfd15b24798caafb79","modified":1481815958117},{"_id":"public/images/9.jpg","hash":"b20a459406751349285f5f09b535efc054e6d9e3","modified":1481815958117},{"_id":"public/css/fonts/fontawesome/fontawesome-webfont.ttf","hash":"61d8d967807ef12598d81582fa95b9f600c3ee01","modified":1481815958117},{"_id":"public/images/2.jpg","hash":"a09b477549ff2523dd0185f1259243f83a7a65bd","modified":1481815958119},{"_id":"public/css/fonts/fontawesome/fontawesome-webfont.svg","hash":"c0522272bbaef2acb3d341912754d6ea2d0ecfc0","modified":1481815958124},{"_id":"public/images/17.png","hash":"b41e4c632feb67ff33de38afbb47d0a2cd17c36f","modified":1481815958126},{"_id":"public/images/15.png","hash":"712606992cd950f17b5d6c8b9c1466e08fb80ba7","modified":1481815958126},{"_id":"public/css/style.css","hash":"e0b1e665daae5f3e3893caf527628570ace5f47d","modified":1481815958338}],"Category":[],"Data":[],"Page":[{"layout":"false","_content":"<style>\n.-webkit-border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    -webkit-border-image: url(/images/8.jpg) 60 70 round stretch;\n    background-color: red;\n}\n</style>\n\n<div class=\"-webkit-border-image-demo\"></div>\n","source":"demos/-webkit-border-image.html","raw":"---\nlayout: false\n---\n<style>\n.-webkit-border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    -webkit-border-image: url(/images/8.jpg) 60 70 round stretch;\n    background-color: red;\n}\n</style>\n\n<div class=\"-webkit-border-image-demo\"></div>\n","date":"2016-06-09T03:45:40.000Z","updated":"2016-06-09T03:45:40.000Z","path":"demos/-webkit-border-image.html","title":"","comments":1,"_id":"ciwqiy01q000104074frwwgc9","content":"<style>\n.-webkit-border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    -webkit-border-image: url(/images/8.jpg) 60 70 round stretch;\n    background-color: red;\n}\n</style>\n\n<div class=\"-webkit-border-image-demo\"></div>\n","excerpt":"","more":"<style>\n.-webkit-border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    -webkit-border-image: url(/images/8.jpg) 60 70 round stretch;\n    background-color: red;\n}\n</style>\n\n<div class=\"-webkit-border-image-demo\"></div>\n"},{"layout":"false","_content":"<style>\n.border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(/images/8.jpg) 60 70 round stretch;\n}\n</style>\n\n<div class=\"border-image-demo\"></div>\n","source":"demos/border-image.html","raw":"---\nlayout: false\n---\n<style>\n.border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(/images/8.jpg) 60 70 round stretch;\n}\n</style>\n\n<div class=\"border-image-demo\"></div>\n","date":"2016-06-09T03:43:03.000Z","updated":"2016-06-09T03:43:03.000Z","path":"demos/border-image.html","title":"","comments":1,"_id":"ciwqiy01s00030407igdcpwsj","content":"<style>\n.border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(/images/8.jpg) 60 70 round stretch;\n}\n</style>\n\n<div class=\"border-image-demo\"></div>\n","excerpt":"","more":"<style>\n.border-image-demo {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(/images/8.jpg) 60 70 round stretch;\n}\n</style>\n\n<div class=\"border-image-demo\"></div>\n"},{"layout":"false","_content":"<style>\n.demo1 {\n    width: 100px;\n    height: 100px;\n    background: lightblue;\n\n    border-radius: 20px/5px;\n}\n</style>\n\n<div class=\"demo1\"></div>\n","source":"demos/border-radius.html","raw":"---\nlayout: false\n---\n<style>\n.demo1 {\n    width: 100px;\n    height: 100px;\n    background: lightblue;\n\n    border-radius: 20px/5px;\n}\n</style>\n\n<div class=\"demo1\"></div>\n","date":"2016-06-09T03:39:07.000Z","updated":"2016-06-09T03:39:07.000Z","path":"demos/border-radius.html","title":"","comments":1,"_id":"ciwqiy01z00060407f1pn3byl","content":"<style>\n.demo1 {\n    width: 100px;\n    height: 100px;\n    background: lightblue;\n\n    border-radius: 20px/5px;\n}\n</style>\n\n<div class=\"demo1\"></div>\n","excerpt":"","more":"<style>\n.demo1 {\n    width: 100px;\n    height: 100px;\n    background: lightblue;\n\n    border-radius: 20px/5px;\n}\n</style>\n\n<div class=\"demo1\"></div>\n"},{"layout":"false","_content":"<style>\n    .css-background-demo1 {\n        width: 300px;\n        height: 200px;\n        margin: 10px 0;\n\n        background-image:\n            repeating-linear-gradient(45deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            ),\n            repeating-linear-gradient(145deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            );\n    }\n</style>\n<div class=\"css-background-demo1\"></div>\n<style>\n    .css-background-demo2 {\n        width: 300px;\n        height: 200px;\n\n        background-image:\n            radial-gradient(\n                transparent 50%,\n                rgba(0,255,0,.5) 50%,\n                rgba(0,255,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 50%,\n                rgba(255,0,0,.5) 50%,\n                rgba(255,0,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 80%,\n                rgba(0,0,255,.5) 80%,\n                rgba(0,0,255,.5) 90%,\n                transparent 90%);\n        background-size: 40px 40px;\n        background-position: 0 0, 20px 20px, 20px 40px;\n    }\n</style>\n<div class=\"css-background-demo2\"></div>\n","source":"demos/css background.html","raw":"---\nlayout: false\n---\n<style>\n    .css-background-demo1 {\n        width: 300px;\n        height: 200px;\n        margin: 10px 0;\n\n        background-image:\n            repeating-linear-gradient(45deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            ),\n            repeating-linear-gradient(145deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            );\n    }\n</style>\n<div class=\"css-background-demo1\"></div>\n<style>\n    .css-background-demo2 {\n        width: 300px;\n        height: 200px;\n\n        background-image:\n            radial-gradient(\n                transparent 50%,\n                rgba(0,255,0,.5) 50%,\n                rgba(0,255,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 50%,\n                rgba(255,0,0,.5) 50%,\n                rgba(255,0,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 80%,\n                rgba(0,0,255,.5) 80%,\n                rgba(0,0,255,.5) 90%,\n                transparent 90%);\n        background-size: 40px 40px;\n        background-position: 0 0, 20px 20px, 20px 40px;\n    }\n</style>\n<div class=\"css-background-demo2\"></div>\n","date":"2016-06-09T03:49:28.000Z","updated":"2016-06-09T03:49:28.000Z","path":"demos/css background.html","title":"","comments":1,"_id":"ciwqiy02300080407lvwn4ohk","content":"<style>\n    .css-background-demo1 {\n        width: 300px;\n        height: 200px;\n        margin: 10px 0;\n\n        background-image:\n            repeating-linear-gradient(45deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            ),\n            repeating-linear-gradient(145deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            );\n    }\n</style>\n<div class=\"css-background-demo1\"></div>\n<style>\n    .css-background-demo2 {\n        width: 300px;\n        height: 200px;\n\n        background-image:\n            radial-gradient(\n                transparent 50%,\n                rgba(0,255,0,.5) 50%,\n                rgba(0,255,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 50%,\n                rgba(255,0,0,.5) 50%,\n                rgba(255,0,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 80%,\n                rgba(0,0,255,.5) 80%,\n                rgba(0,0,255,.5) 90%,\n                transparent 90%);\n        background-size: 40px 40px;\n        background-position: 0 0, 20px 20px, 20px 40px;\n    }\n</style>\n<div class=\"css-background-demo2\"></div>\n","excerpt":"","more":"<style>\n    .css-background-demo1 {\n        width: 300px;\n        height: 200px;\n        margin: 10px 0;\n\n        background-image:\n            repeating-linear-gradient(45deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            ),\n            repeating-linear-gradient(145deg,\n                rgba(255,0,0,.3) 0,\n                rgba(255,0,0,.3) 10px,\n                rgba(0,255,0,.3) 10px,\n                rgba(0,255,0,.3) 20px,\n                rgba(0,0,255,.3) 20px,\n                rgba(0,0,255,.3) 30px,\n                rgba(100,100,0,.3) 30px,\n                rgba(100,100,0,.3) 40px\n            );\n    }\n</style>\n<div class=\"css-background-demo1\"></div>\n<style>\n    .css-background-demo2 {\n        width: 300px;\n        height: 200px;\n\n        background-image:\n            radial-gradient(\n                transparent 50%,\n                rgba(0,255,0,.5) 50%,\n                rgba(0,255,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 50%,\n                rgba(255,0,0,.5) 50%,\n                rgba(255,0,0,.5) 60%,\n                transparent 60%),\n            radial-gradient(\n                transparent 80%,\n                rgba(0,0,255,.5) 80%,\n                rgba(0,0,255,.5) 90%,\n                transparent 90%);\n        background-size: 40px 40px;\n        background-position: 0 0, 20px 20px, 20px 40px;\n    }\n</style>\n<div class=\"css-background-demo2\"></div>\n"},{"layout":"false","_content":"<style type=\"text/css\">\n.demo3 {\n    width: 400px;\n    height: 300px;\n    position: relative;\n}\n.demo3 .box1, .demo3 .box2, .demo3 .box3, .demo3 .box4 {\n    top: 100px;\n    left: 50px;\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo3 .box1 {\n    border: 1px #000 dotted;\n}\n.demo3 .box2 {\n    border: 1px solid #000;\n    transform: skewX(45deg);\n    -webkit-transform: skewX(45deg);\n}\n\n.demo3 .box3, .demo3 .box4 {\n    left: 240px;\n}\n.demo3 .box3 {\n    border: 1px dotted #000;\n}\n.demo3 .box4 {\n    border: 1px solid #000;\n    transform: skewY(45deg);\n    -webkit-transform: skewY(45deg);\n}\n\n.demo3 h5 {\n    position: absolute;\n    margin: 0;\n    top: 20px;\n}\n.demo3 h5:first-child {\n    left: 24px;\n}\n.demo3 h5:nth-child(4) {\n    left: 246px;\n}\n</style>\n\n<div class=\"demo3\">\n    <h5>skewX(45deg)</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n    <h5>skewY(45deg)</h5>\n    <div class=\"box3\"></div>\n    <div class=\"box4\"></div>\n</div>","source":"demos/css skew.html","raw":"---\nlayout: false\n---\n<style type=\"text/css\">\n.demo3 {\n    width: 400px;\n    height: 300px;\n    position: relative;\n}\n.demo3 .box1, .demo3 .box2, .demo3 .box3, .demo3 .box4 {\n    top: 100px;\n    left: 50px;\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo3 .box1 {\n    border: 1px #000 dotted;\n}\n.demo3 .box2 {\n    border: 1px solid #000;\n    transform: skewX(45deg);\n    -webkit-transform: skewX(45deg);\n}\n\n.demo3 .box3, .demo3 .box4 {\n    left: 240px;\n}\n.demo3 .box3 {\n    border: 1px dotted #000;\n}\n.demo3 .box4 {\n    border: 1px solid #000;\n    transform: skewY(45deg);\n    -webkit-transform: skewY(45deg);\n}\n\n.demo3 h5 {\n    position: absolute;\n    margin: 0;\n    top: 20px;\n}\n.demo3 h5:first-child {\n    left: 24px;\n}\n.demo3 h5:nth-child(4) {\n    left: 246px;\n}\n</style>\n\n<div class=\"demo3\">\n    <h5>skewX(45deg)</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n    <h5>skewY(45deg)</h5>\n    <div class=\"box3\"></div>\n    <div class=\"box4\"></div>\n</div>","date":"2016-06-09T03:10:57.000Z","updated":"2016-06-09T03:10:57.000Z","path":"demos/css skew.html","title":"","comments":1,"_id":"ciwqiy026000b0407sv49dj0l","content":"<style type=\"text/css\">\n.demo3 {\n    width: 400px;\n    height: 300px;\n    position: relative;\n}\n.demo3 .box1, .demo3 .box2, .demo3 .box3, .demo3 .box4 {\n    top: 100px;\n    left: 50px;\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo3 .box1 {\n    border: 1px #000 dotted;\n}\n.demo3 .box2 {\n    border: 1px solid #000;\n    transform: skewX(45deg);\n    -webkit-transform: skewX(45deg);\n}\n\n.demo3 .box3, .demo3 .box4 {\n    left: 240px;\n}\n.demo3 .box3 {\n    border: 1px dotted #000;\n}\n.demo3 .box4 {\n    border: 1px solid #000;\n    transform: skewY(45deg);\n    -webkit-transform: skewY(45deg);\n}\n\n.demo3 h5 {\n    position: absolute;\n    margin: 0;\n    top: 20px;\n}\n.demo3 h5:first-child {\n    left: 24px;\n}\n.demo3 h5:nth-child(4) {\n    left: 246px;\n}\n</style>\n\n<div class=\"demo3\">\n    <h5>skewX(45deg)</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n    <h5>skewY(45deg)</h5>\n    <div class=\"box3\"></div>\n    <div class=\"box4\"></div>\n</div>","excerpt":"","more":"<style type=\"text/css\">\n.demo3 {\n    width: 400px;\n    height: 300px;\n    position: relative;\n}\n.demo3 .box1, .demo3 .box2, .demo3 .box3, .demo3 .box4 {\n    top: 100px;\n    left: 50px;\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo3 .box1 {\n    border: 1px #000 dotted;\n}\n.demo3 .box2 {\n    border: 1px solid #000;\n    transform: skewX(45deg);\n    -webkit-transform: skewX(45deg);\n}\n\n.demo3 .box3, .demo3 .box4 {\n    left: 240px;\n}\n.demo3 .box3 {\n    border: 1px dotted #000;\n}\n.demo3 .box4 {\n    border: 1px solid #000;\n    transform: skewY(45deg);\n    -webkit-transform: skewY(45deg);\n}\n\n.demo3 h5 {\n    position: absolute;\n    margin: 0;\n    top: 20px;\n}\n.demo3 h5:first-child {\n    left: 24px;\n}\n.demo3 h5:nth-child(4) {\n    left: 246px;\n}\n</style>\n\n<div class=\"demo3\">\n    <h5>skewX(45deg)</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n    <h5>skewY(45deg)</h5>\n    <div class=\"box3\"></div>\n    <div class=\"box4\"></div>\n</div>"},{"layout":"false","_content":"<style type=\"text/css\">\n    .demo-envelope {\n        width: 200px;\n        height: 80px;\n        margin: 50px 10px;\n\n        padding: 1em;\n        border: .5em solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, red 0, red 12.5%, transparent 0, transparent 25%, #58a 0, #58a 37.5%, transparent 0, transparent 50%)\n            0 / 2em 2em;\n        transform: rotateZ(-10deg);\n        -webkit-transform: rotateZ(-10deg);\n    }\n</style>\n<div class=\"demo-envelope\">the envelope border</div>\n","source":"demos/envelope.html","raw":"---\nlayout: false\n---\n<style type=\"text/css\">\n    .demo-envelope {\n        width: 200px;\n        height: 80px;\n        margin: 50px 10px;\n\n        padding: 1em;\n        border: .5em solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, red 0, red 12.5%, transparent 0, transparent 25%, #58a 0, #58a 37.5%, transparent 0, transparent 50%)\n            0 / 2em 2em;\n        transform: rotateZ(-10deg);\n        -webkit-transform: rotateZ(-10deg);\n    }\n</style>\n<div class=\"demo-envelope\">the envelope border</div>\n","date":"2016-06-09T03:47:46.000Z","updated":"2016-06-09T03:47:46.000Z","path":"demos/envelope.html","title":"","comments":1,"_id":"ciwqiy029000e0407ix5ibo3d","content":"<style type=\"text/css\">\n    .demo-envelope {\n        width: 200px;\n        height: 80px;\n        margin: 50px 10px;\n\n        padding: 1em;\n        border: .5em solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, red 0, red 12.5%, transparent 0, transparent 25%, #58a 0, #58a 37.5%, transparent 0, transparent 50%)\n            0 / 2em 2em;\n        transform: rotateZ(-10deg);\n        -webkit-transform: rotateZ(-10deg);\n    }\n</style>\n<div class=\"demo-envelope\">the envelope border</div>\n","excerpt":"","more":"<style type=\"text/css\">\n    .demo-envelope {\n        width: 200px;\n        height: 80px;\n        margin: 50px 10px;\n\n        padding: 1em;\n        border: .5em solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, red 0, red 12.5%, transparent 0, transparent 25%, #58a 0, #58a 37.5%, transparent 0, transparent 50%)\n            0 / 2em 2em;\n        transform: rotateZ(-10deg);\n        -webkit-transform: rotateZ(-10deg);\n    }\n</style>\n<div class=\"demo-envelope\">the envelope border</div>\n"},{"layout":"false","_content":"<style>\n    .half-ellipse-demo1 {\n        width: 100px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 100px 0 0;\n    }\n    .half-ellipse-demo2 {\n        width: 50px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 0 0 0;\n    }\n</style>\n<div class=\"half-ellipse-demo1\"></div>\n\n<div class=\"half-ellipse-demo2\"></div>","source":"demos/half ellipse.html","raw":"---\nlayout: false\n---\n<style>\n    .half-ellipse-demo1 {\n        width: 100px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 100px 0 0;\n    }\n    .half-ellipse-demo2 {\n        width: 50px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 0 0 0;\n    }\n</style>\n<div class=\"half-ellipse-demo1\"></div>\n\n<div class=\"half-ellipse-demo2\"></div>","date":"2016-06-09T03:40:29.000Z","updated":"2016-06-09T03:40:29.000Z","path":"demos/half ellipse.html","title":"","comments":1,"_id":"ciwqiy02b000i0407u0s3x4rk","content":"<style>\n    .half-ellipse-demo1 {\n        width: 100px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 100px 0 0;\n    }\n    .half-ellipse-demo2 {\n        width: 50px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 0 0 0;\n    }\n</style>\n<div class=\"half-ellipse-demo1\"></div>\n\n<div class=\"half-ellipse-demo2\"></div>","excerpt":"","more":"<style>\n    .half-ellipse-demo1 {\n        width: 100px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 100px 0 0;\n    }\n    .half-ellipse-demo2 {\n        width: 50px;\n        height: 50px;\n        background: orange;\n        border-radius: 100px 0 0 0;\n    }\n</style>\n<div class=\"half-ellipse-demo1\"></div>\n\n<div class=\"half-ellipse-demo2\"></div>"},{"layout":"false","_content":"<style type=\"text/css\">\n    @keyframes ants {\n        to {\n            background-position: 100%;\n        }\n    }\n    .marching-ants-borders {\n        width: 10em;\n        height: 10em;\n        margin: 2em 0;\n\n        border: 1px solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, #000 0, #000 25%, #fff 0, #fff 50%) 0 / .6em .6em;\n        animation: ants 12s linear infinite;\n    }\n</style>\n<div class=\"marching-ants-borders\"></div>","source":"demos/marching ants borders.html","raw":"---\nlayout: false\n---\n<style type=\"text/css\">\n    @keyframes ants {\n        to {\n            background-position: 100%;\n        }\n    }\n    .marching-ants-borders {\n        width: 10em;\n        height: 10em;\n        margin: 2em 0;\n\n        border: 1px solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, #000 0, #000 25%, #fff 0, #fff 50%) 0 / .6em .6em;\n        animation: ants 12s linear infinite;\n    }\n</style>\n<div class=\"marching-ants-borders\"></div>","date":"2016-06-09T03:50:18.000Z","updated":"2016-06-09T03:50:18.000Z","path":"demos/marching ants borders.html","title":"","comments":1,"_id":"ciwqiy02d000l0407gcs1qp6o","content":"<style type=\"text/css\">\n    @keyframes ants {\n        to {\n            background-position: 100%;\n        }\n    }\n    .marching-ants-borders {\n        width: 10em;\n        height: 10em;\n        margin: 2em 0;\n\n        border: 1px solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, #000 0, #000 25%, #fff 0, #fff 50%) 0 / .6em .6em;\n        animation: ants 12s linear infinite;\n    }\n</style>\n<div class=\"marching-ants-borders\"></div>","excerpt":"","more":"<style type=\"text/css\">\n    @keyframes ants {\n        to {\n            background-position: 100%;\n        }\n    }\n    .marching-ants-borders {\n        width: 10em;\n        height: 10em;\n        margin: 2em 0;\n\n        border: 1px solid transparent;\n        background: linear-gradient(white, white) padding-box,\n            repeating-linear-gradient(-45deg, #000 0, #000 25%, #fff 0, #fff 50%) 0 / .6em .6em;\n        animation: ants 12s linear infinite;\n    }\n</style>\n<div class=\"marching-ants-borders\"></div>"},{"layout":"false","_content":"<meta charset=\"utf-8\">\n<style type=\"text/css\">\n.demo1 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo1 .box1, .demo1 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo1 .box1 {\n    border: 1px dotted #000;\n}\n.demo1 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 50% 50%;\n    -webkit-transform-origin: 50% 50%;\n}\n</style>\n\n<div class=\"demo1\">\n    <h5>示例1</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>\n\n<style type=\"text/css\">\n.demo2 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo2 .box1, .demo2 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo2 .box1 {\n    border: 1px dotted #000;\n}\n.demo2 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 100% 100%;\n    -webkit-transform-origin: 100% 100%;\n}\n</style>\n\n<div class=\"demo2\">\n    <h5>示例2</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>","source":"demos/transform-origin.html","raw":"---\nlayout: false\n---\n<meta charset=\"utf-8\">\n<style type=\"text/css\">\n.demo1 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo1 .box1, .demo1 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo1 .box1 {\n    border: 1px dotted #000;\n}\n.demo1 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 50% 50%;\n    -webkit-transform-origin: 50% 50%;\n}\n</style>\n\n<div class=\"demo1\">\n    <h5>示例1</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>\n\n<style type=\"text/css\">\n.demo2 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo2 .box1, .demo2 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo2 .box1 {\n    border: 1px dotted #000;\n}\n.demo2 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 100% 100%;\n    -webkit-transform-origin: 100% 100%;\n}\n</style>\n\n<div class=\"demo2\">\n    <h5>示例2</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>","date":"2016-06-09T03:27:36.000Z","updated":"2016-06-09T03:27:36.000Z","path":"demos/transform-origin.html","title":"","comments":1,"_id":"ciwqiy02g000p0407tg3y9qlt","content":"<meta charset=\"utf-8\">\n<style type=\"text/css\">\n.demo1 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo1 .box1, .demo1 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo1 .box1 {\n    border: 1px dotted #000;\n}\n.demo1 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 50% 50%;\n    -webkit-transform-origin: 50% 50%;\n}\n</style>\n\n<div class=\"demo1\">\n    <h5>示例1</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>\n\n<style type=\"text/css\">\n.demo2 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo2 .box1, .demo2 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo2 .box1 {\n    border: 1px dotted #000;\n}\n.demo2 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 100% 100%;\n    -webkit-transform-origin: 100% 100%;\n}\n</style>\n\n<div class=\"demo2\">\n    <h5>示例2</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>","excerpt":"","more":"<meta charset=\"utf-8\">\n<style type=\"text/css\">\n.demo1 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo1 .box1, .demo1 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo1 .box1 {\n    border: 1px dotted #000;\n}\n.demo1 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 50% 50%;\n    -webkit-transform-origin: 50% 50%;\n}\n</style>\n\n<div class=\"demo1\">\n    <h5>示例1</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>\n\n<style type=\"text/css\">\n.demo2 {\n    width: 150px;\n    height: 200px;\n    position: relative;\n}\n.demo2 .box1, .demo2 .box2 {\n    top: 25px;\n    width: 100px;\n    height: 100px;\n    position: absolute;\n}\n.demo2 .box1 {\n    border: 1px dotted #000;\n}\n.demo2 .box2 {\n    border: 1px solid #000;\n    transform: translate(40px, 40px);\n    -webkit-transform: translate(40px, 40px);\n    transform-origin: 100% 100%;\n    -webkit-transform-origin: 100% 100%;\n}\n</style>\n\n<div class=\"demo2\">\n    <h5>示例2</h5>\n    <div class=\"box1\"></div>\n    <div class=\"box2\"></div>\n</div>"},{"layout":"false","_content":"<style>\n.demo4 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo4 .container1,\n.demo4 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo4 .container1-origin, .demo4 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo4 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo4 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: flat;\n    -webkit-transform-style: flat;\n}\n.demo4 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo4\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>\n\n<style>\n.demo5 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo5 .container1,\n.demo5 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n.demo5 .container1-origin, .demo5 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo5 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo5 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: preserve-3d;\n    -webkit-transform-style: preserve-3d;\n}\n.demo5 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo5\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>","source":"demos/transform-style.html","raw":"---\nlayout: false\n---\n<style>\n.demo4 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo4 .container1,\n.demo4 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo4 .container1-origin, .demo4 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo4 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo4 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: flat;\n    -webkit-transform-style: flat;\n}\n.demo4 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo4\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>\n\n<style>\n.demo5 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo5 .container1,\n.demo5 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n.demo5 .container1-origin, .demo5 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo5 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo5 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: preserve-3d;\n    -webkit-transform-style: preserve-3d;\n}\n.demo5 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo5\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>","date":"2016-06-09T03:30:04.000Z","updated":"2016-06-09T03:30:04.000Z","path":"demos/transform-style.html","title":"","comments":1,"_id":"ciwqiy02j000s040723ypdozu","content":"<style>\n.demo4 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo4 .container1,\n.demo4 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo4 .container1-origin, .demo4 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo4 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo4 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: flat;\n    -webkit-transform-style: flat;\n}\n.demo4 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo4\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>\n\n<style>\n.demo5 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo5 .container1,\n.demo5 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n.demo5 .container1-origin, .demo5 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo5 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo5 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: preserve-3d;\n    -webkit-transform-style: preserve-3d;\n}\n.demo5 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo5\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>","excerpt":"","more":"<style>\n.demo4 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo4 .container1,\n.demo4 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n\n.demo4 .container1-origin, .demo4 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo4 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo4 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: flat;\n    -webkit-transform-style: flat;\n}\n.demo4 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo4\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>\n\n<style>\n.demo5 {\n    position: relative;\n    width: 200px;\n    height: 200px;\n    perspective: 200px;\n    -webkit-perspective: 200px;\n}\n.demo5 .container1,\n.demo5 .container1-origin {\n    position: absolute;\n    width: 100px;\n    height: 100px;\n}\n.demo5 .container1-origin, .demo5 .container1 {\n    left: 40px;\n    top: 40px;\n}\n.demo5 .container1-origin {\n    border: 1px dotted #000;\n}\n.demo5 .container1 {\n    border: 1px solid #000;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n    transform-style: preserve-3d;\n    -webkit-transform-style: preserve-3d;\n}\n.demo5 .container1 .box {\n    border: 1px solid #f00;\n    width: 50px;\n    height: 50px;\n    transform: rotateY(40deg);\n    -webkit-transform: rotateY(40deg);\n}\n</style>\n\n<div class=\"demo5\">\n    <div class=\"container1-origin\">\n        <div class=\"box\"></div>\n    </div>\n    <div class=\"container1\">\n        <div class=\"box\"></div>\n    </div>\n</div>"},{"layout":"false","_content":"<style>\n    @keyframes shadow {\n        0% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n        50% {\n            text-shadow: 0px 0px 10px #f00;\n        }\n        100% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n    }\n    .kongxinzi1 {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: sans-serif;\n        color: #fff;\n\n        animation: shadow 5s linear infinite;\n    }\n</style>\n<div class=\"kongxinzi1\">空心字</div>","source":"demos/空心字1.html","raw":"---\nlayout: false\n---\n<style>\n    @keyframes shadow {\n        0% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n        50% {\n            text-shadow: 0px 0px 10px #f00;\n        }\n        100% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n    }\n    .kongxinzi1 {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: sans-serif;\n        color: #fff;\n\n        animation: shadow 5s linear infinite;\n    }\n</style>\n<div class=\"kongxinzi1\">空心字</div>","date":"2016-06-09T03:35:23.000Z","updated":"2016-06-09T03:35:23.000Z","path":"demos/空心字1.html","title":"","comments":1,"_id":"ciwqiy02l000u04079cgsy78h","content":"<style>\n    @keyframes shadow {\n        0% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n        50% {\n            text-shadow: 0px 0px 10px #f00;\n        }\n        100% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n    }\n    .kongxinzi1 {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: sans-serif;\n        color: #fff;\n\n        animation: shadow 5s linear infinite;\n    }\n</style>\n<div class=\"kongxinzi1\">空心字</div>","excerpt":"","more":"<style>\n    @keyframes shadow {\n        0% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n        50% {\n            text-shadow: 0px 0px 10px #f00;\n        }\n        100% {\n            text-shadow: 0px 0px 0px #f00;\n        }\n    }\n    .kongxinzi1 {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: sans-serif;\n        color: #fff;\n\n        animation: shadow 5s linear infinite;\n    }\n</style>\n<div class=\"kongxinzi1\">空心字</div>"},{"layout":"false","_content":"<style>\n    .kongxinzi2 span {\n        position: absolute;\n        color: transparent;\n        background-image: repeating-linear-gradient(to bottom, #f00 0%, #000 100%);\n\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n    }\n    .kongxinzi2:after, .kongxinzi2 span {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: monospace;\n    }\n    .kongxinzi2:after {\n        content: attr(title);\n        text-shadow: 0px 0px 1px #1e1414;\n        color: transparent;\n    }\n</style>\n<div class=\"kongxinzi2\" title=\"BARCITO\"><span>BARCITO</span></div>","source":"demos/空心字2.html","raw":"---\nlayout: false\n---\n<style>\n    .kongxinzi2 span {\n        position: absolute;\n        color: transparent;\n        background-image: repeating-linear-gradient(to bottom, #f00 0%, #000 100%);\n\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n    }\n    .kongxinzi2:after, .kongxinzi2 span {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: monospace;\n    }\n    .kongxinzi2:after {\n        content: attr(title);\n        text-shadow: 0px 0px 1px #1e1414;\n        color: transparent;\n    }\n</style>\n<div class=\"kongxinzi2\" title=\"BARCITO\"><span>BARCITO</span></div>","date":"2016-06-09T03:36:54.000Z","updated":"2016-06-09T03:36:54.000Z","path":"demos/空心字2.html","title":"","comments":1,"_id":"ciwqiy02m000x0407wn43pvza","content":"<style>\n    .kongxinzi2 span {\n        position: absolute;\n        color: transparent;\n        background-image: repeating-linear-gradient(to bottom, #f00 0%, #000 100%);\n\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n    }\n    .kongxinzi2:after, .kongxinzi2 span {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: monospace;\n    }\n    .kongxinzi2:after {\n        content: attr(title);\n        text-shadow: 0px 0px 1px #1e1414;\n        color: transparent;\n    }\n</style>\n<div class=\"kongxinzi2\" title=\"BARCITO\"><span>BARCITO</span></div>","excerpt":"","more":"<style>\n    .kongxinzi2 span {\n        position: absolute;\n        color: transparent;\n        background-image: repeating-linear-gradient(to bottom, #f00 0%, #000 100%);\n\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n    }\n    .kongxinzi2:after, .kongxinzi2 span {\n        font-size: 5em;\n        font-weight: bold;\n        font-family: monospace;\n    }\n    .kongxinzi2:after {\n        content: attr(title);\n        text-shadow: 0px 0px 1px #1e1414;\n        color: transparent;\n    }\n</style>\n<div class=\"kongxinzi2\" title=\"BARCITO\"><span>BARCITO</span></div>"},{"layout":"false","_content":"<style>\n.form1 .form-row::after {\n    content: ' ';\n    display: block;\n    width: 0;\n    height: 0;\n    clear: both;\n}\n.form1 .form-key,\n.form1 .form-value {\n    float: left;\n    height: 30px;\n    line-height: 30px;\n    padding: 4px 0;\n}\n.form1 .form-key {\n    width: 80px;\n    text-align: right;\n    padding-right: 10px;\n}\n.form1 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form1 .form-operations {\n    padding-left: 90px;\n}\n</style>\n\n<div class=\"form1\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","source":"demos/2016-12-15/form1.html","raw":"---\nlayout: false\n---\n<style>\n.form1 .form-row::after {\n    content: ' ';\n    display: block;\n    width: 0;\n    height: 0;\n    clear: both;\n}\n.form1 .form-key,\n.form1 .form-value {\n    float: left;\n    height: 30px;\n    line-height: 30px;\n    padding: 4px 0;\n}\n.form1 .form-key {\n    width: 80px;\n    text-align: right;\n    padding-right: 10px;\n}\n.form1 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form1 .form-operations {\n    padding-left: 90px;\n}\n</style>\n\n<div class=\"form1\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","date":"2016-12-15T15:17:51.000Z","updated":"2016-12-15T15:17:51.000Z","path":"demos/2016-12-15/form1.html","title":"","comments":1,"_id":"ciwqiy03t002e0407hrws3uqv","content":"<style>\n.form1 .form-row::after {\n    content: ' ';\n    display: block;\n    width: 0;\n    height: 0;\n    clear: both;\n}\n.form1 .form-key,\n.form1 .form-value {\n    float: left;\n    height: 30px;\n    line-height: 30px;\n    padding: 4px 0;\n}\n.form1 .form-key {\n    width: 80px;\n    text-align: right;\n    padding-right: 10px;\n}\n.form1 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form1 .form-operations {\n    padding-left: 90px;\n}\n</style>\n\n<div class=\"form1\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","excerpt":"","more":"<style>\n.form1 .form-row::after {\n    content: ' ';\n    display: block;\n    width: 0;\n    height: 0;\n    clear: both;\n}\n.form1 .form-key,\n.form1 .form-value {\n    float: left;\n    height: 30px;\n    line-height: 30px;\n    padding: 4px 0;\n}\n.form1 .form-key {\n    width: 80px;\n    text-align: right;\n    padding-right: 10px;\n}\n.form1 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form1 .form-operations {\n    padding-left: 90px;\n}\n</style>\n\n<div class=\"form1\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n"},{"layout":"false","_content":"<style>\n.form2 .form {\n    display: table;\n}\n.form2 .form-row,\n.form2 .form-operations {\n    display: table-row;\n}\n.form2 .form-key,\n.form2 .form-value {\n    display: table-cell;\n    padding: 4px 0;\n}\n.form2 .form-key {\n    text-align: right;\n    padding-right: 10px;\n}\n.form2 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form2 .form-operations::before {\n    content: '';\n    display: table-cell;\n}\n</style>\n\n<div class=\"form2\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","source":"demos/2016-12-15/form2.html","raw":"---\nlayout: false\n---\n<style>\n.form2 .form {\n    display: table;\n}\n.form2 .form-row,\n.form2 .form-operations {\n    display: table-row;\n}\n.form2 .form-key,\n.form2 .form-value {\n    display: table-cell;\n    padding: 4px 0;\n}\n.form2 .form-key {\n    text-align: right;\n    padding-right: 10px;\n}\n.form2 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form2 .form-operations::before {\n    content: '';\n    display: table-cell;\n}\n</style>\n\n<div class=\"form2\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","date":"2016-12-15T15:20:22.000Z","updated":"2016-12-15T15:20:22.000Z","path":"demos/2016-12-15/form2.html","title":"","comments":1,"_id":"ciwqiy03t002f04073j95jk1x","content":"<style>\n.form2 .form {\n    display: table;\n}\n.form2 .form-row,\n.form2 .form-operations {\n    display: table-row;\n}\n.form2 .form-key,\n.form2 .form-value {\n    display: table-cell;\n    padding: 4px 0;\n}\n.form2 .form-key {\n    text-align: right;\n    padding-right: 10px;\n}\n.form2 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form2 .form-operations::before {\n    content: '';\n    display: table-cell;\n}\n</style>\n\n<div class=\"form2\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n","excerpt":"","more":"<style>\n.form2 .form {\n    display: table;\n}\n.form2 .form-row,\n.form2 .form-operations {\n    display: table-row;\n}\n.form2 .form-key,\n.form2 .form-value {\n    display: table-cell;\n    padding: 4px 0;\n}\n.form2 .form-key {\n    text-align: right;\n    padding-right: 10px;\n}\n.form2 .form-value input {\n    box-sizing: border-box;\n    height: 30px;\n}\n.form2 .form-operations::before {\n    content: '';\n    display: table-cell;\n}\n</style>\n\n<div class=\"form2\">\n    <div class=\"form\">\n        <div class=\"form-row\">\n            <div class=\"form-key\">用户名</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">手机号</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">验证码</div>\n            <div class=\"form-value\"><input type=\"text\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\">密码</div>\n            <div class=\"form-value\"><input type=\"password\"></div>\n        </div>\n        <div class=\"form-row\">\n            <div class=\"form-key\"></div>\n            <div class=\"form-value\">阅读并接受《百度用户协议》</div>\n        </div>\n        <div class=\"form-operations\">\n            <button type=\"button\">注册</button>\n        </div>\n    </div>\n</div>\n"}],"Post":[{"title":"CSS border-image","date":"2015-08-26T16:00:00.000Z","_content":"\n{% iframe ../demos/border-image.html 100% 336 %}\n\n上面示例的 css 代码为：\n<!-- more -->\n\n```css\n.demo1 {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(../images/8.jpg) 60 70 round stretch;\n}\n```\n\nCSS 中的 border-image 可以给边框设置图片背景，其参数主要分为三部分：\n\n* 1、图片来源。即示例中的 `url(../images/8.jpg)` ；\n* 2、图片裁剪尺寸。即示例中的 `60 70`。裁剪尺寸遵循 `top-right-bottom-left` 规则，其数值可以是百分数，也可以是像素值。如果是像素值，则不能带单位，直接写数值就好了，示例中`60 70`的含义为：对图片实施裁剪，图片上部和下部分别裁掉60px，左部和右部分别裁掉70px，于是图片就形成9块，四个边角块是无法运用round（平铺）等效果的，中间那一块是没用的。如果为百分数，则是根据图片的尺寸来计算出相应的像素值的；\n* 3、图片可运用效果区域的展示效果。取值为 [round|repeat|stretch] 。正如2中所述，图片会被裁剪成9块，而这个展示效果只能运用于上、右、下、左的中间那一块。\n\n`-webkit-border-image` 是有 bug 的，它会用裁剪后的9块图片的中间那一张覆盖掉背景。如下所示：\n\n{% iframe ../demos/-webkit-border-image.html 100% 336 %}\n","source":"_posts/CSS border-image.md","raw":"---\ntitle: CSS border-image\ndate: 2015-08-27\ntags:\n- CSS\n---\n\n{% iframe ../demos/border-image.html 100% 336 %}\n\n上面示例的 css 代码为：\n<!-- more -->\n\n```css\n.demo1 {\n    display: inline-block;\n    width: 400px;\n    height: 200px;\n\n    border-width: 60px 70px;\n    border-image: url(../images/8.jpg) 60 70 round stretch;\n}\n```\n\nCSS 中的 border-image 可以给边框设置图片背景，其参数主要分为三部分：\n\n* 1、图片来源。即示例中的 `url(../images/8.jpg)` ；\n* 2、图片裁剪尺寸。即示例中的 `60 70`。裁剪尺寸遵循 `top-right-bottom-left` 规则，其数值可以是百分数，也可以是像素值。如果是像素值，则不能带单位，直接写数值就好了，示例中`60 70`的含义为：对图片实施裁剪，图片上部和下部分别裁掉60px，左部和右部分别裁掉70px，于是图片就形成9块，四个边角块是无法运用round（平铺）等效果的，中间那一块是没用的。如果为百分数，则是根据图片的尺寸来计算出相应的像素值的；\n* 3、图片可运用效果区域的展示效果。取值为 [round|repeat|stretch] 。正如2中所述，图片会被裁剪成9块，而这个展示效果只能运用于上、右、下、左的中间那一块。\n\n`-webkit-border-image` 是有 bug 的，它会用裁剪后的9块图片的中间那一张覆盖掉背景。如下所示：\n\n{% iframe ../demos/-webkit-border-image.html 100% 336 %}\n","slug":"CSS border-image","published":1,"updated":"2016-06-15T10:44:42.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy01l00000407rl6tpj11","content":"<iframe src=\"../demos/border-image.html\" width=\"100%\" height=\"336\" frameborder=\"0\" allowfullscreen></iframe>\n<p>上面示例的 css 代码为：<br><a id=\"more\"></a></p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-class\">.demo1</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">display</span>: inline-block;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">400px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">200px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">border-width</span>: <span class=\"number\">60px</span> <span class=\"number\">70px</span>;</div><div class=\"line\">    <span class=\"attribute\">border-image</span>: <span class=\"built_in\">url</span>(../images/8.jpg) <span class=\"number\">60</span> <span class=\"number\">70</span> round stretch;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>CSS 中的 border-image 可以给边框设置图片背景，其参数主要分为三部分：</p>\n<ul>\n<li>1、图片来源。即示例中的 <code>url(../images/8.jpg)</code> ；</li>\n<li>2、图片裁剪尺寸。即示例中的 <code>60 70</code>。裁剪尺寸遵循 <code>top-right-bottom-left</code> 规则，其数值可以是百分数，也可以是像素值。如果是像素值，则不能带单位，直接写数值就好了，示例中<code>60 70</code>的含义为：对图片实施裁剪，图片上部和下部分别裁掉60px，左部和右部分别裁掉70px，于是图片就形成9块，四个边角块是无法运用round（平铺）等效果的，中间那一块是没用的。如果为百分数，则是根据图片的尺寸来计算出相应的像素值的；</li>\n<li>3、图片可运用效果区域的展示效果。取值为 [round|repeat|stretch] 。正如2中所述，图片会被裁剪成9块，而这个展示效果只能运用于上、右、下、左的中间那一块。</li>\n</ul>\n<p><code>-webkit-border-image</code> 是有 bug 的，它会用裁剪后的9块图片的中间那一张覆盖掉背景。如下所示：</p>\n<iframe src=\"../demos/-webkit-border-image.html\" width=\"100%\" height=\"336\" frameborder=\"0\" allowfullscreen></iframe>\n","excerpt":"<iframe src=\"../demos/border-image.html\" width=\"100%\" height=\"336\" frameborder=\"0\" allowfullscreen></iframe>\n<p>上面示例的 css 代码为：<br>","more":"</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-class\">.demo1</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">display</span>: inline-block;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">400px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">200px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">border-width</span>: <span class=\"number\">60px</span> <span class=\"number\">70px</span>;</div><div class=\"line\">    <span class=\"attribute\">border-image</span>: <span class=\"built_in\">url</span>(../images/8.jpg) <span class=\"number\">60</span> <span class=\"number\">70</span> round stretch;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>CSS 中的 border-image 可以给边框设置图片背景，其参数主要分为三部分：</p>\n<ul>\n<li>1、图片来源。即示例中的 <code>url(../images/8.jpg)</code> ；</li>\n<li>2、图片裁剪尺寸。即示例中的 <code>60 70</code>。裁剪尺寸遵循 <code>top-right-bottom-left</code> 规则，其数值可以是百分数，也可以是像素值。如果是像素值，则不能带单位，直接写数值就好了，示例中<code>60 70</code>的含义为：对图片实施裁剪，图片上部和下部分别裁掉60px，左部和右部分别裁掉70px，于是图片就形成9块，四个边角块是无法运用round（平铺）等效果的，中间那一块是没用的。如果为百分数，则是根据图片的尺寸来计算出相应的像素值的；</li>\n<li>3、图片可运用效果区域的展示效果。取值为 [round|repeat|stretch] 。正如2中所述，图片会被裁剪成9块，而这个展示效果只能运用于上、右、下、左的中间那一块。</li>\n</ul>\n<p><code>-webkit-border-image</code> 是有 bug 的，它会用裁剪后的9块图片的中间那一张覆盖掉背景。如下所示：</p>\n<iframe src=\"../demos/-webkit-border-image.html\" width=\"100%\" height=\"336\" frameborder=\"0\" allowfullscreen></iframe>"},{"title":"CSS border-radius","date":"2015-08-26T16:00:00.000Z","_content":"\n`border-radius` 的取值：\n<!-- more -->\n\n> [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} [ / [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} ]?\n\n{% iframe ../demos/border-radius.html 100% 116 %}\n\n上述示例的 CSS 代码为：\n\nborder-radius 是可以通过`/`的形式来对某一个角设置一个椭圆弧的。\n\n比如示例中的 `20px/5px` 的含义是：对于左上角的圆弧，圆心到上边框的距离是5px，到左边框的距离是20px；对于右上角的圆弧，圆心到上边框的距离是5px，到右边框的距离是20px；对于右下角的圆弧，圆心到下边框的距离是5px，到右边框的距离是20px；对于左下角的圆弧，圆心到下边框的距离是5px，到左边框的距离是20px。\n\n如果 border-radius 的半径小于或等于元素的边框厚度时，边框内角就会变成直角效果。\n\n对 img 元素运用 border-radius ， webkit 内核不能使图片边角出现圆角的效果，可以使用背景图片的方式来修正这个问题。\n\n当表格样式属性 border-collapse 是 collapse 时，对表格使用 border-radius 圆角效果，表格将不会展现出圆角效果，只有 border-collapse 为 separate 的时候，圆角才能正常展示。\n\nborder-radius 可以做的效果：圆形、半圆、扇形、椭圆。\n\n{% iframe ../demos/half%20ellipse.html 100% 116 %}\n","source":"_posts/CSS border-radius.md","raw":"---\ntitle: CSS border-radius\ndate: 2015-08-27\ntags:\n- CSS\n---\n\n`border-radius` 的取值：\n<!-- more -->\n\n> [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} [ / [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} ]?\n\n{% iframe ../demos/border-radius.html 100% 116 %}\n\n上述示例的 CSS 代码为：\n\nborder-radius 是可以通过`/`的形式来对某一个角设置一个椭圆弧的。\n\n比如示例中的 `20px/5px` 的含义是：对于左上角的圆弧，圆心到上边框的距离是5px，到左边框的距离是20px；对于右上角的圆弧，圆心到上边框的距离是5px，到右边框的距离是20px；对于右下角的圆弧，圆心到下边框的距离是5px，到右边框的距离是20px；对于左下角的圆弧，圆心到下边框的距离是5px，到左边框的距离是20px。\n\n如果 border-radius 的半径小于或等于元素的边框厚度时，边框内角就会变成直角效果。\n\n对 img 元素运用 border-radius ， webkit 内核不能使图片边角出现圆角的效果，可以使用背景图片的方式来修正这个问题。\n\n当表格样式属性 border-collapse 是 collapse 时，对表格使用 border-radius 圆角效果，表格将不会展现出圆角效果，只有 border-collapse 为 separate 的时候，圆角才能正常展示。\n\nborder-radius 可以做的效果：圆形、半圆、扇形、椭圆。\n\n{% iframe ../demos/half%20ellipse.html 100% 116 %}\n","slug":"CSS border-radius","published":1,"updated":"2016-06-15T10:44:50.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy01r00020407cuv7lk8e","content":"<p><code>border-radius</code> 的取值：<br><a id=\"more\"></a></p>\n<blockquote>\n<p>[ &lt;length&gt; | &lt;percentage&gt; ]{1,4} [ / [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} ]?</p>\n</blockquote>\n<iframe src=\"../demos/border-radius.html\" width=\"100%\" height=\"116\" frameborder=\"0\" allowfullscreen></iframe>\n<p>上述示例的 CSS 代码为：</p>\n<p>border-radius 是可以通过<code>/</code>的形式来对某一个角设置一个椭圆弧的。</p>\n<p>比如示例中的 <code>20px/5px</code> 的含义是：对于左上角的圆弧，圆心到上边框的距离是5px，到左边框的距离是20px；对于右上角的圆弧，圆心到上边框的距离是5px，到右边框的距离是20px；对于右下角的圆弧，圆心到下边框的距离是5px，到右边框的距离是20px；对于左下角的圆弧，圆心到下边框的距离是5px，到左边框的距离是20px。</p>\n<p>如果 border-radius 的半径小于或等于元素的边框厚度时，边框内角就会变成直角效果。</p>\n<p>对 img 元素运用 border-radius ， webkit 内核不能使图片边角出现圆角的效果，可以使用背景图片的方式来修正这个问题。</p>\n<p>当表格样式属性 border-collapse 是 collapse 时，对表格使用 border-radius 圆角效果，表格将不会展现出圆角效果，只有 border-collapse 为 separate 的时候，圆角才能正常展示。</p>\n<p>border-radius 可以做的效果：圆形、半圆、扇形、椭圆。</p>\n<iframe src=\"../demos/half%20ellipse.html\" width=\"100%\" height=\"116\" frameborder=\"0\" allowfullscreen></iframe>\n","excerpt":"<p><code>border-radius</code> 的取值：<br>","more":"</p>\n<blockquote>\n<p>[ &lt;length&gt; | &lt;percentage&gt; ]{1,4} [ / [ &lt;length&gt; | &lt;percentage&gt; ]{1,4} ]?</p>\n</blockquote>\n<iframe src=\"../demos/border-radius.html\" width=\"100%\" height=\"116\" frameborder=\"0\" allowfullscreen></iframe>\n<p>上述示例的 CSS 代码为：</p>\n<p>border-radius 是可以通过<code>/</code>的形式来对某一个角设置一个椭圆弧的。</p>\n<p>比如示例中的 <code>20px/5px</code> 的含义是：对于左上角的圆弧，圆心到上边框的距离是5px，到左边框的距离是20px；对于右上角的圆弧，圆心到上边框的距离是5px，到右边框的距离是20px；对于右下角的圆弧，圆心到下边框的距离是5px，到右边框的距离是20px；对于左下角的圆弧，圆心到下边框的距离是5px，到左边框的距离是20px。</p>\n<p>如果 border-radius 的半径小于或等于元素的边框厚度时，边框内角就会变成直角效果。</p>\n<p>对 img 元素运用 border-radius ， webkit 内核不能使图片边角出现圆角的效果，可以使用背景图片的方式来修正这个问题。</p>\n<p>当表格样式属性 border-collapse 是 collapse 时，对表格使用 border-radius 圆角效果，表格将不会展现出圆角效果，只有 border-collapse 为 separate 的时候，圆角才能正常展示。</p>\n<p>border-radius 可以做的效果：圆形、半圆、扇形、椭圆。</p>\n<iframe src=\"../demos/half%20ellipse.html\" width=\"100%\" height=\"116\" frameborder=\"0\" allowfullscreen></iframe>"},{"title":"CSS 变形","date":"2015-08-31T16:00:00.000Z","_content":"\n## 2D\n\n2D 常用的变形函数： tranlate() 、 scale() 、 rotate() 、 skew() 、 matrix() 。\n<!-- more -->\n\n### skew() 函数\n\n示例：\n\n{% iframe ../demos/css%20skew.html 100% 320 %}\n\n下图描述了`skew(30deg, 10deg)`的工作原理：\n\n![](../images/10.jpg)\n\n> **注：**上图来自 [http://dtop.powereasy.net/Item/3715.aspx](http://dtop.powereasy.net/Item/3715.aspx) 。\n\n### transform-origin\n\ntransform-origin 用来指定元素变形的中心点位置，默认就是元素的中心点。\n\n但是，对于位移 translate() 函数来说，无论 transform-origin 如何改变，都是以元素中心点为基准进行位移，例如：\n\n{% iframe ../demos/transform-origin.html 100% 440 %}\n\n`示例1`和`示例2`中的虚线框是元素的原始位置，实线框是位移之后的位置。`示例1`的 transform-origin 是`50% 50%`，而`示例2`是`100% 100%`，但是从最终偏移效果来看，两者的结果是一样的，所以 tranform-origin 对 translate() 函数并没有影响。\n\n## 3D\n\n3D 常用变形函数： translate3d() 、 translate() 、 scale3d() 、 scaleZ() 、 rotate3d() 、 rotateX() 、 rotateY() 、 rotateZ() 、 perspective() 、 matrix3d() 。\n\n### transform-style\n\ntransform-style 的取值为 `flat` 或者 `preserve-3d` 。下面的例子展示了两者的差别：\n\n{% iframe ../demos/transform-style.html 100% 416 %}\n\n从示例中可以看出， `preserve-3d` 会让子元素在父元素变形的基础上继续变形，而 `flat` 则会消除父元素变形对子元素变形带来的影响。\n\n__理解：__\n\n对于第一种 `div.container1` 元素的 transform-style 为 `flat` 的情形，表明其所有子元素在 2D 空间中呈现，于是相对于 2D 平面（就可以理解为显示器的那个平面）做变形；对于第二种 `div.container1` 元素的 transform-style 为 `preserve-3d` 的情形，表明其所有子元素在 3D 空间中呈现，于是相对于当前 `div.container1` 为基准的平面做变形。\n","source":"_posts/CSS 变形.md","raw":"---\ntitle: CSS 变形\ndate: 2015-09-01\ntags:\n- CSS\n---\n\n## 2D\n\n2D 常用的变形函数： tranlate() 、 scale() 、 rotate() 、 skew() 、 matrix() 。\n<!-- more -->\n\n### skew() 函数\n\n示例：\n\n{% iframe ../demos/css%20skew.html 100% 320 %}\n\n下图描述了`skew(30deg, 10deg)`的工作原理：\n\n![](../images/10.jpg)\n\n> **注：**上图来自 [http://dtop.powereasy.net/Item/3715.aspx](http://dtop.powereasy.net/Item/3715.aspx) 。\n\n### transform-origin\n\ntransform-origin 用来指定元素变形的中心点位置，默认就是元素的中心点。\n\n但是，对于位移 translate() 函数来说，无论 transform-origin 如何改变，都是以元素中心点为基准进行位移，例如：\n\n{% iframe ../demos/transform-origin.html 100% 440 %}\n\n`示例1`和`示例2`中的虚线框是元素的原始位置，实线框是位移之后的位置。`示例1`的 transform-origin 是`50% 50%`，而`示例2`是`100% 100%`，但是从最终偏移效果来看，两者的结果是一样的，所以 tranform-origin 对 translate() 函数并没有影响。\n\n## 3D\n\n3D 常用变形函数： translate3d() 、 translate() 、 scale3d() 、 scaleZ() 、 rotate3d() 、 rotateX() 、 rotateY() 、 rotateZ() 、 perspective() 、 matrix3d() 。\n\n### transform-style\n\ntransform-style 的取值为 `flat` 或者 `preserve-3d` 。下面的例子展示了两者的差别：\n\n{% iframe ../demos/transform-style.html 100% 416 %}\n\n从示例中可以看出， `preserve-3d` 会让子元素在父元素变形的基础上继续变形，而 `flat` 则会消除父元素变形对子元素变形带来的影响。\n\n__理解：__\n\n对于第一种 `div.container1` 元素的 transform-style 为 `flat` 的情形，表明其所有子元素在 2D 空间中呈现，于是相对于 2D 平面（就可以理解为显示器的那个平面）做变形；对于第二种 `div.container1` 元素的 transform-style 为 `preserve-3d` 的情形，表明其所有子元素在 3D 空间中呈现，于是相对于当前 `div.container1` 为基准的平面做变形。\n","slug":"CSS 变形","published":1,"updated":"2016-06-15T10:44:56.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy01x0005040755fbsejx","content":"<h2 id=\"2D\"><a href=\"#2D\" class=\"headerlink\" title=\"2D\"></a>2D</h2><p>2D 常用的变形函数： tranlate() 、 scale() 、 rotate() 、 skew() 、 matrix() 。<br><a id=\"more\"></a></p>\n<h3 id=\"skew-函数\"><a href=\"#skew-函数\" class=\"headerlink\" title=\"skew() 函数\"></a>skew() 函数</h3><p>示例：</p>\n<iframe src=\"../demos/css%20skew.html\" width=\"100%\" height=\"320\" frameborder=\"0\" allowfullscreen></iframe>\n<p>下图描述了<code>skew(30deg, 10deg)</code>的工作原理：</p>\n<p><img src=\"../images/10.jpg\" alt=\"\"></p>\n<blockquote>\n<p><strong>注：</strong>上图来自 <a href=\"http://dtop.powereasy.net/Item/3715.aspx\" target=\"_blank\" rel=\"external\">http://dtop.powereasy.net/Item/3715.aspx</a> 。</p>\n</blockquote>\n<h3 id=\"transform-origin\"><a href=\"#transform-origin\" class=\"headerlink\" title=\"transform-origin\"></a>transform-origin</h3><p>transform-origin 用来指定元素变形的中心点位置，默认就是元素的中心点。</p>\n<p>但是，对于位移 translate() 函数来说，无论 transform-origin 如何改变，都是以元素中心点为基准进行位移，例如：</p>\n<iframe src=\"../demos/transform-origin.html\" width=\"100%\" height=\"440\" frameborder=\"0\" allowfullscreen></iframe>\n<p><code>示例1</code>和<code>示例2</code>中的虚线框是元素的原始位置，实线框是位移之后的位置。<code>示例1</code>的 transform-origin 是<code>50% 50%</code>，而<code>示例2</code>是<code>100% 100%</code>，但是从最终偏移效果来看，两者的结果是一样的，所以 tranform-origin 对 translate() 函数并没有影响。</p>\n<h2 id=\"3D\"><a href=\"#3D\" class=\"headerlink\" title=\"3D\"></a>3D</h2><p>3D 常用变形函数： translate3d() 、 translate() 、 scale3d() 、 scaleZ() 、 rotate3d() 、 rotateX() 、 rotateY() 、 rotateZ() 、 perspective() 、 matrix3d() 。</p>\n<h3 id=\"transform-style\"><a href=\"#transform-style\" class=\"headerlink\" title=\"transform-style\"></a>transform-style</h3><p>transform-style 的取值为 <code>flat</code> 或者 <code>preserve-3d</code> 。下面的例子展示了两者的差别：</p>\n<iframe src=\"../demos/transform-style.html\" width=\"100%\" height=\"416\" frameborder=\"0\" allowfullscreen></iframe>\n<p>从示例中可以看出， <code>preserve-3d</code> 会让子元素在父元素变形的基础上继续变形，而 <code>flat</code> 则会消除父元素变形对子元素变形带来的影响。</p>\n<p><strong>理解：</strong></p>\n<p>对于第一种 <code>div.container1</code> 元素的 transform-style 为 <code>flat</code> 的情形，表明其所有子元素在 2D 空间中呈现，于是相对于 2D 平面（就可以理解为显示器的那个平面）做变形；对于第二种 <code>div.container1</code> 元素的 transform-style 为 <code>preserve-3d</code> 的情形，表明其所有子元素在 3D 空间中呈现，于是相对于当前 <code>div.container1</code> 为基准的平面做变形。</p>\n","excerpt":"<h2 id=\"2D\"><a href=\"#2D\" class=\"headerlink\" title=\"2D\"></a>2D</h2><p>2D 常用的变形函数： tranlate() 、 scale() 、 rotate() 、 skew() 、 matrix() 。<br>","more":"</p>\n<h3 id=\"skew-函数\"><a href=\"#skew-函数\" class=\"headerlink\" title=\"skew() 函数\"></a>skew() 函数</h3><p>示例：</p>\n<iframe src=\"../demos/css%20skew.html\" width=\"100%\" height=\"320\" frameborder=\"0\" allowfullscreen></iframe>\n<p>下图描述了<code>skew(30deg, 10deg)</code>的工作原理：</p>\n<p><img src=\"../images/10.jpg\" alt=\"\"></p>\n<blockquote>\n<p><strong>注：</strong>上图来自 <a href=\"http://dtop.powereasy.net/Item/3715.aspx\">http://dtop.powereasy.net/Item/3715.aspx</a> 。</p>\n</blockquote>\n<h3 id=\"transform-origin\"><a href=\"#transform-origin\" class=\"headerlink\" title=\"transform-origin\"></a>transform-origin</h3><p>transform-origin 用来指定元素变形的中心点位置，默认就是元素的中心点。</p>\n<p>但是，对于位移 translate() 函数来说，无论 transform-origin 如何改变，都是以元素中心点为基准进行位移，例如：</p>\n<iframe src=\"../demos/transform-origin.html\" width=\"100%\" height=\"440\" frameborder=\"0\" allowfullscreen></iframe>\n<p><code>示例1</code>和<code>示例2</code>中的虚线框是元素的原始位置，实线框是位移之后的位置。<code>示例1</code>的 transform-origin 是<code>50% 50%</code>，而<code>示例2</code>是<code>100% 100%</code>，但是从最终偏移效果来看，两者的结果是一样的，所以 tranform-origin 对 translate() 函数并没有影响。</p>\n<h2 id=\"3D\"><a href=\"#3D\" class=\"headerlink\" title=\"3D\"></a>3D</h2><p>3D 常用变形函数： translate3d() 、 translate() 、 scale3d() 、 scaleZ() 、 rotate3d() 、 rotateX() 、 rotateY() 、 rotateZ() 、 perspective() 、 matrix3d() 。</p>\n<h3 id=\"transform-style\"><a href=\"#transform-style\" class=\"headerlink\" title=\"transform-style\"></a>transform-style</h3><p>transform-style 的取值为 <code>flat</code> 或者 <code>preserve-3d</code> 。下面的例子展示了两者的差别：</p>\n<iframe src=\"../demos/transform-style.html\" width=\"100%\" height=\"416\" frameborder=\"0\" allowfullscreen></iframe>\n<p>从示例中可以看出， <code>preserve-3d</code> 会让子元素在父元素变形的基础上继续变形，而 <code>flat</code> 则会消除父元素变形对子元素变形带来的影响。</p>\n<p><strong>理解：</strong></p>\n<p>对于第一种 <code>div.container1</code> 元素的 transform-style 为 <code>flat</code> 的情形，表明其所有子元素在 2D 空间中呈现，于是相对于 2D 平面（就可以理解为显示器的那个平面）做变形；对于第二种 <code>div.container1</code> 元素的 transform-style 为 <code>preserve-3d</code> 的情形，表明其所有子元素在 3D 空间中呈现，于是相对于当前 <code>div.container1</code> 为基准的平面做变形。</p>"},{"title":"CSS 空心字","date":"2015-09-01T16:00:00.000Z","_content":"\n空心字。\n<!-- more -->\n\n### 闪烁的空心字\n\n{% iframe ../demos/空心字1.html 100% 96 %}\n\n### 带背景渐变的空心字\n\n{% iframe ../demos/空心字2.html 100% 91 %}\n\ntext-shadow 是绘制在 background 之上的，如果想要文字同时能应用 text-shadow 和 background-image ，那么就必须使用一定的技巧了，不然就会造成 text-shadow 的颜色遮住 background 的颜色。\n","source":"_posts/CSS 空心字.md","raw":"---\ntitle: CSS 空心字\ndate: 2015-09-02\ntags:\n- CSS\n---\n\n空心字。\n<!-- more -->\n\n### 闪烁的空心字\n\n{% iframe ../demos/空心字1.html 100% 96 %}\n\n### 带背景渐变的空心字\n\n{% iframe ../demos/空心字2.html 100% 91 %}\n\ntext-shadow 是绘制在 background 之上的，如果想要文字同时能应用 text-shadow 和 background-image ，那么就必须使用一定的技巧了，不然就会造成 text-shadow 的颜色遮住 background 的颜色。\n","slug":"CSS 空心字","published":1,"updated":"2016-06-15T10:45:03.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02100070407f5w3fvq6","content":"<p>空心字。<br><a id=\"more\"></a></p>\n<h3 id=\"闪烁的空心字\"><a href=\"#闪烁的空心字\" class=\"headerlink\" title=\"闪烁的空心字\"></a>闪烁的空心字</h3><iframe src=\"../demos/空心字1.html\" width=\"100%\" height=\"96\" frameborder=\"0\" allowfullscreen></iframe>\n<h3 id=\"带背景渐变的空心字\"><a href=\"#带背景渐变的空心字\" class=\"headerlink\" title=\"带背景渐变的空心字\"></a>带背景渐变的空心字</h3><iframe src=\"../demos/空心字2.html\" width=\"100%\" height=\"91\" frameborder=\"0\" allowfullscreen></iframe>\n<p>text-shadow 是绘制在 background 之上的，如果想要文字同时能应用 text-shadow 和 background-image ，那么就必须使用一定的技巧了，不然就会造成 text-shadow 的颜色遮住 background 的颜色。</p>\n","excerpt":"<p>空心字。<br>","more":"</p>\n<h3 id=\"闪烁的空心字\"><a href=\"#闪烁的空心字\" class=\"headerlink\" title=\"闪烁的空心字\"></a>闪烁的空心字</h3><iframe src=\"../demos/空心字1.html\" width=\"100%\" height=\"96\" frameborder=\"0\" allowfullscreen></iframe>\n<h3 id=\"带背景渐变的空心字\"><a href=\"#带背景渐变的空心字\" class=\"headerlink\" title=\"带背景渐变的空心字\"></a>带背景渐变的空心字</h3><iframe src=\"../demos/空心字2.html\" width=\"100%\" height=\"91\" frameborder=\"0\" allowfullscreen></iframe>\n<p>text-shadow 是绘制在 background 之上的，如果想要文字同时能应用 text-shadow 和 background-image ，那么就必须使用一定的技巧了，不然就会造成 text-shadow 的颜色遮住 background 的颜色。</p>"},{"title":"CSS 语法速查","date":"2015-09-03T11:06:00.000Z","_content":"\n<!-- more -->\n### [background](http://www.w3.org/TR/css3-background/)\n\n```\n[ <bg-layer> , ]* <final-bg-layer>\n\n    <bg-layer> = <bg-image> || <position> [ / <bg-size> ]? || <repeat-style> || <attachment> || <box> || <box>\n    <final-bg-layer> = <bg-image> || <position> [ / <bg-size> ]? || <repeat-style> || <attachment> || <box> || <box> || <'background-color'>\n\n        <bg-image> = <image> | none\n```\n\n[&lt;image&gt;](http://www.w3.org/TR/css3-background/#ltimagegt)\n[&lt;position&gt;](http://www.w3.org/TR/css3-background/#ltpositiongt)\n[&lt;bg-size&gt;](http://www.w3.org/TR/css3-background/#ltbg-sizegt)\n[&lt;repeat-style&gt;](http://www.w3.org/TR/css3-background/#ltrepeat-stylegt)\n[&lt;attachment&gt;](http://www.w3.org/TR/css3-background/#ltattachmentgt)\n[&lt;box&gt;](http://www.w3.org/TR/css3-background/#ltboxgt)\n\n### [radial-gradient()](http://www.w3.org/TR/2012/CR-css3-images-20120417/#radial-gradients)\n\n```\n<radial-gradient> = radial-gradient(\n  [ [ <shape> || <size> ] [ at <position> ]? , |\n    at <position>,\n  ]?\n  <color-stop> [ , <color-stop> ]+\n)\n\n    <shape> = circle || ellipse\n```\n","source":"_posts/CSS 语法速查.md","raw":"---\ntitle: CSS 语法速查\ndate: 2015-09-03 19:06\ntags:\n- CSS\n---\n\n<!-- more -->\n### [background](http://www.w3.org/TR/css3-background/)\n\n```\n[ <bg-layer> , ]* <final-bg-layer>\n\n    <bg-layer> = <bg-image> || <position> [ / <bg-size> ]? || <repeat-style> || <attachment> || <box> || <box>\n    <final-bg-layer> = <bg-image> || <position> [ / <bg-size> ]? || <repeat-style> || <attachment> || <box> || <box> || <'background-color'>\n\n        <bg-image> = <image> | none\n```\n\n[&lt;image&gt;](http://www.w3.org/TR/css3-background/#ltimagegt)\n[&lt;position&gt;](http://www.w3.org/TR/css3-background/#ltpositiongt)\n[&lt;bg-size&gt;](http://www.w3.org/TR/css3-background/#ltbg-sizegt)\n[&lt;repeat-style&gt;](http://www.w3.org/TR/css3-background/#ltrepeat-stylegt)\n[&lt;attachment&gt;](http://www.w3.org/TR/css3-background/#ltattachmentgt)\n[&lt;box&gt;](http://www.w3.org/TR/css3-background/#ltboxgt)\n\n### [radial-gradient()](http://www.w3.org/TR/2012/CR-css3-images-20120417/#radial-gradients)\n\n```\n<radial-gradient> = radial-gradient(\n  [ [ <shape> || <size> ] [ at <position> ]? , |\n    at <position>,\n  ]?\n  <color-stop> [ , <color-stop> ]+\n)\n\n    <shape> = circle || ellipse\n```\n","slug":"CSS 语法速查","published":1,"updated":"2016-06-15T10:45:09.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy0260009040760800xol","content":"<a id=\"more\"></a>\n<h3 id=\"background\"><a href=\"#background\" class=\"headerlink\" title=\"background\"></a><a href=\"http://www.w3.org/TR/css3-background/\" target=\"_blank\" rel=\"external\">background</a></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[ &lt;bg-layer&gt; , ]* &lt;final-bg-layer&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;bg-layer&gt; = &lt;bg-image&gt; || &lt;position&gt; [ / &lt;bg-size&gt; ]? || &lt;repeat-style&gt; || &lt;attachment&gt; || &lt;box&gt; || &lt;box&gt;</div><div class=\"line\">    &lt;final-bg-layer&gt; = &lt;bg-image&gt; || &lt;position&gt; [ / &lt;bg-size&gt; ]? || &lt;repeat-style&gt; || &lt;attachment&gt; || &lt;box&gt; || &lt;box&gt; || &lt;&apos;background-color&apos;&gt;</div><div class=\"line\"></div><div class=\"line\">        &lt;bg-image&gt; = &lt;image&gt; | none</div></pre></td></tr></table></figure>\n<p><a href=\"http://www.w3.org/TR/css3-background/#ltimagegt\" target=\"_blank\" rel=\"external\">&lt;image&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltpositiongt\" target=\"_blank\" rel=\"external\">&lt;position&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltbg-sizegt\" target=\"_blank\" rel=\"external\">&lt;bg-size&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltrepeat-stylegt\" target=\"_blank\" rel=\"external\">&lt;repeat-style&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltattachmentgt\" target=\"_blank\" rel=\"external\">&lt;attachment&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltboxgt\" target=\"_blank\" rel=\"external\">&lt;box&gt;</a></p>\n<h3 id=\"radial-gradient\"><a href=\"#radial-gradient\" class=\"headerlink\" title=\"radial-gradient()\"></a><a href=\"http://www.w3.org/TR/2012/CR-css3-images-20120417/#radial-gradients\" target=\"_blank\" rel=\"external\">radial-gradient()</a></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;radial-gradient&gt; = radial-gradient(</div><div class=\"line\">  [ [ &lt;shape&gt; || &lt;size&gt; ] [ at &lt;position&gt; ]? , |</div><div class=\"line\">    at &lt;position&gt;,</div><div class=\"line\">  ]?</div><div class=\"line\">  &lt;color-stop&gt; [ , &lt;color-stop&gt; ]+</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\">    &lt;shape&gt; = circle || ellipse</div></pre></td></tr></table></figure>\n","excerpt":"","more":"<h3 id=\"background\"><a href=\"#background\" class=\"headerlink\" title=\"background\"></a><a href=\"http://www.w3.org/TR/css3-background/\">background</a></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[ &lt;bg-layer&gt; , ]* &lt;final-bg-layer&gt;</div><div class=\"line\"></div><div class=\"line\">    &lt;bg-layer&gt; = &lt;bg-image&gt; || &lt;position&gt; [ / &lt;bg-size&gt; ]? || &lt;repeat-style&gt; || &lt;attachment&gt; || &lt;box&gt; || &lt;box&gt;</div><div class=\"line\">    &lt;final-bg-layer&gt; = &lt;bg-image&gt; || &lt;position&gt; [ / &lt;bg-size&gt; ]? || &lt;repeat-style&gt; || &lt;attachment&gt; || &lt;box&gt; || &lt;box&gt; || &lt;&apos;background-color&apos;&gt;</div><div class=\"line\"></div><div class=\"line\">        &lt;bg-image&gt; = &lt;image&gt; | none</div></pre></td></tr></table></figure>\n<p><a href=\"http://www.w3.org/TR/css3-background/#ltimagegt\">&lt;image&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltpositiongt\">&lt;position&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltbg-sizegt\">&lt;bg-size&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltrepeat-stylegt\">&lt;repeat-style&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltattachmentgt\">&lt;attachment&gt;</a><br><a href=\"http://www.w3.org/TR/css3-background/#ltboxgt\">&lt;box&gt;</a></p>\n<h3 id=\"radial-gradient\"><a href=\"#radial-gradient\" class=\"headerlink\" title=\"radial-gradient()\"></a><a href=\"http://www.w3.org/TR/2012/CR-css3-images-20120417/#radial-gradients\">radial-gradient()</a></h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;radial-gradient&gt; = radial-gradient(</div><div class=\"line\">  [ [ &lt;shape&gt; || &lt;size&gt; ] [ at &lt;position&gt; ]? , |</div><div class=\"line\">    at &lt;position&gt;,</div><div class=\"line\">  ]?</div><div class=\"line\">  &lt;color-stop&gt; [ , &lt;color-stop&gt; ]+</div><div class=\"line\">)</div><div class=\"line\"></div><div class=\"line\">    &lt;shape&gt; = circle || ellipse</div></pre></td></tr></table></figure>"},{"title":"ES6 简单特性概览","date":"2015-10-18T03:43:00.000Z","_content":"\n本文内容：\n\n* 讲解了如何使用交互式的方式体验 ES6 。\n* 列举了容易被人接受的 ES6 特性，附带这些特性在 ES5 中的实现方式。\n\n<!-- more -->\n\n## 体验 ECMAScript 6\n\n有三种简单的方式可以运行 ES6 代码：\n\n* 1、 Web 浏览器：使用[在线的 Babel REPL ](http://babeljs.io/repl/)，这是一个交互式的工具，将 ES6 代码编译成 ES5 代码。采用这种方式的话就不用安装任何东西。\n* 2、命令行：使用 `babel-node` ，一个 Node.js 可执行程序的版本，认识 ES6 代码（在内部会编译成 ES5 代码）。可以通过 npm 安装。\n* 3、各种 JavaScript 引擎：查询[ kangax 的 ES6 兼容表格](https://kangax.github.io/compat-table/es6/)，可以找到本地支持 ES6 的引擎。\n\n下面将会给出更多关于选项1和2的内容。\n\n### Babel REPL\n\nBabel REPL 有四个主要部分：\n\n* 左上角部分包含 ES6 源码。\n* 左下角部分显示 ES6 代码中发现的语法错误。\n* 右上角部分包含 ES6 代码编译成的 ES5 代码。\n* 右下角部分展示通过 `console.log()` 输出的内容。\n\n![](../images/11.jpg)\n\n### babel-node\n\n`babel-node` 可执行程序可以通过 npm 安装：\n\n```\nnpm install --global babel\n```\n\n你可以像使用可执行程序 `node` 一样使用 `babel-node` 。类似于 `node` ，像这样启动一个交互式的 REPL ：\n\n```\nbabel-node\n```\n\n一旦进入该 REPL ，你就可以执行 ES6 代码了：\n\n```\n> let arr = [1, 2, 3];\n> arr.map(x => x * x)\n[ 1, 4, 9 ]\n```\n\n注意 [babel-node 目前还不支持多行输入](https://github.com/babel/babel/issues/1741)。\n\nBabel 官网有[更多关于 Babel 命令行工具的信息](http://babeljs.io/docs/usage/cli/)。\n\n本文接下来的部分描述了易于接受的 ES6 特性。\n\n## 从 var 到 let/const\n\nES6 有两种新的声明变量的方式：\n\n* `let` （大致）相当于 `var` 的一个块级范围版本。\n* `const` 类似于 `let` ，但是用于创建*常量*：值不能被改变的变量。\n\n一般情况下，你可以用 `let` 或者 `const` 替换每一个 `var` 。但是不能盲目地这么做，因为不同类型的变量作用范围可能会改变代码的运行流程。看下面的用 ES5 写的例子：\n\n```js\nvar x = 3;\nfunction func(randomize) {\n    if (randomize) {\n        var x = Math.random(); // (A) scope: whole function\n        return x;\n    }\n    return x; // accesses the x from line A\n}\nfunc(false); // undefined\n```\n\n`func()` 返回 `undefined` ，这可能会比较奇怪。如果重写一下这段代码，让其更清楚地展现出来实际上发生了什么，你就明白了：\n\n```js\nvar x = 3;\nfunction func(randomize) {\n    var x;\n    if (randomize) {\n        x = Math.random();\n        return x;\n    }\n    return x;\n}\nfunc(false); // undefined\n```\n\n如果你在最初的版本中用 `let` 替换 `var` ，将会得到不一样的结果：\n\n```js\nlet x = 3;\nfunction func(randomize) {\n    if (randomize) {\n        let x = Math.random();\n        return x;\n    }\n    return x;\n}\nfunc(false); // 3\n```\n\n因此，盲目地用 `let` 或者 `const` 替换 `var` 很危险。我的建议是：\n\n* 仅在新的代码中使用 `let`/`const` 。\n* 不动老的代码，或者小心地重构老的代码。\n\n## 从 IIFE 到块级作用域\n\n在 ES5 中，你必须使用 IIFE 来使变量保持本地化：\n\n```js\n(function () {  // open IIFE\n    var tmp = ···;\n    ···\n}());  // close IIFE\n\nconsole.log(tmp); // ReferenceError\n```\n\n在 ECMAScript 6 中，你可以简单地使用一个块和一个 `let` 声明：\n\n```js\n{  // open block\n    let tmp = ···;\n    ···\n}  // close block\n\nconsole.log(tmp); // ReferenceError\n```\n\n## 从拼接字符串到模板字面量\n\n在 ES6 中， JavaScript 终于拥有了字面量式的字符串插值和多行字符串功能。\n\n### 字符串插值\n\n在 ES5 中，通过拼接字符串片段和变量值的方式来把变量值插入到字符串中：\n\n```js\nfunction printCoord(x, y) {\n    console.log('('+x+', '+y+')');\n}\n```\n\n在 ES6 中，你可以通过模板字面量的方式实现字符串插值：\n\n```js\nfunction printCoord(x, y) {\n    console.log(`(${x}, ${y})`);\n}\n```\n\n### 多行字符串\n\n模板字面量也可以用于表示多行字符串。\n\n例如，下面是在 ES5 中表示多行文本的样子：\n\n```js\nvar HTML5_SKELETON =\n    '<!doctype html>\\n' +\n    '<html>\\n' +\n    '<head>\\n' +\n    '    <meta charset=\"UTF-8\">\\n' +\n    '    <title></title>\\n' +\n    '</head>\\n' +\n    '<body>\\n' +\n    '</body>\\n' +\n    '</html>\\n';\n```\n\n如果你通过反斜线转义换行符，代码看起来就漂亮一点了（但是仍然需要显示地添加新行）：\n\n```js\nvar HTML5_SKELETON = '\\\n    <!doctype html>\\n\\\n    <html>\\n\\\n    <head>\\n\\\n        <meta charset=\"UTF-8\">\\n\\\n        <title></title>\\n\\\n    </head>\\n\\\n    <body>\\n\\\n    </body>\\n\\\n    </html>';\n```\n\nES6 模板字面量可以跨越多行：\n\n```js\nconst HTML5_SKELETON = `\n    <!doctype html>\n    <html>\n    <head>\n        <meta charset=\"UTF-8\">\n        <title></title>\n    </head>\n    <body>\n    </body>\n    </html>`;\n```\n\n（这些例子包含的空格数是不一样的，但是在此处并不重要。）\n\n## 从函数表达式到箭头函数\n\n在当前的 ES5 代码中，在函数表达式中必须小心使用 `this` 。在下面的例子中，我创建了辅助变量 `_this` （行 A ），以便在行 B 能够访问到 UiComponent 的 `this` 。\n\n```js\nfunction UiComponent {\n    var _this = this; // (A)\n    var button = document.getElementById('myButton');\n    button.addEventListener('click', function () {\n        console.log('CLICK');\n        _this.handleClick(); // (B)\n    });\n}\nUiComponent.prototype.handleClick = function () {\n    ···\n};\n```\n\n在 ES6 中，你可以使用箭头函数，它不会改变 `this` 指向（行 A ，*词法范围的 this* ）：\n\n```js\nclass UiComponent {\n    constructor() {\n        let button = document.getElementById('myButton');\n        button.addEventListener('click', () => {\n            console.log('CLICK');\n            this.handleClick(); // (A)\n        });\n    }\n    handleClick() {\n        ···\n    }\n}\n```\n\n箭头函数对于短小的仅返回表达式值的回调函数来说尤其方便。\n\n在 ES5 中，这样的回调函数相当啰嗦：\n\n```js\nvar arr = [1, 2, 3];\nvar squares = arr.map(function (x) { return x * x });\n```\n\n在 ES6 中，箭头函数简洁很多：\n\n```js\nlet arr = [1, 2, 3];\nlet squares = arr.map(x => x * x);\n```\n\n在定义参数的时候，如果参数是一个标识符，甚至可以省略括号。所以： `(x) => x * x` 和 `x => x * x` 都是合法的。\n\n## 处理多个返回值\n\n一些函数或者方法通过数组或对象返回多个值。在 ES5 中，如果想要访问这些值，总是需要创建一些中间变量。在 ES6 中，可以借助于解构来避免中间变量。\n\n### 借助数组返回多个值\n\n`exec()` 通过类数组对象返回捕获到的匹配组。在 ES5 中，需要一个中间变量（下面例子中的 `matchObj` ），即便是你仅对匹配组感兴趣：\n\n```js\nvar matchObj =\n    /^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/\n    .exec('2999-12-31');\nvar year = matchObj[1];\nvar month = matchObj[2];\nvar day = matchObj[3];\n```\n\n在 ES6 中，解构使代码更简单：\n\n```js\nlet [, year, month, day] =\n    /^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/\n    .exec('2999-12-31');\n```\n\n左侧数组模式开始处为空，可以跳过右侧索引为0的数组元素。\n\n### 借助对象返回多个值\n\n方法 `Object.getOwnPropertyDescriptor()` 返回一个*属性描述符*，一个包含多个属性值的对象。\n\n在 ES5 中，即便你仅对一个对象的属性感兴趣，仍然需要一个中间变量（下例中的 `propDesc` ）：\n\n```js\nvar obj = { foo: 123 };\n\nvar propDesc = Object.getOwnPropertyDescriptor(obj, 'foo');\nvar writable = propDesc.writable;\nvar configurable = propDesc.configurable;\n\nconsole.log(writable, configurable); // true true\n```\n\n在 ES6 中，可以使用解构：\n\n```js\nlet obj = { foo: 123 };\n\nlet {writable, configurable} =\n    Object.getOwnPropertyDescriptor(obj, 'foo');\n\nconsole.log(writable, configurable); // true true\n```\n\n`{writable, configurable}` 是下面内容的缩写：\n\n```js\n{ writable: writable, configurable: configurable }\n```\n\n## 从 for 到 forEach() ，再到 for-of\n\n在 ES5 之前，可以选择使用数组方法 `forEach()` ：\n\n```js\narr.forEach(function (elem) {\n    console.log(elem);\n});\n```\n\n`for` 循环的优点在于可以中断， `forEach()` 的优点在于简洁。\n\n在 ES6 中， `for-of` 循环结合了两种优点：\n\n```js\nlet arr = ['a', 'b', 'c'];\nfor (let elem of arr) {\n    console.log(elem);\n}\n```\n\n如果想访问每个元素的索引和值， `for-of` 也可以做到，通过新的数组方法 `entries()` 和解构：\n\n```js\nfor (let [index, elem] of arr.entries()) {\n    console.log(index+'. '+elem);\n}\n```\n\n## 处理参数默认值\n\n在 ES5 中，为参数指定默认值的代码像这样：\n\n```js\nfunction foo(x, y) {\n    x = x || 0;\n    y = y || 0;\n    ···\n}\n```\n\nES6 有更漂亮的语法：\n\n```js\nfunction foo(x=0, y=0) {\n    ···\n}\n```\n\n一个额外的好处就是，在 ES6 中，参数默认值只会被 `undefined` 触发，而在之前的 ES5 代码中，任何假值都会出发默认值。\n\n## 处理命名参数\n\n在 JavaScript 中使用命名参数的一种通常做法是通过对象字面量的方式（所谓的*可选对象模式*）：\n\n```js\nselectEntries({ start: 0, end: -1 });\n```\n\n这种方式的两个优点是：代码可读性更好，并且可以更容易地省略任何参数。\n\n在 ES5 中，你可以这样实现 `selectEntries()` ：\n\n```js\nfunction selectEntries(options) {\n    var start = options.start || 0;\n    var end = options.end || -1;\n    var step = options.step || 1;\n    ···\n}\n```\n\n在 ES6 中，你可以在参数定义中使用解构，代码看起来就更简单了：\n\n```js\nfunction selectEntries({ start=0, end=-1, step=1 }) {\n    ···\n}\n```\n\n### 可选参数\n\n在 ES5 中，要让参数 `options` 变得可选，会添加行 A 所示的代码：\n\n```js\nfunction selectEntries(options) {\n    options = options || {}; // (A)\n    var start = options.start || 0;\n    var end = options.end || -1;\n    var step = options.step || 1;\n    ···\n}\n```\n\n在 ES6 中，可以用 `{}` 指定参数的默认值：\n\n```js\nfunction selectEntries({ start=0, end=-1, step=1 } = {}) {\n    ···\n}\n```\n\n## 从 arguments 到剩余参数\n\n在 ES5 中，如果想要函数（或者方法）接收任意数量的参数，就必须使用特殊变量 `arguments` ：\n\n```js\nfunction logAllArguments() {\n    for (var i=0; i < arguments.length; i++) {\n        console.log(arguments[i]);\n    }\n}\n```\n\n在 ES6 中，可以通过 `...` 操作符声明一个剩余参数（下例中的 args ）：\n\n```js\nfunction logAllArguments(...args) {\n    for (let arg of args) {\n        console.log(arg);\n    }\n}\n```\n\n如果仅对尾部的参数感兴趣，剩余参数看起来就更漂亮了：\n\n```js\nfunction format(pattern, ...args) {\n    ···\n}\n```\n\n在 ES5 中处理这种场景很笨拙：\n\n```js\nfunction format() {\n    var pattern = arguments[0];\n    var args = arguments.slice(1);\n    ···\n}\n```\n\n剩余参数让代码可读性更好：你可以从参数定义上面看出来一个函数是否有不定数量的参数。\n\n## 从 apply() 到扩展操作符（ ... ）\n\n在 ES5 中，用 `apply()` 将数组转换成参数。 ES6 有扩展操作符可以达到这个目的。\n\n### 4.11.1 Math.max()\n\nES5 - apply() ：\n\n```\n> Math.max.apply(null, [-1, 5, 11, 3])\n11\n```\n\nES6 - 扩展操作符：\n\n```\n> Math.max(...[-1, 5, 11, 3])\n11\n```\n\n### Array.prototype.push()\n\nES5 - apply() ：\n\n```js\nvar arr1 = ['a', 'b'];\nvar arr2 = ['c', 'd'];\n\narr1.push.apply(arr1, arr2);\n    // arr1 is now ['a', 'b', 'c', 'd']\n```\n\nES6 - 扩展操作符：\n\nlet arr1 = ['a', 'b'];\nlet arr2 = ['c', 'd'];\n\narr1.push(...arr2);\n    // arr1 is now ['a', 'b', 'c', 'd']\n\n## 从 concat() 到扩展操作符（ ... ）\n\n扩展操作符也能将操作数的内容转换成数组元素，也就是说它实现数组方法 `concat()` 的功能。\n\nES5 - concat() ：\n\n```js\nvar arr1 = ['a', 'b'];\nvar arr2 = ['c'];\nvar arr3 = ['d', 'e'];\n\nconsole.log(arr1.concat(arr2, arr3));\n    // [ 'a', 'b', 'c', 'd', 'e' ]\n```\n\nES6 - 扩展操作符：\n\n```js\nlet arr1 = ['a', 'b'];\nlet arr2 = ['c'];\nlet arr3 = ['d', 'e'];\n\nconsole.log([...arr1, ...arr2, ...arr3]);\n    // [ 'a', 'b', 'c', 'd', 'e' ]\n```\n\n## 从构造函数到类\n\n相对于构造函数来说，ES6 类是一种更加方便的语法。\n\n### 基类\n\n在 ES5 中，直接实现构造函数：\n\n```js\nfunction Person(name) {\n    this.name = name;\n}\nPerson.prototype.describe = function () {\n    return 'Person called '+this.name;\n};\n```\n\n在 ES6 中，类为构造函数提供了略微方便的语法：\n\n```js\nclass Person {\n    constructor(name) {\n        this.name = name;\n    }\n    describe() {\n        return 'Person called '+this.name;\n    }\n}\n```\n\n### 继承类\n\n在 ES5 中实现子类很复杂，尤其是要指向父类构造函数和父类属性。下面是一种比较正规的创建 `Person` 的子构造器 `Employee` 的方式：\n\n```js\nfunction Employee(name, title) {\n    Person.call(this, name); // super(name)\n    this.title = title;\n}\nEmployee.prototype = Object.create(Person.prototype);\nEmployee.prototype.constructor = Employee;\nEmployee.prototype.describe = function () {\n    return Person.prototype.describe.call(this) // super.describe()\n           + ' (' + this.title + ')';\n};\n```\n\nES6 内置支持子类继承，使用 extends 子句：\n\n```js\nclass Employee extends Person {\n    constructor(name, title) {\n        super(name);\n        this.title = title;\n    }\n    describe() {\n        return super.describe() + ' (' + this.title + ')';\n    }\n}\n```\n\n## 从自定义错误构造函数到 Error 子类\n\n在 ES5 中，不可能内置构造器的继承（除了 Error ）。下面的代码展示了一种继承的方式，并赋予了构造函数 MyError 一些重要的特性，比如堆栈跟踪：\n\n```js\nfunction MyError() {\n    // Use Error as a function\n    var superInstance = Error.apply(null, arguments);\n    copyOwnPropertiesFrom(this, superInstance);\n}\nMyError.prototype = Object.create(Error.prototype);\nMyError.prototype.constructor = MyError;\n```\n\n在 ES6 中，所有内置的构造函数都可以被继承，这就是为什么下面的代码实现了在 ES5 中只能模拟的功能：\n\n```js\nclass MyError extends Error {\n}\n```\n\n## 从对象字面量中的函数表达式到方法定义\n\n在 JavaScript 中，方法就是值为函数的属性。\n\n在 ES5 对象字面量中，方法以类似于其他属性的方式创建。属性值通过函数表达式提供。\n\n```js\nvar obj = {\n    foo: function () {\n        ···\n    },\n    bar: function () {\n        this.foo();\n    }, // trailing comma is legal in ES5\n}\n```\n\nES6 有*方法定义*，一种创建方法的特殊语法：\n\n```js\nlet obj = {\n    foo() {\n        ···\n    },\n    bar() {\n        this.foo();\n    },\n}\n```\n\n## 从对象到 Map\n\n把语言结构 *object* 用作字符串到任意值的映射（一种数据结构）是 JavaScript 中一直以来的一种替代解决方案。实现这种影射最安全的方式就是创建一个 prototype 为 null 的对象，然后你还得确保没有键名会是 `__proto__` ，因为这个键名在很多 JavaScript 引擎中都会触发特殊的功能。\n\n下面的 ES5 代码包含了函数 `countWords` ，该函数将对象 `dict` 用作一个 map ：\n\n```js\nvar dict = Object.create(null);\nfunction countWords(word) {\n    var escapedWord = escapeKey(word);\n    if (escapedWord in dict) {\n        dict[escapedWord]++;\n    } else {\n        dict[escapedWord] = 1;\n    }\n}\nfunction escapeKey(key) {\n    if (key.indexOf('__proto__') === 0) {\n        return key+'%';\n    } else {\n        return key;\n    }\n}\n```\n\n在 ES6 中，可以使用内置的数据结构 Map ，并且不需要转义键名。不过有一个缺点，对 map 中的值进行自增操作变得更不方便了。\n\n```js\nlet map = new Map();\nfunction countWords(word) {\n    let count = map.get(word) || 0;\n    map.set(word, count + 1);\n}\n```\n\nmap 的另一个优点是可以用任何值作为键，而不仅仅是字符串。\n\n## 从 CommonJS 模块到 ES6 模块\n\n直到 ES5 ，基于 AMD 语法或者 CommonJS 语法的模块系统才几乎替代了手写的解决方案（比如[暴露的模块方式](http://christianheilmann.com/2007/08/22/again-with-the-module-pattern-reveal-something-to-the-world/)）。\n\nES6 内置支持模块。但是，目前还没有 JavaScript 引擎原生支持。但是像 browserfy 、 webpack 或者 jspm 这些工具让你能够使用 ES6 语法来创建模块，从而使你写的代码不会过时。\n\n### 导出多个值\n\n在 CommonJS 里，像下面这样导出多个实体：\n\n```js\n//------ lib.js ------\nvar sqrt = Math.sqrt;\nfunction square(x) {\n    return x * x;\n}\nfunction diag(x, y) {\n    return sqrt(square(x) + square(y));\n}\nmodule.exports = {\n    sqrt: sqrt,\n    square: square,\n    diag: diag,\n};\n\n//------ main1.js ------\nvar square = require('lib').square;\nvar diag = require('lib').diag;\n\nconsole.log(square(11)); // 121\nconsole.log(diag(4, 3)); // 5\n```\n\n相应地，你可以引入整个模块为一个对象，然后通过这个对象访问 `square` 和 `diag` ：\n\n```js\n//------ main2.js ------\nvar lib = require('lib');\nconsole.log(lib.square(11)); // 121\nconsole.log(lib.diag(4, 3)); // 5\n```\n\n在 ES6 中，多个导出值被称为*命名导出*，像这样处理：\n\n```js\n//------ lib.js ------\nexport const sqrt = Math.sqrt;\nexport function square(x) {\n    return x * x;\n}\nexport function diag(x, y) {\n    return sqrt(square(x) + square(y));\n}\n\n//------ main1.js ------\nimport { square, diag } from 'lib';\nconsole.log(square(11)); // 121\nconsole.log(diag(4, 3)); // 5\n```\n\n引入模块为对象的语法就像下面这样（行 A ）：\n\n```js\n//------ main2.js ------\nimport * as lib from 'lib'; // (A)\nconsole.log(lib.square(11)); // 121\nconsole.log(lib.diag(4, 3)); // 5\n```\n\n### 导出一个值\n\nNode.js 使用了 CommonJS 的模块方案，允许通过 `module.exports` 在模块中导出一个值：\n\n```js\n//------ myFunc.js ------\nmodule.exports = function () { ··· };\n\n//------ main1.js ------\nvar myFunc = require('myFunc');\nmyFunc();\n```\n\n在 ES6 中， `export default` 完成同样的功能：\n\n```js\n//------ myFunc.js ------\nexport default function () { ··· } // no semicolon!\n\n//------ main1.js ------\nimport myFunc from 'myFunc';\nmyFunc();\n```\n","source":"_posts/ES6 简单特性概览.md","raw":"---\ntitle: ES6 简单特性概览\ndate: 2015-10-18 11:43\ntags:\n- JavaScript\n- ECMAScript 6\n---\n\n本文内容：\n\n* 讲解了如何使用交互式的方式体验 ES6 。\n* 列举了容易被人接受的 ES6 特性，附带这些特性在 ES5 中的实现方式。\n\n<!-- more -->\n\n## 体验 ECMAScript 6\n\n有三种简单的方式可以运行 ES6 代码：\n\n* 1、 Web 浏览器：使用[在线的 Babel REPL ](http://babeljs.io/repl/)，这是一个交互式的工具，将 ES6 代码编译成 ES5 代码。采用这种方式的话就不用安装任何东西。\n* 2、命令行：使用 `babel-node` ，一个 Node.js 可执行程序的版本，认识 ES6 代码（在内部会编译成 ES5 代码）。可以通过 npm 安装。\n* 3、各种 JavaScript 引擎：查询[ kangax 的 ES6 兼容表格](https://kangax.github.io/compat-table/es6/)，可以找到本地支持 ES6 的引擎。\n\n下面将会给出更多关于选项1和2的内容。\n\n### Babel REPL\n\nBabel REPL 有四个主要部分：\n\n* 左上角部分包含 ES6 源码。\n* 左下角部分显示 ES6 代码中发现的语法错误。\n* 右上角部分包含 ES6 代码编译成的 ES5 代码。\n* 右下角部分展示通过 `console.log()` 输出的内容。\n\n![](../images/11.jpg)\n\n### babel-node\n\n`babel-node` 可执行程序可以通过 npm 安装：\n\n```\nnpm install --global babel\n```\n\n你可以像使用可执行程序 `node` 一样使用 `babel-node` 。类似于 `node` ，像这样启动一个交互式的 REPL ：\n\n```\nbabel-node\n```\n\n一旦进入该 REPL ，你就可以执行 ES6 代码了：\n\n```\n> let arr = [1, 2, 3];\n> arr.map(x => x * x)\n[ 1, 4, 9 ]\n```\n\n注意 [babel-node 目前还不支持多行输入](https://github.com/babel/babel/issues/1741)。\n\nBabel 官网有[更多关于 Babel 命令行工具的信息](http://babeljs.io/docs/usage/cli/)。\n\n本文接下来的部分描述了易于接受的 ES6 特性。\n\n## 从 var 到 let/const\n\nES6 有两种新的声明变量的方式：\n\n* `let` （大致）相当于 `var` 的一个块级范围版本。\n* `const` 类似于 `let` ，但是用于创建*常量*：值不能被改变的变量。\n\n一般情况下，你可以用 `let` 或者 `const` 替换每一个 `var` 。但是不能盲目地这么做，因为不同类型的变量作用范围可能会改变代码的运行流程。看下面的用 ES5 写的例子：\n\n```js\nvar x = 3;\nfunction func(randomize) {\n    if (randomize) {\n        var x = Math.random(); // (A) scope: whole function\n        return x;\n    }\n    return x; // accesses the x from line A\n}\nfunc(false); // undefined\n```\n\n`func()` 返回 `undefined` ，这可能会比较奇怪。如果重写一下这段代码，让其更清楚地展现出来实际上发生了什么，你就明白了：\n\n```js\nvar x = 3;\nfunction func(randomize) {\n    var x;\n    if (randomize) {\n        x = Math.random();\n        return x;\n    }\n    return x;\n}\nfunc(false); // undefined\n```\n\n如果你在最初的版本中用 `let` 替换 `var` ，将会得到不一样的结果：\n\n```js\nlet x = 3;\nfunction func(randomize) {\n    if (randomize) {\n        let x = Math.random();\n        return x;\n    }\n    return x;\n}\nfunc(false); // 3\n```\n\n因此，盲目地用 `let` 或者 `const` 替换 `var` 很危险。我的建议是：\n\n* 仅在新的代码中使用 `let`/`const` 。\n* 不动老的代码，或者小心地重构老的代码。\n\n## 从 IIFE 到块级作用域\n\n在 ES5 中，你必须使用 IIFE 来使变量保持本地化：\n\n```js\n(function () {  // open IIFE\n    var tmp = ···;\n    ···\n}());  // close IIFE\n\nconsole.log(tmp); // ReferenceError\n```\n\n在 ECMAScript 6 中，你可以简单地使用一个块和一个 `let` 声明：\n\n```js\n{  // open block\n    let tmp = ···;\n    ···\n}  // close block\n\nconsole.log(tmp); // ReferenceError\n```\n\n## 从拼接字符串到模板字面量\n\n在 ES6 中， JavaScript 终于拥有了字面量式的字符串插值和多行字符串功能。\n\n### 字符串插值\n\n在 ES5 中，通过拼接字符串片段和变量值的方式来把变量值插入到字符串中：\n\n```js\nfunction printCoord(x, y) {\n    console.log('('+x+', '+y+')');\n}\n```\n\n在 ES6 中，你可以通过模板字面量的方式实现字符串插值：\n\n```js\nfunction printCoord(x, y) {\n    console.log(`(${x}, ${y})`);\n}\n```\n\n### 多行字符串\n\n模板字面量也可以用于表示多行字符串。\n\n例如，下面是在 ES5 中表示多行文本的样子：\n\n```js\nvar HTML5_SKELETON =\n    '<!doctype html>\\n' +\n    '<html>\\n' +\n    '<head>\\n' +\n    '    <meta charset=\"UTF-8\">\\n' +\n    '    <title></title>\\n' +\n    '</head>\\n' +\n    '<body>\\n' +\n    '</body>\\n' +\n    '</html>\\n';\n```\n\n如果你通过反斜线转义换行符，代码看起来就漂亮一点了（但是仍然需要显示地添加新行）：\n\n```js\nvar HTML5_SKELETON = '\\\n    <!doctype html>\\n\\\n    <html>\\n\\\n    <head>\\n\\\n        <meta charset=\"UTF-8\">\\n\\\n        <title></title>\\n\\\n    </head>\\n\\\n    <body>\\n\\\n    </body>\\n\\\n    </html>';\n```\n\nES6 模板字面量可以跨越多行：\n\n```js\nconst HTML5_SKELETON = `\n    <!doctype html>\n    <html>\n    <head>\n        <meta charset=\"UTF-8\">\n        <title></title>\n    </head>\n    <body>\n    </body>\n    </html>`;\n```\n\n（这些例子包含的空格数是不一样的，但是在此处并不重要。）\n\n## 从函数表达式到箭头函数\n\n在当前的 ES5 代码中，在函数表达式中必须小心使用 `this` 。在下面的例子中，我创建了辅助变量 `_this` （行 A ），以便在行 B 能够访问到 UiComponent 的 `this` 。\n\n```js\nfunction UiComponent {\n    var _this = this; // (A)\n    var button = document.getElementById('myButton');\n    button.addEventListener('click', function () {\n        console.log('CLICK');\n        _this.handleClick(); // (B)\n    });\n}\nUiComponent.prototype.handleClick = function () {\n    ···\n};\n```\n\n在 ES6 中，你可以使用箭头函数，它不会改变 `this` 指向（行 A ，*词法范围的 this* ）：\n\n```js\nclass UiComponent {\n    constructor() {\n        let button = document.getElementById('myButton');\n        button.addEventListener('click', () => {\n            console.log('CLICK');\n            this.handleClick(); // (A)\n        });\n    }\n    handleClick() {\n        ···\n    }\n}\n```\n\n箭头函数对于短小的仅返回表达式值的回调函数来说尤其方便。\n\n在 ES5 中，这样的回调函数相当啰嗦：\n\n```js\nvar arr = [1, 2, 3];\nvar squares = arr.map(function (x) { return x * x });\n```\n\n在 ES6 中，箭头函数简洁很多：\n\n```js\nlet arr = [1, 2, 3];\nlet squares = arr.map(x => x * x);\n```\n\n在定义参数的时候，如果参数是一个标识符，甚至可以省略括号。所以： `(x) => x * x` 和 `x => x * x` 都是合法的。\n\n## 处理多个返回值\n\n一些函数或者方法通过数组或对象返回多个值。在 ES5 中，如果想要访问这些值，总是需要创建一些中间变量。在 ES6 中，可以借助于解构来避免中间变量。\n\n### 借助数组返回多个值\n\n`exec()` 通过类数组对象返回捕获到的匹配组。在 ES5 中，需要一个中间变量（下面例子中的 `matchObj` ），即便是你仅对匹配组感兴趣：\n\n```js\nvar matchObj =\n    /^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/\n    .exec('2999-12-31');\nvar year = matchObj[1];\nvar month = matchObj[2];\nvar day = matchObj[3];\n```\n\n在 ES6 中，解构使代码更简单：\n\n```js\nlet [, year, month, day] =\n    /^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/\n    .exec('2999-12-31');\n```\n\n左侧数组模式开始处为空，可以跳过右侧索引为0的数组元素。\n\n### 借助对象返回多个值\n\n方法 `Object.getOwnPropertyDescriptor()` 返回一个*属性描述符*，一个包含多个属性值的对象。\n\n在 ES5 中，即便你仅对一个对象的属性感兴趣，仍然需要一个中间变量（下例中的 `propDesc` ）：\n\n```js\nvar obj = { foo: 123 };\n\nvar propDesc = Object.getOwnPropertyDescriptor(obj, 'foo');\nvar writable = propDesc.writable;\nvar configurable = propDesc.configurable;\n\nconsole.log(writable, configurable); // true true\n```\n\n在 ES6 中，可以使用解构：\n\n```js\nlet obj = { foo: 123 };\n\nlet {writable, configurable} =\n    Object.getOwnPropertyDescriptor(obj, 'foo');\n\nconsole.log(writable, configurable); // true true\n```\n\n`{writable, configurable}` 是下面内容的缩写：\n\n```js\n{ writable: writable, configurable: configurable }\n```\n\n## 从 for 到 forEach() ，再到 for-of\n\n在 ES5 之前，可以选择使用数组方法 `forEach()` ：\n\n```js\narr.forEach(function (elem) {\n    console.log(elem);\n});\n```\n\n`for` 循环的优点在于可以中断， `forEach()` 的优点在于简洁。\n\n在 ES6 中， `for-of` 循环结合了两种优点：\n\n```js\nlet arr = ['a', 'b', 'c'];\nfor (let elem of arr) {\n    console.log(elem);\n}\n```\n\n如果想访问每个元素的索引和值， `for-of` 也可以做到，通过新的数组方法 `entries()` 和解构：\n\n```js\nfor (let [index, elem] of arr.entries()) {\n    console.log(index+'. '+elem);\n}\n```\n\n## 处理参数默认值\n\n在 ES5 中，为参数指定默认值的代码像这样：\n\n```js\nfunction foo(x, y) {\n    x = x || 0;\n    y = y || 0;\n    ···\n}\n```\n\nES6 有更漂亮的语法：\n\n```js\nfunction foo(x=0, y=0) {\n    ···\n}\n```\n\n一个额外的好处就是，在 ES6 中，参数默认值只会被 `undefined` 触发，而在之前的 ES5 代码中，任何假值都会出发默认值。\n\n## 处理命名参数\n\n在 JavaScript 中使用命名参数的一种通常做法是通过对象字面量的方式（所谓的*可选对象模式*）：\n\n```js\nselectEntries({ start: 0, end: -1 });\n```\n\n这种方式的两个优点是：代码可读性更好，并且可以更容易地省略任何参数。\n\n在 ES5 中，你可以这样实现 `selectEntries()` ：\n\n```js\nfunction selectEntries(options) {\n    var start = options.start || 0;\n    var end = options.end || -1;\n    var step = options.step || 1;\n    ···\n}\n```\n\n在 ES6 中，你可以在参数定义中使用解构，代码看起来就更简单了：\n\n```js\nfunction selectEntries({ start=0, end=-1, step=1 }) {\n    ···\n}\n```\n\n### 可选参数\n\n在 ES5 中，要让参数 `options` 变得可选，会添加行 A 所示的代码：\n\n```js\nfunction selectEntries(options) {\n    options = options || {}; // (A)\n    var start = options.start || 0;\n    var end = options.end || -1;\n    var step = options.step || 1;\n    ···\n}\n```\n\n在 ES6 中，可以用 `{}` 指定参数的默认值：\n\n```js\nfunction selectEntries({ start=0, end=-1, step=1 } = {}) {\n    ···\n}\n```\n\n## 从 arguments 到剩余参数\n\n在 ES5 中，如果想要函数（或者方法）接收任意数量的参数，就必须使用特殊变量 `arguments` ：\n\n```js\nfunction logAllArguments() {\n    for (var i=0; i < arguments.length; i++) {\n        console.log(arguments[i]);\n    }\n}\n```\n\n在 ES6 中，可以通过 `...` 操作符声明一个剩余参数（下例中的 args ）：\n\n```js\nfunction logAllArguments(...args) {\n    for (let arg of args) {\n        console.log(arg);\n    }\n}\n```\n\n如果仅对尾部的参数感兴趣，剩余参数看起来就更漂亮了：\n\n```js\nfunction format(pattern, ...args) {\n    ···\n}\n```\n\n在 ES5 中处理这种场景很笨拙：\n\n```js\nfunction format() {\n    var pattern = arguments[0];\n    var args = arguments.slice(1);\n    ···\n}\n```\n\n剩余参数让代码可读性更好：你可以从参数定义上面看出来一个函数是否有不定数量的参数。\n\n## 从 apply() 到扩展操作符（ ... ）\n\n在 ES5 中，用 `apply()` 将数组转换成参数。 ES6 有扩展操作符可以达到这个目的。\n\n### 4.11.1 Math.max()\n\nES5 - apply() ：\n\n```\n> Math.max.apply(null, [-1, 5, 11, 3])\n11\n```\n\nES6 - 扩展操作符：\n\n```\n> Math.max(...[-1, 5, 11, 3])\n11\n```\n\n### Array.prototype.push()\n\nES5 - apply() ：\n\n```js\nvar arr1 = ['a', 'b'];\nvar arr2 = ['c', 'd'];\n\narr1.push.apply(arr1, arr2);\n    // arr1 is now ['a', 'b', 'c', 'd']\n```\n\nES6 - 扩展操作符：\n\nlet arr1 = ['a', 'b'];\nlet arr2 = ['c', 'd'];\n\narr1.push(...arr2);\n    // arr1 is now ['a', 'b', 'c', 'd']\n\n## 从 concat() 到扩展操作符（ ... ）\n\n扩展操作符也能将操作数的内容转换成数组元素，也就是说它实现数组方法 `concat()` 的功能。\n\nES5 - concat() ：\n\n```js\nvar arr1 = ['a', 'b'];\nvar arr2 = ['c'];\nvar arr3 = ['d', 'e'];\n\nconsole.log(arr1.concat(arr2, arr3));\n    // [ 'a', 'b', 'c', 'd', 'e' ]\n```\n\nES6 - 扩展操作符：\n\n```js\nlet arr1 = ['a', 'b'];\nlet arr2 = ['c'];\nlet arr3 = ['d', 'e'];\n\nconsole.log([...arr1, ...arr2, ...arr3]);\n    // [ 'a', 'b', 'c', 'd', 'e' ]\n```\n\n## 从构造函数到类\n\n相对于构造函数来说，ES6 类是一种更加方便的语法。\n\n### 基类\n\n在 ES5 中，直接实现构造函数：\n\n```js\nfunction Person(name) {\n    this.name = name;\n}\nPerson.prototype.describe = function () {\n    return 'Person called '+this.name;\n};\n```\n\n在 ES6 中，类为构造函数提供了略微方便的语法：\n\n```js\nclass Person {\n    constructor(name) {\n        this.name = name;\n    }\n    describe() {\n        return 'Person called '+this.name;\n    }\n}\n```\n\n### 继承类\n\n在 ES5 中实现子类很复杂，尤其是要指向父类构造函数和父类属性。下面是一种比较正规的创建 `Person` 的子构造器 `Employee` 的方式：\n\n```js\nfunction Employee(name, title) {\n    Person.call(this, name); // super(name)\n    this.title = title;\n}\nEmployee.prototype = Object.create(Person.prototype);\nEmployee.prototype.constructor = Employee;\nEmployee.prototype.describe = function () {\n    return Person.prototype.describe.call(this) // super.describe()\n           + ' (' + this.title + ')';\n};\n```\n\nES6 内置支持子类继承，使用 extends 子句：\n\n```js\nclass Employee extends Person {\n    constructor(name, title) {\n        super(name);\n        this.title = title;\n    }\n    describe() {\n        return super.describe() + ' (' + this.title + ')';\n    }\n}\n```\n\n## 从自定义错误构造函数到 Error 子类\n\n在 ES5 中，不可能内置构造器的继承（除了 Error ）。下面的代码展示了一种继承的方式，并赋予了构造函数 MyError 一些重要的特性，比如堆栈跟踪：\n\n```js\nfunction MyError() {\n    // Use Error as a function\n    var superInstance = Error.apply(null, arguments);\n    copyOwnPropertiesFrom(this, superInstance);\n}\nMyError.prototype = Object.create(Error.prototype);\nMyError.prototype.constructor = MyError;\n```\n\n在 ES6 中，所有内置的构造函数都可以被继承，这就是为什么下面的代码实现了在 ES5 中只能模拟的功能：\n\n```js\nclass MyError extends Error {\n}\n```\n\n## 从对象字面量中的函数表达式到方法定义\n\n在 JavaScript 中，方法就是值为函数的属性。\n\n在 ES5 对象字面量中，方法以类似于其他属性的方式创建。属性值通过函数表达式提供。\n\n```js\nvar obj = {\n    foo: function () {\n        ···\n    },\n    bar: function () {\n        this.foo();\n    }, // trailing comma is legal in ES5\n}\n```\n\nES6 有*方法定义*，一种创建方法的特殊语法：\n\n```js\nlet obj = {\n    foo() {\n        ···\n    },\n    bar() {\n        this.foo();\n    },\n}\n```\n\n## 从对象到 Map\n\n把语言结构 *object* 用作字符串到任意值的映射（一种数据结构）是 JavaScript 中一直以来的一种替代解决方案。实现这种影射最安全的方式就是创建一个 prototype 为 null 的对象，然后你还得确保没有键名会是 `__proto__` ，因为这个键名在很多 JavaScript 引擎中都会触发特殊的功能。\n\n下面的 ES5 代码包含了函数 `countWords` ，该函数将对象 `dict` 用作一个 map ：\n\n```js\nvar dict = Object.create(null);\nfunction countWords(word) {\n    var escapedWord = escapeKey(word);\n    if (escapedWord in dict) {\n        dict[escapedWord]++;\n    } else {\n        dict[escapedWord] = 1;\n    }\n}\nfunction escapeKey(key) {\n    if (key.indexOf('__proto__') === 0) {\n        return key+'%';\n    } else {\n        return key;\n    }\n}\n```\n\n在 ES6 中，可以使用内置的数据结构 Map ，并且不需要转义键名。不过有一个缺点，对 map 中的值进行自增操作变得更不方便了。\n\n```js\nlet map = new Map();\nfunction countWords(word) {\n    let count = map.get(word) || 0;\n    map.set(word, count + 1);\n}\n```\n\nmap 的另一个优点是可以用任何值作为键，而不仅仅是字符串。\n\n## 从 CommonJS 模块到 ES6 模块\n\n直到 ES5 ，基于 AMD 语法或者 CommonJS 语法的模块系统才几乎替代了手写的解决方案（比如[暴露的模块方式](http://christianheilmann.com/2007/08/22/again-with-the-module-pattern-reveal-something-to-the-world/)）。\n\nES6 内置支持模块。但是，目前还没有 JavaScript 引擎原生支持。但是像 browserfy 、 webpack 或者 jspm 这些工具让你能够使用 ES6 语法来创建模块，从而使你写的代码不会过时。\n\n### 导出多个值\n\n在 CommonJS 里，像下面这样导出多个实体：\n\n```js\n//------ lib.js ------\nvar sqrt = Math.sqrt;\nfunction square(x) {\n    return x * x;\n}\nfunction diag(x, y) {\n    return sqrt(square(x) + square(y));\n}\nmodule.exports = {\n    sqrt: sqrt,\n    square: square,\n    diag: diag,\n};\n\n//------ main1.js ------\nvar square = require('lib').square;\nvar diag = require('lib').diag;\n\nconsole.log(square(11)); // 121\nconsole.log(diag(4, 3)); // 5\n```\n\n相应地，你可以引入整个模块为一个对象，然后通过这个对象访问 `square` 和 `diag` ：\n\n```js\n//------ main2.js ------\nvar lib = require('lib');\nconsole.log(lib.square(11)); // 121\nconsole.log(lib.diag(4, 3)); // 5\n```\n\n在 ES6 中，多个导出值被称为*命名导出*，像这样处理：\n\n```js\n//------ lib.js ------\nexport const sqrt = Math.sqrt;\nexport function square(x) {\n    return x * x;\n}\nexport function diag(x, y) {\n    return sqrt(square(x) + square(y));\n}\n\n//------ main1.js ------\nimport { square, diag } from 'lib';\nconsole.log(square(11)); // 121\nconsole.log(diag(4, 3)); // 5\n```\n\n引入模块为对象的语法就像下面这样（行 A ）：\n\n```js\n//------ main2.js ------\nimport * as lib from 'lib'; // (A)\nconsole.log(lib.square(11)); // 121\nconsole.log(lib.diag(4, 3)); // 5\n```\n\n### 导出一个值\n\nNode.js 使用了 CommonJS 的模块方案，允许通过 `module.exports` 在模块中导出一个值：\n\n```js\n//------ myFunc.js ------\nmodule.exports = function () { ··· };\n\n//------ main1.js ------\nvar myFunc = require('myFunc');\nmyFunc();\n```\n\n在 ES6 中， `export default` 完成同样的功能：\n\n```js\n//------ myFunc.js ------\nexport default function () { ··· } // no semicolon!\n\n//------ main1.js ------\nimport myFunc from 'myFunc';\nmyFunc();\n```\n","slug":"ES6 简单特性概览","published":1,"updated":"2016-07-01T03:56:27.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy028000d0407dfucb4tp","content":"<p>本文内容：</p>\n<ul>\n<li>讲解了如何使用交互式的方式体验 ES6 。</li>\n<li>列举了容易被人接受的 ES6 特性，附带这些特性在 ES5 中的实现方式。</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"体验-ECMAScript-6\"><a href=\"#体验-ECMAScript-6\" class=\"headerlink\" title=\"体验 ECMAScript 6\"></a>体验 ECMAScript 6</h2><p>有三种简单的方式可以运行 ES6 代码：</p>\n<ul>\n<li>1、 Web 浏览器：使用<a href=\"http://babeljs.io/repl/\" target=\"_blank\" rel=\"external\">在线的 Babel REPL </a>，这是一个交互式的工具，将 ES6 代码编译成 ES5 代码。采用这种方式的话就不用安装任何东西。</li>\n<li>2、命令行：使用 <code>babel-node</code> ，一个 Node.js 可执行程序的版本，认识 ES6 代码（在内部会编译成 ES5 代码）。可以通过 npm 安装。</li>\n<li>3、各种 JavaScript 引擎：查询<a href=\"https://kangax.github.io/compat-table/es6/\" target=\"_blank\" rel=\"external\"> kangax 的 ES6 兼容表格</a>，可以找到本地支持 ES6 的引擎。</li>\n</ul>\n<p>下面将会给出更多关于选项1和2的内容。</p>\n<h3 id=\"Babel-REPL\"><a href=\"#Babel-REPL\" class=\"headerlink\" title=\"Babel REPL\"></a>Babel REPL</h3><p>Babel REPL 有四个主要部分：</p>\n<ul>\n<li>左上角部分包含 ES6 源码。</li>\n<li>左下角部分显示 ES6 代码中发现的语法错误。</li>\n<li>右上角部分包含 ES6 代码编译成的 ES5 代码。</li>\n<li>右下角部分展示通过 <code>console.log()</code> 输出的内容。</li>\n</ul>\n<p><img src=\"../images/11.jpg\" alt=\"\"></p>\n<h3 id=\"babel-node\"><a href=\"#babel-node\" class=\"headerlink\" title=\"babel-node\"></a>babel-node</h3><p><code>babel-node</code> 可执行程序可以通过 npm 安装：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install --global babel</div></pre></td></tr></table></figure>\n<p>你可以像使用可执行程序 <code>node</code> 一样使用 <code>babel-node</code> 。类似于 <code>node</code> ，像这样启动一个交互式的 REPL ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">babel-node</div></pre></td></tr></table></figure>\n<p>一旦进入该 REPL ，你就可以执行 ES6 代码了：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; let arr = [1, 2, 3];</div><div class=\"line\">&gt; arr.map(x =&gt; x * x)</div><div class=\"line\">[ 1, 4, 9 ]</div></pre></td></tr></table></figure>\n<p>注意 <a href=\"https://github.com/babel/babel/issues/1741\" target=\"_blank\" rel=\"external\">babel-node 目前还不支持多行输入</a>。</p>\n<p>Babel 官网有<a href=\"http://babeljs.io/docs/usage/cli/\" target=\"_blank\" rel=\"external\">更多关于 Babel 命令行工具的信息</a>。</p>\n<p>本文接下来的部分描述了易于接受的 ES6 特性。</p>\n<h2 id=\"从-var-到-let-const\"><a href=\"#从-var-到-let-const\" class=\"headerlink\" title=\"从 var 到 let/const\"></a>从 var 到 let/const</h2><p>ES6 有两种新的声明变量的方式：</p>\n<ul>\n<li><code>let</code> （大致）相当于 <code>var</code> 的一个块级范围版本。</li>\n<li><code>const</code> 类似于 <code>let</code> ，但是用于创建<em>常量</em>：值不能被改变的变量。</li>\n</ul>\n<p>一般情况下，你可以用 <code>let</code> 或者 <code>const</code> 替换每一个 <code>var</code> 。但是不能盲目地这么做，因为不同类型的变量作用范围可能会改变代码的运行流程。看下面的用 ES5 写的例子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> x = <span class=\"built_in\">Math</span>.random(); <span class=\"comment\">// (A) scope: whole function</span></div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x; <span class=\"comment\">// accesses the x from line A</span></div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// undefined</span></div></pre></td></tr></table></figure>\n<p><code>func()</code> 返回 <code>undefined</code> ，这可能会比较奇怪。如果重写一下这段代码，让其更清楚地展现出来实际上发生了什么，你就明白了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> x;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        x = <span class=\"built_in\">Math</span>.random();</div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x;</div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// undefined</span></div></pre></td></tr></table></figure>\n<p>如果你在最初的版本中用 <code>let</code> 替换 <code>var</code> ，将会得到不一样的结果：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"built_in\">Math</span>.random();</div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x;</div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// 3</span></div></pre></td></tr></table></figure>\n<p>因此，盲目地用 <code>let</code> 或者 <code>const</code> 替换 <code>var</code> 很危险。我的建议是：</p>\n<ul>\n<li>仅在新的代码中使用 <code>let</code>/<code>const</code> 。</li>\n<li>不动老的代码，或者小心地重构老的代码。</li>\n</ul>\n<h2 id=\"从-IIFE-到块级作用域\"><a href=\"#从-IIFE-到块级作用域\" class=\"headerlink\" title=\"从 IIFE 到块级作用域\"></a>从 IIFE 到块级作用域</h2><p>在 ES5 中，你必须使用 IIFE 来使变量保持本地化：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;  <span class=\"comment\">// open IIFE</span></div><div class=\"line\">    <span class=\"keyword\">var</span> tmp = ···;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;());  <span class=\"comment\">// close IIFE</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(tmp); <span class=\"comment\">// ReferenceError</span></div></pre></td></tr></table></figure>\n<p>在 ECMAScript 6 中，你可以简单地使用一个块和一个 <code>let</code> 声明：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;  <span class=\"comment\">// open block</span></div><div class=\"line\">    <span class=\"keyword\">let</span> tmp = ···;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;  <span class=\"comment\">// close block</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(tmp); <span class=\"comment\">// ReferenceError</span></div></pre></td></tr></table></figure>\n<h2 id=\"从拼接字符串到模板字面量\"><a href=\"#从拼接字符串到模板字面量\" class=\"headerlink\" title=\"从拼接字符串到模板字面量\"></a>从拼接字符串到模板字面量</h2><p>在 ES6 中， JavaScript 终于拥有了字面量式的字符串插值和多行字符串功能。</p>\n<h3 id=\"字符串插值\"><a href=\"#字符串插值\" class=\"headerlink\" title=\"字符串插值\"></a>字符串插值</h3><p>在 ES5 中，通过拼接字符串片段和变量值的方式来把变量值插入到字符串中：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">printCoord</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'('</span>+x+<span class=\"string\">', '</span>+y+<span class=\"string\">')'</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以通过模板字面量的方式实现字符串插值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">printCoord</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">`(<span class=\"subst\">$&#123;x&#125;</span>, <span class=\"subst\">$&#123;y&#125;</span>)`</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"多行字符串\"><a href=\"#多行字符串\" class=\"headerlink\" title=\"多行字符串\"></a>多行字符串</h3><p>模板字面量也可以用于表示多行字符串。</p>\n<p>例如，下面是在 ES5 中表示多行文本的样子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> HTML5_SKELETON =</div><div class=\"line\">    <span class=\"string\">'&lt;!doctype html&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;html&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;head&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'    &lt;meta charset=\"UTF-8\"&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'    &lt;title&gt;&lt;/title&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/head&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;body&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/body&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/html&gt;\\n'</span>;</div></pre></td></tr></table></figure>\n<p>如果你通过反斜线转义换行符，代码看起来就漂亮一点了（但是仍然需要显示地添加新行）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> HTML5_SKELETON = <span class=\"string\">'\\</span></div><div class=\"line\">    &lt;!doctype html&gt;\\n\\</div><div class=\"line\">    &lt;html&gt;\\n\\</div><div class=\"line\">    &lt;head&gt;\\n\\</div><div class=\"line\">        &lt;meta charset=\"UTF-8\"&gt;\\n\\</div><div class=\"line\">        &lt;title&gt;&lt;/title&gt;\\n\\</div><div class=\"line\">    &lt;/head&gt;\\n\\</div><div class=\"line\">    &lt;body&gt;\\n\\</div><div class=\"line\">    &lt;/body&gt;\\n\\</div><div class=\"line\">    &lt;/html&gt;';</div></pre></td></tr></table></figure>\n<p>ES6 模板字面量可以跨越多行：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> HTML5_SKELETON = <span class=\"string\">`</span></div><div class=\"line\">    &lt;!doctype html&gt;</div><div class=\"line\">    &lt;html&gt;</div><div class=\"line\">    &lt;head&gt;</div><div class=\"line\">        &lt;meta charset=\"UTF-8\"&gt;</div><div class=\"line\">        &lt;title&gt;&lt;/title&gt;</div><div class=\"line\">    &lt;/head&gt;</div><div class=\"line\">    &lt;body&gt;</div><div class=\"line\">    &lt;/body&gt;</div><div class=\"line\">    &lt;/html&gt;`;</div></pre></td></tr></table></figure>\n<p>（这些例子包含的空格数是不一样的，但是在此处并不重要。）</p>\n<h2 id=\"从函数表达式到箭头函数\"><a href=\"#从函数表达式到箭头函数\" class=\"headerlink\" title=\"从函数表达式到箭头函数\"></a>从函数表达式到箭头函数</h2><p>在当前的 ES5 代码中，在函数表达式中必须小心使用 <code>this</code> 。在下面的例子中，我创建了辅助变量 <code>_this</code> （行 A ），以便在行 B 能够访问到 UiComponent 的 <code>this</code> 。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">UiComponent</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> _this = <span class=\"keyword\">this</span>; <span class=\"comment\">// (A)</span></div><div class=\"line\">    <span class=\"keyword\">var</span> button = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'myButton'</span>);</div><div class=\"line\">    button.addEventListener(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'CLICK'</span>);</div><div class=\"line\">        _this.handleClick(); <span class=\"comment\">// (B)</span></div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\">UiComponent.prototype.handleClick = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以使用箭头函数，它不会改变 <code>this</code> 指向（行 A ，<em>词法范围的 this</em> ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UiComponent</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">let</span> button = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'myButton'</span>);</div><div class=\"line\">        button.addEventListener(<span class=\"string\">'click'</span>, () =&gt; &#123;</div><div class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'CLICK'</span>);</div><div class=\"line\">            <span class=\"keyword\">this</span>.handleClick(); <span class=\"comment\">// (A)</span></div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    handleClick() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>箭头函数对于短小的仅返回表达式值的回调函数来说尤其方便。</p>\n<p>在 ES5 中，这样的回调函数相当啰嗦：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> squares = arr.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">x</span>) </span>&#123; <span class=\"keyword\">return</span> x * x &#125;);</div></pre></td></tr></table></figure>\n<p>在 ES6 中，箭头函数简洁很多：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> squares = arr.map(<span class=\"function\"><span class=\"params\">x</span> =&gt;</span> x * x);</div></pre></td></tr></table></figure>\n<p>在定义参数的时候，如果参数是一个标识符，甚至可以省略括号。所以： <code>(x) =&gt; x * x</code> 和 <code>x =&gt; x * x</code> 都是合法的。</p>\n<h2 id=\"处理多个返回值\"><a href=\"#处理多个返回值\" class=\"headerlink\" title=\"处理多个返回值\"></a>处理多个返回值</h2><p>一些函数或者方法通过数组或对象返回多个值。在 ES5 中，如果想要访问这些值，总是需要创建一些中间变量。在 ES6 中，可以借助于解构来避免中间变量。</p>\n<h3 id=\"借助数组返回多个值\"><a href=\"#借助数组返回多个值\" class=\"headerlink\" title=\"借助数组返回多个值\"></a>借助数组返回多个值</h3><p><code>exec()</code> 通过类数组对象返回捕获到的匹配组。在 ES5 中，需要一个中间变量（下面例子中的 <code>matchObj</code> ），即便是你仅对匹配组感兴趣：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> matchObj =</div><div class=\"line\">    <span class=\"regexp\">/^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/</span></div><div class=\"line\">    .exec(<span class=\"string\">'2999-12-31'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> year = matchObj[<span class=\"number\">1</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> month = matchObj[<span class=\"number\">2</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> day = matchObj[<span class=\"number\">3</span>];</div></pre></td></tr></table></figure>\n<p>在 ES6 中，解构使代码更简单：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> [, year, month, day] =</div><div class=\"line\">    <span class=\"regexp\">/^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/</span></div><div class=\"line\">    .exec(<span class=\"string\">'2999-12-31'</span>);</div></pre></td></tr></table></figure>\n<p>左侧数组模式开始处为空，可以跳过右侧索引为0的数组元素。</p>\n<h3 id=\"借助对象返回多个值\"><a href=\"#借助对象返回多个值\" class=\"headerlink\" title=\"借助对象返回多个值\"></a>借助对象返回多个值</h3><p>方法 <code>Object.getOwnPropertyDescriptor()</code> 返回一个<em>属性描述符</em>，一个包含多个属性值的对象。</p>\n<p>在 ES5 中，即便你仅对一个对象的属性感兴趣，仍然需要一个中间变量（下例中的 <code>propDesc</code> ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> obj = &#123; <span class=\"attr\">foo</span>: <span class=\"number\">123</span> &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> propDesc = <span class=\"built_in\">Object</span>.getOwnPropertyDescriptor(obj, <span class=\"string\">'foo'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> writable = propDesc.writable;</div><div class=\"line\"><span class=\"keyword\">var</span> configurable = propDesc.configurable;</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(writable, configurable); <span class=\"comment\">// true true</span></div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以使用解构：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123; <span class=\"attr\">foo</span>: <span class=\"number\">123</span> &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> &#123;writable, configurable&#125; =</div><div class=\"line\">    <span class=\"built_in\">Object</span>.getOwnPropertyDescriptor(obj, <span class=\"string\">'foo'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(writable, configurable); <span class=\"comment\">// true true</span></div></pre></td></tr></table></figure>\n<p><code>{writable, configurable}</code> 是下面内容的缩写：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123; <span class=\"attr\">writable</span>: writable, <span class=\"attr\">configurable</span>: configurable &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从-for-到-forEach-，再到-for-of\"><a href=\"#从-for-到-forEach-，再到-for-of\" class=\"headerlink\" title=\"从 for 到 forEach() ，再到 for-of\"></a>从 for 到 forEach() ，再到 for-of</h2><p>在 ES5 之前，可以选择使用数组方法 <code>forEach()</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">arr.forEach(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">elem</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(elem);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p><code>for</code> 循环的优点在于可以中断， <code>forEach()</code> 的优点在于简洁。</p>\n<p>在 ES6 中， <code>for-of</code> 循环结合了两种优点：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> elem <span class=\"keyword\">of</span> arr) &#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(elem);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果想访问每个元素的索引和值， <code>for-of</code> 也可以做到，通过新的数组方法 <code>entries()</code> 和解构：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> [index, elem] <span class=\"keyword\">of</span> arr.entries()) &#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(index+<span class=\"string\">'. '</span>+elem);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"处理参数默认值\"><a href=\"#处理参数默认值\" class=\"headerlink\" title=\"处理参数默认值\"></a>处理参数默认值</h2><p>在 ES5 中，为参数指定默认值的代码像这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    x = x || <span class=\"number\">0</span>;</div><div class=\"line\">    y = y || <span class=\"number\">0</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ES6 有更漂亮的语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\">x=<span class=\"number\">0</span>, y=<span class=\"number\">0</span></span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一个额外的好处就是，在 ES6 中，参数默认值只会被 <code>undefined</code> 触发，而在之前的 ES5 代码中，任何假值都会出发默认值。</p>\n<h2 id=\"处理命名参数\"><a href=\"#处理命名参数\" class=\"headerlink\" title=\"处理命名参数\"></a>处理命名参数</h2><p>在 JavaScript 中使用命名参数的一种通常做法是通过对象字面量的方式（所谓的<em>可选对象模式</em>）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">selectEntries(&#123; <span class=\"attr\">start</span>: <span class=\"number\">0</span>, <span class=\"attr\">end</span>: <span class=\"number\">-1</span> &#125;);</div></pre></td></tr></table></figure>\n<p>这种方式的两个优点是：代码可读性更好，并且可以更容易地省略任何参数。</p>\n<p>在 ES5 中，你可以这样实现 <code>selectEntries()</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">options</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> start = options.start || <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> end = options.end || <span class=\"number\">-1</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> step = options.step || <span class=\"number\">1</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以在参数定义中使用解构，代码看起来就更简单了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">&#123; start=<span class=\"number\">0</span>, end=<span class=\"number\">-1</span>, step=<span class=\"number\">1</span> &#125;</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"可选参数\"><a href=\"#可选参数\" class=\"headerlink\" title=\"可选参数\"></a>可选参数</h3><p>在 ES5 中，要让参数 <code>options</code> 变得可选，会添加行 A 所示的代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">options</span>) </span>&#123;</div><div class=\"line\">    options = options || &#123;&#125;; <span class=\"comment\">// (A)</span></div><div class=\"line\">    <span class=\"keyword\">var</span> start = options.start || <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> end = options.end || <span class=\"number\">-1</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> step = options.step || <span class=\"number\">1</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以用 <code>{}</code> 指定参数的默认值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">&#123; start=<span class=\"number\">0</span>, end=<span class=\"number\">-1</span>, step=<span class=\"number\">1</span> &#125; = &#123;&#125;</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从-arguments-到剩余参数\"><a href=\"#从-arguments-到剩余参数\" class=\"headerlink\" title=\"从 arguments 到剩余参数\"></a>从 arguments 到剩余参数</h2><p>在 ES5 中，如果想要函数（或者方法）接收任意数量的参数，就必须使用特殊变量 <code>arguments</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">logAllArguments</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">arguments</span>.length; i++) &#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>[i]);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以通过 <code>...</code> 操作符声明一个剩余参数（下例中的 args ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">logAllArguments</span>(<span class=\"params\">...args</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> arg <span class=\"keyword\">of</span> args) &#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(arg);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果仅对尾部的参数感兴趣，剩余参数看起来就更漂亮了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">format</span>(<span class=\"params\">pattern, ...args</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES5 中处理这种场景很笨拙：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">format</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> pattern = <span class=\"built_in\">arguments</span>[<span class=\"number\">0</span>];</div><div class=\"line\">    <span class=\"keyword\">var</span> args = <span class=\"built_in\">arguments</span>.slice(<span class=\"number\">1</span>);</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>剩余参数让代码可读性更好：你可以从参数定义上面看出来一个函数是否有不定数量的参数。</p>\n<h2 id=\"从-apply-到扩展操作符（-…-）\"><a href=\"#从-apply-到扩展操作符（-…-）\" class=\"headerlink\" title=\"从 apply() 到扩展操作符（ … ）\"></a>从 apply() 到扩展操作符（ … ）</h2><p>在 ES5 中，用 <code>apply()</code> 将数组转换成参数。 ES6 有扩展操作符可以达到这个目的。</p>\n<h3 id=\"4-11-1-Math-max\"><a href=\"#4-11-1-Math-max\" class=\"headerlink\" title=\"4.11.1 Math.max()\"></a>4.11.1 Math.max()</h3><p>ES5 - apply() ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; Math.max.apply(null, [-1, 5, 11, 3])</div><div class=\"line\">11</div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; Math.max(...[-1, 5, 11, 3])</div><div class=\"line\">11</div></pre></td></tr></table></figure>\n<h3 id=\"Array-prototype-push\"><a href=\"#Array-prototype-push\" class=\"headerlink\" title=\"Array.prototype.push()\"></a>Array.prototype.push()</h3><p>ES5 - apply() ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr2 = [<span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>];</div><div class=\"line\"></div><div class=\"line\">arr1.push.apply(arr1, arr2);</div><div class=\"line\">    <span class=\"comment\">// arr1 is now ['a', 'b', 'c', 'd']</span></div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<p>let arr1 = [‘a’, ‘b’];<br>let arr2 = [‘c’, ‘d’];</p>\n<p>arr1.push(…arr2);<br>    // arr1 is now [‘a’, ‘b’, ‘c’, ‘d’]</p>\n<h2 id=\"从-concat-到扩展操作符（-…-）\"><a href=\"#从-concat-到扩展操作符（-…-）\" class=\"headerlink\" title=\"从 concat() 到扩展操作符（ … ）\"></a>从 concat() 到扩展操作符（ … ）</h2><p>扩展操作符也能将操作数的内容转换成数组元素，也就是说它实现数组方法 <code>concat()</code> 的功能。</p>\n<p>ES5 - concat() ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr2 = [<span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr3 = [<span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(arr1.concat(arr2, arr3));</div><div class=\"line\">    <span class=\"comment\">// [ 'a', 'b', 'c', 'd', 'e' ]</span></div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> arr2 = [<span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> arr3 = [<span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log([...arr1, ...arr2, ...arr3]);</div><div class=\"line\">    <span class=\"comment\">// [ 'a', 'b', 'c', 'd', 'e' ]</span></div></pre></td></tr></table></figure>\n<h2 id=\"从构造函数到类\"><a href=\"#从构造函数到类\" class=\"headerlink\" title=\"从构造函数到类\"></a>从构造函数到类</h2><p>相对于构造函数来说，ES6 类是一种更加方便的语法。</p>\n<h3 id=\"基类\"><a href=\"#基类\" class=\"headerlink\" title=\"基类\"></a>基类</h3><p>在 ES5 中，直接实现构造函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Person</span>(<span class=\"params\">name</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\">&#125;</div><div class=\"line\">Person.prototype.describe = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'Person called '</span>+<span class=\"keyword\">this</span>.name;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，类为构造函数提供了略微方便的语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>(name) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\">    &#125;</div><div class=\"line\">    describe() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">'Person called '</span>+<span class=\"keyword\">this</span>.name;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"继承类\"><a href=\"#继承类\" class=\"headerlink\" title=\"继承类\"></a>继承类</h3><p>在 ES5 中实现子类很复杂，尤其是要指向父类构造函数和父类属性。下面是一种比较正规的创建 <code>Person</code> 的子构造器 <code>Employee</code> 的方式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Employee</span>(<span class=\"params\">name, title</span>) </span>&#123;</div><div class=\"line\">    Person.call(<span class=\"keyword\">this</span>, name); <span class=\"comment\">// super(name)</span></div><div class=\"line\">    <span class=\"keyword\">this</span>.title = title;</div><div class=\"line\">&#125;</div><div class=\"line\">Employee.prototype = <span class=\"built_in\">Object</span>.create(Person.prototype);</div><div class=\"line\">Employee.prototype.constructor = Employee;</div><div class=\"line\">Employee.prototype.describe = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> Person.prototype.describe.call(<span class=\"keyword\">this</span>) <span class=\"comment\">// super.describe()</span></div><div class=\"line\">           + <span class=\"string\">' ('</span> + <span class=\"keyword\">this</span>.title + <span class=\"string\">')'</span>;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>ES6 内置支持子类继承，使用 extends 子句：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Employee</span> <span class=\"keyword\">extends</span> <span class=\"title\">Person</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>(name, title) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(name);</div><div class=\"line\">        <span class=\"keyword\">this</span>.title = title;</div><div class=\"line\">    &#125;</div><div class=\"line\">    describe() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.describe() + <span class=\"string\">' ('</span> + <span class=\"keyword\">this</span>.title + <span class=\"string\">')'</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从自定义错误构造函数到-Error-子类\"><a href=\"#从自定义错误构造函数到-Error-子类\" class=\"headerlink\" title=\"从自定义错误构造函数到 Error 子类\"></a>从自定义错误构造函数到 Error 子类</h2><p>在 ES5 中，不可能内置构造器的继承（除了 Error ）。下面的代码展示了一种继承的方式，并赋予了构造函数 MyError 一些重要的特性，比如堆栈跟踪：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">MyError</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// Use Error as a function</span></div><div class=\"line\">    <span class=\"keyword\">var</span> superInstance = <span class=\"built_in\">Error</span>.apply(<span class=\"literal\">null</span>, <span class=\"built_in\">arguments</span>);</div><div class=\"line\">    copyOwnPropertiesFrom(<span class=\"keyword\">this</span>, superInstance);</div><div class=\"line\">&#125;</div><div class=\"line\">MyError.prototype = <span class=\"built_in\">Object</span>.create(<span class=\"built_in\">Error</span>.prototype);</div><div class=\"line\">MyError.prototype.constructor = MyError;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，所有内置的构造函数都可以被继承，这就是为什么下面的代码实现了在 ES5 中只能模拟的功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyError</span> <span class=\"keyword\">extends</span> <span class=\"title\">Error</span> </span>&#123;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从对象字面量中的函数表达式到方法定义\"><a href=\"#从对象字面量中的函数表达式到方法定义\" class=\"headerlink\" title=\"从对象字面量中的函数表达式到方法定义\"></a>从对象字面量中的函数表达式到方法定义</h2><p>在 JavaScript 中，方法就是值为函数的属性。</p>\n<p>在 ES5 对象字面量中，方法以类似于其他属性的方式创建。属性值通过函数表达式提供。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> obj = &#123;</div><div class=\"line\">    <span class=\"attr\">foo</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">bar</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.foo();</div><div class=\"line\">    &#125;, <span class=\"comment\">// trailing comma is legal in ES5</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ES6 有<em>方法定义</em>，一种创建方法的特殊语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123;</div><div class=\"line\">    foo() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;,</div><div class=\"line\">    bar() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.foo();</div><div class=\"line\">    &#125;,</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从对象到-Map\"><a href=\"#从对象到-Map\" class=\"headerlink\" title=\"从对象到 Map\"></a>从对象到 Map</h2><p>把语言结构 <em>object</em> 用作字符串到任意值的映射（一种数据结构）是 JavaScript 中一直以来的一种替代解决方案。实现这种影射最安全的方式就是创建一个 prototype 为 null 的对象，然后你还得确保没有键名会是 <code>__proto__</code> ，因为这个键名在很多 JavaScript 引擎中都会触发特殊的功能。</p>\n<p>下面的 ES5 代码包含了函数 <code>countWords</code> ，该函数将对象 <code>dict</code> 用作一个 map ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">countWords</span>(<span class=\"params\">word</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> escapedWord = escapeKey(word);</div><div class=\"line\">    <span class=\"keyword\">if</span> (escapedWord <span class=\"keyword\">in</span> dict) &#123;</div><div class=\"line\">        dict[escapedWord]++;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        dict[escapedWord] = <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">escapeKey</span>(<span class=\"params\">key</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (key.indexOf(<span class=\"string\">'__proto__'</span>) === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> key+<span class=\"string\">'%'</span>;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> key;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以使用内置的数据结构 Map ，并且不需要转义键名。不过有一个缺点，对 map 中的值进行自增操作变得更不方便了。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> map = <span class=\"keyword\">new</span> <span class=\"built_in\">Map</span>();</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">countWords</span>(<span class=\"params\">word</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">let</span> count = map.get(word) || <span class=\"number\">0</span>;</div><div class=\"line\">    map.set(word, count + <span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>map 的另一个优点是可以用任何值作为键，而不仅仅是字符串。</p>\n<h2 id=\"从-CommonJS-模块到-ES6-模块\"><a href=\"#从-CommonJS-模块到-ES6-模块\" class=\"headerlink\" title=\"从 CommonJS 模块到 ES6 模块\"></a>从 CommonJS 模块到 ES6 模块</h2><p>直到 ES5 ，基于 AMD 语法或者 CommonJS 语法的模块系统才几乎替代了手写的解决方案（比如<a href=\"http://christianheilmann.com/2007/08/22/again-with-the-module-pattern-reveal-something-to-the-world/\" target=\"_blank\" rel=\"external\">暴露的模块方式</a>）。</p>\n<p>ES6 内置支持模块。但是，目前还没有 JavaScript 引擎原生支持。但是像 browserfy 、 webpack 或者 jspm 这些工具让你能够使用 ES6 语法来创建模块，从而使你写的代码不会过时。</p>\n<h3 id=\"导出多个值\"><a href=\"#导出多个值\" class=\"headerlink\" title=\"导出多个值\"></a>导出多个值</h3><p>在 CommonJS 里，像下面这样导出多个实体：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ lib.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> sqrt = <span class=\"built_in\">Math</span>.sqrt;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">square</span>(<span class=\"params\">x</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> x * x;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">diag</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> sqrt(square(x) + square(y));</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</div><div class=\"line\">    <span class=\"attr\">sqrt</span>: sqrt,</div><div class=\"line\">    <span class=\"attr\">square</span>: square,</div><div class=\"line\">    <span class=\"attr\">diag</span>: diag,</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> square = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>).square;</div><div class=\"line\"><span class=\"keyword\">var</span> diag = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>).diag;</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>相应地，你可以引入整个模块为一个对象，然后通过这个对象访问 <code>square</code> 和 <code>diag</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ main2.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> lib = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>);</div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>在 ES6 中，多个导出值被称为<em>命名导出</em>，像这样处理：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ lib.js ------</span></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> sqrt = <span class=\"built_in\">Math</span>.sqrt;</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">square</span>(<span class=\"params\">x</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> x * x;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">diag</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> sqrt(square(x) + square(y));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; square, diag &#125; <span class=\"keyword\">from</span> <span class=\"string\">'lib'</span>;</div><div class=\"line\"><span class=\"built_in\">console</span>.log(square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>引入模块为对象的语法就像下面这样（行 A ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ main2.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> lib <span class=\"keyword\">from</span> <span class=\"string\">'lib'</span>; <span class=\"comment\">// (A)</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<h3 id=\"导出一个值\"><a href=\"#导出一个值\" class=\"headerlink\" title=\"导出一个值\"></a>导出一个值</h3><p>Node.js 使用了 CommonJS 的模块方案，允许通过 <code>module.exports</code> 在模块中导出一个值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ myFunc.js ------</span></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; ··· &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> myFunc = <span class=\"built_in\">require</span>(<span class=\"string\">'myFunc'</span>);</div><div class=\"line\">myFunc();</div></pre></td></tr></table></figure>\n<p>在 ES6 中， <code>export default</code> 完成同样的功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ myFunc.js ------</span></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; ··· &#125; <span class=\"comment\">// no semicolon!</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> myFunc <span class=\"keyword\">from</span> <span class=\"string\">'myFunc'</span>;</div><div class=\"line\">myFunc();</div></pre></td></tr></table></figure>\n","excerpt":"<p>本文内容：</p>\n<ul>\n<li>讲解了如何使用交互式的方式体验 ES6 。</li>\n<li>列举了容易被人接受的 ES6 特性，附带这些特性在 ES5 中的实现方式。</li>\n</ul>","more":"<h2 id=\"体验-ECMAScript-6\"><a href=\"#体验-ECMAScript-6\" class=\"headerlink\" title=\"体验 ECMAScript 6\"></a>体验 ECMAScript 6</h2><p>有三种简单的方式可以运行 ES6 代码：</p>\n<ul>\n<li>1、 Web 浏览器：使用<a href=\"http://babeljs.io/repl/\">在线的 Babel REPL </a>，这是一个交互式的工具，将 ES6 代码编译成 ES5 代码。采用这种方式的话就不用安装任何东西。</li>\n<li>2、命令行：使用 <code>babel-node</code> ，一个 Node.js 可执行程序的版本，认识 ES6 代码（在内部会编译成 ES5 代码）。可以通过 npm 安装。</li>\n<li>3、各种 JavaScript 引擎：查询<a href=\"https://kangax.github.io/compat-table/es6/\"> kangax 的 ES6 兼容表格</a>，可以找到本地支持 ES6 的引擎。</li>\n</ul>\n<p>下面将会给出更多关于选项1和2的内容。</p>\n<h3 id=\"Babel-REPL\"><a href=\"#Babel-REPL\" class=\"headerlink\" title=\"Babel REPL\"></a>Babel REPL</h3><p>Babel REPL 有四个主要部分：</p>\n<ul>\n<li>左上角部分包含 ES6 源码。</li>\n<li>左下角部分显示 ES6 代码中发现的语法错误。</li>\n<li>右上角部分包含 ES6 代码编译成的 ES5 代码。</li>\n<li>右下角部分展示通过 <code>console.log()</code> 输出的内容。</li>\n</ul>\n<p><img src=\"../images/11.jpg\" alt=\"\"></p>\n<h3 id=\"babel-node\"><a href=\"#babel-node\" class=\"headerlink\" title=\"babel-node\"></a>babel-node</h3><p><code>babel-node</code> 可执行程序可以通过 npm 安装：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">npm install --global babel</div></pre></td></tr></table></figure>\n<p>你可以像使用可执行程序 <code>node</code> 一样使用 <code>babel-node</code> 。类似于 <code>node</code> ，像这样启动一个交互式的 REPL ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">babel-node</div></pre></td></tr></table></figure>\n<p>一旦进入该 REPL ，你就可以执行 ES6 代码了：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; let arr = [1, 2, 3];</div><div class=\"line\">&gt; arr.map(x =&gt; x * x)</div><div class=\"line\">[ 1, 4, 9 ]</div></pre></td></tr></table></figure>\n<p>注意 <a href=\"https://github.com/babel/babel/issues/1741\">babel-node 目前还不支持多行输入</a>。</p>\n<p>Babel 官网有<a href=\"http://babeljs.io/docs/usage/cli/\">更多关于 Babel 命令行工具的信息</a>。</p>\n<p>本文接下来的部分描述了易于接受的 ES6 特性。</p>\n<h2 id=\"从-var-到-let-const\"><a href=\"#从-var-到-let-const\" class=\"headerlink\" title=\"从 var 到 let/const\"></a>从 var 到 let/const</h2><p>ES6 有两种新的声明变量的方式：</p>\n<ul>\n<li><code>let</code> （大致）相当于 <code>var</code> 的一个块级范围版本。</li>\n<li><code>const</code> 类似于 <code>let</code> ，但是用于创建<em>常量</em>：值不能被改变的变量。</li>\n</ul>\n<p>一般情况下，你可以用 <code>let</code> 或者 <code>const</code> 替换每一个 <code>var</code> 。但是不能盲目地这么做，因为不同类型的变量作用范围可能会改变代码的运行流程。看下面的用 ES5 写的例子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> x = <span class=\"built_in\">Math</span>.random(); <span class=\"comment\">// (A) scope: whole function</span></div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x; <span class=\"comment\">// accesses the x from line A</span></div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// undefined</span></div></pre></td></tr></table></figure>\n<p><code>func()</code> 返回 <code>undefined</code> ，这可能会比较奇怪。如果重写一下这段代码，让其更清楚地展现出来实际上发生了什么，你就明白了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> x;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        x = <span class=\"built_in\">Math</span>.random();</div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x;</div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// undefined</span></div></pre></td></tr></table></figure>\n<p>如果你在最初的版本中用 <code>let</code> 替换 <code>var</code> ，将会得到不一样的结果：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> x = <span class=\"number\">3</span>;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">func</span>(<span class=\"params\">randomize</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (randomize) &#123;</div><div class=\"line\">        <span class=\"keyword\">let</span> x = <span class=\"built_in\">Math</span>.random();</div><div class=\"line\">        <span class=\"keyword\">return</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> x;</div><div class=\"line\">&#125;</div><div class=\"line\">func(<span class=\"literal\">false</span>); <span class=\"comment\">// 3</span></div></pre></td></tr></table></figure>\n<p>因此，盲目地用 <code>let</code> 或者 <code>const</code> 替换 <code>var</code> 很危险。我的建议是：</p>\n<ul>\n<li>仅在新的代码中使用 <code>let</code>/<code>const</code> 。</li>\n<li>不动老的代码，或者小心地重构老的代码。</li>\n</ul>\n<h2 id=\"从-IIFE-到块级作用域\"><a href=\"#从-IIFE-到块级作用域\" class=\"headerlink\" title=\"从 IIFE 到块级作用域\"></a>从 IIFE 到块级作用域</h2><p>在 ES5 中，你必须使用 IIFE 来使变量保持本地化：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;  <span class=\"comment\">// open IIFE</span></div><div class=\"line\">    <span class=\"keyword\">var</span> tmp = ···;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;());  <span class=\"comment\">// close IIFE</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(tmp); <span class=\"comment\">// ReferenceError</span></div></pre></td></tr></table></figure>\n<p>在 ECMAScript 6 中，你可以简单地使用一个块和一个 <code>let</code> 声明：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;  <span class=\"comment\">// open block</span></div><div class=\"line\">    <span class=\"keyword\">let</span> tmp = ···;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;  <span class=\"comment\">// close block</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(tmp); <span class=\"comment\">// ReferenceError</span></div></pre></td></tr></table></figure>\n<h2 id=\"从拼接字符串到模板字面量\"><a href=\"#从拼接字符串到模板字面量\" class=\"headerlink\" title=\"从拼接字符串到模板字面量\"></a>从拼接字符串到模板字面量</h2><p>在 ES6 中， JavaScript 终于拥有了字面量式的字符串插值和多行字符串功能。</p>\n<h3 id=\"字符串插值\"><a href=\"#字符串插值\" class=\"headerlink\" title=\"字符串插值\"></a>字符串插值</h3><p>在 ES5 中，通过拼接字符串片段和变量值的方式来把变量值插入到字符串中：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">printCoord</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'('</span>+x+<span class=\"string\">', '</span>+y+<span class=\"string\">')'</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以通过模板字面量的方式实现字符串插值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">printCoord</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">`(<span class=\"subst\">$&#123;x&#125;</span>, <span class=\"subst\">$&#123;y&#125;</span>)`</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"多行字符串\"><a href=\"#多行字符串\" class=\"headerlink\" title=\"多行字符串\"></a>多行字符串</h3><p>模板字面量也可以用于表示多行字符串。</p>\n<p>例如，下面是在 ES5 中表示多行文本的样子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> HTML5_SKELETON =</div><div class=\"line\">    <span class=\"string\">'&lt;!doctype html&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;html&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;head&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'    &lt;meta charset=\"UTF-8\"&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'    &lt;title&gt;&lt;/title&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/head&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;body&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/body&gt;\\n'</span> +</div><div class=\"line\">    <span class=\"string\">'&lt;/html&gt;\\n'</span>;</div></pre></td></tr></table></figure>\n<p>如果你通过反斜线转义换行符，代码看起来就漂亮一点了（但是仍然需要显示地添加新行）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> HTML5_SKELETON = <span class=\"string\">'\\</div><div class=\"line\">    &lt;!doctype html&gt;\\n\\</div><div class=\"line\">    &lt;html&gt;\\n\\</div><div class=\"line\">    &lt;head&gt;\\n\\</div><div class=\"line\">        &lt;meta charset=\"UTF-8\"&gt;\\n\\</div><div class=\"line\">        &lt;title&gt;&lt;/title&gt;\\n\\</div><div class=\"line\">    &lt;/head&gt;\\n\\</div><div class=\"line\">    &lt;body&gt;\\n\\</div><div class=\"line\">    &lt;/body&gt;\\n\\</div><div class=\"line\">    &lt;/html&gt;'</span>;</div></pre></td></tr></table></figure>\n<p>ES6 模板字面量可以跨越多行：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> HTML5_SKELETON = <span class=\"string\">`</div><div class=\"line\">    &lt;!doctype html&gt;</div><div class=\"line\">    &lt;html&gt;</div><div class=\"line\">    &lt;head&gt;</div><div class=\"line\">        &lt;meta charset=\"UTF-8\"&gt;</div><div class=\"line\">        &lt;title&gt;&lt;/title&gt;</div><div class=\"line\">    &lt;/head&gt;</div><div class=\"line\">    &lt;body&gt;</div><div class=\"line\">    &lt;/body&gt;</div><div class=\"line\">    &lt;/html&gt;`</span>;</div></pre></td></tr></table></figure>\n<p>（这些例子包含的空格数是不一样的，但是在此处并不重要。）</p>\n<h2 id=\"从函数表达式到箭头函数\"><a href=\"#从函数表达式到箭头函数\" class=\"headerlink\" title=\"从函数表达式到箭头函数\"></a>从函数表达式到箭头函数</h2><p>在当前的 ES5 代码中，在函数表达式中必须小心使用 <code>this</code> 。在下面的例子中，我创建了辅助变量 <code>_this</code> （行 A ），以便在行 B 能够访问到 UiComponent 的 <code>this</code> 。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">UiComponent</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> _this = <span class=\"keyword\">this</span>; <span class=\"comment\">// (A)</span></div><div class=\"line\">    <span class=\"keyword\">var</span> button = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'myButton'</span>);</div><div class=\"line\">    button.addEventListener(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'CLICK'</span>);</div><div class=\"line\">        _this.handleClick(); <span class=\"comment\">// (B)</span></div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\">UiComponent.prototype.handleClick = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以使用箭头函数，它不会改变 <code>this</code> 指向（行 A ，<em>词法范围的 this</em> ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UiComponent</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">let</span> button = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'myButton'</span>);</div><div class=\"line\">        button.addEventListener(<span class=\"string\">'click'</span>, () =&gt; &#123;</div><div class=\"line\">            <span class=\"built_in\">console</span>.log(<span class=\"string\">'CLICK'</span>);</div><div class=\"line\">            <span class=\"keyword\">this</span>.handleClick(); <span class=\"comment\">// (A)</span></div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    handleClick() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>箭头函数对于短小的仅返回表达式值的回调函数来说尤其方便。</p>\n<p>在 ES5 中，这样的回调函数相当啰嗦：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> squares = arr.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">x</span>) </span>&#123; <span class=\"keyword\">return</span> x * x &#125;);</div></pre></td></tr></table></figure>\n<p>在 ES6 中，箭头函数简洁很多：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> squares = arr.map(<span class=\"function\"><span class=\"params\">x</span> =&gt;</span> x * x);</div></pre></td></tr></table></figure>\n<p>在定义参数的时候，如果参数是一个标识符，甚至可以省略括号。所以： <code>(x) =&gt; x * x</code> 和 <code>x =&gt; x * x</code> 都是合法的。</p>\n<h2 id=\"处理多个返回值\"><a href=\"#处理多个返回值\" class=\"headerlink\" title=\"处理多个返回值\"></a>处理多个返回值</h2><p>一些函数或者方法通过数组或对象返回多个值。在 ES5 中，如果想要访问这些值，总是需要创建一些中间变量。在 ES6 中，可以借助于解构来避免中间变量。</p>\n<h3 id=\"借助数组返回多个值\"><a href=\"#借助数组返回多个值\" class=\"headerlink\" title=\"借助数组返回多个值\"></a>借助数组返回多个值</h3><p><code>exec()</code> 通过类数组对象返回捕获到的匹配组。在 ES5 中，需要一个中间变量（下面例子中的 <code>matchObj</code> ），即便是你仅对匹配组感兴趣：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> matchObj =</div><div class=\"line\">    <span class=\"regexp\">/^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/</span></div><div class=\"line\">    .exec(<span class=\"string\">'2999-12-31'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> year = matchObj[<span class=\"number\">1</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> month = matchObj[<span class=\"number\">2</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> day = matchObj[<span class=\"number\">3</span>];</div></pre></td></tr></table></figure>\n<p>在 ES6 中，解构使代码更简单：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> [, year, month, day] =</div><div class=\"line\">    <span class=\"regexp\">/^(\\d\\d\\d\\d)-(\\d\\d)-(\\d\\d)$/</span></div><div class=\"line\">    .exec(<span class=\"string\">'2999-12-31'</span>);</div></pre></td></tr></table></figure>\n<p>左侧数组模式开始处为空，可以跳过右侧索引为0的数组元素。</p>\n<h3 id=\"借助对象返回多个值\"><a href=\"#借助对象返回多个值\" class=\"headerlink\" title=\"借助对象返回多个值\"></a>借助对象返回多个值</h3><p>方法 <code>Object.getOwnPropertyDescriptor()</code> 返回一个<em>属性描述符</em>，一个包含多个属性值的对象。</p>\n<p>在 ES5 中，即便你仅对一个对象的属性感兴趣，仍然需要一个中间变量（下例中的 <code>propDesc</code> ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> obj = &#123; <span class=\"attr\">foo</span>: <span class=\"number\">123</span> &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> propDesc = <span class=\"built_in\">Object</span>.getOwnPropertyDescriptor(obj, <span class=\"string\">'foo'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> writable = propDesc.writable;</div><div class=\"line\"><span class=\"keyword\">var</span> configurable = propDesc.configurable;</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(writable, configurable); <span class=\"comment\">// true true</span></div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以使用解构：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123; <span class=\"attr\">foo</span>: <span class=\"number\">123</span> &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> &#123;writable, configurable&#125; =</div><div class=\"line\">    <span class=\"built_in\">Object</span>.getOwnPropertyDescriptor(obj, <span class=\"string\">'foo'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(writable, configurable); <span class=\"comment\">// true true</span></div></pre></td></tr></table></figure>\n<p><code>{writable, configurable}</code> 是下面内容的缩写：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123; <span class=\"attr\">writable</span>: writable, <span class=\"attr\">configurable</span>: configurable &#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从-for-到-forEach-，再到-for-of\"><a href=\"#从-for-到-forEach-，再到-for-of\" class=\"headerlink\" title=\"从 for 到 forEach() ，再到 for-of\"></a>从 for 到 forEach() ，再到 for-of</h2><p>在 ES5 之前，可以选择使用数组方法 <code>forEach()</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">arr.forEach(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">elem</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(elem);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p><code>for</code> 循环的优点在于可以中断， <code>forEach()</code> 的优点在于简洁。</p>\n<p>在 ES6 中， <code>for-of</code> 循环结合了两种优点：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> elem <span class=\"keyword\">of</span> arr) &#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(elem);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果想访问每个元素的索引和值， <code>for-of</code> 也可以做到，通过新的数组方法 <code>entries()</code> 和解构：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> [index, elem] <span class=\"keyword\">of</span> arr.entries()) &#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(index+<span class=\"string\">'. '</span>+elem);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"处理参数默认值\"><a href=\"#处理参数默认值\" class=\"headerlink\" title=\"处理参数默认值\"></a>处理参数默认值</h2><p>在 ES5 中，为参数指定默认值的代码像这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    x = x || <span class=\"number\">0</span>;</div><div class=\"line\">    y = y || <span class=\"number\">0</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ES6 有更漂亮的语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">foo</span>(<span class=\"params\">x=<span class=\"number\">0</span>, y=<span class=\"number\">0</span></span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>一个额外的好处就是，在 ES6 中，参数默认值只会被 <code>undefined</code> 触发，而在之前的 ES5 代码中，任何假值都会出发默认值。</p>\n<h2 id=\"处理命名参数\"><a href=\"#处理命名参数\" class=\"headerlink\" title=\"处理命名参数\"></a>处理命名参数</h2><p>在 JavaScript 中使用命名参数的一种通常做法是通过对象字面量的方式（所谓的<em>可选对象模式</em>）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">selectEntries(&#123; <span class=\"attr\">start</span>: <span class=\"number\">0</span>, <span class=\"attr\">end</span>: <span class=\"number\">-1</span> &#125;);</div></pre></td></tr></table></figure>\n<p>这种方式的两个优点是：代码可读性更好，并且可以更容易地省略任何参数。</p>\n<p>在 ES5 中，你可以这样实现 <code>selectEntries()</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">options</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> start = options.start || <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> end = options.end || <span class=\"number\">-1</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> step = options.step || <span class=\"number\">1</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，你可以在参数定义中使用解构，代码看起来就更简单了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">&#123; start=<span class=\"number\">0</span>, end=<span class=\"number\">-1</span>, step=<span class=\"number\">1</span> &#125;</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"可选参数\"><a href=\"#可选参数\" class=\"headerlink\" title=\"可选参数\"></a>可选参数</h3><p>在 ES5 中，要让参数 <code>options</code> 变得可选，会添加行 A 所示的代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">options</span>) </span>&#123;</div><div class=\"line\">    options = options || &#123;&#125;; <span class=\"comment\">// (A)</span></div><div class=\"line\">    <span class=\"keyword\">var</span> start = options.start || <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> end = options.end || <span class=\"number\">-1</span>;</div><div class=\"line\">    <span class=\"keyword\">var</span> step = options.step || <span class=\"number\">1</span>;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以用 <code>{}</code> 指定参数的默认值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">selectEntries</span>(<span class=\"params\">&#123; start=<span class=\"number\">0</span>, end=<span class=\"number\">-1</span>, step=<span class=\"number\">1</span> &#125; = &#123;&#125;</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从-arguments-到剩余参数\"><a href=\"#从-arguments-到剩余参数\" class=\"headerlink\" title=\"从 arguments 到剩余参数\"></a>从 arguments 到剩余参数</h2><p>在 ES5 中，如果想要函数（或者方法）接收任意数量的参数，就必须使用特殊变量 <code>arguments</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">logAllArguments</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i=<span class=\"number\">0</span>; i &lt; <span class=\"built_in\">arguments</span>.length; i++) &#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"built_in\">arguments</span>[i]);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以通过 <code>...</code> 操作符声明一个剩余参数（下例中的 args ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">logAllArguments</span>(<span class=\"params\">...args</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> arg <span class=\"keyword\">of</span> args) &#123;</div><div class=\"line\">        <span class=\"built_in\">console</span>.log(arg);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>如果仅对尾部的参数感兴趣，剩余参数看起来就更漂亮了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">format</span>(<span class=\"params\">pattern, ...args</span>) </span>&#123;</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES5 中处理这种场景很笨拙：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">format</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> pattern = <span class=\"built_in\">arguments</span>[<span class=\"number\">0</span>];</div><div class=\"line\">    <span class=\"keyword\">var</span> args = <span class=\"built_in\">arguments</span>.slice(<span class=\"number\">1</span>);</div><div class=\"line\">    ···</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>剩余参数让代码可读性更好：你可以从参数定义上面看出来一个函数是否有不定数量的参数。</p>\n<h2 id=\"从-apply-到扩展操作符（-…-）\"><a href=\"#从-apply-到扩展操作符（-…-）\" class=\"headerlink\" title=\"从 apply() 到扩展操作符（ … ）\"></a>从 apply() 到扩展操作符（ … ）</h2><p>在 ES5 中，用 <code>apply()</code> 将数组转换成参数。 ES6 有扩展操作符可以达到这个目的。</p>\n<h3 id=\"4-11-1-Math-max\"><a href=\"#4-11-1-Math-max\" class=\"headerlink\" title=\"4.11.1 Math.max()\"></a>4.11.1 Math.max()</h3><p>ES5 - apply() ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; Math.max.apply(null, [-1, 5, 11, 3])</div><div class=\"line\">11</div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; Math.max(...[-1, 5, 11, 3])</div><div class=\"line\">11</div></pre></td></tr></table></figure>\n<h3 id=\"Array-prototype-push\"><a href=\"#Array-prototype-push\" class=\"headerlink\" title=\"Array.prototype.push()\"></a>Array.prototype.push()</h3><p>ES5 - apply() ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr2 = [<span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>];</div><div class=\"line\"></div><div class=\"line\">arr1.push.apply(arr1, arr2);</div><div class=\"line\">    <span class=\"comment\">// arr1 is now ['a', 'b', 'c', 'd']</span></div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<p>let arr1 = [‘a’, ‘b’];<br>let arr2 = [‘c’, ‘d’];</p>\n<p>arr1.push(…arr2);<br>    // arr1 is now [‘a’, ‘b’, ‘c’, ‘d’]</p>\n<h2 id=\"从-concat-到扩展操作符（-…-）\"><a href=\"#从-concat-到扩展操作符（-…-）\" class=\"headerlink\" title=\"从 concat() 到扩展操作符（ … ）\"></a>从 concat() 到扩展操作符（ … ）</h2><p>扩展操作符也能将操作数的内容转换成数组元素，也就是说它实现数组方法 <code>concat()</code> 的功能。</p>\n<p>ES5 - concat() ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr2 = [<span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">var</span> arr3 = [<span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(arr1.concat(arr2, arr3));</div><div class=\"line\">    <span class=\"comment\">// [ 'a', 'b', 'c', 'd', 'e' ]</span></div></pre></td></tr></table></figure>\n<p>ES6 - 扩展操作符：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> arr1 = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> arr2 = [<span class=\"string\">'c'</span>];</div><div class=\"line\"><span class=\"keyword\">let</span> arr3 = [<span class=\"string\">'d'</span>, <span class=\"string\">'e'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log([...arr1, ...arr2, ...arr3]);</div><div class=\"line\">    <span class=\"comment\">// [ 'a', 'b', 'c', 'd', 'e' ]</span></div></pre></td></tr></table></figure>\n<h2 id=\"从构造函数到类\"><a href=\"#从构造函数到类\" class=\"headerlink\" title=\"从构造函数到类\"></a>从构造函数到类</h2><p>相对于构造函数来说，ES6 类是一种更加方便的语法。</p>\n<h3 id=\"基类\"><a href=\"#基类\" class=\"headerlink\" title=\"基类\"></a>基类</h3><p>在 ES5 中，直接实现构造函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Person</span>(<span class=\"params\">name</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\">&#125;</div><div class=\"line\">Person.prototype.describe = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'Person called '</span>+<span class=\"keyword\">this</span>.name;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，类为构造函数提供了略微方便的语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>(name) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.name = name;</div><div class=\"line\">    &#125;</div><div class=\"line\">    describe() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">'Person called '</span>+<span class=\"keyword\">this</span>.name;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"继承类\"><a href=\"#继承类\" class=\"headerlink\" title=\"继承类\"></a>继承类</h3><p>在 ES5 中实现子类很复杂，尤其是要指向父类构造函数和父类属性。下面是一种比较正规的创建 <code>Person</code> 的子构造器 <code>Employee</code> 的方式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Employee</span>(<span class=\"params\">name, title</span>) </span>&#123;</div><div class=\"line\">    Person.call(<span class=\"keyword\">this</span>, name); <span class=\"comment\">// super(name)</span></div><div class=\"line\">    <span class=\"keyword\">this</span>.title = title;</div><div class=\"line\">&#125;</div><div class=\"line\">Employee.prototype = <span class=\"built_in\">Object</span>.create(Person.prototype);</div><div class=\"line\">Employee.prototype.constructor = Employee;</div><div class=\"line\">Employee.prototype.describe = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> Person.prototype.describe.call(<span class=\"keyword\">this</span>) <span class=\"comment\">// super.describe()</span></div><div class=\"line\">           + <span class=\"string\">' ('</span> + <span class=\"keyword\">this</span>.title + <span class=\"string\">')'</span>;</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>ES6 内置支持子类继承，使用 extends 子句：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Employee</span> <span class=\"keyword\">extends</span> <span class=\"title\">Person</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>(name, title) &#123;</div><div class=\"line\">        <span class=\"keyword\">super</span>(name);</div><div class=\"line\">        <span class=\"keyword\">this</span>.title = title;</div><div class=\"line\">    &#125;</div><div class=\"line\">    describe() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">super</span>.describe() + <span class=\"string\">' ('</span> + <span class=\"keyword\">this</span>.title + <span class=\"string\">')'</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从自定义错误构造函数到-Error-子类\"><a href=\"#从自定义错误构造函数到-Error-子类\" class=\"headerlink\" title=\"从自定义错误构造函数到 Error 子类\"></a>从自定义错误构造函数到 Error 子类</h2><p>在 ES5 中，不可能内置构造器的继承（除了 Error ）。下面的代码展示了一种继承的方式，并赋予了构造函数 MyError 一些重要的特性，比如堆栈跟踪：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">MyError</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// Use Error as a function</span></div><div class=\"line\">    <span class=\"keyword\">var</span> superInstance = <span class=\"built_in\">Error</span>.apply(<span class=\"literal\">null</span>, <span class=\"built_in\">arguments</span>);</div><div class=\"line\">    copyOwnPropertiesFrom(<span class=\"keyword\">this</span>, superInstance);</div><div class=\"line\">&#125;</div><div class=\"line\">MyError.prototype = <span class=\"built_in\">Object</span>.create(<span class=\"built_in\">Error</span>.prototype);</div><div class=\"line\">MyError.prototype.constructor = MyError;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，所有内置的构造函数都可以被继承，这就是为什么下面的代码实现了在 ES5 中只能模拟的功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyError</span> <span class=\"keyword\">extends</span> <span class=\"title\">Error</span> </span>&#123;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从对象字面量中的函数表达式到方法定义\"><a href=\"#从对象字面量中的函数表达式到方法定义\" class=\"headerlink\" title=\"从对象字面量中的函数表达式到方法定义\"></a>从对象字面量中的函数表达式到方法定义</h2><p>在 JavaScript 中，方法就是值为函数的属性。</p>\n<p>在 ES5 对象字面量中，方法以类似于其他属性的方式创建。属性值通过函数表达式提供。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> obj = &#123;</div><div class=\"line\">    <span class=\"attr\">foo</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">bar</span>: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.foo();</div><div class=\"line\">    &#125;, <span class=\"comment\">// trailing comma is legal in ES5</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>ES6 有<em>方法定义</em>，一种创建方法的特殊语法：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123;</div><div class=\"line\">    foo() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;,</div><div class=\"line\">    bar() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.foo();</div><div class=\"line\">    &#125;,</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"从对象到-Map\"><a href=\"#从对象到-Map\" class=\"headerlink\" title=\"从对象到 Map\"></a>从对象到 Map</h2><p>把语言结构 <em>object</em> 用作字符串到任意值的映射（一种数据结构）是 JavaScript 中一直以来的一种替代解决方案。实现这种影射最安全的方式就是创建一个 prototype 为 null 的对象，然后你还得确保没有键名会是 <code>__proto__</code> ，因为这个键名在很多 JavaScript 引擎中都会触发特殊的功能。</p>\n<p>下面的 ES5 代码包含了函数 <code>countWords</code> ，该函数将对象 <code>dict</code> 用作一个 map ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> dict = <span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>);</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">countWords</span>(<span class=\"params\">word</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> escapedWord = escapeKey(word);</div><div class=\"line\">    <span class=\"keyword\">if</span> (escapedWord <span class=\"keyword\">in</span> dict) &#123;</div><div class=\"line\">        dict[escapedWord]++;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        dict[escapedWord] = <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">escapeKey</span>(<span class=\"params\">key</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (key.indexOf(<span class=\"string\">'__proto__'</span>) === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> key+<span class=\"string\">'%'</span>;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> key;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 ES6 中，可以使用内置的数据结构 Map ，并且不需要转义键名。不过有一个缺点，对 map 中的值进行自增操作变得更不方便了。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> map = <span class=\"keyword\">new</span> <span class=\"built_in\">Map</span>();</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">countWords</span>(<span class=\"params\">word</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">let</span> count = map.get(word) || <span class=\"number\">0</span>;</div><div class=\"line\">    map.set(word, count + <span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>map 的另一个优点是可以用任何值作为键，而不仅仅是字符串。</p>\n<h2 id=\"从-CommonJS-模块到-ES6-模块\"><a href=\"#从-CommonJS-模块到-ES6-模块\" class=\"headerlink\" title=\"从 CommonJS 模块到 ES6 模块\"></a>从 CommonJS 模块到 ES6 模块</h2><p>直到 ES5 ，基于 AMD 语法或者 CommonJS 语法的模块系统才几乎替代了手写的解决方案（比如<a href=\"http://christianheilmann.com/2007/08/22/again-with-the-module-pattern-reveal-something-to-the-world/\">暴露的模块方式</a>）。</p>\n<p>ES6 内置支持模块。但是，目前还没有 JavaScript 引擎原生支持。但是像 browserfy 、 webpack 或者 jspm 这些工具让你能够使用 ES6 语法来创建模块，从而使你写的代码不会过时。</p>\n<h3 id=\"导出多个值\"><a href=\"#导出多个值\" class=\"headerlink\" title=\"导出多个值\"></a>导出多个值</h3><p>在 CommonJS 里，像下面这样导出多个实体：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ lib.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> sqrt = <span class=\"built_in\">Math</span>.sqrt;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">square</span>(<span class=\"params\">x</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> x * x;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">diag</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> sqrt(square(x) + square(y));</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</div><div class=\"line\">    <span class=\"attr\">sqrt</span>: sqrt,</div><div class=\"line\">    <span class=\"attr\">square</span>: square,</div><div class=\"line\">    <span class=\"attr\">diag</span>: diag,</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> square = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>).square;</div><div class=\"line\"><span class=\"keyword\">var</span> diag = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>).diag;</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">console</span>.log(square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>相应地，你可以引入整个模块为一个对象，然后通过这个对象访问 <code>square</code> 和 <code>diag</code> ：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ main2.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> lib = <span class=\"built_in\">require</span>(<span class=\"string\">'lib'</span>);</div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>在 ES6 中，多个导出值被称为<em>命名导出</em>，像这样处理：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ lib.js ------</span></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> sqrt = <span class=\"built_in\">Math</span>.sqrt;</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">square</span>(<span class=\"params\">x</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> x * x;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">diag</span>(<span class=\"params\">x, y</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> sqrt(square(x) + square(y));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> &#123; square, diag &#125; <span class=\"keyword\">from</span> <span class=\"string\">'lib'</span>;</div><div class=\"line\"><span class=\"built_in\">console</span>.log(square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<p>引入模块为对象的语法就像下面这样（行 A ）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ main2.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> lib <span class=\"keyword\">from</span> <span class=\"string\">'lib'</span>; <span class=\"comment\">// (A)</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.square(<span class=\"number\">11</span>)); <span class=\"comment\">// 121</span></div><div class=\"line\"><span class=\"built_in\">console</span>.log(lib.diag(<span class=\"number\">4</span>, <span class=\"number\">3</span>)); <span class=\"comment\">// 5</span></div></pre></td></tr></table></figure>\n<h3 id=\"导出一个值\"><a href=\"#导出一个值\" class=\"headerlink\" title=\"导出一个值\"></a>导出一个值</h3><p>Node.js 使用了 CommonJS 的模块方案，允许通过 <code>module.exports</code> 在模块中导出一个值：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ myFunc.js ------</span></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; ··· &#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">var</span> myFunc = <span class=\"built_in\">require</span>(<span class=\"string\">'myFunc'</span>);</div><div class=\"line\">myFunc();</div></pre></td></tr></table></figure>\n<p>在 ES6 中， <code>export default</code> 完成同样的功能：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//------ myFunc.js ------</span></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123; ··· &#125; <span class=\"comment\">// no semicolon!</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------ main1.js ------</span></div><div class=\"line\"><span class=\"keyword\">import</span> myFunc <span class=\"keyword\">from</span> <span class=\"string\">'myFunc'</span>;</div><div class=\"line\">myFunc();</div></pre></td></tr></table></figure>"},{"title":"HTTP请求重发","date":"2016-07-05T16:00:00.000Z","_content":"\nHTTP 协议中，从语义上讲， GET 请求一般是获取服务器端的资源，不会对服务器数据造成副作用，可简单理解为一种“读”操作；而 POST 请求多用于更改（增、删、改）服务器上的资源，会产生一定的副作用。\n\n所以，这样看起来，浏览器是不是就不会因为网络原因啥的自动重发 POST 请求吧？实际上是这样么？\n<!-- more -->\n\n# 起因\n\n最近在对接地图的一个数据录入接口：前端向后端发送一个 CSV 文件，后端将 CSV 文件中的数据解析出来，然后将数据通过地图接口导入到地图数据库。由于地图提供的接口有点怪异，批量导入数据的接口有一些问题，只能使用单条导入接口，所以在这里， CSV 文件里面有多少条数据，就会访问多少次地图的接口。\n\n虽然有点坑，不过问题究竟是解决了，于是就这样上线了。\n\n天有不测风云，遇到一个客户，一下要导入上千条数据，后端这样串行地一条一条去导入，很轻易地就花了好几分钟。而且还遇到一个诡异的现象：每条数据都导入了两次！\n\n# 分析\n\n凭借多年的前端开发经验（不要脸了），立马大胆猜测，浏览器发送了两次请求。\n\n于是先到谷歌开发者工具的 Network 标签页检查一下请求，发现此处只记录了一次请求，并且该请求没有响应，好像看不出来什么猫腻。再切换到 chrome://net-internals/ 中看看日志，发现一个 error code ， google 了一下，并没有什么结果，看起来也验证不了猜想。\n\n然后再去找后端同学看看接口日志，是不是访问了两次，后端同学似乎稍微有点不太想打日志重新部署（过程比较麻烦），所以先放弃用这种方式求证。\n\n那用啥求证呢？ Charles 吧。\n\n在 Charles 中一看，发现发了四次请求，每次请求基本上都耗时六十多秒，每次都没有响应内容。\n\n好了，看起来就是浏览器六十秒超时重发请求。\n\n# 深入分析\n\n可以转念一想，这对么？\n\n- 1、 POST 请求就这样轻易地被浏览器超时重发，难道浏览器开发者没考虑过数据重复发送的问题吗？表单 POST 请求手动刷新浏览器的时候都会弹窗提醒用户要不要重复提交数据呢！\n- 2、为啥是六十秒呢？时间这么短吗？想想平时本地断点调试服务器代码的时候，那可是会超时老长时间的，所以这六十秒算个啥呢？\n\n搜一搜往上资料，发现 [HTTP/1.1 的一处规范](https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.4) ：\n\n> If an HTTP/1.1 client sends a request which includes a request body, but which does not include an Expect request-header field with the \"100-continue\" expectation, and if the client is not directly connected to an HTTP/1.1 origin server, and if the client sees the connection close before receiving any status from the server, the client SHOULD retry the request.\n\n大致意思就是说，如果发送一个请求到服务器端，该请求有请求体，但是请求头里面不包含“ 100-continue ”这种东西，并且客户端没有直接连接到原始的 HTTP/1.1 服务器，此时，如果客户端在接收到服务器发送的 HTTP 状态之前发现服务器主动关掉连接，那么客户端应该重试请求。\n\n那看起来好像就是服务器端主动关掉了连接，导致浏览器重新发送请求了。\n\n我们服务器端使用的是 Tomcat ，查一查资料，发现 Tomcat 默认的 connector 超时时间是六十秒，刚好吻合上了。\n\n问题原因找到了，解决起来就轻松了，此处不赘述。\n","source":"_posts/HTTP请求重发.md","raw":"---\ntitle: HTTP请求重发\ndate: 2016-07-06\ntags:\n- HTTP\n---\n\nHTTP 协议中，从语义上讲， GET 请求一般是获取服务器端的资源，不会对服务器数据造成副作用，可简单理解为一种“读”操作；而 POST 请求多用于更改（增、删、改）服务器上的资源，会产生一定的副作用。\n\n所以，这样看起来，浏览器是不是就不会因为网络原因啥的自动重发 POST 请求吧？实际上是这样么？\n<!-- more -->\n\n# 起因\n\n最近在对接地图的一个数据录入接口：前端向后端发送一个 CSV 文件，后端将 CSV 文件中的数据解析出来，然后将数据通过地图接口导入到地图数据库。由于地图提供的接口有点怪异，批量导入数据的接口有一些问题，只能使用单条导入接口，所以在这里， CSV 文件里面有多少条数据，就会访问多少次地图的接口。\n\n虽然有点坑，不过问题究竟是解决了，于是就这样上线了。\n\n天有不测风云，遇到一个客户，一下要导入上千条数据，后端这样串行地一条一条去导入，很轻易地就花了好几分钟。而且还遇到一个诡异的现象：每条数据都导入了两次！\n\n# 分析\n\n凭借多年的前端开发经验（不要脸了），立马大胆猜测，浏览器发送了两次请求。\n\n于是先到谷歌开发者工具的 Network 标签页检查一下请求，发现此处只记录了一次请求，并且该请求没有响应，好像看不出来什么猫腻。再切换到 chrome://net-internals/ 中看看日志，发现一个 error code ， google 了一下，并没有什么结果，看起来也验证不了猜想。\n\n然后再去找后端同学看看接口日志，是不是访问了两次，后端同学似乎稍微有点不太想打日志重新部署（过程比较麻烦），所以先放弃用这种方式求证。\n\n那用啥求证呢？ Charles 吧。\n\n在 Charles 中一看，发现发了四次请求，每次请求基本上都耗时六十多秒，每次都没有响应内容。\n\n好了，看起来就是浏览器六十秒超时重发请求。\n\n# 深入分析\n\n可以转念一想，这对么？\n\n- 1、 POST 请求就这样轻易地被浏览器超时重发，难道浏览器开发者没考虑过数据重复发送的问题吗？表单 POST 请求手动刷新浏览器的时候都会弹窗提醒用户要不要重复提交数据呢！\n- 2、为啥是六十秒呢？时间这么短吗？想想平时本地断点调试服务器代码的时候，那可是会超时老长时间的，所以这六十秒算个啥呢？\n\n搜一搜往上资料，发现 [HTTP/1.1 的一处规范](https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.4) ：\n\n> If an HTTP/1.1 client sends a request which includes a request body, but which does not include an Expect request-header field with the \"100-continue\" expectation, and if the client is not directly connected to an HTTP/1.1 origin server, and if the client sees the connection close before receiving any status from the server, the client SHOULD retry the request.\n\n大致意思就是说，如果发送一个请求到服务器端，该请求有请求体，但是请求头里面不包含“ 100-continue ”这种东西，并且客户端没有直接连接到原始的 HTTP/1.1 服务器，此时，如果客户端在接收到服务器发送的 HTTP 状态之前发现服务器主动关掉连接，那么客户端应该重试请求。\n\n那看起来好像就是服务器端主动关掉了连接，导致浏览器重新发送请求了。\n\n我们服务器端使用的是 Tomcat ，查一查资料，发现 Tomcat 默认的 connector 超时时间是六十秒，刚好吻合上了。\n\n问题原因找到了，解决起来就轻松了，此处不赘述。\n","slug":"HTTP请求重发","published":1,"updated":"2016-07-08T08:07:25.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02a000g0407t0vu1qb8","content":"<p>HTTP 协议中，从语义上讲， GET 请求一般是获取服务器端的资源，不会对服务器数据造成副作用，可简单理解为一种“读”操作；而 POST 请求多用于更改（增、删、改）服务器上的资源，会产生一定的副作用。</p>\n<p>所以，这样看起来，浏览器是不是就不会因为网络原因啥的自动重发 POST 请求吧？实际上是这样么？<br><a id=\"more\"></a></p>\n<h1 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h1><p>最近在对接地图的一个数据录入接口：前端向后端发送一个 CSV 文件，后端将 CSV 文件中的数据解析出来，然后将数据通过地图接口导入到地图数据库。由于地图提供的接口有点怪异，批量导入数据的接口有一些问题，只能使用单条导入接口，所以在这里， CSV 文件里面有多少条数据，就会访问多少次地图的接口。</p>\n<p>虽然有点坑，不过问题究竟是解决了，于是就这样上线了。</p>\n<p>天有不测风云，遇到一个客户，一下要导入上千条数据，后端这样串行地一条一条去导入，很轻易地就花了好几分钟。而且还遇到一个诡异的现象：每条数据都导入了两次！</p>\n<h1 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h1><p>凭借多年的前端开发经验（不要脸了），立马大胆猜测，浏览器发送了两次请求。</p>\n<p>于是先到谷歌开发者工具的 Network 标签页检查一下请求，发现此处只记录了一次请求，并且该请求没有响应，好像看不出来什么猫腻。再切换到 chrome://net-internals/ 中看看日志，发现一个 error code ， google 了一下，并没有什么结果，看起来也验证不了猜想。</p>\n<p>然后再去找后端同学看看接口日志，是不是访问了两次，后端同学似乎稍微有点不太想打日志重新部署（过程比较麻烦），所以先放弃用这种方式求证。</p>\n<p>那用啥求证呢？ Charles 吧。</p>\n<p>在 Charles 中一看，发现发了四次请求，每次请求基本上都耗时六十多秒，每次都没有响应内容。</p>\n<p>好了，看起来就是浏览器六十秒超时重发请求。</p>\n<h1 id=\"深入分析\"><a href=\"#深入分析\" class=\"headerlink\" title=\"深入分析\"></a>深入分析</h1><p>可以转念一想，这对么？</p>\n<ul>\n<li>1、 POST 请求就这样轻易地被浏览器超时重发，难道浏览器开发者没考虑过数据重复发送的问题吗？表单 POST 请求手动刷新浏览器的时候都会弹窗提醒用户要不要重复提交数据呢！</li>\n<li>2、为啥是六十秒呢？时间这么短吗？想想平时本地断点调试服务器代码的时候，那可是会超时老长时间的，所以这六十秒算个啥呢？</li>\n</ul>\n<p>搜一搜往上资料，发现 <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.4\" target=\"_blank\" rel=\"external\">HTTP/1.1 的一处规范</a> ：</p>\n<blockquote>\n<p>If an HTTP/1.1 client sends a request which includes a request body, but which does not include an Expect request-header field with the “100-continue” expectation, and if the client is not directly connected to an HTTP/1.1 origin server, and if the client sees the connection close before receiving any status from the server, the client SHOULD retry the request.</p>\n</blockquote>\n<p>大致意思就是说，如果发送一个请求到服务器端，该请求有请求体，但是请求头里面不包含“ 100-continue ”这种东西，并且客户端没有直接连接到原始的 HTTP/1.1 服务器，此时，如果客户端在接收到服务器发送的 HTTP 状态之前发现服务器主动关掉连接，那么客户端应该重试请求。</p>\n<p>那看起来好像就是服务器端主动关掉了连接，导致浏览器重新发送请求了。</p>\n<p>我们服务器端使用的是 Tomcat ，查一查资料，发现 Tomcat 默认的 connector 超时时间是六十秒，刚好吻合上了。</p>\n<p>问题原因找到了，解决起来就轻松了，此处不赘述。</p>\n","excerpt":"<p>HTTP 协议中，从语义上讲， GET 请求一般是获取服务器端的资源，不会对服务器数据造成副作用，可简单理解为一种“读”操作；而 POST 请求多用于更改（增、删、改）服务器上的资源，会产生一定的副作用。</p>\n<p>所以，这样看起来，浏览器是不是就不会因为网络原因啥的自动重发 POST 请求吧？实际上是这样么？<br>","more":"</p>\n<h1 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h1><p>最近在对接地图的一个数据录入接口：前端向后端发送一个 CSV 文件，后端将 CSV 文件中的数据解析出来，然后将数据通过地图接口导入到地图数据库。由于地图提供的接口有点怪异，批量导入数据的接口有一些问题，只能使用单条导入接口，所以在这里， CSV 文件里面有多少条数据，就会访问多少次地图的接口。</p>\n<p>虽然有点坑，不过问题究竟是解决了，于是就这样上线了。</p>\n<p>天有不测风云，遇到一个客户，一下要导入上千条数据，后端这样串行地一条一条去导入，很轻易地就花了好几分钟。而且还遇到一个诡异的现象：每条数据都导入了两次！</p>\n<h1 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h1><p>凭借多年的前端开发经验（不要脸了），立马大胆猜测，浏览器发送了两次请求。</p>\n<p>于是先到谷歌开发者工具的 Network 标签页检查一下请求，发现此处只记录了一次请求，并且该请求没有响应，好像看不出来什么猫腻。再切换到 chrome://net-internals/ 中看看日志，发现一个 error code ， google 了一下，并没有什么结果，看起来也验证不了猜想。</p>\n<p>然后再去找后端同学看看接口日志，是不是访问了两次，后端同学似乎稍微有点不太想打日志重新部署（过程比较麻烦），所以先放弃用这种方式求证。</p>\n<p>那用啥求证呢？ Charles 吧。</p>\n<p>在 Charles 中一看，发现发了四次请求，每次请求基本上都耗时六十多秒，每次都没有响应内容。</p>\n<p>好了，看起来就是浏览器六十秒超时重发请求。</p>\n<h1 id=\"深入分析\"><a href=\"#深入分析\" class=\"headerlink\" title=\"深入分析\"></a>深入分析</h1><p>可以转念一想，这对么？</p>\n<ul>\n<li>1、 POST 请求就这样轻易地被浏览器超时重发，难道浏览器开发者没考虑过数据重复发送的问题吗？表单 POST 请求手动刷新浏览器的时候都会弹窗提醒用户要不要重复提交数据呢！</li>\n<li>2、为啥是六十秒呢？时间这么短吗？想想平时本地断点调试服务器代码的时候，那可是会超时老长时间的，所以这六十秒算个啥呢？</li>\n</ul>\n<p>搜一搜往上资料，发现 <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.2.4\">HTTP/1.1 的一处规范</a> ：</p>\n<blockquote>\n<p>If an HTTP/1.1 client sends a request which includes a request body, but which does not include an Expect request-header field with the “100-continue” expectation, and if the client is not directly connected to an HTTP/1.1 origin server, and if the client sees the connection close before receiving any status from the server, the client SHOULD retry the request.</p>\n</blockquote>\n<p>大致意思就是说，如果发送一个请求到服务器端，该请求有请求体，但是请求头里面不包含“ 100-continue ”这种东西，并且客户端没有直接连接到原始的 HTTP/1.1 服务器，此时，如果客户端在接收到服务器发送的 HTTP 状态之前发现服务器主动关掉连接，那么客户端应该重试请求。</p>\n<p>那看起来好像就是服务器端主动关掉了连接，导致浏览器重新发送请求了。</p>\n<p>我们服务器端使用的是 Tomcat ，查一查资料，发现 Tomcat 默认的 connector 超时时间是六十秒，刚好吻合上了。</p>\n<p>问题原因找到了，解决起来就轻松了，此处不赘述。</p>"},{"title":"Reflux 使用进化日记","date":"2015-05-21T16:00:00.000Z","_content":"\nReflux 算是比较新的东西，由于自己水平有限，刚接触，不能很好地去使用 Reflux 来处理数据，下面是我使用 Reflux 逐步进化的过程（当然最终状态不一定就是标准的 Reflux 使用方式）：\n\n<!-- more -->\n\n## 第一步：初识 Reflux\n\n一直在听人说 Reflux ，说这个东西比较适合中小型的前端项目，使用起来很方便，于是我就找到了 Reflux  在 GitHub 的[主页](https://github.com/spoike/refluxjs)。\n\n文档说 dispatcher 被移除了，没关系，反正我也没用过 Flux 。\n\n于是继续阅读关于 actions 和 stores 的文档。由于心浮气躁急着用，看文档很马虎，action 、 store 可以监听过去监听过来的，还有 store 可以 connect 啥的，完全看晕了，无法用 Reflux 组织起一个完整的处理流程。但是没关系，我就按照文档上的这些 listen 啥的，自己来写写看吧。\n\n于是， 创建 action ，在 store 中用 listenTo 来监听 action ，然后请求数据，store trigger 返回数据。写的时候，由于完全不理解 Reflux 怎么用，一通胡乱监听，写出来的代码不三不四，看着都觉得累。为了照顾项目进度，放弃 Reflux ，自己写一个 service 层吧。\n\n## 第二步：认识了一点 Reflux\n\n过了几天，对 Reflux 心有不甘，于是转头再去看 Reflux 文档，同时也很开心找到一篇[使用 Reflux 的经验文章](http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615)，于是知道了 action 可以当成方法调用，在 action 中监听调用，发出请求之类的，然后 store 做一些存储等操作，再 trigger ，component 中通过 mixin 来监听 store 中的 trigger ，然后做一些界面变动，摘录一段那篇文章中的例子：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createAction({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    onLoginSuccess: function(payload) {\n        this.trigger(payload);\n    },\n    onLoginFailed: function(payload) {\n        this.trigger(payload);\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.connect(UserStore, 'user')],\n    render: function() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n感觉自己似乎知道怎么来组织流程了，于是很开心地又去改造代码，希望能用上 Reflux 。\n\n写了一会儿，发现完了，因为有这样的场景：就拿上述一小段代码来说，UserAction 中很可能还有其它 action ，例如：\n\n```js\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']},\n    'register': {children: ['success', 'failed']}\n});\n```\n\nlogin 和 register 两个 action 都会触发 UserStore 中相应方法的调用，然后这些方法再调用 trigger ，然后改变 UserComponent 中 `state.user` 的值，此处有两个问题：\n\n* 1、登录和注册最终得到的数据真的都要反映到 UserComponent 的 `state.user` 上吗？这样合适吗？\n* 2、如果登录报错了，怎么通知 UserComponent ，怎么告诉其错误信息？\n\n想了想，有种方案：组织好 trigger 返回的数据结构，比如像这样：\n\n```js\n{\n  actionType: 'login',                  // 本次 action 的类型\n  status: 0,                                 // 0代表出错了，1代表成功了\n  message: 'an error occurred'  // 错误信息\n}\n```\n\n但是转念一想，这明显不对，肯定不是标准的用法，这样的话我又得在 component 中写好多代码来分析这些分发复杂的情况，太不优雅了。\n\n想了半天，实在没想出好的方式，在[《聊一聊基于Flux的前端系统》](http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615)中也没找到相关内容。\n\n于是，使用 Reflux 的想法再次被搁置，继续使用 service 吧！\n\n## 第三步：别扭的方式解决出错处理\n\n改回 service 之后，心中还是蛮不爽的，便去一个牛人云集的 React 群(161461760)求助，初步描述完我的问题之后，群中一位热心网友提出了他的方式：给 store 添加方法，获取 action 执行的结果。\n\n感觉这种方式似乎能解决问题，虽然还是有点别扭，于是代码变成了这样：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar userStoreMixin = {\n    getLoginResult() {\n        if (this._error) {\n            throw this._error;\n        }\n        return this._user;\n    }\n};\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    mixins: [userStoreMixin],\n    onLoginSuccess(payload) {\n        this._error = null;\n        this.trigger(payload);\n    },\n    onLoginFailed(error) {\n        if (error.status === -1) {\n            this._error = new UnloginError(error.message);\n        } else {\n            this._error = new Error(error.message);\n        }\n        this.trigger();\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.listenTo(UserStore, 'onUserStore')],\n    onUserStore() {\n        try {\n            this.setState({\n                user: UserStore.getLoginResult()\n            });\n        } catch (e) {\n            if (e instanceof UnloginError) {\n                alert('not login');\n            } else {\n                alert(e.message);\n            }\n        }\n    },\n    render() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n似乎还行，于是开开心心地翻新项目代码，将 service 改成“这种的 Reflux ”。\n\n## 第四步：产生新的想法\n\n按照第三步的思维使用了一段时间之后，感觉实在是别扭，越来越感受到这不是标准的方案，写出来的代码看着有点丑。\n\n于是想啊想，突然，灵光一闪，还是应该回归到第二步中写的那个例子啊，store 应该只是用来处理`正确的数据`，至于那些报错什么的，可以用额外的 action 、 store 来处理啊！于是上述代码应该是这个样子的：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar ErrorAction = Reflux.createActions({\n    Unlogin: {}, // 未登录\n    error: {}    // 一般性的错误\n});\n\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    onLoginSuccess(payload) {\n        this.trigger(payload);\n    },\n    onLoginFailed(payload) {\n        if (error.status === -1) {\n            ErrorAction.Unlogin(error.message);\n        } else {\n            ErrorAction.error(error.message);\n        }\n    }\n});\n\nvar ErrorStoreMixin = {\n    UNLOGIN: 1,\n    ERROR: 2\n};\nvar ErrorStore = Reflux.createStore({\n    listenables: ErrorAction,\n    mixins: [ErrorStoreMixin],\n    onUnlogin(message) {\n        this.trigger({type: this.UNLOGIN, message: message});\n    },\n    onError(message) {\n        this.trigger({type: this.ERROR, message: message});\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.connect(UserStore, 'user'), Reflux.listenTo(ErrorStore, 'onErrorStore')],\n    onErrorStore(error) {\n        if (error.type === ErrorStore.UNLOGIN) {\n            alert('not login');\n        } else if (error.type === ErrorStore.ERROR) {\n            alert(error.message);\n        }\n    },\n    render() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n现在，感觉似乎完美一点了，代码看着也相对优雅。\n\n不过，到目前为止，还有一点疑问：按照这种 store 写法，似乎会创建很多 store ，是否需要控制 store 数量，如果有必要，如何整合各个 store ？\n\n带着一些疑问，继续前行吧，骚年！\n\n（后续有使用心得的时候会继续更新本文章）\n","source":"_posts/Reflux 使用进化日记.md","raw":"---\ntitle: Reflux 使用进化日记\ndate: 2015-05-22\ntags:\n- JavaScript\n- Reflux\n- React\n---\n\nReflux 算是比较新的东西，由于自己水平有限，刚接触，不能很好地去使用 Reflux 来处理数据，下面是我使用 Reflux 逐步进化的过程（当然最终状态不一定就是标准的 Reflux 使用方式）：\n\n<!-- more -->\n\n## 第一步：初识 Reflux\n\n一直在听人说 Reflux ，说这个东西比较适合中小型的前端项目，使用起来很方便，于是我就找到了 Reflux  在 GitHub 的[主页](https://github.com/spoike/refluxjs)。\n\n文档说 dispatcher 被移除了，没关系，反正我也没用过 Flux 。\n\n于是继续阅读关于 actions 和 stores 的文档。由于心浮气躁急着用，看文档很马虎，action 、 store 可以监听过去监听过来的，还有 store 可以 connect 啥的，完全看晕了，无法用 Reflux 组织起一个完整的处理流程。但是没关系，我就按照文档上的这些 listen 啥的，自己来写写看吧。\n\n于是， 创建 action ，在 store 中用 listenTo 来监听 action ，然后请求数据，store trigger 返回数据。写的时候，由于完全不理解 Reflux 怎么用，一通胡乱监听，写出来的代码不三不四，看着都觉得累。为了照顾项目进度，放弃 Reflux ，自己写一个 service 层吧。\n\n## 第二步：认识了一点 Reflux\n\n过了几天，对 Reflux 心有不甘，于是转头再去看 Reflux 文档，同时也很开心找到一篇[使用 Reflux 的经验文章](http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615)，于是知道了 action 可以当成方法调用，在 action 中监听调用，发出请求之类的，然后 store 做一些存储等操作，再 trigger ，component 中通过 mixin 来监听 store 中的 trigger ，然后做一些界面变动，摘录一段那篇文章中的例子：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createAction({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    onLoginSuccess: function(payload) {\n        this.trigger(payload);\n    },\n    onLoginFailed: function(payload) {\n        this.trigger(payload);\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.connect(UserStore, 'user')],\n    render: function() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n感觉自己似乎知道怎么来组织流程了，于是很开心地又去改造代码，希望能用上 Reflux 。\n\n写了一会儿，发现完了，因为有这样的场景：就拿上述一小段代码来说，UserAction 中很可能还有其它 action ，例如：\n\n```js\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']},\n    'register': {children: ['success', 'failed']}\n});\n```\n\nlogin 和 register 两个 action 都会触发 UserStore 中相应方法的调用，然后这些方法再调用 trigger ，然后改变 UserComponent 中 `state.user` 的值，此处有两个问题：\n\n* 1、登录和注册最终得到的数据真的都要反映到 UserComponent 的 `state.user` 上吗？这样合适吗？\n* 2、如果登录报错了，怎么通知 UserComponent ，怎么告诉其错误信息？\n\n想了想，有种方案：组织好 trigger 返回的数据结构，比如像这样：\n\n```js\n{\n  actionType: 'login',                  // 本次 action 的类型\n  status: 0,                                 // 0代表出错了，1代表成功了\n  message: 'an error occurred'  // 错误信息\n}\n```\n\n但是转念一想，这明显不对，肯定不是标准的用法，这样的话我又得在 component 中写好多代码来分析这些分发复杂的情况，太不优雅了。\n\n想了半天，实在没想出好的方式，在[《聊一聊基于Flux的前端系统》](http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615)中也没找到相关内容。\n\n于是，使用 Reflux 的想法再次被搁置，继续使用 service 吧！\n\n## 第三步：别扭的方式解决出错处理\n\n改回 service 之后，心中还是蛮不爽的，便去一个牛人云集的 React 群(161461760)求助，初步描述完我的问题之后，群中一位热心网友提出了他的方式：给 store 添加方法，获取 action 执行的结果。\n\n感觉这种方式似乎能解决问题，虽然还是有点别扭，于是代码变成了这样：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar userStoreMixin = {\n    getLoginResult() {\n        if (this._error) {\n            throw this._error;\n        }\n        return this._user;\n    }\n};\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    mixins: [userStoreMixin],\n    onLoginSuccess(payload) {\n        this._error = null;\n        this.trigger(payload);\n    },\n    onLoginFailed(error) {\n        if (error.status === -1) {\n            this._error = new UnloginError(error.message);\n        } else {\n            this._error = new Error(error.message);\n        }\n        this.trigger();\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.listenTo(UserStore, 'onUserStore')],\n    onUserStore() {\n        try {\n            this.setState({\n                user: UserStore.getLoginResult()\n            });\n        } catch (e) {\n            if (e instanceof UnloginError) {\n                alert('not login');\n            } else {\n                alert(e.message);\n            }\n        }\n    },\n    render() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n似乎还行，于是开开心心地翻新项目代码，将 service 改成“这种的 Reflux ”。\n\n## 第四步：产生新的想法\n\n按照第三步的思维使用了一段时间之后，感觉实在是别扭，越来越感受到这不是标准的方案，写出来的代码看着有点丑。\n\n于是想啊想，突然，灵光一闪，还是应该回归到第二步中写的那个例子啊，store 应该只是用来处理`正确的数据`，至于那些报错什么的，可以用额外的 action 、 store 来处理啊！于是上述代码应该是这个样子的：\n\n```js\nvar Reflux = require('reflux');\nvar React = require('react');\n\nvar UserAction = Reflux.createActions({\n    'login': {children: ['success', 'failed']}\n});\n\nUsersAction.login.listen(function(data) {\n    $.post('/api/users/Action/login', data).then(this.success, this.failed);\n});\n\nvar ErrorAction = Reflux.createActions({\n    Unlogin: {}, // 未登录\n    error: {}    // 一般性的错误\n});\n\nvar UserStore = Reflux.createStore({\n    listenables: UserAction,\n    onLoginSuccess(payload) {\n        this.trigger(payload);\n    },\n    onLoginFailed(payload) {\n        if (error.status === -1) {\n            ErrorAction.Unlogin(error.message);\n        } else {\n            ErrorAction.error(error.message);\n        }\n    }\n});\n\nvar ErrorStoreMixin = {\n    UNLOGIN: 1,\n    ERROR: 2\n};\nvar ErrorStore = Reflux.createStore({\n    listenables: ErrorAction,\n    mixins: [ErrorStoreMixin],\n    onUnlogin(message) {\n        this.trigger({type: this.UNLOGIN, message: message});\n    },\n    onError(message) {\n        this.trigger({type: this.ERROR, message: message});\n    }\n});\n\nvar UserComponent = React.createClass({\n    mixins: [Reflux.connect(UserStore, 'user'), Reflux.listenTo(ErrorStore, 'onErrorStore')],\n    onErrorStore(error) {\n        if (error.type === ErrorStore.UNLOGIN) {\n            alert('not login');\n        } else if (error.type === ErrorStore.ERROR) {\n            alert(error.message);\n        }\n    },\n    render() {\n        return <span>{this.state.user.name}</span>;\n    }\n});\n```\n\n现在，感觉似乎完美一点了，代码看着也相对优雅。\n\n不过，到目前为止，还有一点疑问：按照这种 store 写法，似乎会创建很多 store ，是否需要控制 store 数量，如果有必要，如何整合各个 store ？\n\n带着一些疑问，继续前行吧，骚年！\n\n（后续有使用心得的时候会继续更新本文章）\n","slug":"Reflux 使用进化日记","published":1,"updated":"2016-06-15T10:46:27.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02c000k0407jn2j41ee","content":"<p>Reflux 算是比较新的东西，由于自己水平有限，刚接触，不能很好地去使用 Reflux 来处理数据，下面是我使用 Reflux 逐步进化的过程（当然最终状态不一定就是标准的 Reflux 使用方式）：</p>\n<a id=\"more\"></a>\n<h2 id=\"第一步：初识-Reflux\"><a href=\"#第一步：初识-Reflux\" class=\"headerlink\" title=\"第一步：初识 Reflux\"></a>第一步：初识 Reflux</h2><p>一直在听人说 Reflux ，说这个东西比较适合中小型的前端项目，使用起来很方便，于是我就找到了 Reflux  在 GitHub 的<a href=\"https://github.com/spoike/refluxjs\" target=\"_blank\" rel=\"external\">主页</a>。</p>\n<p>文档说 dispatcher 被移除了，没关系，反正我也没用过 Flux 。</p>\n<p>于是继续阅读关于 actions 和 stores 的文档。由于心浮气躁急着用，看文档很马虎，action 、 store 可以监听过去监听过来的，还有 store 可以 connect 啥的，完全看晕了，无法用 Reflux 组织起一个完整的处理流程。但是没关系，我就按照文档上的这些 listen 啥的，自己来写写看吧。</p>\n<p>于是， 创建 action ，在 store 中用 listenTo 来监听 action ，然后请求数据，store trigger 返回数据。写的时候，由于完全不理解 Reflux 怎么用，一通胡乱监听，写出来的代码不三不四，看着都觉得累。为了照顾项目进度，放弃 Reflux ，自己写一个 service 层吧。</p>\n<h2 id=\"第二步：认识了一点-Reflux\"><a href=\"#第二步：认识了一点-Reflux\" class=\"headerlink\" title=\"第二步：认识了一点 Reflux\"></a>第二步：认识了一点 Reflux</h2><p>过了几天，对 Reflux 心有不甘，于是转头再去看 Reflux 文档，同时也很开心找到一篇<a href=\"http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615\" target=\"_blank\" rel=\"external\">使用 Reflux 的经验文章</a>，于是知道了 action 可以当成方法调用，在 action 中监听调用，发出请求之类的，然后 store 做一些存储等操作，再 trigger ，component 中通过 mixin 来监听 store 中的 trigger ，然后做一些界面变动，摘录一段那篇文章中的例子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createAction(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    <span class=\"attr\">onLoginSuccess</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">payload</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">onLoginFailed</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">payload</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.connect(UserStore, <span class=\"string\">'user'</span>)],</div><div class=\"line\">    <span class=\"attr\">render</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>感觉自己似乎知道怎么来组织流程了，于是很开心地又去改造代码，希望能用上 Reflux 。</p>\n<p>写了一会儿，发现完了，因为有这样的场景：就拿上述一小段代码来说，UserAction 中很可能还有其它 action ，例如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;,</div><div class=\"line\">    <span class=\"string\">'register'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>login 和 register 两个 action 都会触发 UserStore 中相应方法的调用，然后这些方法再调用 trigger ，然后改变 UserComponent 中 <code>state.user</code> 的值，此处有两个问题：</p>\n<ul>\n<li>1、登录和注册最终得到的数据真的都要反映到 UserComponent 的 <code>state.user</code> 上吗？这样合适吗？</li>\n<li>2、如果登录报错了，怎么通知 UserComponent ，怎么告诉其错误信息？</li>\n</ul>\n<p>想了想，有种方案：组织好 trigger 返回的数据结构，比如像这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">actionType</span>: <span class=\"string\">'login'</span>,                  <span class=\"comment\">// 本次 action 的类型</span></div><div class=\"line\">  status: <span class=\"number\">0</span>,                                 <span class=\"comment\">// 0代表出错了，1代表成功了</span></div><div class=\"line\">  message: <span class=\"string\">'an error occurred'</span>  <span class=\"comment\">// 错误信息</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>但是转念一想，这明显不对，肯定不是标准的用法，这样的话我又得在 component 中写好多代码来分析这些分发复杂的情况，太不优雅了。</p>\n<p>想了半天，实在没想出好的方式，在<a href=\"http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615\" target=\"_blank\" rel=\"external\">《聊一聊基于Flux的前端系统》</a>中也没找到相关内容。</p>\n<p>于是，使用 Reflux 的想法再次被搁置，继续使用 service 吧！</p>\n<h2 id=\"第三步：别扭的方式解决出错处理\"><a href=\"#第三步：别扭的方式解决出错处理\" class=\"headerlink\" title=\"第三步：别扭的方式解决出错处理\"></a>第三步：别扭的方式解决出错处理</h2><p>改回 service 之后，心中还是蛮不爽的，便去一个牛人云集的 React 群(161461760)求助，初步描述完我的问题之后，群中一位热心网友提出了他的方式：给 store 添加方法，获取 action 执行的结果。</p>\n<p>感觉这种方式似乎能解决问题，虽然还是有点别扭，于是代码变成了这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> userStoreMixin = &#123;</div><div class=\"line\">    getLoginResult() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>._error) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">this</span>._error;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>._user;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [userStoreMixin],</div><div class=\"line\">    onLoginSuccess(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>._error = <span class=\"literal\">null</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onLoginFailed(error) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.status === <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>._error = <span class=\"keyword\">new</span> UnloginError(error.message);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>._error = <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.listenTo(UserStore, <span class=\"string\">'onUserStore'</span>)],</div><div class=\"line\">    onUserStore() &#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.setState(&#123;</div><div class=\"line\">                <span class=\"attr\">user</span>: UserStore.getLoginResult()</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (e) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> UnloginError) &#123;</div><div class=\"line\">                alert(<span class=\"string\">'not login'</span>);</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                alert(e.message);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    render() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>似乎还行，于是开开心心地翻新项目代码，将 service 改成“这种的 Reflux ”。</p>\n<h2 id=\"第四步：产生新的想法\"><a href=\"#第四步：产生新的想法\" class=\"headerlink\" title=\"第四步：产生新的想法\"></a>第四步：产生新的想法</h2><p>按照第三步的思维使用了一段时间之后，感觉实在是别扭，越来越感受到这不是标准的方案，写出来的代码看着有点丑。</p>\n<p>于是想啊想，突然，灵光一闪，还是应该回归到第二步中写的那个例子啊，store 应该只是用来处理<code>正确的数据</code>，至于那些报错什么的，可以用额外的 action 、 store 来处理啊！于是上述代码应该是这个样子的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> ErrorAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"attr\">Unlogin</span>: &#123;&#125;, <span class=\"comment\">// 未登录</span></div><div class=\"line\">    error: &#123;&#125;    <span class=\"comment\">// 一般性的错误</span></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    onLoginSuccess(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onLoginFailed(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.status === <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">            ErrorAction.Unlogin(error.message);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            ErrorAction.error(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> ErrorStoreMixin = &#123;</div><div class=\"line\">    <span class=\"attr\">UNLOGIN</span>: <span class=\"number\">1</span>,</div><div class=\"line\">    <span class=\"attr\">ERROR</span>: <span class=\"number\">2</span></div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> ErrorStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: ErrorAction,</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [ErrorStoreMixin],</div><div class=\"line\">    onUnlogin(message) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(&#123;<span class=\"attr\">type</span>: <span class=\"keyword\">this</span>.UNLOGIN, <span class=\"attr\">message</span>: message&#125;);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onError(message) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(&#123;<span class=\"attr\">type</span>: <span class=\"keyword\">this</span>.ERROR, <span class=\"attr\">message</span>: message&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.connect(UserStore, <span class=\"string\">'user'</span>), Reflux.listenTo(ErrorStore, <span class=\"string\">'onErrorStore'</span>)],</div><div class=\"line\">    onErrorStore(error) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.type === ErrorStore.UNLOGIN) &#123;</div><div class=\"line\">            alert(<span class=\"string\">'not login'</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (error.type === ErrorStore.ERROR) &#123;</div><div class=\"line\">            alert(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    render() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>现在，感觉似乎完美一点了，代码看着也相对优雅。</p>\n<p>不过，到目前为止，还有一点疑问：按照这种 store 写法，似乎会创建很多 store ，是否需要控制 store 数量，如果有必要，如何整合各个 store ？</p>\n<p>带着一些疑问，继续前行吧，骚年！</p>\n<p>（后续有使用心得的时候会继续更新本文章）</p>\n","excerpt":"<p>Reflux 算是比较新的东西，由于自己水平有限，刚接触，不能很好地去使用 Reflux 来处理数据，下面是我使用 Reflux 逐步进化的过程（当然最终状态不一定就是标准的 Reflux 使用方式）：</p>","more":"<h2 id=\"第一步：初识-Reflux\"><a href=\"#第一步：初识-Reflux\" class=\"headerlink\" title=\"第一步：初识 Reflux\"></a>第一步：初识 Reflux</h2><p>一直在听人说 Reflux ，说这个东西比较适合中小型的前端项目，使用起来很方便，于是我就找到了 Reflux  在 GitHub 的<a href=\"https://github.com/spoike/refluxjs\">主页</a>。</p>\n<p>文档说 dispatcher 被移除了，没关系，反正我也没用过 Flux 。</p>\n<p>于是继续阅读关于 actions 和 stores 的文档。由于心浮气躁急着用，看文档很马虎，action 、 store 可以监听过去监听过来的，还有 store 可以 connect 啥的，完全看晕了，无法用 Reflux 组织起一个完整的处理流程。但是没关系，我就按照文档上的这些 listen 啥的，自己来写写看吧。</p>\n<p>于是， 创建 action ，在 store 中用 listenTo 来监听 action ，然后请求数据，store trigger 返回数据。写的时候，由于完全不理解 Reflux 怎么用，一通胡乱监听，写出来的代码不三不四，看着都觉得累。为了照顾项目进度，放弃 Reflux ，自己写一个 service 层吧。</p>\n<h2 id=\"第二步：认识了一点-Reflux\"><a href=\"#第二步：认识了一点-Reflux\" class=\"headerlink\" title=\"第二步：认识了一点 Reflux\"></a>第二步：认识了一点 Reflux</h2><p>过了几天，对 Reflux 心有不甘，于是转头再去看 Reflux 文档，同时也很开心找到一篇<a href=\"http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615\">使用 Reflux 的经验文章</a>，于是知道了 action 可以当成方法调用，在 action 中监听调用，发出请求之类的，然后 store 做一些存储等操作，再 trigger ，component 中通过 mixin 来监听 store 中的 trigger ，然后做一些界面变动，摘录一段那篇文章中的例子：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createAction(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    <span class=\"attr\">onLoginSuccess</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">payload</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"attr\">onLoginFailed</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">payload</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.connect(UserStore, <span class=\"string\">'user'</span>)],</div><div class=\"line\">    <span class=\"attr\">render</span>: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>感觉自己似乎知道怎么来组织流程了，于是很开心地又去改造代码，希望能用上 Reflux 。</p>\n<p>写了一会儿，发现完了，因为有这样的场景：就拿上述一小段代码来说，UserAction 中很可能还有其它 action ，例如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;,</div><div class=\"line\">    <span class=\"string\">'register'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>login 和 register 两个 action 都会触发 UserStore 中相应方法的调用，然后这些方法再调用 trigger ，然后改变 UserComponent 中 <code>state.user</code> 的值，此处有两个问题：</p>\n<ul>\n<li>1、登录和注册最终得到的数据真的都要反映到 UserComponent 的 <code>state.user</code> 上吗？这样合适吗？</li>\n<li>2、如果登录报错了，怎么通知 UserComponent ，怎么告诉其错误信息？</li>\n</ul>\n<p>想了想，有种方案：组织好 trigger 返回的数据结构，比如像这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">actionType</span>: <span class=\"string\">'login'</span>,                  <span class=\"comment\">// 本次 action 的类型</span></div><div class=\"line\">  status: <span class=\"number\">0</span>,                                 <span class=\"comment\">// 0代表出错了，1代表成功了</span></div><div class=\"line\">  message: <span class=\"string\">'an error occurred'</span>  <span class=\"comment\">// 错误信息</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>但是转念一想，这明显不对，肯定不是标准的用法，这样的话我又得在 component 中写好多代码来分析这些分发复杂的情况，太不优雅了。</p>\n<p>想了半天，实在没想出好的方式，在<a href=\"http://react.nodejs-china.org/t/liao-liao-ji-yu-fluxde-qian-duan-xi-tong/615\">《聊一聊基于Flux的前端系统》</a>中也没找到相关内容。</p>\n<p>于是，使用 Reflux 的想法再次被搁置，继续使用 service 吧！</p>\n<h2 id=\"第三步：别扭的方式解决出错处理\"><a href=\"#第三步：别扭的方式解决出错处理\" class=\"headerlink\" title=\"第三步：别扭的方式解决出错处理\"></a>第三步：别扭的方式解决出错处理</h2><p>改回 service 之后，心中还是蛮不爽的，便去一个牛人云集的 React 群(161461760)求助，初步描述完我的问题之后，群中一位热心网友提出了他的方式：给 store 添加方法，获取 action 执行的结果。</p>\n<p>感觉这种方式似乎能解决问题，虽然还是有点别扭，于是代码变成了这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> userStoreMixin = &#123;</div><div class=\"line\">    getLoginResult() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>._error) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">this</span>._error;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>._user;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [userStoreMixin],</div><div class=\"line\">    onLoginSuccess(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>._error = <span class=\"literal\">null</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onLoginFailed(error) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.status === <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>._error = <span class=\"keyword\">new</span> UnloginError(error.message);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>._error = <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger();</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.listenTo(UserStore, <span class=\"string\">'onUserStore'</span>)],</div><div class=\"line\">    onUserStore() &#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>.setState(&#123;</div><div class=\"line\">                <span class=\"attr\">user</span>: UserStore.getLoginResult()</div><div class=\"line\">            &#125;);</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (e) &#123;</div><div class=\"line\">            <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> UnloginError) &#123;</div><div class=\"line\">                alert(<span class=\"string\">'not login'</span>);</div><div class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">                alert(e.message);</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    render() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>似乎还行，于是开开心心地翻新项目代码，将 service 改成“这种的 Reflux ”。</p>\n<h2 id=\"第四步：产生新的想法\"><a href=\"#第四步：产生新的想法\" class=\"headerlink\" title=\"第四步：产生新的想法\"></a>第四步：产生新的想法</h2><p>按照第三步的思维使用了一段时间之后，感觉实在是别扭，越来越感受到这不是标准的方案，写出来的代码看着有点丑。</p>\n<p>于是想啊想，突然，灵光一闪，还是应该回归到第二步中写的那个例子啊，store 应该只是用来处理<code>正确的数据</code>，至于那些报错什么的，可以用额外的 action 、 store 来处理啊！于是上述代码应该是这个样子的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> Reflux = <span class=\"built_in\">require</span>(<span class=\"string\">'reflux'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> React = <span class=\"built_in\">require</span>(<span class=\"string\">'react'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"string\">'login'</span>: &#123;<span class=\"attr\">children</span>: [<span class=\"string\">'success'</span>, <span class=\"string\">'failed'</span>]&#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">UsersAction.login.listen(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">data</span>) </span>&#123;</div><div class=\"line\">    $.post(<span class=\"string\">'/api/users/Action/login'</span>, data).then(<span class=\"keyword\">this</span>.success, <span class=\"keyword\">this</span>.failed);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> ErrorAction = Reflux.createActions(&#123;</div><div class=\"line\">    <span class=\"attr\">Unlogin</span>: &#123;&#125;, <span class=\"comment\">// 未登录</span></div><div class=\"line\">    error: &#123;&#125;    <span class=\"comment\">// 一般性的错误</span></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: UserAction,</div><div class=\"line\">    onLoginSuccess(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(payload);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onLoginFailed(payload) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.status === <span class=\"number\">-1</span>) &#123;</div><div class=\"line\">            ErrorAction.Unlogin(error.message);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            ErrorAction.error(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> ErrorStoreMixin = &#123;</div><div class=\"line\">    <span class=\"attr\">UNLOGIN</span>: <span class=\"number\">1</span>,</div><div class=\"line\">    <span class=\"attr\">ERROR</span>: <span class=\"number\">2</span></div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">var</span> ErrorStore = Reflux.createStore(&#123;</div><div class=\"line\">    <span class=\"attr\">listenables</span>: ErrorAction,</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [ErrorStoreMixin],</div><div class=\"line\">    onUnlogin(message) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(&#123;<span class=\"attr\">type</span>: <span class=\"keyword\">this</span>.UNLOGIN, <span class=\"attr\">message</span>: message&#125;);</div><div class=\"line\">    &#125;,</div><div class=\"line\">    onError(message) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>.trigger(&#123;<span class=\"attr\">type</span>: <span class=\"keyword\">this</span>.ERROR, <span class=\"attr\">message</span>: message&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> UserComponent = React.createClass(&#123;</div><div class=\"line\">    <span class=\"attr\">mixins</span>: [Reflux.connect(UserStore, <span class=\"string\">'user'</span>), Reflux.listenTo(ErrorStore, <span class=\"string\">'onErrorStore'</span>)],</div><div class=\"line\">    onErrorStore(error) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (error.type === ErrorStore.UNLOGIN) &#123;</div><div class=\"line\">            alert(<span class=\"string\">'not login'</span>);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (error.type === ErrorStore.ERROR) &#123;</div><div class=\"line\">            alert(error.message);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;,</div><div class=\"line\">    render() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.user.name&#125;&lt;/span&gt;;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>现在，感觉似乎完美一点了，代码看着也相对优雅。</p>\n<p>不过，到目前为止，还有一点疑问：按照这种 store 写法，似乎会创建很多 store ，是否需要控制 store 数量，如果有必要，如何整合各个 store ？</p>\n<p>带着一些疑问，继续前行吧，骚年！</p>\n<p>（后续有使用心得的时候会继续更新本文章）</p>"},{"title":"WEB 中的文件下载","date":"2016-06-17T00:59:00.000Z","_content":"\n在 WEB 开发中，我们会期望用户在点击某个链接的时候，下载一个文件（不管这个文件能不能被浏览器解析，都要下载）。以前接触过一种方式，就是在响应 header 中设置 `force-download` ：\n\n```\nContent-Type: application/force-download\nContent-Disposition: attachment; filename=\"test.zip\"\n```\n\n然而，这是一种 hack 方式，并不推荐使用：\n<!-- more -->\n\n{% blockquote Quentin http://stackoverflow.com/a/10616753/3468416 Utility of HTTP header “Content-Type: application/force-download” for mobile? %}\nContent-Type: application/force-download means \"I, the web server, am going to lie to you (the browser) about what this file is so that you will not treat it as a PDF/Word Document/MP3/whatever and prompt the user to save the mysterious file to disk instead\". It is a dirty hack that breaks horribly when the client doesn't do \"save to disk\".\n{% endblockquote %}\n\n有位小伙伴就遇到了不奏效的情况：\n\n{% blockquote Jörg Wagner http://www.digiblog.de/2011/04/android-and-the-download-file-headers/ Android and the HTTP download file headers%}\nATTENTION:\nIf you use any of the lines below your download will probably NOT WORK on Android 2.1.\n<br>\n\nContent-Type: application/force-download\nContent-Disposition: attachment; filename=MyFileName.ZIP\nContent-Disposition: attachment; filename=\"MyFileName.zip\"\nContent-Disposition: attachment; filename=\"MyFileName.ZIP\";\n{% endblockquote %}\n\n那么，究竟怎么办呢？接下来描述我的同事和我遇到的问题。\n\n# 问题发现\n\n最近接手了一个新项目，今天刚好有空熟悉一下之前的功能。于是打开线上地址，输入测试账号，进入一个列表页面，这个列表页面提供了下载数据为 Excel 文件的功能，点了一下`下载`链接，猛然发现，下载的文件名字怎么是 `download` ？为啥呢？\n\n我用的浏览器是 Chrome 51 ，系统是 OS EI Capitan 10.11.5 。\n\n我一同事 Chrome 47，可以完全正常下载！\n\n先看看为啥我的浏览器不行吧！\n\n# 第一步探索\n\n打开 Chrome 开发者工具，查看 HTTP 请求，发现响应头部有如下两项：\n\n```\nContent-Type: application/octet-stream;charset=GBK\nContent-Disposition: attachment; filename=\"%D6%D0%CE%C4.xlsx\n```\n\n噢，filename 那里多了一个双引号，去掉吧！\n\n# 第二步探索\n\n然而，引号去掉之后，问题依旧！什么情况？难道是 filename 需要引号包起来？\n\n好吧，包起来试试！\n\n# 第三步探索\n\n包起来后问题依旧，什么鬼？\n\n灵机一动，去看看别人怎么做的吧！于是找到别人网站一个下载 Excel 的页面，点击下载，发现响应 header 里面是这样的：\n\n```\nContent-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8\nContent-Disposition: inline;filename=\"%D6%D0%CE%C4.xlsx\";filename*=utf-8''%D6%D0%CE%C4.xlsx\n```\n\nContent-Type 指明了具体的文件类型，然后 Content-Disposition 多了一个 `filename*=` ，这是什么东西？ `utf-8` 是什么编码？\n\n经过一堆胡乱搜索，猜测 utf-8 就是文件名的编码。为啥文件名要编码呢？呃，HTTP header 里面还未见过中文……\n\n好了，我们后端的代码大致做法是这样的：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\") + \"\\\".xlsx\");\n```\n\n看起来，只需要用 `filename*=` 附上编码就行了，于是后端代码改成：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\") + \"\\\".xlsx;filename*=GBK''\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\"));\n```\n\n好了，我再点击下载，没问题！\n\n# 第四步探索\n\n看起来好像是 OK 了，但是，用 IE 试一下，又不正常了，文件名字不对了！\n\n为什么呢？别人网站在 IE 下都能正常下载的！现在主要有两处区别：\n\n- 我们的 Content-Type 没有写具体；\n- 我们使用了 GBK 编码。\n\n一思索，感觉编码的嫌疑较大，为啥呢？因为对于文件下载，浏览器根本不用管文件内容是个啥，只需要按照二进制流写入本地磁盘就好了，并且，此处也只是文件名错了，下载下来的文件内容还是没问题的。\n\n那就改编码吧，改成 UTF-8 ：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"UTF-8\"), \"ISO-8859-1\") + \"\\\".xlsx;filename*=UTF-8''\" + new String(fileName.getBytes(\"UTF-8\"), \"ISO-8859-1\"));\n```\n\n经测试，一切正常！\n\n# 总结\n\n在文件下载功能中，一般都会借助于这两个 header 来达到效果，那么两个 header 的具体作用是什么呢？\n\n- Content-Type：告诉浏览器当前的响应体是个什么类型的数据。当其为 application/octet-stream 的时候，就说明 body 里面是一堆不知道是啥的二进制数据。\n- Content-Disposition：用于向浏览器提供一些关于如何处理响应内容的额外的信息，同时也可以附带一些其它数据，比如在保存响应体到本地的时候应该使用什么样的文件名。\n\n细想一下， Content-Type 好像对于文件下载没什么作用？事实上的确如此。可是再想一下，如果浏览器不理会 Content-Disposition ，不下载文件怎么办？如果此时提供了 Content-Type ,至少浏览器还有机会根据具体的 Content-Type 对响应体进行处理。\n\n可是为什么浏览器会不理会 Content-Disposition 呢？因为这个 Content-Disposition 头部并不是 HTTP 标准中的内容，只是被浏览器广泛实现的一个 header 而已。\n\n话题转一转， Content-Disposition 的语法见[此处](https://tools.ietf.org/html/rfc6266#section-4.1)，其中相对重要的点此处罗列一下：\n\n- 常用的 disponsition-type 有 `inline` 和 `attachment` ：\n    - inline：建议浏览器使用默认的行为处理响应体。\n    - attachment：建议浏览器将响应体保存到本地，而不是正常处理响应体。\n- Content-Disposition 中可以传入 filename 参数，有两种形式：\n    - filename=yourfilename.suffix：直接指明文件名和后缀。\n    - filename*=utf-8''yourfilename.suffix：指定了文件名编码。其中，编码后面那对单引号中还可以填入内容，此处不赘述，可参考[规范](https://tools.ietf.org/html/rfc6266)。\n    - 有些浏览器不认识 `filename*=utf-8''yourfilename.suffix` （估计因为这东西比较复杂），所以最好带上 `filename=yourfilename.suffix` 。\n","source":"_posts/filedownload.md","raw":"---\ntitle: WEB 中的文件下载\ndate: 2016-06-17 8:59\ntags:\n- HTTP\n---\n\n在 WEB 开发中，我们会期望用户在点击某个链接的时候，下载一个文件（不管这个文件能不能被浏览器解析，都要下载）。以前接触过一种方式，就是在响应 header 中设置 `force-download` ：\n\n```\nContent-Type: application/force-download\nContent-Disposition: attachment; filename=\"test.zip\"\n```\n\n然而，这是一种 hack 方式，并不推荐使用：\n<!-- more -->\n\n{% blockquote Quentin http://stackoverflow.com/a/10616753/3468416 Utility of HTTP header “Content-Type: application/force-download” for mobile? %}\nContent-Type: application/force-download means \"I, the web server, am going to lie to you (the browser) about what this file is so that you will not treat it as a PDF/Word Document/MP3/whatever and prompt the user to save the mysterious file to disk instead\". It is a dirty hack that breaks horribly when the client doesn't do \"save to disk\".\n{% endblockquote %}\n\n有位小伙伴就遇到了不奏效的情况：\n\n{% blockquote Jörg Wagner http://www.digiblog.de/2011/04/android-and-the-download-file-headers/ Android and the HTTP download file headers%}\nATTENTION:\nIf you use any of the lines below your download will probably NOT WORK on Android 2.1.\n<br>\n\nContent-Type: application/force-download\nContent-Disposition: attachment; filename=MyFileName.ZIP\nContent-Disposition: attachment; filename=\"MyFileName.zip\"\nContent-Disposition: attachment; filename=\"MyFileName.ZIP\";\n{% endblockquote %}\n\n那么，究竟怎么办呢？接下来描述我的同事和我遇到的问题。\n\n# 问题发现\n\n最近接手了一个新项目，今天刚好有空熟悉一下之前的功能。于是打开线上地址，输入测试账号，进入一个列表页面，这个列表页面提供了下载数据为 Excel 文件的功能，点了一下`下载`链接，猛然发现，下载的文件名字怎么是 `download` ？为啥呢？\n\n我用的浏览器是 Chrome 51 ，系统是 OS EI Capitan 10.11.5 。\n\n我一同事 Chrome 47，可以完全正常下载！\n\n先看看为啥我的浏览器不行吧！\n\n# 第一步探索\n\n打开 Chrome 开发者工具，查看 HTTP 请求，发现响应头部有如下两项：\n\n```\nContent-Type: application/octet-stream;charset=GBK\nContent-Disposition: attachment; filename=\"%D6%D0%CE%C4.xlsx\n```\n\n噢，filename 那里多了一个双引号，去掉吧！\n\n# 第二步探索\n\n然而，引号去掉之后，问题依旧！什么情况？难道是 filename 需要引号包起来？\n\n好吧，包起来试试！\n\n# 第三步探索\n\n包起来后问题依旧，什么鬼？\n\n灵机一动，去看看别人怎么做的吧！于是找到别人网站一个下载 Excel 的页面，点击下载，发现响应 header 里面是这样的：\n\n```\nContent-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8\nContent-Disposition: inline;filename=\"%D6%D0%CE%C4.xlsx\";filename*=utf-8''%D6%D0%CE%C4.xlsx\n```\n\nContent-Type 指明了具体的文件类型，然后 Content-Disposition 多了一个 `filename*=` ，这是什么东西？ `utf-8` 是什么编码？\n\n经过一堆胡乱搜索，猜测 utf-8 就是文件名的编码。为啥文件名要编码呢？呃，HTTP header 里面还未见过中文……\n\n好了，我们后端的代码大致做法是这样的：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\") + \"\\\".xlsx\");\n```\n\n看起来，只需要用 `filename*=` 附上编码就行了，于是后端代码改成：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\") + \"\\\".xlsx;filename*=GBK''\" + new String(fileName.getBytes(\"GBK\"), \"ISO-8859-1\"));\n```\n\n好了，我再点击下载，没问题！\n\n# 第四步探索\n\n看起来好像是 OK 了，但是，用 IE 试一下，又不正常了，文件名字不对了！\n\n为什么呢？别人网站在 IE 下都能正常下载的！现在主要有两处区别：\n\n- 我们的 Content-Type 没有写具体；\n- 我们使用了 GBK 编码。\n\n一思索，感觉编码的嫌疑较大，为啥呢？因为对于文件下载，浏览器根本不用管文件内容是个啥，只需要按照二进制流写入本地磁盘就好了，并且，此处也只是文件名错了，下载下来的文件内容还是没问题的。\n\n那就改编码吧，改成 UTF-8 ：\n\n```java\nresponse.addHeader(\"Content-Type\", \"application/octet-stream\");\nresponse.addHeader(\"Content-Disposition\", \"attachment; filename=\\\"\" + new String(fileName.getBytes(\"UTF-8\"), \"ISO-8859-1\") + \"\\\".xlsx;filename*=UTF-8''\" + new String(fileName.getBytes(\"UTF-8\"), \"ISO-8859-1\"));\n```\n\n经测试，一切正常！\n\n# 总结\n\n在文件下载功能中，一般都会借助于这两个 header 来达到效果，那么两个 header 的具体作用是什么呢？\n\n- Content-Type：告诉浏览器当前的响应体是个什么类型的数据。当其为 application/octet-stream 的时候，就说明 body 里面是一堆不知道是啥的二进制数据。\n- Content-Disposition：用于向浏览器提供一些关于如何处理响应内容的额外的信息，同时也可以附带一些其它数据，比如在保存响应体到本地的时候应该使用什么样的文件名。\n\n细想一下， Content-Type 好像对于文件下载没什么作用？事实上的确如此。可是再想一下，如果浏览器不理会 Content-Disposition ，不下载文件怎么办？如果此时提供了 Content-Type ,至少浏览器还有机会根据具体的 Content-Type 对响应体进行处理。\n\n可是为什么浏览器会不理会 Content-Disposition 呢？因为这个 Content-Disposition 头部并不是 HTTP 标准中的内容，只是被浏览器广泛实现的一个 header 而已。\n\n话题转一转， Content-Disposition 的语法见[此处](https://tools.ietf.org/html/rfc6266#section-4.1)，其中相对重要的点此处罗列一下：\n\n- 常用的 disponsition-type 有 `inline` 和 `attachment` ：\n    - inline：建议浏览器使用默认的行为处理响应体。\n    - attachment：建议浏览器将响应体保存到本地，而不是正常处理响应体。\n- Content-Disposition 中可以传入 filename 参数，有两种形式：\n    - filename=yourfilename.suffix：直接指明文件名和后缀。\n    - filename*=utf-8''yourfilename.suffix：指定了文件名编码。其中，编码后面那对单引号中还可以填入内容，此处不赘述，可参考[规范](https://tools.ietf.org/html/rfc6266)。\n    - 有些浏览器不认识 `filename*=utf-8''yourfilename.suffix` （估计因为这东西比较复杂），所以最好带上 `filename=yourfilename.suffix` 。\n","slug":"filedownload","published":1,"updated":"2016-06-17T16:12:32.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02f000n04070dwxw697","content":"<p>在 WEB 开发中，我们会期望用户在点击某个链接的时候，下载一个文件（不管这个文件能不能被浏览器解析，都要下载）。以前接触过一种方式，就是在响应 header 中设置 <code>force-download</code> ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/force-download</div><div class=\"line\">Content-Disposition: attachment; filename=&quot;test.zip&quot;</div></pre></td></tr></table></figure>\n<p>然而，这是一种 hack 方式，并不推荐使用：<br><a id=\"more\"></a></p>\n<blockquote><p>Content-Type: application/force-download means “I, the web server, am going to lie to you (the browser) about what this file is so that you will not treat it as a PDF/Word Document/MP3/whatever and prompt the user to save the mysterious file to disk instead”. It is a dirty hack that breaks horribly when the client doesn’t do “save to disk”.</p>\n<footer><strong>Quentin</strong><cite><a href=\"http://stackoverflow.com/a/10616753/3468416\" target=\"_blank\" rel=\"external\">Utility of HTTP header “Content-Type: application/force-download” for mobile?</a></cite></footer></blockquote>\n<p>有位小伙伴就遇到了不奏效的情况：</p>\n<blockquote><p>ATTENTION:<br>If you use any of the lines below your download will probably NOT WORK on Android 2.1.<br><br></p>\n<p>Content-Type: application/force-download<br>Content-Disposition: attachment; filename=MyFileName.ZIP<br>Content-Disposition: attachment; filename=”MyFileName.zip”<br>Content-Disposition: attachment; filename=”MyFileName.ZIP”;</p>\n<footer><strong>Jörg Wagner</strong><cite><a href=\"http://www.digiblog.de/2011/04/android-and-the-download-file-headers/\" target=\"_blank\" rel=\"external\">Android and the HTTP download file headers</a></cite></footer></blockquote>\n<p>那么，究竟怎么办呢？接下来描述我的同事和我遇到的问题。</p>\n<h1 id=\"问题发现\"><a href=\"#问题发现\" class=\"headerlink\" title=\"问题发现\"></a>问题发现</h1><p>最近接手了一个新项目，今天刚好有空熟悉一下之前的功能。于是打开线上地址，输入测试账号，进入一个列表页面，这个列表页面提供了下载数据为 Excel 文件的功能，点了一下<code>下载</code>链接，猛然发现，下载的文件名字怎么是 <code>download</code> ？为啥呢？</p>\n<p>我用的浏览器是 Chrome 51 ，系统是 OS EI Capitan 10.11.5 。</p>\n<p>我一同事 Chrome 47，可以完全正常下载！</p>\n<p>先看看为啥我的浏览器不行吧！</p>\n<h1 id=\"第一步探索\"><a href=\"#第一步探索\" class=\"headerlink\" title=\"第一步探索\"></a>第一步探索</h1><p>打开 Chrome 开发者工具，查看 HTTP 请求，发现响应头部有如下两项：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/octet-stream;charset=GBK</div><div class=\"line\">Content-Disposition: attachment; filename=&quot;%D6%D0%CE%C4.xlsx</div></pre></td></tr></table></figure>\n<p>噢，filename 那里多了一个双引号，去掉吧！</p>\n<h1 id=\"第二步探索\"><a href=\"#第二步探索\" class=\"headerlink\" title=\"第二步探索\"></a>第二步探索</h1><p>然而，引号去掉之后，问题依旧！什么情况？难道是 filename 需要引号包起来？</p>\n<p>好吧，包起来试试！</p>\n<h1 id=\"第三步探索\"><a href=\"#第三步探索\" class=\"headerlink\" title=\"第三步探索\"></a>第三步探索</h1><p>包起来后问题依旧，什么鬼？</p>\n<p>灵机一动，去看看别人怎么做的吧！于是找到别人网站一个下载 Excel 的页面，点击下载，发现响应 header 里面是这样的：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8</div><div class=\"line\">Content-Disposition: inline;filename=&quot;%D6%D0%CE%C4.xlsx&quot;;filename*=utf-8&apos;&apos;%D6%D0%CE%C4.xlsx</div></pre></td></tr></table></figure>\n<p>Content-Type 指明了具体的文件类型，然后 Content-Disposition 多了一个 <code>filename*=</code> ，这是什么东西？ <code>utf-8</code> 是什么编码？</p>\n<p>经过一堆胡乱搜索，猜测 utf-8 就是文件名的编码。为啥文件名要编码呢？呃，HTTP header 里面还未见过中文……</p>\n<p>好了，我们后端的代码大致做法是这样的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx\"</span>);</div></pre></td></tr></table></figure>\n<p>看起来，只需要用 <code>filename*=</code> 附上编码就行了，于是后端代码改成：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx;filename*=GBK''\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>));</div></pre></td></tr></table></figure>\n<p>好了，我再点击下载，没问题！</p>\n<h1 id=\"第四步探索\"><a href=\"#第四步探索\" class=\"headerlink\" title=\"第四步探索\"></a>第四步探索</h1><p>看起来好像是 OK 了，但是，用 IE 试一下，又不正常了，文件名字不对了！</p>\n<p>为什么呢？别人网站在 IE 下都能正常下载的！现在主要有两处区别：</p>\n<ul>\n<li>我们的 Content-Type 没有写具体；</li>\n<li>我们使用了 GBK 编码。</li>\n</ul>\n<p>一思索，感觉编码的嫌疑较大，为啥呢？因为对于文件下载，浏览器根本不用管文件内容是个啥，只需要按照二进制流写入本地磁盘就好了，并且，此处也只是文件名错了，下载下来的文件内容还是没问题的。</p>\n<p>那就改编码吧，改成 UTF-8 ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"UTF-8\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx;filename*=UTF-8''\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"UTF-8\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>));</div></pre></td></tr></table></figure>\n<p>经测试，一切正常！</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>在文件下载功能中，一般都会借助于这两个 header 来达到效果，那么两个 header 的具体作用是什么呢？</p>\n<ul>\n<li>Content-Type：告诉浏览器当前的响应体是个什么类型的数据。当其为 application/octet-stream 的时候，就说明 body 里面是一堆不知道是啥的二进制数据。</li>\n<li>Content-Disposition：用于向浏览器提供一些关于如何处理响应内容的额外的信息，同时也可以附带一些其它数据，比如在保存响应体到本地的时候应该使用什么样的文件名。</li>\n</ul>\n<p>细想一下， Content-Type 好像对于文件下载没什么作用？事实上的确如此。可是再想一下，如果浏览器不理会 Content-Disposition ，不下载文件怎么办？如果此时提供了 Content-Type ,至少浏览器还有机会根据具体的 Content-Type 对响应体进行处理。</p>\n<p>可是为什么浏览器会不理会 Content-Disposition 呢？因为这个 Content-Disposition 头部并不是 HTTP 标准中的内容，只是被浏览器广泛实现的一个 header 而已。</p>\n<p>话题转一转， Content-Disposition 的语法见<a href=\"https://tools.ietf.org/html/rfc6266#section-4.1\" target=\"_blank\" rel=\"external\">此处</a>，其中相对重要的点此处罗列一下：</p>\n<ul>\n<li>常用的 disponsition-type 有 <code>inline</code> 和 <code>attachment</code> ：<ul>\n<li>inline：建议浏览器使用默认的行为处理响应体。</li>\n<li>attachment：建议浏览器将响应体保存到本地，而不是正常处理响应体。</li>\n</ul>\n</li>\n<li>Content-Disposition 中可以传入 filename 参数，有两种形式：<ul>\n<li>filename=yourfilename.suffix：直接指明文件名和后缀。</li>\n<li>filename*=utf-8’’yourfilename.suffix：指定了文件名编码。其中，编码后面那对单引号中还可以填入内容，此处不赘述，可参考<a href=\"https://tools.ietf.org/html/rfc6266\" target=\"_blank\" rel=\"external\">规范</a>。</li>\n<li>有些浏览器不认识 <code>filename*=utf-8&#39;&#39;yourfilename.suffix</code> （估计因为这东西比较复杂），所以最好带上 <code>filename=yourfilename.suffix</code> 。</li>\n</ul>\n</li>\n</ul>\n","excerpt":"<p>在 WEB 开发中，我们会期望用户在点击某个链接的时候，下载一个文件（不管这个文件能不能被浏览器解析，都要下载）。以前接触过一种方式，就是在响应 header 中设置 <code>force-download</code> ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/force-download</div><div class=\"line\">Content-Disposition: attachment; filename=&quot;test.zip&quot;</div></pre></td></tr></table></figure>\n<p>然而，这是一种 hack 方式，并不推荐使用：<br>","more":"</p>\n<blockquote><p>Content-Type: application/force-download means “I, the web server, am going to lie to you (the browser) about what this file is so that you will not treat it as a PDF/Word Document/MP3/whatever and prompt the user to save the mysterious file to disk instead”. It is a dirty hack that breaks horribly when the client doesn’t do “save to disk”.</p>\n<footer><strong>Quentin</strong><cite><a href=\"http://stackoverflow.com/a/10616753/3468416\">Utility of HTTP header “Content-Type: application/force-download” for mobile?</a></cite></footer></blockquote>\n<p>有位小伙伴就遇到了不奏效的情况：</p>\n<blockquote><p>ATTENTION:<br>If you use any of the lines below your download will probably NOT WORK on Android 2.1.<br><br></p>\n<p>Content-Type: application/force-download<br>Content-Disposition: attachment; filename=MyFileName.ZIP<br>Content-Disposition: attachment; filename=”MyFileName.zip”<br>Content-Disposition: attachment; filename=”MyFileName.ZIP”;</p>\n<footer><strong>Jörg Wagner</strong><cite><a href=\"http://www.digiblog.de/2011/04/android-and-the-download-file-headers/\">Android and the HTTP download file headers</a></cite></footer></blockquote>\n<p>那么，究竟怎么办呢？接下来描述我的同事和我遇到的问题。</p>\n<h1 id=\"问题发现\"><a href=\"#问题发现\" class=\"headerlink\" title=\"问题发现\"></a>问题发现</h1><p>最近接手了一个新项目，今天刚好有空熟悉一下之前的功能。于是打开线上地址，输入测试账号，进入一个列表页面，这个列表页面提供了下载数据为 Excel 文件的功能，点了一下<code>下载</code>链接，猛然发现，下载的文件名字怎么是 <code>download</code> ？为啥呢？</p>\n<p>我用的浏览器是 Chrome 51 ，系统是 OS EI Capitan 10.11.5 。</p>\n<p>我一同事 Chrome 47，可以完全正常下载！</p>\n<p>先看看为啥我的浏览器不行吧！</p>\n<h1 id=\"第一步探索\"><a href=\"#第一步探索\" class=\"headerlink\" title=\"第一步探索\"></a>第一步探索</h1><p>打开 Chrome 开发者工具，查看 HTTP 请求，发现响应头部有如下两项：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/octet-stream;charset=GBK</div><div class=\"line\">Content-Disposition: attachment; filename=&quot;%D6%D0%CE%C4.xlsx</div></pre></td></tr></table></figure>\n<p>噢，filename 那里多了一个双引号，去掉吧！</p>\n<h1 id=\"第二步探索\"><a href=\"#第二步探索\" class=\"headerlink\" title=\"第二步探索\"></a>第二步探索</h1><p>然而，引号去掉之后，问题依旧！什么情况？难道是 filename 需要引号包起来？</p>\n<p>好吧，包起来试试！</p>\n<h1 id=\"第三步探索\"><a href=\"#第三步探索\" class=\"headerlink\" title=\"第三步探索\"></a>第三步探索</h1><p>包起来后问题依旧，什么鬼？</p>\n<p>灵机一动，去看看别人怎么做的吧！于是找到别人网站一个下载 Excel 的页面，点击下载，发现响应 header 里面是这样的：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8</div><div class=\"line\">Content-Disposition: inline;filename=&quot;%D6%D0%CE%C4.xlsx&quot;;filename*=utf-8&apos;&apos;%D6%D0%CE%C4.xlsx</div></pre></td></tr></table></figure>\n<p>Content-Type 指明了具体的文件类型，然后 Content-Disposition 多了一个 <code>filename*=</code> ，这是什么东西？ <code>utf-8</code> 是什么编码？</p>\n<p>经过一堆胡乱搜索，猜测 utf-8 就是文件名的编码。为啥文件名要编码呢？呃，HTTP header 里面还未见过中文……</p>\n<p>好了，我们后端的代码大致做法是这样的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx\"</span>);</div></pre></td></tr></table></figure>\n<p>看起来，只需要用 <code>filename*=</code> 附上编码就行了，于是后端代码改成：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx;filename*=GBK''\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"GBK\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>));</div></pre></td></tr></table></figure>\n<p>好了，我再点击下载，没问题！</p>\n<h1 id=\"第四步探索\"><a href=\"#第四步探索\" class=\"headerlink\" title=\"第四步探索\"></a>第四步探索</h1><p>看起来好像是 OK 了，但是，用 IE 试一下，又不正常了，文件名字不对了！</p>\n<p>为什么呢？别人网站在 IE 下都能正常下载的！现在主要有两处区别：</p>\n<ul>\n<li>我们的 Content-Type 没有写具体；</li>\n<li>我们使用了 GBK 编码。</li>\n</ul>\n<p>一思索，感觉编码的嫌疑较大，为啥呢？因为对于文件下载，浏览器根本不用管文件内容是个啥，只需要按照二进制流写入本地磁盘就好了，并且，此处也只是文件名错了，下载下来的文件内容还是没问题的。</p>\n<p>那就改编码吧，改成 UTF-8 ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Type\"</span>, <span class=\"string\">\"application/octet-stream\"</span>);</div><div class=\"line\">response.addHeader(<span class=\"string\">\"Content-Disposition\"</span>, <span class=\"string\">\"attachment; filename=\\\"\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"UTF-8\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>) + <span class=\"string\">\"\\\".xlsx;filename*=UTF-8''\"</span> + <span class=\"keyword\">new</span> String(fileName.getBytes(<span class=\"string\">\"UTF-8\"</span>), <span class=\"string\">\"ISO-8859-1\"</span>));</div></pre></td></tr></table></figure>\n<p>经测试，一切正常！</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>在文件下载功能中，一般都会借助于这两个 header 来达到效果，那么两个 header 的具体作用是什么呢？</p>\n<ul>\n<li>Content-Type：告诉浏览器当前的响应体是个什么类型的数据。当其为 application/octet-stream 的时候，就说明 body 里面是一堆不知道是啥的二进制数据。</li>\n<li>Content-Disposition：用于向浏览器提供一些关于如何处理响应内容的额外的信息，同时也可以附带一些其它数据，比如在保存响应体到本地的时候应该使用什么样的文件名。</li>\n</ul>\n<p>细想一下， Content-Type 好像对于文件下载没什么作用？事实上的确如此。可是再想一下，如果浏览器不理会 Content-Disposition ，不下载文件怎么办？如果此时提供了 Content-Type ,至少浏览器还有机会根据具体的 Content-Type 对响应体进行处理。</p>\n<p>可是为什么浏览器会不理会 Content-Disposition 呢？因为这个 Content-Disposition 头部并不是 HTTP 标准中的内容，只是被浏览器广泛实现的一个 header 而已。</p>\n<p>话题转一转， Content-Disposition 的语法见<a href=\"https://tools.ietf.org/html/rfc6266#section-4.1\">此处</a>，其中相对重要的点此处罗列一下：</p>\n<ul>\n<li>常用的 disponsition-type 有 <code>inline</code> 和 <code>attachment</code> ：<ul>\n<li>inline：建议浏览器使用默认的行为处理响应体。</li>\n<li>attachment：建议浏览器将响应体保存到本地，而不是正常处理响应体。</li>\n</ul>\n</li>\n<li>Content-Disposition 中可以传入 filename 参数，有两种形式：<ul>\n<li>filename=yourfilename.suffix：直接指明文件名和后缀。</li>\n<li>filename*=utf-8’’yourfilename.suffix：指定了文件名编码。其中，编码后面那对单引号中还可以填入内容，此处不赘述，可参考<a href=\"https://tools.ietf.org/html/rfc6266\">规范</a>。</li>\n<li>有些浏览器不认识 <code>filename*=utf-8&#39;&#39;yourfilename.suffix</code> （估计因为这东西比较复杂），所以最好带上 <code>filename=yourfilename.suffix</code> 。</li>\n</ul>\n</li>\n</ul>"},{"title":"karma 入门","date":"2016-07-01T02:35:44.000Z","_content":"\n本文介绍了 karma 的入门知识点。\n<!-- more -->\n\n# 什么是 karma\n\nkarma 是一个提升测试效率的工具，帮助开发者更好更快速地在多种环境下执行测试代码，拿到测试结果。在运行的时候，它会自动启动配置好的浏览器，同时也会启动一个 node 服务器，然后在启动好的浏览器中执行测试代码，并将测试代码执行结果传回给 node 服务器，然后 node 服务器在打印出收到的执行结果。\n\n# 安装 karma\n\n可以通过 npm 安装 karma ：\n\n```\n// 本地安装\nnpm i karma --save-dev\n\n// 全局安装\nnpm i karma -g\n```\n\n# 初始化 karma\n\n安装完成之后，切换到目标项目根目录，运行：\n\n```\nkarma init\n```\n\n这样就会以向导的形式生成 karma 的配置文件 `karma.conf.js` ，文件内容大致为：\n\n```js\n// Karma configuration\n// Generated on Wed Jun 29 2016 23:22:24 GMT+0800 (CST)\n\nmodule.exports = function(config) {\n    config.set({\n\n        // 根路径，后面配置的基本所有相对路径都会根据这个路径来构造。\n        basePath: '',\n\n\n        // 使用到的框架\n        // 目前支持的框架： https://npmjs.org/browse/keyword/karma-adapter\n        frameworks: ['jasmine', 'requirejs'],\n\n\n        // 将会在浏览器里面执行的代码\n        files: [\n            'test/main.js',\n            {\n                pattern: 'src/**/*.js',\n                // false 表示初始化的时候不会使用 script 标签直接将相关 js 引入到浏览器，需要自己写代码加载\n                included: false\n            },\n            {\n                pattern: 'test/**/*Spec.js',\n                included: false\n            }\n        ],\n\n\n        // 需要从 files 中排除掉的文件\n        exclude: [],\n\n\n        // 需要做预处理的文件，以及这些文件对应的预处理器。\n        // 此处就可以将 coffee 、 ES6 等代码转换一下。\n        preprocessors: {\n            'src/**/*.js': ['babel', 'coverage'],\n            'test/**/!(main).js': ['babel', 'coverage'],\n            'node_modules/protectobject/src/**/*.js': ['babel']\n        },\n\n        // babel 预处理器的配置\n        babelPreprocessor: {\n            options: {\n                presets: ['es2015', 'stage-0'],\n                plugins: ['transform-decorators-legacy', 'transform-es2015-modules-amd']\n            }\n        },\n\n        // 覆盖率报告器配置\n        coverageReporter: {\n            type: 'html',\n            dir: 'coverage'\n        },\n\n\n        // 实际使用的报告期\n        // 可用的报告器： https://npmjs.org/browse/keyword/karma-reporter\n        reporters: ['dots', 'coverage'],\n\n\n        // 服务器端口号\n        port: 9876,\n\n\n        // 在输出内容（报告器和日志）中启用/禁用颜色\n        colors: true,\n\n\n        // 日志级别\n        // 取值： config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG\n        logLevel: config.LOG_INFO,\n\n\n        // 启用/禁用监视文件变化重新执行测试的功能\n        autoWatch: true,\n\n\n        // 要测试的目标环境\n        browsers: ['Chrome', 'Firefox', 'Safari'],\n\n\n        // Continuous Integration mode\n        // if true, Karma captures browsers, runs the tests and exits\n        singleRun: false,\n\n        // Concurrency level\n        // how many browser should be started simultaneous\n        concurrency: Infinity\n    });\n};\n```\n\n# 配置 Require.js\n\n对于 Require.js ，还要注意配置一个入口文件，主要用于配置 Require.js 的模块信息等。\n\n上述 karma 配置文件中的 test/main.js 即为 Require.js 的入口文件，在该文件中的代码一般来说应该是这样的：\n\n```js\nvar TEST_REGEXP = /(spec|test)\\.js$/i;\nvar allTestFiles = [];\n\n// Get a list of all the test files to include\nObject.keys(window.__karma__.files).forEach(function(file) {\n  if (TEST_REGEXP.test(file)) {\n    // Normalize paths to RequireJS module names.\n    // If you require sub-dependencies of test files to be loaded as-is (requiring file extension)\n    // then do not normalize the paths\n    var normalizedTestModule = file.replace(/^\\/base\\/|\\.js$/g, '');\n    allTestFiles.push(normalizedTestModule);\n  }\n});\n\nrequire.config({\n  // Karma serves files under /base, which is the basePath from your config file\n  baseUrl: '/base/src',\n\n  // example of using a couple of path translations (paths), to allow us to refer to different library dependencies, without using relative paths\n  paths: {\n    'jquery': '../lib/jquery',\n    'underscore': '../lib/underscore',\n  },\n\n  // example of using a shim, to load non AMD libraries (such as underscore)\n  shim: {\n    'underscore': {\n      exports: '_'\n    }\n  },\n\n  // dynamically load all test files\n  deps: allTestFiles,\n\n  // we have to kickoff jasmine, as it is asynchronous\n  callback: window.__karma__.start\n});\n```\n\n# 执行测试\n\n运行如下命令，执行测试：\n\n```\nkarma start\n```\n\n# karma 分析\n\n在执行测试的时候，点击 `debug` 按钮，进入 debug 页面，然后打开浏览器开发者工具，可以看到在 HTML 中有一段 js 代码：\n\n```js\n// Configure our Karma\n    window.__karma__.config = {\"args\":[],\"useIframe\":true,\"captureConsole\":true,\"clearContext\":true};\n\n\n    // All served files with the latest timestamps\n    window.__karma__.files = {\n  '/base/node_modules/requirejs/require.js': '2c8b45573db27c131094a113e995236d20f043bb',\n  '/base/node_modules/karma-requirejs/lib/adapter.js': '2621a4400d4a8a49588243fce2d8609ef950b46a',\n  '/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js': '391e45351df9ee35392d2e5cb623221a969fc009',\n  '/base/node_modules/karma-jasmine/lib/boot.js': '945a38bf4e45ad2770eb94868231905a04a0bd3e',\n  '/base/node_modules/karma-jasmine/lib/adapter.js': '7975a273517f1eb29d7bd018790fd4c7b9a485d5',\n  '/base/test/main.js': 'fc5206f4dff3b583db818cb10ed7c5cade572896',\n  '/base/src/State.js': 'db89a58b4570983b8f8febfd4dedbc586c353670',\n  '/base/test/StateSpec.js': 'faf31b373690a6d7a7035fdfdc9c85d906ace5c1'\n};\n```\n\n可以看到 `window.__karma__.files` 中列出了所有的可能会在浏览器中执行的 js ，如果通过 Require.js 加载这里没有列举出来的 js ，就会报错。\n\n然后再看下面的一堆 script 标签，大致是这样的：\n\n```html\n<script type=\"text/javascript\" src=\"/base/node_modules/requirejs/require.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-requirejs/lib/adapter.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-jasmine/lib/boot.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-jasmine/lib/adapter.js\"></script>\n<script type=\"text/javascript\" src=\"/base/test/main.js\"></script>\n  <script type=\"text/javascript\">\n    window.__karma__.loaded();\n  </script>\n```\n\n可以看到，直接引入了 require.js 、 karma 相关的一堆 js 、jasmine 相关的 js ，还直接引入了刚才配置的 test/main.js （Require.js 入口文件）。注意，此处并没有直接引入 `included: false` 的 js 。\n\n## URL 路径中的 `base`\n\n如果仔细看各种资源请求的 URL 地址，会发现除了 `debug.js` 和 `context.js` 之外，其它 js 文件都会以 `/base` 开头，在配置 Require.js 的时候，务必注意这一点。\n\n## coverage\n\n可以引入 karma 的 coverage 插件来查看测试覆盖率，该插件会在目标代码中插入很多额外的代码，用于判断测试代码执行流程有没有走到这些地方。在 debug 的时候，最好关掉 coverage 功能，不然这些额外的代码非常影响调试。\n\n另外 karma-coverage-es6 声称支持 ES6 ，但是似乎并不行？\n\n## jasmine 的 HTML reporter\n\n默认情况下，浏览器中 debug 页面是不会输出任何 jamine 测试结果的，可以借助 `karma-jasmine-html-reporter` 解决这个问题。\n\n但是，`karma-jasmine-html-reporter` 有坑，在该插件的 index.js 中，有这样一段代码：\n\n```js\nvar createPattern = function(path) {\n  return {pattern: path, included: true, served: true, watched: false};\n};\n\nvar initReporter = function(files,  baseReporterDecorator) {\n\n  baseReporterDecorator(this);\n\n  files.unshift(createPattern(__dirname + '/lib/adapter.js'));\n  files.unshift(createPattern(__dirname + '/lib/html.jasmine.reporter.js'));\n  files.unshift(createPattern(__dirname + '/css/jasmine.css'));\n};\n\ninitReporter.$inject = ['config.files',  'baseReporterDecorator'];\n\nmodule.exports = {\n  'reporter:kjhtml': ['type', initReporter]\n};\n```\n\n`files` 指的就是 karma.conf.js 中配置的 files ，此处使用 `unshift` 方法将这堆 js 、 css 放在了 files 最前面，这样就会导致 `html.jasmine.reporter.js` 先于 `jasmine.js` 加载，从而报错（`html.jasmine.reporter.js` 是要依赖 `jasmine.js` 的），所以这里最好根据项目的实际情况，合理调整一下顺序。\n","source":"_posts/karma-入门.md","raw":"---\ntitle: karma 入门\ndate: 2016-07-01 10:35:44\n---\n\n本文介绍了 karma 的入门知识点。\n<!-- more -->\n\n# 什么是 karma\n\nkarma 是一个提升测试效率的工具，帮助开发者更好更快速地在多种环境下执行测试代码，拿到测试结果。在运行的时候，它会自动启动配置好的浏览器，同时也会启动一个 node 服务器，然后在启动好的浏览器中执行测试代码，并将测试代码执行结果传回给 node 服务器，然后 node 服务器在打印出收到的执行结果。\n\n# 安装 karma\n\n可以通过 npm 安装 karma ：\n\n```\n// 本地安装\nnpm i karma --save-dev\n\n// 全局安装\nnpm i karma -g\n```\n\n# 初始化 karma\n\n安装完成之后，切换到目标项目根目录，运行：\n\n```\nkarma init\n```\n\n这样就会以向导的形式生成 karma 的配置文件 `karma.conf.js` ，文件内容大致为：\n\n```js\n// Karma configuration\n// Generated on Wed Jun 29 2016 23:22:24 GMT+0800 (CST)\n\nmodule.exports = function(config) {\n    config.set({\n\n        // 根路径，后面配置的基本所有相对路径都会根据这个路径来构造。\n        basePath: '',\n\n\n        // 使用到的框架\n        // 目前支持的框架： https://npmjs.org/browse/keyword/karma-adapter\n        frameworks: ['jasmine', 'requirejs'],\n\n\n        // 将会在浏览器里面执行的代码\n        files: [\n            'test/main.js',\n            {\n                pattern: 'src/**/*.js',\n                // false 表示初始化的时候不会使用 script 标签直接将相关 js 引入到浏览器，需要自己写代码加载\n                included: false\n            },\n            {\n                pattern: 'test/**/*Spec.js',\n                included: false\n            }\n        ],\n\n\n        // 需要从 files 中排除掉的文件\n        exclude: [],\n\n\n        // 需要做预处理的文件，以及这些文件对应的预处理器。\n        // 此处就可以将 coffee 、 ES6 等代码转换一下。\n        preprocessors: {\n            'src/**/*.js': ['babel', 'coverage'],\n            'test/**/!(main).js': ['babel', 'coverage'],\n            'node_modules/protectobject/src/**/*.js': ['babel']\n        },\n\n        // babel 预处理器的配置\n        babelPreprocessor: {\n            options: {\n                presets: ['es2015', 'stage-0'],\n                plugins: ['transform-decorators-legacy', 'transform-es2015-modules-amd']\n            }\n        },\n\n        // 覆盖率报告器配置\n        coverageReporter: {\n            type: 'html',\n            dir: 'coverage'\n        },\n\n\n        // 实际使用的报告期\n        // 可用的报告器： https://npmjs.org/browse/keyword/karma-reporter\n        reporters: ['dots', 'coverage'],\n\n\n        // 服务器端口号\n        port: 9876,\n\n\n        // 在输出内容（报告器和日志）中启用/禁用颜色\n        colors: true,\n\n\n        // 日志级别\n        // 取值： config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG\n        logLevel: config.LOG_INFO,\n\n\n        // 启用/禁用监视文件变化重新执行测试的功能\n        autoWatch: true,\n\n\n        // 要测试的目标环境\n        browsers: ['Chrome', 'Firefox', 'Safari'],\n\n\n        // Continuous Integration mode\n        // if true, Karma captures browsers, runs the tests and exits\n        singleRun: false,\n\n        // Concurrency level\n        // how many browser should be started simultaneous\n        concurrency: Infinity\n    });\n};\n```\n\n# 配置 Require.js\n\n对于 Require.js ，还要注意配置一个入口文件，主要用于配置 Require.js 的模块信息等。\n\n上述 karma 配置文件中的 test/main.js 即为 Require.js 的入口文件，在该文件中的代码一般来说应该是这样的：\n\n```js\nvar TEST_REGEXP = /(spec|test)\\.js$/i;\nvar allTestFiles = [];\n\n// Get a list of all the test files to include\nObject.keys(window.__karma__.files).forEach(function(file) {\n  if (TEST_REGEXP.test(file)) {\n    // Normalize paths to RequireJS module names.\n    // If you require sub-dependencies of test files to be loaded as-is (requiring file extension)\n    // then do not normalize the paths\n    var normalizedTestModule = file.replace(/^\\/base\\/|\\.js$/g, '');\n    allTestFiles.push(normalizedTestModule);\n  }\n});\n\nrequire.config({\n  // Karma serves files under /base, which is the basePath from your config file\n  baseUrl: '/base/src',\n\n  // example of using a couple of path translations (paths), to allow us to refer to different library dependencies, without using relative paths\n  paths: {\n    'jquery': '../lib/jquery',\n    'underscore': '../lib/underscore',\n  },\n\n  // example of using a shim, to load non AMD libraries (such as underscore)\n  shim: {\n    'underscore': {\n      exports: '_'\n    }\n  },\n\n  // dynamically load all test files\n  deps: allTestFiles,\n\n  // we have to kickoff jasmine, as it is asynchronous\n  callback: window.__karma__.start\n});\n```\n\n# 执行测试\n\n运行如下命令，执行测试：\n\n```\nkarma start\n```\n\n# karma 分析\n\n在执行测试的时候，点击 `debug` 按钮，进入 debug 页面，然后打开浏览器开发者工具，可以看到在 HTML 中有一段 js 代码：\n\n```js\n// Configure our Karma\n    window.__karma__.config = {\"args\":[],\"useIframe\":true,\"captureConsole\":true,\"clearContext\":true};\n\n\n    // All served files with the latest timestamps\n    window.__karma__.files = {\n  '/base/node_modules/requirejs/require.js': '2c8b45573db27c131094a113e995236d20f043bb',\n  '/base/node_modules/karma-requirejs/lib/adapter.js': '2621a4400d4a8a49588243fce2d8609ef950b46a',\n  '/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js': '391e45351df9ee35392d2e5cb623221a969fc009',\n  '/base/node_modules/karma-jasmine/lib/boot.js': '945a38bf4e45ad2770eb94868231905a04a0bd3e',\n  '/base/node_modules/karma-jasmine/lib/adapter.js': '7975a273517f1eb29d7bd018790fd4c7b9a485d5',\n  '/base/test/main.js': 'fc5206f4dff3b583db818cb10ed7c5cade572896',\n  '/base/src/State.js': 'db89a58b4570983b8f8febfd4dedbc586c353670',\n  '/base/test/StateSpec.js': 'faf31b373690a6d7a7035fdfdc9c85d906ace5c1'\n};\n```\n\n可以看到 `window.__karma__.files` 中列出了所有的可能会在浏览器中执行的 js ，如果通过 Require.js 加载这里没有列举出来的 js ，就会报错。\n\n然后再看下面的一堆 script 标签，大致是这样的：\n\n```html\n<script type=\"text/javascript\" src=\"/base/node_modules/requirejs/require.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-requirejs/lib/adapter.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-jasmine/lib/boot.js\"></script>\n<script type=\"text/javascript\" src=\"/base/node_modules/karma-jasmine/lib/adapter.js\"></script>\n<script type=\"text/javascript\" src=\"/base/test/main.js\"></script>\n  <script type=\"text/javascript\">\n    window.__karma__.loaded();\n  </script>\n```\n\n可以看到，直接引入了 require.js 、 karma 相关的一堆 js 、jasmine 相关的 js ，还直接引入了刚才配置的 test/main.js （Require.js 入口文件）。注意，此处并没有直接引入 `included: false` 的 js 。\n\n## URL 路径中的 `base`\n\n如果仔细看各种资源请求的 URL 地址，会发现除了 `debug.js` 和 `context.js` 之外，其它 js 文件都会以 `/base` 开头，在配置 Require.js 的时候，务必注意这一点。\n\n## coverage\n\n可以引入 karma 的 coverage 插件来查看测试覆盖率，该插件会在目标代码中插入很多额外的代码，用于判断测试代码执行流程有没有走到这些地方。在 debug 的时候，最好关掉 coverage 功能，不然这些额外的代码非常影响调试。\n\n另外 karma-coverage-es6 声称支持 ES6 ，但是似乎并不行？\n\n## jasmine 的 HTML reporter\n\n默认情况下，浏览器中 debug 页面是不会输出任何 jamine 测试结果的，可以借助 `karma-jasmine-html-reporter` 解决这个问题。\n\n但是，`karma-jasmine-html-reporter` 有坑，在该插件的 index.js 中，有这样一段代码：\n\n```js\nvar createPattern = function(path) {\n  return {pattern: path, included: true, served: true, watched: false};\n};\n\nvar initReporter = function(files,  baseReporterDecorator) {\n\n  baseReporterDecorator(this);\n\n  files.unshift(createPattern(__dirname + '/lib/adapter.js'));\n  files.unshift(createPattern(__dirname + '/lib/html.jasmine.reporter.js'));\n  files.unshift(createPattern(__dirname + '/css/jasmine.css'));\n};\n\ninitReporter.$inject = ['config.files',  'baseReporterDecorator'];\n\nmodule.exports = {\n  'reporter:kjhtml': ['type', initReporter]\n};\n```\n\n`files` 指的就是 karma.conf.js 中配置的 files ，此处使用 `unshift` 方法将这堆 js 、 css 放在了 files 最前面，这样就会导致 `html.jasmine.reporter.js` 先于 `jasmine.js` 加载，从而报错（`html.jasmine.reporter.js` 是要依赖 `jasmine.js` 的），所以这里最好根据项目的实际情况，合理调整一下顺序。\n","slug":"karma-入门","published":1,"updated":"2016-07-01T03:56:25.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02i000r0407idbuqkbl","content":"<p>本文介绍了 karma 的入门知识点。<br><a id=\"more\"></a></p>\n<h1 id=\"什么是-karma\"><a href=\"#什么是-karma\" class=\"headerlink\" title=\"什么是 karma\"></a>什么是 karma</h1><p>karma 是一个提升测试效率的工具，帮助开发者更好更快速地在多种环境下执行测试代码，拿到测试结果。在运行的时候，它会自动启动配置好的浏览器，同时也会启动一个 node 服务器，然后在启动好的浏览器中执行测试代码，并将测试代码执行结果传回给 node 服务器，然后 node 服务器在打印出收到的执行结果。</p>\n<h1 id=\"安装-karma\"><a href=\"#安装-karma\" class=\"headerlink\" title=\"安装 karma\"></a>安装 karma</h1><p>可以通过 npm 安装 karma ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">// 本地安装</div><div class=\"line\">npm i karma --save-dev</div><div class=\"line\"></div><div class=\"line\">// 全局安装</div><div class=\"line\">npm i karma -g</div></pre></td></tr></table></figure>\n<h1 id=\"初始化-karma\"><a href=\"#初始化-karma\" class=\"headerlink\" title=\"初始化 karma\"></a>初始化 karma</h1><p>安装完成之后，切换到目标项目根目录，运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">karma init</div></pre></td></tr></table></figure>\n<p>这样就会以向导的形式生成 karma 的配置文件 <code>karma.conf.js</code> ，文件内容大致为：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// Karma configuration</span></div><div class=\"line\"><span class=\"comment\">// Generated on Wed Jun 29 2016 23:22:24 GMT+0800 (CST)</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">config</span>) </span>&#123;</div><div class=\"line\">    config.set(&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 根路径，后面配置的基本所有相对路径都会根据这个路径来构造。</span></div><div class=\"line\">        basePath: <span class=\"string\">''</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 使用到的框架</span></div><div class=\"line\">        <span class=\"comment\">// 目前支持的框架： https://npmjs.org/browse/keyword/karma-adapter</span></div><div class=\"line\">        frameworks: [<span class=\"string\">'jasmine'</span>, <span class=\"string\">'requirejs'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 将会在浏览器里面执行的代码</span></div><div class=\"line\">        files: [</div><div class=\"line\">            <span class=\"string\">'test/main.js'</span>,</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">pattern</span>: <span class=\"string\">'src/**/*.js'</span>,</div><div class=\"line\">                <span class=\"comment\">// false 表示初始化的时候不会使用 script 标签直接将相关 js 引入到浏览器，需要自己写代码加载</span></div><div class=\"line\">                included: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;,</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">pattern</span>: <span class=\"string\">'test/**/*Spec.js'</span>,</div><div class=\"line\">                <span class=\"attr\">included</span>: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        ],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 需要从 files 中排除掉的文件</span></div><div class=\"line\">        exclude: [],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 需要做预处理的文件，以及这些文件对应的预处理器。</span></div><div class=\"line\">        <span class=\"comment\">// 此处就可以将 coffee 、 ES6 等代码转换一下。</span></div><div class=\"line\">        preprocessors: &#123;</div><div class=\"line\">            <span class=\"string\">'src/**/*.js'</span>: [<span class=\"string\">'babel'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\">            <span class=\"string\">'test/**/!(main).js'</span>: [<span class=\"string\">'babel'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\">            <span class=\"string\">'node_modules/protectobject/src/**/*.js'</span>: [<span class=\"string\">'babel'</span>]</div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// babel 预处理器的配置</span></div><div class=\"line\">        babelPreprocessor: &#123;</div><div class=\"line\">            <span class=\"attr\">options</span>: &#123;</div><div class=\"line\">                <span class=\"attr\">presets</span>: [<span class=\"string\">'es2015'</span>, <span class=\"string\">'stage-0'</span>],</div><div class=\"line\">                <span class=\"attr\">plugins</span>: [<span class=\"string\">'transform-decorators-legacy'</span>, <span class=\"string\">'transform-es2015-modules-amd'</span>]</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 覆盖率报告器配置</span></div><div class=\"line\">        coverageReporter: &#123;</div><div class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">'html'</span>,</div><div class=\"line\">            <span class=\"attr\">dir</span>: <span class=\"string\">'coverage'</span></div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 实际使用的报告期</span></div><div class=\"line\">        <span class=\"comment\">// 可用的报告器： https://npmjs.org/browse/keyword/karma-reporter</span></div><div class=\"line\">        reporters: [<span class=\"string\">'dots'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务器端口号</span></div><div class=\"line\">        port: <span class=\"number\">9876</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 在输出内容（报告器和日志）中启用/禁用颜色</span></div><div class=\"line\">        colors: <span class=\"literal\">true</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 日志级别</span></div><div class=\"line\">        <span class=\"comment\">// 取值： config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG</span></div><div class=\"line\">        logLevel: config.LOG_INFO,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 启用/禁用监视文件变化重新执行测试的功能</span></div><div class=\"line\">        autoWatch: <span class=\"literal\">true</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 要测试的目标环境</span></div><div class=\"line\">        browsers: [<span class=\"string\">'Chrome'</span>, <span class=\"string\">'Firefox'</span>, <span class=\"string\">'Safari'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Continuous Integration mode</span></div><div class=\"line\">        <span class=\"comment\">// if true, Karma captures browsers, runs the tests and exits</span></div><div class=\"line\">        singleRun: <span class=\"literal\">false</span>,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Concurrency level</span></div><div class=\"line\">        <span class=\"comment\">// how many browser should be started simultaneous</span></div><div class=\"line\">        concurrency: <span class=\"literal\">Infinity</span></div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<h1 id=\"配置-Require-js\"><a href=\"#配置-Require-js\" class=\"headerlink\" title=\"配置 Require.js\"></a>配置 Require.js</h1><p>对于 Require.js ，还要注意配置一个入口文件，主要用于配置 Require.js 的模块信息等。</p>\n<p>上述 karma 配置文件中的 test/main.js 即为 Require.js 的入口文件，在该文件中的代码一般来说应该是这样的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> TEST_REGEXP = <span class=\"regexp\">/(spec|test)\\.js$/i</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> allTestFiles = [];</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Get a list of all the test files to include</span></div><div class=\"line\"><span class=\"built_in\">Object</span>.keys(<span class=\"built_in\">window</span>.__karma__.files).forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">file</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (TEST_REGEXP.test(file)) &#123;</div><div class=\"line\">    <span class=\"comment\">// Normalize paths to RequireJS module names.</span></div><div class=\"line\">    <span class=\"comment\">// If you require sub-dependencies of test files to be loaded as-is (requiring file extension)</span></div><div class=\"line\">    <span class=\"comment\">// then do not normalize the paths</span></div><div class=\"line\">    <span class=\"keyword\">var</span> normalizedTestModule = file.replace(<span class=\"regexp\">/^\\/base\\/|\\.js$/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    allTestFiles.push(normalizedTestModule);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">require</span>.config(&#123;</div><div class=\"line\">  <span class=\"comment\">// Karma serves files under /base, which is the basePath from your config file</span></div><div class=\"line\">  baseUrl: <span class=\"string\">'/base/src'</span>,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// example of using a couple of path translations (paths), to allow us to refer to different library dependencies, without using relative paths</span></div><div class=\"line\">  paths: &#123;</div><div class=\"line\">    <span class=\"string\">'jquery'</span>: <span class=\"string\">'../lib/jquery'</span>,</div><div class=\"line\">    <span class=\"string\">'underscore'</span>: <span class=\"string\">'../lib/underscore'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// example of using a shim, to load non AMD libraries (such as underscore)</span></div><div class=\"line\">  shim: &#123;</div><div class=\"line\">    <span class=\"string\">'underscore'</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">exports</span>: <span class=\"string\">'_'</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// dynamically load all test files</span></div><div class=\"line\">  deps: allTestFiles,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// we have to kickoff jasmine, as it is asynchronous</span></div><div class=\"line\">  callback: <span class=\"built_in\">window</span>.__karma__.start</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h1 id=\"执行测试\"><a href=\"#执行测试\" class=\"headerlink\" title=\"执行测试\"></a>执行测试</h1><p>运行如下命令，执行测试：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">karma start</div></pre></td></tr></table></figure>\n<h1 id=\"karma-分析\"><a href=\"#karma-分析\" class=\"headerlink\" title=\"karma 分析\"></a>karma 分析</h1><p>在执行测试的时候，点击 <code>debug</code> 按钮，进入 debug 页面，然后打开浏览器开发者工具，可以看到在 HTML 中有一段 js 代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// Configure our Karma</span></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.config = &#123;<span class=\"string\">\"args\"</span>:[],<span class=\"string\">\"useIframe\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"captureConsole\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"clearContext\"</span>:<span class=\"literal\">true</span>&#125;;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// All served files with the latest timestamps</span></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.files = &#123;</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/requirejs/require.js'</span>: <span class=\"string\">'2c8b45573db27c131094a113e995236d20f043bb'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-requirejs/lib/adapter.js'</span>: <span class=\"string\">'2621a4400d4a8a49588243fce2d8609ef950b46a'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js'</span>: <span class=\"string\">'391e45351df9ee35392d2e5cb623221a969fc009'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-jasmine/lib/boot.js'</span>: <span class=\"string\">'945a38bf4e45ad2770eb94868231905a04a0bd3e'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-jasmine/lib/adapter.js'</span>: <span class=\"string\">'7975a273517f1eb29d7bd018790fd4c7b9a485d5'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/test/main.js'</span>: <span class=\"string\">'fc5206f4dff3b583db818cb10ed7c5cade572896'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/src/State.js'</span>: <span class=\"string\">'db89a58b4570983b8f8febfd4dedbc586c353670'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/test/StateSpec.js'</span>: <span class=\"string\">'faf31b373690a6d7a7035fdfdc9c85d906ace5c1'</span></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>可以看到 <code>window.__karma__.files</code> 中列出了所有的可能会在浏览器中执行的 js ，如果通过 Require.js 加载这里没有列举出来的 js ，就会报错。</p>\n<p>然后再看下面的一堆 script 标签，大致是这样的：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/requirejs/require.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-requirejs/lib/adapter.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-jasmine/lib/boot.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-jasmine/lib/adapter.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/test/main.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.loaded();</div><div class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>可以看到，直接引入了 require.js 、 karma 相关的一堆 js 、jasmine 相关的 js ，还直接引入了刚才配置的 test/main.js （Require.js 入口文件）。注意，此处并没有直接引入 <code>included: false</code> 的 js 。</p>\n<h2 id=\"URL-路径中的-base\"><a href=\"#URL-路径中的-base\" class=\"headerlink\" title=\"URL 路径中的 base\"></a>URL 路径中的 <code>base</code></h2><p>如果仔细看各种资源请求的 URL 地址，会发现除了 <code>debug.js</code> 和 <code>context.js</code> 之外，其它 js 文件都会以 <code>/base</code> 开头，在配置 Require.js 的时候，务必注意这一点。</p>\n<h2 id=\"coverage\"><a href=\"#coverage\" class=\"headerlink\" title=\"coverage\"></a>coverage</h2><p>可以引入 karma 的 coverage 插件来查看测试覆盖率，该插件会在目标代码中插入很多额外的代码，用于判断测试代码执行流程有没有走到这些地方。在 debug 的时候，最好关掉 coverage 功能，不然这些额外的代码非常影响调试。</p>\n<p>另外 karma-coverage-es6 声称支持 ES6 ，但是似乎并不行？</p>\n<h2 id=\"jasmine-的-HTML-reporter\"><a href=\"#jasmine-的-HTML-reporter\" class=\"headerlink\" title=\"jasmine 的 HTML reporter\"></a>jasmine 的 HTML reporter</h2><p>默认情况下，浏览器中 debug 页面是不会输出任何 jamine 测试结果的，可以借助 <code>karma-jasmine-html-reporter</code> 解决这个问题。</p>\n<p>但是，<code>karma-jasmine-html-reporter</code> 有坑，在该插件的 index.js 中，有这样一段代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> createPattern = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">path</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> &#123;<span class=\"attr\">pattern</span>: path, <span class=\"attr\">included</span>: <span class=\"literal\">true</span>, <span class=\"attr\">served</span>: <span class=\"literal\">true</span>, <span class=\"attr\">watched</span>: <span class=\"literal\">false</span>&#125;;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> initReporter = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">files,  baseReporterDecorator</span>) </span>&#123;</div><div class=\"line\"></div><div class=\"line\">  baseReporterDecorator(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/lib/adapter.js'</span>));</div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/lib/html.jasmine.reporter.js'</span>));</div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/css/jasmine.css'</span>));</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">initReporter.$inject = [<span class=\"string\">'config.files'</span>,  <span class=\"string\">'baseReporterDecorator'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</div><div class=\"line\">  <span class=\"string\">'reporter:kjhtml'</span>: [<span class=\"string\">'type'</span>, initReporter]</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p><code>files</code> 指的就是 karma.conf.js 中配置的 files ，此处使用 <code>unshift</code> 方法将这堆 js 、 css 放在了 files 最前面，这样就会导致 <code>html.jasmine.reporter.js</code> 先于 <code>jasmine.js</code> 加载，从而报错（<code>html.jasmine.reporter.js</code> 是要依赖 <code>jasmine.js</code> 的），所以这里最好根据项目的实际情况，合理调整一下顺序。</p>\n","excerpt":"<p>本文介绍了 karma 的入门知识点。<br>","more":"</p>\n<h1 id=\"什么是-karma\"><a href=\"#什么是-karma\" class=\"headerlink\" title=\"什么是 karma\"></a>什么是 karma</h1><p>karma 是一个提升测试效率的工具，帮助开发者更好更快速地在多种环境下执行测试代码，拿到测试结果。在运行的时候，它会自动启动配置好的浏览器，同时也会启动一个 node 服务器，然后在启动好的浏览器中执行测试代码，并将测试代码执行结果传回给 node 服务器，然后 node 服务器在打印出收到的执行结果。</p>\n<h1 id=\"安装-karma\"><a href=\"#安装-karma\" class=\"headerlink\" title=\"安装 karma\"></a>安装 karma</h1><p>可以通过 npm 安装 karma ：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">// 本地安装</div><div class=\"line\">npm i karma --save-dev</div><div class=\"line\"></div><div class=\"line\">// 全局安装</div><div class=\"line\">npm i karma -g</div></pre></td></tr></table></figure>\n<h1 id=\"初始化-karma\"><a href=\"#初始化-karma\" class=\"headerlink\" title=\"初始化 karma\"></a>初始化 karma</h1><p>安装完成之后，切换到目标项目根目录，运行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">karma init</div></pre></td></tr></table></figure>\n<p>这样就会以向导的形式生成 karma 的配置文件 <code>karma.conf.js</code> ，文件内容大致为：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// Karma configuration</span></div><div class=\"line\"><span class=\"comment\">// Generated on Wed Jun 29 2016 23:22:24 GMT+0800 (CST)</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">config</span>) </span>&#123;</div><div class=\"line\">    config.set(&#123;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 根路径，后面配置的基本所有相对路径都会根据这个路径来构造。</span></div><div class=\"line\">        basePath: <span class=\"string\">''</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 使用到的框架</span></div><div class=\"line\">        <span class=\"comment\">// 目前支持的框架： https://npmjs.org/browse/keyword/karma-adapter</span></div><div class=\"line\">        frameworks: [<span class=\"string\">'jasmine'</span>, <span class=\"string\">'requirejs'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 将会在浏览器里面执行的代码</span></div><div class=\"line\">        files: [</div><div class=\"line\">            <span class=\"string\">'test/main.js'</span>,</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">pattern</span>: <span class=\"string\">'src/**/*.js'</span>,</div><div class=\"line\">                <span class=\"comment\">// false 表示初始化的时候不会使用 script 标签直接将相关 js 引入到浏览器，需要自己写代码加载</span></div><div class=\"line\">                included: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;,</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">pattern</span>: <span class=\"string\">'test/**/*Spec.js'</span>,</div><div class=\"line\">                <span class=\"attr\">included</span>: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;</div><div class=\"line\">        ],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 需要从 files 中排除掉的文件</span></div><div class=\"line\">        exclude: [],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 需要做预处理的文件，以及这些文件对应的预处理器。</span></div><div class=\"line\">        <span class=\"comment\">// 此处就可以将 coffee 、 ES6 等代码转换一下。</span></div><div class=\"line\">        preprocessors: &#123;</div><div class=\"line\">            <span class=\"string\">'src/**/*.js'</span>: [<span class=\"string\">'babel'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\">            <span class=\"string\">'test/**/!(main).js'</span>: [<span class=\"string\">'babel'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\">            <span class=\"string\">'node_modules/protectobject/src/**/*.js'</span>: [<span class=\"string\">'babel'</span>]</div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// babel 预处理器的配置</span></div><div class=\"line\">        babelPreprocessor: &#123;</div><div class=\"line\">            <span class=\"attr\">options</span>: &#123;</div><div class=\"line\">                <span class=\"attr\">presets</span>: [<span class=\"string\">'es2015'</span>, <span class=\"string\">'stage-0'</span>],</div><div class=\"line\">                <span class=\"attr\">plugins</span>: [<span class=\"string\">'transform-decorators-legacy'</span>, <span class=\"string\">'transform-es2015-modules-amd'</span>]</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 覆盖率报告器配置</span></div><div class=\"line\">        coverageReporter: &#123;</div><div class=\"line\">            <span class=\"attr\">type</span>: <span class=\"string\">'html'</span>,</div><div class=\"line\">            <span class=\"attr\">dir</span>: <span class=\"string\">'coverage'</span></div><div class=\"line\">        &#125;,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 实际使用的报告期</span></div><div class=\"line\">        <span class=\"comment\">// 可用的报告器： https://npmjs.org/browse/keyword/karma-reporter</span></div><div class=\"line\">        reporters: [<span class=\"string\">'dots'</span>, <span class=\"string\">'coverage'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 服务器端口号</span></div><div class=\"line\">        port: <span class=\"number\">9876</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 在输出内容（报告器和日志）中启用/禁用颜色</span></div><div class=\"line\">        colors: <span class=\"literal\">true</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 日志级别</span></div><div class=\"line\">        <span class=\"comment\">// 取值： config.LOG_DISABLE || config.LOG_ERROR || config.LOG_WARN || config.LOG_INFO || config.LOG_DEBUG</span></div><div class=\"line\">        logLevel: config.LOG_INFO,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 启用/禁用监视文件变化重新执行测试的功能</span></div><div class=\"line\">        autoWatch: <span class=\"literal\">true</span>,</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 要测试的目标环境</span></div><div class=\"line\">        browsers: [<span class=\"string\">'Chrome'</span>, <span class=\"string\">'Firefox'</span>, <span class=\"string\">'Safari'</span>],</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Continuous Integration mode</span></div><div class=\"line\">        <span class=\"comment\">// if true, Karma captures browsers, runs the tests and exits</span></div><div class=\"line\">        singleRun: <span class=\"literal\">false</span>,</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// Concurrency level</span></div><div class=\"line\">        <span class=\"comment\">// how many browser should be started simultaneous</span></div><div class=\"line\">        concurrency: <span class=\"literal\">Infinity</span></div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<h1 id=\"配置-Require-js\"><a href=\"#配置-Require-js\" class=\"headerlink\" title=\"配置 Require.js\"></a>配置 Require.js</h1><p>对于 Require.js ，还要注意配置一个入口文件，主要用于配置 Require.js 的模块信息等。</p>\n<p>上述 karma 配置文件中的 test/main.js 即为 Require.js 的入口文件，在该文件中的代码一般来说应该是这样的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> TEST_REGEXP = <span class=\"regexp\">/(spec|test)\\.js$/i</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> allTestFiles = [];</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Get a list of all the test files to include</span></div><div class=\"line\"><span class=\"built_in\">Object</span>.keys(<span class=\"built_in\">window</span>.__karma__.files).forEach(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">file</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (TEST_REGEXP.test(file)) &#123;</div><div class=\"line\">    <span class=\"comment\">// Normalize paths to RequireJS module names.</span></div><div class=\"line\">    <span class=\"comment\">// If you require sub-dependencies of test files to be loaded as-is (requiring file extension)</span></div><div class=\"line\">    <span class=\"comment\">// then do not normalize the paths</span></div><div class=\"line\">    <span class=\"keyword\">var</span> normalizedTestModule = file.replace(<span class=\"regexp\">/^\\/base\\/|\\.js$/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    allTestFiles.push(normalizedTestModule);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">require</span>.config(&#123;</div><div class=\"line\">  <span class=\"comment\">// Karma serves files under /base, which is the basePath from your config file</span></div><div class=\"line\">  baseUrl: <span class=\"string\">'/base/src'</span>,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// example of using a couple of path translations (paths), to allow us to refer to different library dependencies, without using relative paths</span></div><div class=\"line\">  paths: &#123;</div><div class=\"line\">    <span class=\"string\">'jquery'</span>: <span class=\"string\">'../lib/jquery'</span>,</div><div class=\"line\">    <span class=\"string\">'underscore'</span>: <span class=\"string\">'../lib/underscore'</span>,</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// example of using a shim, to load non AMD libraries (such as underscore)</span></div><div class=\"line\">  shim: &#123;</div><div class=\"line\">    <span class=\"string\">'underscore'</span>: &#123;</div><div class=\"line\">      <span class=\"attr\">exports</span>: <span class=\"string\">'_'</span></div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// dynamically load all test files</span></div><div class=\"line\">  deps: allTestFiles,</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">// we have to kickoff jasmine, as it is asynchronous</span></div><div class=\"line\">  callback: <span class=\"built_in\">window</span>.__karma__.start</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h1 id=\"执行测试\"><a href=\"#执行测试\" class=\"headerlink\" title=\"执行测试\"></a>执行测试</h1><p>运行如下命令，执行测试：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">karma start</div></pre></td></tr></table></figure>\n<h1 id=\"karma-分析\"><a href=\"#karma-分析\" class=\"headerlink\" title=\"karma 分析\"></a>karma 分析</h1><p>在执行测试的时候，点击 <code>debug</code> 按钮，进入 debug 页面，然后打开浏览器开发者工具，可以看到在 HTML 中有一段 js 代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// Configure our Karma</span></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.config = &#123;<span class=\"string\">\"args\"</span>:[],<span class=\"string\">\"useIframe\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"captureConsole\"</span>:<span class=\"literal\">true</span>,<span class=\"string\">\"clearContext\"</span>:<span class=\"literal\">true</span>&#125;;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// All served files with the latest timestamps</span></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.files = &#123;</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/requirejs/require.js'</span>: <span class=\"string\">'2c8b45573db27c131094a113e995236d20f043bb'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-requirejs/lib/adapter.js'</span>: <span class=\"string\">'2621a4400d4a8a49588243fce2d8609ef950b46a'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js'</span>: <span class=\"string\">'391e45351df9ee35392d2e5cb623221a969fc009'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-jasmine/lib/boot.js'</span>: <span class=\"string\">'945a38bf4e45ad2770eb94868231905a04a0bd3e'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/node_modules/karma-jasmine/lib/adapter.js'</span>: <span class=\"string\">'7975a273517f1eb29d7bd018790fd4c7b9a485d5'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/test/main.js'</span>: <span class=\"string\">'fc5206f4dff3b583db818cb10ed7c5cade572896'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/src/State.js'</span>: <span class=\"string\">'db89a58b4570983b8f8febfd4dedbc586c353670'</span>,</div><div class=\"line\">  <span class=\"string\">'/base/test/StateSpec.js'</span>: <span class=\"string\">'faf31b373690a6d7a7035fdfdc9c85d906ace5c1'</span></div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>可以看到 <code>window.__karma__.files</code> 中列出了所有的可能会在浏览器中执行的 js ，如果通过 Require.js 加载这里没有列举出来的 js ，就会报错。</p>\n<p>然后再看下面的一堆 script 标签，大致是这样的：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/requirejs/require.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-requirejs/lib/adapter.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/jasmine-core/lib/jasmine-core/jasmine.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-jasmine/lib/boot.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/node_modules/karma-jasmine/lib/adapter.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span> <span class=\"attr\">src</span>=<span class=\"string\">\"/base/test/main.js\"</span>&gt;</span><span class=\"undefined\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">    <span class=\"built_in\">window</span>.__karma__.loaded();</div><div class=\"line\">  </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>可以看到，直接引入了 require.js 、 karma 相关的一堆 js 、jasmine 相关的 js ，还直接引入了刚才配置的 test/main.js （Require.js 入口文件）。注意，此处并没有直接引入 <code>included: false</code> 的 js 。</p>\n<h2 id=\"URL-路径中的-base\"><a href=\"#URL-路径中的-base\" class=\"headerlink\" title=\"URL 路径中的 base\"></a>URL 路径中的 <code>base</code></h2><p>如果仔细看各种资源请求的 URL 地址，会发现除了 <code>debug.js</code> 和 <code>context.js</code> 之外，其它 js 文件都会以 <code>/base</code> 开头，在配置 Require.js 的时候，务必注意这一点。</p>\n<h2 id=\"coverage\"><a href=\"#coverage\" class=\"headerlink\" title=\"coverage\"></a>coverage</h2><p>可以引入 karma 的 coverage 插件来查看测试覆盖率，该插件会在目标代码中插入很多额外的代码，用于判断测试代码执行流程有没有走到这些地方。在 debug 的时候，最好关掉 coverage 功能，不然这些额外的代码非常影响调试。</p>\n<p>另外 karma-coverage-es6 声称支持 ES6 ，但是似乎并不行？</p>\n<h2 id=\"jasmine-的-HTML-reporter\"><a href=\"#jasmine-的-HTML-reporter\" class=\"headerlink\" title=\"jasmine 的 HTML reporter\"></a>jasmine 的 HTML reporter</h2><p>默认情况下，浏览器中 debug 页面是不会输出任何 jamine 测试结果的，可以借助 <code>karma-jasmine-html-reporter</code> 解决这个问题。</p>\n<p>但是，<code>karma-jasmine-html-reporter</code> 有坑，在该插件的 index.js 中，有这样一段代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> createPattern = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">path</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> &#123;<span class=\"attr\">pattern</span>: path, <span class=\"attr\">included</span>: <span class=\"literal\">true</span>, <span class=\"attr\">served</span>: <span class=\"literal\">true</span>, <span class=\"attr\">watched</span>: <span class=\"literal\">false</span>&#125;;</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> initReporter = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">files,  baseReporterDecorator</span>) </span>&#123;</div><div class=\"line\"></div><div class=\"line\">  baseReporterDecorator(<span class=\"keyword\">this</span>);</div><div class=\"line\"></div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/lib/adapter.js'</span>));</div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/lib/html.jasmine.reporter.js'</span>));</div><div class=\"line\">  files.unshift(createPattern(__dirname + <span class=\"string\">'/css/jasmine.css'</span>));</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\">initReporter.$inject = [<span class=\"string\">'config.files'</span>,  <span class=\"string\">'baseReporterDecorator'</span>];</div><div class=\"line\"></div><div class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</div><div class=\"line\">  <span class=\"string\">'reporter:kjhtml'</span>: [<span class=\"string\">'type'</span>, initReporter]</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p><code>files</code> 指的就是 karma.conf.js 中配置的 files ，此处使用 <code>unshift</code> 方法将这堆 js 、 css 放在了 files 最前面，这样就会导致 <code>html.jasmine.reporter.js</code> 先于 <code>jasmine.js</code> 加载，从而报错（<code>html.jasmine.reporter.js</code> 是要依赖 <code>jasmine.js</code> 的），所以这里最好根据项目的实际情况，合理调整一下顺序。</p>"},{"title":"oracle 安装","date":"2016-05-23T04:13:00.000Z","excerpt":"<p>这个周末学习了一些后端的技能，折腾了好久 Oracle 数据库，总算安装上了。</p>\n<p>本文记录的东西非常粗浅，仅限于探索如何使用的层面上，因此文中描述的各种观点可能有所错误，欢迎读者批评纠正。<br>","_content":"\n这个周末学习了一些后端的技能，折腾了好久 Oracle 数据库，总算安装上了。\n\n本文记录的东西非常粗浅，仅限于探索如何使用的层面上，因此文中描述的各种观点可能有所错误，欢迎读者批评纠正。\n<!-- more -->\n\n## 基本环境和工具\n\n- 基于 Parallels Desktop 10 的 windows 10 操作系统；\n- JDK 1.8；\n- Oracle 11g。\n\n其中， Oracle 11g 的下载地址是 [win64_11gR2_database_1of2.zip](http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html) 、 [win64_11gR2_database_2of2.zip](http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html)。\n\n## 第一次安装\n\n第一次安装，当然是处于非常的纯净的 windows 10 系统上面，基本没有任何干扰，按照安装说明一步一步往下走，很简单，很轻松，大多数参数都按照默认配置来。这样一路配置下来的话，连接 Oracle 的 URL 就会是 `jdbc:oracle:thin:@10.211.55.4:1521:orcl` （如果使用 Oracle Thin Driver 来连接的话，当然我也不知道是否还存在其他的 Driver ）。\n\n后续可能会遇到一个问题：如何在一个局域网内连接这台 Oracle 服务器上面的数据库呢？默认情况下，用前面所示的 URL 并不能成功连接上，那么，首先就应该去检查连接是不是被 windows 10 的防火墙阻止了，排除了这个原因之后，再去看看 listener 服务有没有启动。\n\n如果使用 PLSQL Developer 这种 GUI 工具连接 Oracle 服务器的话，会有个很蛋疼的问题，就是要关联一个 Oracle 的 client ，这玩意儿在 windows 系统下面可能要容易点，在 OS X 下面坑特别多。稍微列举一些坑：\n\n- client 要分 32bit 和 64bit ，这个好像要和具体的 GUI 工具对应上？不太记得了，后续有时间补上吧！\n- 在 OS X 下面要手动配置各种环境变量。\n\n## 第二次安装（卸载重装）\n\n某一天，我一不小心删掉了手动创建的数据库文件（*.pdf），这下就完蛋了，不能正常工作了：数据库文件丢失。\n\n网上搜了一些资料，没找到正确的处理方式，于是决定重装。\n\n重装的第一步是卸载。\n\n### 卸载\n\n很常规的，先跑到 windows 标准的应用程序卸载那里看了下，发现根本没有 Oracle ，看起来无法从这里卸载。\n\n于是 Google 了一下，发现 Oracle 的卸载好麻烦：手动停服务、删文件、删注册表，这种方式肯定是逗逼方式。\n\n后面鼓捣了会儿，发现“所有程序”里的 Oracle 项目下，有个 Universal Installer 工具，很多应用的安装程序和卸载程序不都是一体的么！抱着试一试的心态，点开了这个程序，果不其然，里面有卸载功能。点击“卸载”按钮，发现只能删除一些目录，果断删除，但是却不能删除主目录，必须要运行主目录下面的 deinstall/deinstall.bat 来卸载。好了，这个程序看起来只是删除目录而已，那么相关的服务可能还得自己手动删除，此处使用了 `sc delete serviceName` 命令删除服务。\n\n这样鼓捣一圈下来之后，发现还有很多 Oracle 目录，感觉只能手动清除掉了。果断使用`鼠标右键->删除`的方式，结果发现被占用了，无法删除，此时可以到`资源监视器 -> cpu 标签 -> 关联的句柄`里面搜索，搜索关键词是文件名，然后找到哪些进程占用了文件，果断结束掉，这样一来，就可以成功删掉这些文件了。\n\n这样卸载完之后，就开始安装了。\n\n### 重装\n\n按照第一次的安装流程来，一步一步的，比较顺利。\n\n但是，在创建数据库的时候，老是说 `local_listener=LISTENER_ORCL` 这玩意儿配置错误， Goolge 了很多资料，基本都不是说的重装遇到的问题。唉，纠结了半天不知道为啥，只好跳过这个创建数据库的步骤，直接安装完成了。\n\n后面仔细一想，从字面猜测应该是 listener 的名字没有和服务里面 listener 的名字对应上，抱着试一试的心态，去 /app/yibuyisheng/admin/orcl/pfile/init.ora 里面做了修改，然后运行 DBCA 重新创建数据库。事实证明，还真是这样的。\n\n## 总结\n\n- 这是一次未知领域的探索过程，其中看似简单的每一步，都花费了不少时间，各种 Google 查资料，全方位面向搜索引擎解决问题。\n- 相对于 MySQL ，Oracle 入门配置真特么麻烦。\n- 做政府、国企软件项目基本要选用 Oracle 数据库，这些不懂技术的鸟人，真把程序员坑死了。\n","source":"_posts/oracle安装.md","raw":"---\ntitle: oracle 安装\ndate: 2016-05-23 12:13\nexcerpt: 本文记录了 oracle 的安装探索过程。\ntags:\n- Oracle\n- 数据库\n---\n\n这个周末学习了一些后端的技能，折腾了好久 Oracle 数据库，总算安装上了。\n\n本文记录的东西非常粗浅，仅限于探索如何使用的层面上，因此文中描述的各种观点可能有所错误，欢迎读者批评纠正。\n<!-- more -->\n\n## 基本环境和工具\n\n- 基于 Parallels Desktop 10 的 windows 10 操作系统；\n- JDK 1.8；\n- Oracle 11g。\n\n其中， Oracle 11g 的下载地址是 [win64_11gR2_database_1of2.zip](http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html) 、 [win64_11gR2_database_2of2.zip](http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html)。\n\n## 第一次安装\n\n第一次安装，当然是处于非常的纯净的 windows 10 系统上面，基本没有任何干扰，按照安装说明一步一步往下走，很简单，很轻松，大多数参数都按照默认配置来。这样一路配置下来的话，连接 Oracle 的 URL 就会是 `jdbc:oracle:thin:@10.211.55.4:1521:orcl` （如果使用 Oracle Thin Driver 来连接的话，当然我也不知道是否还存在其他的 Driver ）。\n\n后续可能会遇到一个问题：如何在一个局域网内连接这台 Oracle 服务器上面的数据库呢？默认情况下，用前面所示的 URL 并不能成功连接上，那么，首先就应该去检查连接是不是被 windows 10 的防火墙阻止了，排除了这个原因之后，再去看看 listener 服务有没有启动。\n\n如果使用 PLSQL Developer 这种 GUI 工具连接 Oracle 服务器的话，会有个很蛋疼的问题，就是要关联一个 Oracle 的 client ，这玩意儿在 windows 系统下面可能要容易点，在 OS X 下面坑特别多。稍微列举一些坑：\n\n- client 要分 32bit 和 64bit ，这个好像要和具体的 GUI 工具对应上？不太记得了，后续有时间补上吧！\n- 在 OS X 下面要手动配置各种环境变量。\n\n## 第二次安装（卸载重装）\n\n某一天，我一不小心删掉了手动创建的数据库文件（*.pdf），这下就完蛋了，不能正常工作了：数据库文件丢失。\n\n网上搜了一些资料，没找到正确的处理方式，于是决定重装。\n\n重装的第一步是卸载。\n\n### 卸载\n\n很常规的，先跑到 windows 标准的应用程序卸载那里看了下，发现根本没有 Oracle ，看起来无法从这里卸载。\n\n于是 Google 了一下，发现 Oracle 的卸载好麻烦：手动停服务、删文件、删注册表，这种方式肯定是逗逼方式。\n\n后面鼓捣了会儿，发现“所有程序”里的 Oracle 项目下，有个 Universal Installer 工具，很多应用的安装程序和卸载程序不都是一体的么！抱着试一试的心态，点开了这个程序，果不其然，里面有卸载功能。点击“卸载”按钮，发现只能删除一些目录，果断删除，但是却不能删除主目录，必须要运行主目录下面的 deinstall/deinstall.bat 来卸载。好了，这个程序看起来只是删除目录而已，那么相关的服务可能还得自己手动删除，此处使用了 `sc delete serviceName` 命令删除服务。\n\n这样鼓捣一圈下来之后，发现还有很多 Oracle 目录，感觉只能手动清除掉了。果断使用`鼠标右键->删除`的方式，结果发现被占用了，无法删除，此时可以到`资源监视器 -> cpu 标签 -> 关联的句柄`里面搜索，搜索关键词是文件名，然后找到哪些进程占用了文件，果断结束掉，这样一来，就可以成功删掉这些文件了。\n\n这样卸载完之后，就开始安装了。\n\n### 重装\n\n按照第一次的安装流程来，一步一步的，比较顺利。\n\n但是，在创建数据库的时候，老是说 `local_listener=LISTENER_ORCL` 这玩意儿配置错误， Goolge 了很多资料，基本都不是说的重装遇到的问题。唉，纠结了半天不知道为啥，只好跳过这个创建数据库的步骤，直接安装完成了。\n\n后面仔细一想，从字面猜测应该是 listener 的名字没有和服务里面 listener 的名字对应上，抱着试一试的心态，去 /app/yibuyisheng/admin/orcl/pfile/init.ora 里面做了修改，然后运行 DBCA 重新创建数据库。事实证明，还真是这样的。\n\n## 总结\n\n- 这是一次未知领域的探索过程，其中看似简单的每一步，都花费了不少时间，各种 Google 查资料，全方位面向搜索引擎解决问题。\n- 相对于 MySQL ，Oracle 入门配置真特么麻烦。\n- 做政府、国企软件项目基本要选用 Oracle 数据库，这些不懂技术的鸟人，真把程序员坑死了。\n","slug":"oracle安装","published":1,"updated":"2016-06-15T10:45:36.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02k000t0407ia66y7tc","content":"<p>这个周末学习了一些后端的技能，折腾了好久 Oracle 数据库，总算安装上了。</p>\n<p>本文记录的东西非常粗浅，仅限于探索如何使用的层面上，因此文中描述的各种观点可能有所错误，欢迎读者批评纠正。<br><a id=\"more\"></a></p>\n<h2 id=\"基本环境和工具\"><a href=\"#基本环境和工具\" class=\"headerlink\" title=\"基本环境和工具\"></a>基本环境和工具</h2><ul>\n<li>基于 Parallels Desktop 10 的 windows 10 操作系统；</li>\n<li>JDK 1.8；</li>\n<li>Oracle 11g。</li>\n</ul>\n<p>其中， Oracle 11g 的下载地址是 <a href=\"http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html\" target=\"_blank\" rel=\"external\">win64_11gR2_database_1of2.zip</a> 、 <a href=\"http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html\" target=\"_blank\" rel=\"external\">win64_11gR2_database_2of2.zip</a>。</p>\n<h2 id=\"第一次安装\"><a href=\"#第一次安装\" class=\"headerlink\" title=\"第一次安装\"></a>第一次安装</h2><p>第一次安装，当然是处于非常的纯净的 windows 10 系统上面，基本没有任何干扰，按照安装说明一步一步往下走，很简单，很轻松，大多数参数都按照默认配置来。这样一路配置下来的话，连接 Oracle 的 URL 就会是 <code>jdbc:oracle:thin:@10.211.55.4:1521:orcl</code> （如果使用 Oracle Thin Driver 来连接的话，当然我也不知道是否还存在其他的 Driver ）。</p>\n<p>后续可能会遇到一个问题：如何在一个局域网内连接这台 Oracle 服务器上面的数据库呢？默认情况下，用前面所示的 URL 并不能成功连接上，那么，首先就应该去检查连接是不是被 windows 10 的防火墙阻止了，排除了这个原因之后，再去看看 listener 服务有没有启动。</p>\n<p>如果使用 PLSQL Developer 这种 GUI 工具连接 Oracle 服务器的话，会有个很蛋疼的问题，就是要关联一个 Oracle 的 client ，这玩意儿在 windows 系统下面可能要容易点，在 OS X 下面坑特别多。稍微列举一些坑：</p>\n<ul>\n<li>client 要分 32bit 和 64bit ，这个好像要和具体的 GUI 工具对应上？不太记得了，后续有时间补上吧！</li>\n<li>在 OS X 下面要手动配置各种环境变量。</li>\n</ul>\n<h2 id=\"第二次安装（卸载重装）\"><a href=\"#第二次安装（卸载重装）\" class=\"headerlink\" title=\"第二次安装（卸载重装）\"></a>第二次安装（卸载重装）</h2><p>某一天，我一不小心删掉了手动创建的数据库文件（*.pdf），这下就完蛋了，不能正常工作了：数据库文件丢失。</p>\n<p>网上搜了一些资料，没找到正确的处理方式，于是决定重装。</p>\n<p>重装的第一步是卸载。</p>\n<h3 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h3><p>很常规的，先跑到 windows 标准的应用程序卸载那里看了下，发现根本没有 Oracle ，看起来无法从这里卸载。</p>\n<p>于是 Google 了一下，发现 Oracle 的卸载好麻烦：手动停服务、删文件、删注册表，这种方式肯定是逗逼方式。</p>\n<p>后面鼓捣了会儿，发现“所有程序”里的 Oracle 项目下，有个 Universal Installer 工具，很多应用的安装程序和卸载程序不都是一体的么！抱着试一试的心态，点开了这个程序，果不其然，里面有卸载功能。点击“卸载”按钮，发现只能删除一些目录，果断删除，但是却不能删除主目录，必须要运行主目录下面的 deinstall/deinstall.bat 来卸载。好了，这个程序看起来只是删除目录而已，那么相关的服务可能还得自己手动删除，此处使用了 <code>sc delete serviceName</code> 命令删除服务。</p>\n<p>这样鼓捣一圈下来之后，发现还有很多 Oracle 目录，感觉只能手动清除掉了。果断使用<code>鼠标右键-&gt;删除</code>的方式，结果发现被占用了，无法删除，此时可以到<code>资源监视器 -&gt; cpu 标签 -&gt; 关联的句柄</code>里面搜索，搜索关键词是文件名，然后找到哪些进程占用了文件，果断结束掉，这样一来，就可以成功删掉这些文件了。</p>\n<p>这样卸载完之后，就开始安装了。</p>\n<h3 id=\"重装\"><a href=\"#重装\" class=\"headerlink\" title=\"重装\"></a>重装</h3><p>按照第一次的安装流程来，一步一步的，比较顺利。</p>\n<p>但是，在创建数据库的时候，老是说 <code>local_listener=LISTENER_ORCL</code> 这玩意儿配置错误， Goolge 了很多资料，基本都不是说的重装遇到的问题。唉，纠结了半天不知道为啥，只好跳过这个创建数据库的步骤，直接安装完成了。</p>\n<p>后面仔细一想，从字面猜测应该是 listener 的名字没有和服务里面 listener 的名字对应上，抱着试一试的心态，去 /app/yibuyisheng/admin/orcl/pfile/init.ora 里面做了修改，然后运行 DBCA 重新创建数据库。事实证明，还真是这样的。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>这是一次未知领域的探索过程，其中看似简单的每一步，都花费了不少时间，各种 Google 查资料，全方位面向搜索引擎解决问题。</li>\n<li>相对于 MySQL ，Oracle 入门配置真特么麻烦。</li>\n<li>做政府、国企软件项目基本要选用 Oracle 数据库，这些不懂技术的鸟人，真把程序员坑死了。</li>\n</ul>\n","more":"</p>\n<h2 id=\"基本环境和工具\"><a href=\"#基本环境和工具\" class=\"headerlink\" title=\"基本环境和工具\"></a>基本环境和工具</h2><ul>\n<li>基于 Parallels Desktop 10 的 windows 10 操作系统；</li>\n<li>JDK 1.8；</li>\n<li>Oracle 11g。</li>\n</ul>\n<p>其中， Oracle 11g 的下载地址是 <a href=\"http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html\">win64_11gR2_database_1of2.zip</a> 、 <a href=\"http://www.oracle.com/technetwork/database/enterprise-edition/downloads/112010-win64soft-094461.html\">win64_11gR2_database_2of2.zip</a>。</p>\n<h2 id=\"第一次安装\"><a href=\"#第一次安装\" class=\"headerlink\" title=\"第一次安装\"></a>第一次安装</h2><p>第一次安装，当然是处于非常的纯净的 windows 10 系统上面，基本没有任何干扰，按照安装说明一步一步往下走，很简单，很轻松，大多数参数都按照默认配置来。这样一路配置下来的话，连接 Oracle 的 URL 就会是 <code>jdbc:oracle:thin:@10.211.55.4:1521:orcl</code> （如果使用 Oracle Thin Driver 来连接的话，当然我也不知道是否还存在其他的 Driver ）。</p>\n<p>后续可能会遇到一个问题：如何在一个局域网内连接这台 Oracle 服务器上面的数据库呢？默认情况下，用前面所示的 URL 并不能成功连接上，那么，首先就应该去检查连接是不是被 windows 10 的防火墙阻止了，排除了这个原因之后，再去看看 listener 服务有没有启动。</p>\n<p>如果使用 PLSQL Developer 这种 GUI 工具连接 Oracle 服务器的话，会有个很蛋疼的问题，就是要关联一个 Oracle 的 client ，这玩意儿在 windows 系统下面可能要容易点，在 OS X 下面坑特别多。稍微列举一些坑：</p>\n<ul>\n<li>client 要分 32bit 和 64bit ，这个好像要和具体的 GUI 工具对应上？不太记得了，后续有时间补上吧！</li>\n<li>在 OS X 下面要手动配置各种环境变量。</li>\n</ul>\n<h2 id=\"第二次安装（卸载重装）\"><a href=\"#第二次安装（卸载重装）\" class=\"headerlink\" title=\"第二次安装（卸载重装）\"></a>第二次安装（卸载重装）</h2><p>某一天，我一不小心删掉了手动创建的数据库文件（*.pdf），这下就完蛋了，不能正常工作了：数据库文件丢失。</p>\n<p>网上搜了一些资料，没找到正确的处理方式，于是决定重装。</p>\n<p>重装的第一步是卸载。</p>\n<h3 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h3><p>很常规的，先跑到 windows 标准的应用程序卸载那里看了下，发现根本没有 Oracle ，看起来无法从这里卸载。</p>\n<p>于是 Google 了一下，发现 Oracle 的卸载好麻烦：手动停服务、删文件、删注册表，这种方式肯定是逗逼方式。</p>\n<p>后面鼓捣了会儿，发现“所有程序”里的 Oracle 项目下，有个 Universal Installer 工具，很多应用的安装程序和卸载程序不都是一体的么！抱着试一试的心态，点开了这个程序，果不其然，里面有卸载功能。点击“卸载”按钮，发现只能删除一些目录，果断删除，但是却不能删除主目录，必须要运行主目录下面的 deinstall/deinstall.bat 来卸载。好了，这个程序看起来只是删除目录而已，那么相关的服务可能还得自己手动删除，此处使用了 <code>sc delete serviceName</code> 命令删除服务。</p>\n<p>这样鼓捣一圈下来之后，发现还有很多 Oracle 目录，感觉只能手动清除掉了。果断使用<code>鼠标右键-&gt;删除</code>的方式，结果发现被占用了，无法删除，此时可以到<code>资源监视器 -&gt; cpu 标签 -&gt; 关联的句柄</code>里面搜索，搜索关键词是文件名，然后找到哪些进程占用了文件，果断结束掉，这样一来，就可以成功删掉这些文件了。</p>\n<p>这样卸载完之后，就开始安装了。</p>\n<h3 id=\"重装\"><a href=\"#重装\" class=\"headerlink\" title=\"重装\"></a>重装</h3><p>按照第一次的安装流程来，一步一步的，比较顺利。</p>\n<p>但是，在创建数据库的时候，老是说 <code>local_listener=LISTENER_ORCL</code> 这玩意儿配置错误， Goolge 了很多资料，基本都不是说的重装遇到的问题。唉，纠结了半天不知道为啥，只好跳过这个创建数据库的步骤，直接安装完成了。</p>\n<p>后面仔细一想，从字面猜测应该是 listener 的名字没有和服务里面 listener 的名字对应上，抱着试一试的心态，去 /app/yibuyisheng/admin/orcl/pfile/init.ora 里面做了修改，然后运行 DBCA 重新创建数据库。事实证明，还真是这样的。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>这是一次未知领域的探索过程，其中看似简单的每一步，都花费了不少时间，各种 Google 查资料，全方位面向搜索引擎解决问题。</li>\n<li>相对于 MySQL ，Oracle 入门配置真特么麻烦。</li>\n<li>做政府、国企软件项目基本要选用 Oracle 数据库，这些不懂技术的鸟人，真把程序员坑死了。</li>\n</ul>"},{"title":"web 前端外部点击事件的实现","date":"2014-10-22T06:52:00.000Z","_content":"\n在 web 前端开发中，元素外部点击事件算是非常常用的一种事件了。比如弹出一个对话框，点击对话框外部的时候需要把这个对话框关掉。\n\n<!-- more -->\n\n实现这个事件有一个核心的东西，就是判断两个节点是否存在父子关系，整个事件流程如下：\n\n* 1、事先设定好的一组元素，如果在这组元素外部点击的话，就会触发外部点击事件，这组元素暂记为 nodes ；\n* 2、用户点击一个元素，可以从 event.target 中获取到当前用户点击的节点，暂记为 nodeClick ；\n* 3、当用户点击 nodeClick 的时候，需要判断 nodes 中是否存在 nodeClick 的祖先节点，如果不存在的话，则触发外部点击事件。\n\n按照这个分析，关键点就落在了判断节点父子关系上面了。\n\n其实早在 IE5 的时候，元素节点上面就有一个方法 `contains()` ，用于判断父子关系，具体文档可参见： https://developer.mozilla.org/en-US/docs/Web/API/Node.contains 。从文档中，我们可以看见 mobile 部分测试不太充分，所以此处最好保留一个自己实现的版本，代码如下：\n\n```js\nfunction contains(parentNode, childNode) {\n  var fn = Node.prototype.contains || function(childNode) {\n    while (childNode) {\n      if (childNode === parentNode) return true;\n      childNode = childNode.parentNode;\n    }\n  };\n  return fn.call(parentNode, childNode);\n}\nfunction isIn(parentNodes, node) {\n  for (var i = 0, il = parentNodes.length; i < il; i += 1) {\n    if (contains(parentNodes[i], node)) return true;\n  }\n  return false;\n}\n```\n\n实现了这个之后，接下来的事情就是维护回调函数队列了，实现机制可能会有多种，此处给出其中一种。\n\n给出一个Array，用于记录所有回调函数，其中每一个数组元素的结构如下：\n\n```js\n{\n  nodes: [node1, node2, ...],      // 对应上一大步中的nodes变量，即事先设定好的那一组元素\n  callback: function() {}          // 触发本次out click事件的回调函数\n}\n```\n\n暂记这个 Array 变量的名字是 outerCallbacks 。\n\n接下来，就剩下对外提供 API 了，此处向外部提供两个 API ：\n\n* 1、 `on()` 函数，用于注册回调函数；\n* 2、 `off()` 函数，用于取消回调函数。\n\non函数的实现非常简单，此处直接上代码：\n\n```js\nfunction outer(elem, callback) {\n  if (!isFunction(callback)) return;            // isFunction = function(obj) {return Object.prototype.toString.call(obj) === '[object Function]';}\n\n  outerCallbacks.push({\n    nodes: (isArray(elem) ? elem : [elem]),     // isArray = function(obj) {return Object.prototype.toString.call(obj) === '[object Array]'}\n    callback: callback\n  });\n}\n```\n\n实现 `off()` 函数的时候，有一个难点和一个注意点：\n\n难点：参数处理，条件判断；\n\n注意点：在外部点击事件回调函数里面调用了 `off()` 函数怎么办？\n\n可以参看我的实现： https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js 。\n","source":"_posts/web 前端外部点击事件的实现.md","raw":"---\ntitle: web 前端外部点击事件的实现\ndate: 2014-10-22 14:52\ntags:\n- JavaScript\n---\n\n在 web 前端开发中，元素外部点击事件算是非常常用的一种事件了。比如弹出一个对话框，点击对话框外部的时候需要把这个对话框关掉。\n\n<!-- more -->\n\n实现这个事件有一个核心的东西，就是判断两个节点是否存在父子关系，整个事件流程如下：\n\n* 1、事先设定好的一组元素，如果在这组元素外部点击的话，就会触发外部点击事件，这组元素暂记为 nodes ；\n* 2、用户点击一个元素，可以从 event.target 中获取到当前用户点击的节点，暂记为 nodeClick ；\n* 3、当用户点击 nodeClick 的时候，需要判断 nodes 中是否存在 nodeClick 的祖先节点，如果不存在的话，则触发外部点击事件。\n\n按照这个分析，关键点就落在了判断节点父子关系上面了。\n\n其实早在 IE5 的时候，元素节点上面就有一个方法 `contains()` ，用于判断父子关系，具体文档可参见： https://developer.mozilla.org/en-US/docs/Web/API/Node.contains 。从文档中，我们可以看见 mobile 部分测试不太充分，所以此处最好保留一个自己实现的版本，代码如下：\n\n```js\nfunction contains(parentNode, childNode) {\n  var fn = Node.prototype.contains || function(childNode) {\n    while (childNode) {\n      if (childNode === parentNode) return true;\n      childNode = childNode.parentNode;\n    }\n  };\n  return fn.call(parentNode, childNode);\n}\nfunction isIn(parentNodes, node) {\n  for (var i = 0, il = parentNodes.length; i < il; i += 1) {\n    if (contains(parentNodes[i], node)) return true;\n  }\n  return false;\n}\n```\n\n实现了这个之后，接下来的事情就是维护回调函数队列了，实现机制可能会有多种，此处给出其中一种。\n\n给出一个Array，用于记录所有回调函数，其中每一个数组元素的结构如下：\n\n```js\n{\n  nodes: [node1, node2, ...],      // 对应上一大步中的nodes变量，即事先设定好的那一组元素\n  callback: function() {}          // 触发本次out click事件的回调函数\n}\n```\n\n暂记这个 Array 变量的名字是 outerCallbacks 。\n\n接下来，就剩下对外提供 API 了，此处向外部提供两个 API ：\n\n* 1、 `on()` 函数，用于注册回调函数；\n* 2、 `off()` 函数，用于取消回调函数。\n\non函数的实现非常简单，此处直接上代码：\n\n```js\nfunction outer(elem, callback) {\n  if (!isFunction(callback)) return;            // isFunction = function(obj) {return Object.prototype.toString.call(obj) === '[object Function]';}\n\n  outerCallbacks.push({\n    nodes: (isArray(elem) ? elem : [elem]),     // isArray = function(obj) {return Object.prototype.toString.call(obj) === '[object Array]'}\n    callback: callback\n  });\n}\n```\n\n实现 `off()` 函数的时候，有一个难点和一个注意点：\n\n难点：参数处理，条件判断；\n\n注意点：在外部点击事件回调函数里面调用了 `off()` 函数怎么办？\n\n可以参看我的实现： https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js 。\n","slug":"web 前端外部点击事件的实现","published":1,"updated":"2016-06-15T10:46:16.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02m000w0407wjmbut0x","content":"<p>在 web 前端开发中，元素外部点击事件算是非常常用的一种事件了。比如弹出一个对话框，点击对话框外部的时候需要把这个对话框关掉。</p>\n<a id=\"more\"></a>\n<p>实现这个事件有一个核心的东西，就是判断两个节点是否存在父子关系，整个事件流程如下：</p>\n<ul>\n<li>1、事先设定好的一组元素，如果在这组元素外部点击的话，就会触发外部点击事件，这组元素暂记为 nodes ；</li>\n<li>2、用户点击一个元素，可以从 event.target 中获取到当前用户点击的节点，暂记为 nodeClick ；</li>\n<li>3、当用户点击 nodeClick 的时候，需要判断 nodes 中是否存在 nodeClick 的祖先节点，如果不存在的话，则触发外部点击事件。</li>\n</ul>\n<p>按照这个分析，关键点就落在了判断节点父子关系上面了。</p>\n<p>其实早在 IE5 的时候，元素节点上面就有一个方法 <code>contains()</code> ，用于判断父子关系，具体文档可参见： <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Node.contains\" target=\"_blank\" rel=\"external\">https://developer.mozilla.org/en-US/docs/Web/API/Node.contains</a> 。从文档中，我们可以看见 mobile 部分测试不太充分，所以此处最好保留一个自己实现的版本，代码如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">contains</span>(<span class=\"params\">parentNode, childNode</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">var</span> fn = Node.prototype.contains || <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">childNode</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">while</span> (childNode) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (childNode === parentNode) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">      childNode = childNode.parentNode;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;;</div><div class=\"line\">  <span class=\"keyword\">return</span> fn.call(parentNode, childNode);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isIn</span>(<span class=\"params\">parentNodes, node</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>, il = parentNodes.length; i &lt; il; i += <span class=\"number\">1</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (contains(parentNodes[i], node)) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>实现了这个之后，接下来的事情就是维护回调函数队列了，实现机制可能会有多种，此处给出其中一种。</p>\n<p>给出一个Array，用于记录所有回调函数，其中每一个数组元素的结构如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">nodes</span>: [node1, node2, ...],      <span class=\"comment\">// 对应上一大步中的nodes变量，即事先设定好的那一组元素</span></div><div class=\"line\">  callback: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;          <span class=\"comment\">// 触发本次out click事件的回调函数</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>暂记这个 Array 变量的名字是 outerCallbacks 。</p>\n<p>接下来，就剩下对外提供 API 了，此处向外部提供两个 API ：</p>\n<ul>\n<li>1、 <code>on()</code> 函数，用于注册回调函数；</li>\n<li>2、 <code>off()</code> 函数，用于取消回调函数。</li>\n</ul>\n<p>on函数的实现非常简单，此处直接上代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outer</span>(<span class=\"params\">elem, callback</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!isFunction(callback)) <span class=\"keyword\">return</span>;            <span class=\"comment\">// isFunction = function(obj) &#123;return Object.prototype.toString.call(obj) === '[object Function]';&#125;</span></div><div class=\"line\"></div><div class=\"line\">  outerCallbacks.push(&#123;</div><div class=\"line\">    <span class=\"attr\">nodes</span>: (isArray(elem) ? elem : [elem]),     <span class=\"comment\">// isArray = function(obj) &#123;return Object.prototype.toString.call(obj) === '[object Array]'&#125;</span></div><div class=\"line\">    callback: callback</div><div class=\"line\">  &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>实现 <code>off()</code> 函数的时候，有一个难点和一个注意点：</p>\n<p>难点：参数处理，条件判断；</p>\n<p>注意点：在外部点击事件回调函数里面调用了 <code>off()</code> 函数怎么办？</p>\n<p>可以参看我的实现： <a href=\"https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js\" target=\"_blank\" rel=\"external\">https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js</a> 。</p>\n","excerpt":"<p>在 web 前端开发中，元素外部点击事件算是非常常用的一种事件了。比如弹出一个对话框，点击对话框外部的时候需要把这个对话框关掉。</p>","more":"<p>实现这个事件有一个核心的东西，就是判断两个节点是否存在父子关系，整个事件流程如下：</p>\n<ul>\n<li>1、事先设定好的一组元素，如果在这组元素外部点击的话，就会触发外部点击事件，这组元素暂记为 nodes ；</li>\n<li>2、用户点击一个元素，可以从 event.target 中获取到当前用户点击的节点，暂记为 nodeClick ；</li>\n<li>3、当用户点击 nodeClick 的时候，需要判断 nodes 中是否存在 nodeClick 的祖先节点，如果不存在的话，则触发外部点击事件。</li>\n</ul>\n<p>按照这个分析，关键点就落在了判断节点父子关系上面了。</p>\n<p>其实早在 IE5 的时候，元素节点上面就有一个方法 <code>contains()</code> ，用于判断父子关系，具体文档可参见： <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Node.contains\">https://developer.mozilla.org/en-US/docs/Web/API/Node.contains</a> 。从文档中，我们可以看见 mobile 部分测试不太充分，所以此处最好保留一个自己实现的版本，代码如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">contains</span>(<span class=\"params\">parentNode, childNode</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">var</span> fn = Node.prototype.contains || <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">childNode</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">while</span> (childNode) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (childNode === parentNode) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">      childNode = childNode.parentNode;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;;</div><div class=\"line\">  <span class=\"keyword\">return</span> fn.call(parentNode, childNode);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isIn</span>(<span class=\"params\">parentNodes, node</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>, il = parentNodes.length; i &lt; il; i += <span class=\"number\">1</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (contains(parentNodes[i], node)) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>实现了这个之后，接下来的事情就是维护回调函数队列了，实现机制可能会有多种，此处给出其中一种。</p>\n<p>给出一个Array，用于记录所有回调函数，其中每一个数组元素的结构如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  <span class=\"attr\">nodes</span>: [node1, node2, ...],      <span class=\"comment\">// 对应上一大步中的nodes变量，即事先设定好的那一组元素</span></div><div class=\"line\">  callback: <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;          <span class=\"comment\">// 触发本次out click事件的回调函数</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>暂记这个 Array 变量的名字是 outerCallbacks 。</p>\n<p>接下来，就剩下对外提供 API 了，此处向外部提供两个 API ：</p>\n<ul>\n<li>1、 <code>on()</code> 函数，用于注册回调函数；</li>\n<li>2、 <code>off()</code> 函数，用于取消回调函数。</li>\n</ul>\n<p>on函数的实现非常简单，此处直接上代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outer</span>(<span class=\"params\">elem, callback</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (!isFunction(callback)) <span class=\"keyword\">return</span>;            <span class=\"comment\">// isFunction = function(obj) &#123;return Object.prototype.toString.call(obj) === '[object Function]';&#125;</span></div><div class=\"line\"></div><div class=\"line\">  outerCallbacks.push(&#123;</div><div class=\"line\">    <span class=\"attr\">nodes</span>: (isArray(elem) ? elem : [elem]),     <span class=\"comment\">// isArray = function(obj) &#123;return Object.prototype.toString.call(obj) === '[object Array]'&#125;</span></div><div class=\"line\">    callback: callback</div><div class=\"line\">  &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>实现 <code>off()</code> 函数的时候，有一个难点和一个注意点：</p>\n<p>难点：参数处理，条件判断；</p>\n<p>注意点：在外部点击事件回调函数里面调用了 <code>off()</code> 函数怎么办？</p>\n<p>可以参看我的实现： <a href=\"https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js\">https://github.com/yibuyisheng/web-ui/blob/master/static/js/event/outer.js</a> 。</p>"},{"title":"一个 JavaScript","date":"2015-10-04T16:00:00.000Z","_content":"\nES6 使用了“一个 JavaScript ”的方式来避免版本化的问题。\n\n那么，什么是“版本化”？什么又是“一个 JavaScript”呢？\n<!-- more -->\n\n## 版本化\n\n一般地，版本化就是说一门语言分成了不同的版本，新版本可以清理老版本中不好的特性，或者改变某些特性的运作方式。这就会导致新的代码无法在老引擎中运行，老的代码也不能在新引擎中运行。很可能某些代码就只能在特定版本的引擎中正常运行，然后针对不同版本的引擎，就要写不同的代码。\n\n如果代码库升级到新的语言版本，就有两种处理方式。\n\n第一种，彻底升级代码库中所有的代码。但是如果代码库的代码量很大的话，就很坑爹了。\n\n第二种，让代码库包含多个语言版本的代码，根据指定的语言版本使用不同的执行引擎。对于 ES6 ，就可以使用媒体类型来标记 ES6 代码，比如在 HTTP 响应头中设置：\n\n```\nContent-Type: application/ecmascript;version=6\n```\n\n也可以利用 `<script>` 标签的 `type` 属性来标记：\n\n```html\n<script type=\"application/ecmascript;version=6\">\n    ···\n</script>\n```\n\n也可以在代码内部标记版本（类似于 `'use strict'` ，放在 JavaScript 文件第一行）：\n\n```js\nuse version 6;\n```\n\n这两种类型的标记方式都有问题：外部版本标记法很脆弱，容易丢失；内部版本标记法又会使代码显得杂乱。\n\n一个更根本的问题是，针对不同的语言版本，要维护不同的执行引擎。这就产生了几个问题：\n\n* 引擎变得很臃肿，因为要实现所有版本的语法。对于语言分析工具也带来了同样的问题（比如类型检测， JSLint ）。\n* 开发者需要记住版本之间的不同点。\n* 代码变得更加难以重构，因为在移动代码的时候需要考虑语言版本的问题。\n\n因此，应该避免版本化，尤其是 JavaScript 和 web 。\n\n## 一个 JavaScript\n\n既然版本化有这么多弊端，对于 JavaScript 和 web 来说都不适用，那么如何避免版本化呢？\n\n采用向后兼容的方式。这就是说我们必须放弃一些关于清理 JavaScript 语言的野心：不能引入破坏性的改变。向后兼容就是不移除已有特性，也不改变已有特性。该规则的口号就是：“不要破坏 web 代码”。\n\n我们可以增加新的特性，使已有的特性更加强大。\n\n这样一来，新的语言和引擎就不需要版本号了，因为仍然需要能够运行老的代码。 David Herman 称这种避免版本化的方式为“[一个 JavaScript ](http://exploringjs.com/es6/ch_one-javascript.html#one-js_1)”，它避免了 JavaScript 被拆分成不同的版本或者模式。甚至，“一个 JavaScript ”纠正了之前由于严格模式引入的 JavaScript 分支。\n\n“一个 Javascript ”并不是说就要完全放弃对语言的清理。相对于去掉已有的特性，可以引入新的干净的特性。 `let` 就是这样干的，它用于声明块级变量，是 `var` 的改进版。但是它并没有替换掉 `var` ，只是作为更好的方案与 `var` 并存。\n\n将来某个时候，可能会清除掉不再有人使用的特性。实际上，一些 ES6 特性是通过调查 web 上的代码来设计的，比如下面两个：\n\n* `let` 声明很难引入到非严格模式中，因为在非严格模式下 let 并不是保留字。在 ES5 中，有且仅有一种形式的 let 变量是合法的：\n\n```js\nlet[x] = arr;\n```\n\n调查发现， web 上没人会在非严格模式下这样使用 `let` 变量，这就使得 TC39 能够将 `let` 引入非严格模式中。\n\n## 严格模式和 ES6\n\nECMAScript 5 引入严格模式来对语言进行清理。在文件或者函数的第一行放入下面的内容就可以打开严格模式：\n\n```js\n'use strict';\n```\n\n严格模式带来了三种具有破坏性的改变：\n\n* 语法改变：一些之前合法的语法在严格模式下面是不允许的。例如：\n    - 禁止 with 语句。它允许开发者添加任何对象到作用域链，这会减缓程序的执行速度，并且很难指出某个变量指向哪里。\n    - 删除一个`独立的标识符`（是一个变量，而不是一个属性）是不允许的。\n    - 函数只能在作用域的顶层声明。\n    - 更多的保留字： implements interface let package private protected public static yield 。\n* 更多类型的错误。例如：\n    - 给一个未声明的变量赋值会抛出 `ReferenceError` 。而在非严格模式下，这样做就会创建一个全局变量。\n    - 修改只读的属性（比如字符串的长度属性）会抛出 `TypeError` 。而在非严格模式下，不会产生任何效果。\n* 不同的语义：在严格模式下，一些结构体会表现得不一样。例如：\n    - `arguments` 不再随着当前参数值的改变而改变。\n    - 在非方法的函数中 `this` 为 `undefined` 。在非严格模式下，它指向全局对象（ window ）。如果调用一个构造器的时候没有使用 new ，就会创建一些全局变量。\n\n从严格模式的这些破坏性改变中可以看出，版本化是很棘手的：即便能够制定出一个干净版本的 JavaScript ，也很难被大家接受。主要原因在于会破坏很多现有的代码，会减缓执行速度，并且引入到文件很繁琐（更不用说交互式的命令行）。\n\n## 支持松散（非严格）模式\n\n`一个 JavaScript` 意味着我们不能放弃松散模式：此模式将会继续存在（例如在 HTML 属性中）。因此，我们不能基于严格模式来构建 ECMAScript 6 ，必须同时在严格模式和非严格模式（又称为松散模式）中都增加相同的特性。否则，严格模式就会成为语言的一个不同版本，回到了版本化的方式。\n\n但是很不幸，有两个特性很难引入松散模式： `let` 声明和块级函数声明。让我们看看为什么很难引入和如何引入。\n\n## 松散模式中的 `let` 声明\n\n`let` 使你能够声明块级变量。这很难被引入到松散模式，因为 `let` 仅在严格模式下是保留字。也就是说，下面两条语句在 ES5 的松散模式下是合法的：\n\n```js\nvar let = [];\nlet[x] = 'abc';\n```\n\n在 ECMASCript 6 的严格模式下，第一行就会抛出异常。因为使用了 `let` 作为变量名。然后第二行会被解析为一个 `let` 变量声明（使用解构）。\n\n在 ECMAScript 6 的松散模式下，第一行不会抛出异常，但是第二行依然被解析为一个 `let` 声明。这种使用 `let` 的方式在 web 上是极少见的，因此 ES6 可以直接这样来解析。 ES5 松散模式下的其他 `let` 声明的书写方式不会被误解：\n\n```js\nlet foo = 123;\nlet {x,y} = computeCoordinates();\n```\n\n## 松散模式下的块级函数声明\n\nECMAScript 5 严格模式中，是禁止在块中声明函数的；在松散模式下，却可以这么做，但是没说这样做会发生什么。因此，很多 JavaScript 实现都支持块级函数声明，但是处理方式是不一样的。\n\nECMAScript 6 想要块中的函数声明本地化（即该函数的作用域就在该块中）。作为 ES5 严格模式的升级，这是没问题的，但是会破坏一些松散模式的代码。因此， ES6 为浏览器提供了“[ web 遗留的兼容语义](http://www.ecma-international.org/ecma-262/6.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics)”，允许块中的函数声明在函数作用域范围内存在。\n\n## 其它关键字\n\n标识符 `yield` 和 `static` 仅在 ES5 的严格模式下是保留字。 ECMAScript 6 使用上下文相关的语法规则来使它们在松散模式下起作用：\n\n* 在松散模式下， `yield` 仅在生成器函数中是保留字。\n* `static` 现在仅用于类字面量中，类字面中默认就是严格模式的（见下文）。\n\n## 隐式的严格模式\n\n在 ECMAScript 6 中，模块体和类体默认就是严格模式的–没必要使用 `use strict` 标记。考虑到将来所有的代码都会位于模块中， ECMAScript 6 有效地将整个语言升级到了严格模式。\n\n其它语法结构（比如箭头函数和生成器函数）本来也应该隐式地为严格模式，但是考虑到通常情况下这些结构都很小，在非严格模式下使用它们就会造成代码中两种模式的碎片化切换。类，尤其是模块一般是足够大的，这样一来就可以忽略两种模式的碎片化切换问题了。\n\n## 无法修复的东西\n\n`一个 JavaScript `的缺陷就是无法修复已有的怪异行为，尤其是下面这两个。\n\n第一个， `typeof null` 应该返回字符串 `null` 而不是 `object` ，修正这个就会破坏已有的代码。而另一方面，给新类型的操作数定义新的操作结果是没问题的， ECMAScript 6 的 Symbol 就是一个例子：\n\n```\n> typeof Symbol.iterator\n'symbol'\n```\n\n第二个，全局对象（浏览器中的 `window` 对象）不应该在变量作用域链，现在修正这个也太晚了。但是至少，在模块中不会直接处于全局作用域下，并且 `let` 永远不会创建全局对象属性，甚至在全局作用域下使用也不会。\n\n## 总结\n\n`一个 JavaScript `意思就是使 ECMAScript 6 完全地向后兼容，很高兴这获得了成功。尤其是模块隐式就是严格模式的（这样一来我们大部分的代码都会处于严格模式下）。\n\n在短期内，对于制定 ES6 规范和引擎实现来说，给严格模式和松散模式添加 ES6 的语法结构会耗费更多的精力。从长远来看，规范和引擎将会受益于语言不分叉（更少的膨胀等等）。开发人员会立即从一个 JavaScript 中获得好处，因为开始使用 ECMAScript 6 变得更加容易。\n","source":"_posts/一个 JavaScript.md","raw":"---\ntitle: 一个 JavaScript\ndate: 2015-10-05\ntags:\n- JavaScript\n- ECMAScript 6\n---\n\nES6 使用了“一个 JavaScript ”的方式来避免版本化的问题。\n\n那么，什么是“版本化”？什么又是“一个 JavaScript”呢？\n<!-- more -->\n\n## 版本化\n\n一般地，版本化就是说一门语言分成了不同的版本，新版本可以清理老版本中不好的特性，或者改变某些特性的运作方式。这就会导致新的代码无法在老引擎中运行，老的代码也不能在新引擎中运行。很可能某些代码就只能在特定版本的引擎中正常运行，然后针对不同版本的引擎，就要写不同的代码。\n\n如果代码库升级到新的语言版本，就有两种处理方式。\n\n第一种，彻底升级代码库中所有的代码。但是如果代码库的代码量很大的话，就很坑爹了。\n\n第二种，让代码库包含多个语言版本的代码，根据指定的语言版本使用不同的执行引擎。对于 ES6 ，就可以使用媒体类型来标记 ES6 代码，比如在 HTTP 响应头中设置：\n\n```\nContent-Type: application/ecmascript;version=6\n```\n\n也可以利用 `<script>` 标签的 `type` 属性来标记：\n\n```html\n<script type=\"application/ecmascript;version=6\">\n    ···\n</script>\n```\n\n也可以在代码内部标记版本（类似于 `'use strict'` ，放在 JavaScript 文件第一行）：\n\n```js\nuse version 6;\n```\n\n这两种类型的标记方式都有问题：外部版本标记法很脆弱，容易丢失；内部版本标记法又会使代码显得杂乱。\n\n一个更根本的问题是，针对不同的语言版本，要维护不同的执行引擎。这就产生了几个问题：\n\n* 引擎变得很臃肿，因为要实现所有版本的语法。对于语言分析工具也带来了同样的问题（比如类型检测， JSLint ）。\n* 开发者需要记住版本之间的不同点。\n* 代码变得更加难以重构，因为在移动代码的时候需要考虑语言版本的问题。\n\n因此，应该避免版本化，尤其是 JavaScript 和 web 。\n\n## 一个 JavaScript\n\n既然版本化有这么多弊端，对于 JavaScript 和 web 来说都不适用，那么如何避免版本化呢？\n\n采用向后兼容的方式。这就是说我们必须放弃一些关于清理 JavaScript 语言的野心：不能引入破坏性的改变。向后兼容就是不移除已有特性，也不改变已有特性。该规则的口号就是：“不要破坏 web 代码”。\n\n我们可以增加新的特性，使已有的特性更加强大。\n\n这样一来，新的语言和引擎就不需要版本号了，因为仍然需要能够运行老的代码。 David Herman 称这种避免版本化的方式为“[一个 JavaScript ](http://exploringjs.com/es6/ch_one-javascript.html#one-js_1)”，它避免了 JavaScript 被拆分成不同的版本或者模式。甚至，“一个 JavaScript ”纠正了之前由于严格模式引入的 JavaScript 分支。\n\n“一个 Javascript ”并不是说就要完全放弃对语言的清理。相对于去掉已有的特性，可以引入新的干净的特性。 `let` 就是这样干的，它用于声明块级变量，是 `var` 的改进版。但是它并没有替换掉 `var` ，只是作为更好的方案与 `var` 并存。\n\n将来某个时候，可能会清除掉不再有人使用的特性。实际上，一些 ES6 特性是通过调查 web 上的代码来设计的，比如下面两个：\n\n* `let` 声明很难引入到非严格模式中，因为在非严格模式下 let 并不是保留字。在 ES5 中，有且仅有一种形式的 let 变量是合法的：\n\n```js\nlet[x] = arr;\n```\n\n调查发现， web 上没人会在非严格模式下这样使用 `let` 变量，这就使得 TC39 能够将 `let` 引入非严格模式中。\n\n## 严格模式和 ES6\n\nECMAScript 5 引入严格模式来对语言进行清理。在文件或者函数的第一行放入下面的内容就可以打开严格模式：\n\n```js\n'use strict';\n```\n\n严格模式带来了三种具有破坏性的改变：\n\n* 语法改变：一些之前合法的语法在严格模式下面是不允许的。例如：\n    - 禁止 with 语句。它允许开发者添加任何对象到作用域链，这会减缓程序的执行速度，并且很难指出某个变量指向哪里。\n    - 删除一个`独立的标识符`（是一个变量，而不是一个属性）是不允许的。\n    - 函数只能在作用域的顶层声明。\n    - 更多的保留字： implements interface let package private protected public static yield 。\n* 更多类型的错误。例如：\n    - 给一个未声明的变量赋值会抛出 `ReferenceError` 。而在非严格模式下，这样做就会创建一个全局变量。\n    - 修改只读的属性（比如字符串的长度属性）会抛出 `TypeError` 。而在非严格模式下，不会产生任何效果。\n* 不同的语义：在严格模式下，一些结构体会表现得不一样。例如：\n    - `arguments` 不再随着当前参数值的改变而改变。\n    - 在非方法的函数中 `this` 为 `undefined` 。在非严格模式下，它指向全局对象（ window ）。如果调用一个构造器的时候没有使用 new ，就会创建一些全局变量。\n\n从严格模式的这些破坏性改变中可以看出，版本化是很棘手的：即便能够制定出一个干净版本的 JavaScript ，也很难被大家接受。主要原因在于会破坏很多现有的代码，会减缓执行速度，并且引入到文件很繁琐（更不用说交互式的命令行）。\n\n## 支持松散（非严格）模式\n\n`一个 JavaScript` 意味着我们不能放弃松散模式：此模式将会继续存在（例如在 HTML 属性中）。因此，我们不能基于严格模式来构建 ECMAScript 6 ，必须同时在严格模式和非严格模式（又称为松散模式）中都增加相同的特性。否则，严格模式就会成为语言的一个不同版本，回到了版本化的方式。\n\n但是很不幸，有两个特性很难引入松散模式： `let` 声明和块级函数声明。让我们看看为什么很难引入和如何引入。\n\n## 松散模式中的 `let` 声明\n\n`let` 使你能够声明块级变量。这很难被引入到松散模式，因为 `let` 仅在严格模式下是保留字。也就是说，下面两条语句在 ES5 的松散模式下是合法的：\n\n```js\nvar let = [];\nlet[x] = 'abc';\n```\n\n在 ECMASCript 6 的严格模式下，第一行就会抛出异常。因为使用了 `let` 作为变量名。然后第二行会被解析为一个 `let` 变量声明（使用解构）。\n\n在 ECMAScript 6 的松散模式下，第一行不会抛出异常，但是第二行依然被解析为一个 `let` 声明。这种使用 `let` 的方式在 web 上是极少见的，因此 ES6 可以直接这样来解析。 ES5 松散模式下的其他 `let` 声明的书写方式不会被误解：\n\n```js\nlet foo = 123;\nlet {x,y} = computeCoordinates();\n```\n\n## 松散模式下的块级函数声明\n\nECMAScript 5 严格模式中，是禁止在块中声明函数的；在松散模式下，却可以这么做，但是没说这样做会发生什么。因此，很多 JavaScript 实现都支持块级函数声明，但是处理方式是不一样的。\n\nECMAScript 6 想要块中的函数声明本地化（即该函数的作用域就在该块中）。作为 ES5 严格模式的升级，这是没问题的，但是会破坏一些松散模式的代码。因此， ES6 为浏览器提供了“[ web 遗留的兼容语义](http://www.ecma-international.org/ecma-262/6.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics)”，允许块中的函数声明在函数作用域范围内存在。\n\n## 其它关键字\n\n标识符 `yield` 和 `static` 仅在 ES5 的严格模式下是保留字。 ECMAScript 6 使用上下文相关的语法规则来使它们在松散模式下起作用：\n\n* 在松散模式下， `yield` 仅在生成器函数中是保留字。\n* `static` 现在仅用于类字面量中，类字面中默认就是严格模式的（见下文）。\n\n## 隐式的严格模式\n\n在 ECMAScript 6 中，模块体和类体默认就是严格模式的–没必要使用 `use strict` 标记。考虑到将来所有的代码都会位于模块中， ECMAScript 6 有效地将整个语言升级到了严格模式。\n\n其它语法结构（比如箭头函数和生成器函数）本来也应该隐式地为严格模式，但是考虑到通常情况下这些结构都很小，在非严格模式下使用它们就会造成代码中两种模式的碎片化切换。类，尤其是模块一般是足够大的，这样一来就可以忽略两种模式的碎片化切换问题了。\n\n## 无法修复的东西\n\n`一个 JavaScript `的缺陷就是无法修复已有的怪异行为，尤其是下面这两个。\n\n第一个， `typeof null` 应该返回字符串 `null` 而不是 `object` ，修正这个就会破坏已有的代码。而另一方面，给新类型的操作数定义新的操作结果是没问题的， ECMAScript 6 的 Symbol 就是一个例子：\n\n```\n> typeof Symbol.iterator\n'symbol'\n```\n\n第二个，全局对象（浏览器中的 `window` 对象）不应该在变量作用域链，现在修正这个也太晚了。但是至少，在模块中不会直接处于全局作用域下，并且 `let` 永远不会创建全局对象属性，甚至在全局作用域下使用也不会。\n\n## 总结\n\n`一个 JavaScript `意思就是使 ECMAScript 6 完全地向后兼容，很高兴这获得了成功。尤其是模块隐式就是严格模式的（这样一来我们大部分的代码都会处于严格模式下）。\n\n在短期内，对于制定 ES6 规范和引擎实现来说，给严格模式和松散模式添加 ES6 的语法结构会耗费更多的精力。从长远来看，规范和引擎将会受益于语言不分叉（更少的膨胀等等）。开发人员会立即从一个 JavaScript 中获得好处，因为开始使用 ECMAScript 6 变得更加容易。\n","slug":"一个 JavaScript","published":1,"updated":"2016-06-15T10:46:43.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02o000y04077eicfm6h","content":"<p>ES6 使用了“一个 JavaScript ”的方式来避免版本化的问题。</p>\n<p>那么，什么是“版本化”？什么又是“一个 JavaScript”呢？<br><a id=\"more\"></a></p>\n<h2 id=\"版本化\"><a href=\"#版本化\" class=\"headerlink\" title=\"版本化\"></a>版本化</h2><p>一般地，版本化就是说一门语言分成了不同的版本，新版本可以清理老版本中不好的特性，或者改变某些特性的运作方式。这就会导致新的代码无法在老引擎中运行，老的代码也不能在新引擎中运行。很可能某些代码就只能在特定版本的引擎中正常运行，然后针对不同版本的引擎，就要写不同的代码。</p>\n<p>如果代码库升级到新的语言版本，就有两种处理方式。</p>\n<p>第一种，彻底升级代码库中所有的代码。但是如果代码库的代码量很大的话，就很坑爹了。</p>\n<p>第二种，让代码库包含多个语言版本的代码，根据指定的语言版本使用不同的执行引擎。对于 ES6 ，就可以使用媒体类型来标记 ES6 代码，比如在 HTTP 响应头中设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/ecmascript;version=6</div></pre></td></tr></table></figure>\n<p>也可以利用 <code>&lt;script&gt;</code> 标签的 <code>type</code> 属性来标记：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"application/ecmascript;version=6\"</span>&gt;</span><span class=\"undefined\"></span></div><div class=\"line\">    ···</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>也可以在代码内部标记版本（类似于 <code>&#39;use strict&#39;</code> ，放在 JavaScript 文件第一行）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">use version <span class=\"number\">6</span>;</div></pre></td></tr></table></figure>\n<p>这两种类型的标记方式都有问题：外部版本标记法很脆弱，容易丢失；内部版本标记法又会使代码显得杂乱。</p>\n<p>一个更根本的问题是，针对不同的语言版本，要维护不同的执行引擎。这就产生了几个问题：</p>\n<ul>\n<li>引擎变得很臃肿，因为要实现所有版本的语法。对于语言分析工具也带来了同样的问题（比如类型检测， JSLint ）。</li>\n<li>开发者需要记住版本之间的不同点。</li>\n<li>代码变得更加难以重构，因为在移动代码的时候需要考虑语言版本的问题。</li>\n</ul>\n<p>因此，应该避免版本化，尤其是 JavaScript 和 web 。</p>\n<h2 id=\"一个-JavaScript\"><a href=\"#一个-JavaScript\" class=\"headerlink\" title=\"一个 JavaScript\"></a>一个 JavaScript</h2><p>既然版本化有这么多弊端，对于 JavaScript 和 web 来说都不适用，那么如何避免版本化呢？</p>\n<p>采用向后兼容的方式。这就是说我们必须放弃一些关于清理 JavaScript 语言的野心：不能引入破坏性的改变。向后兼容就是不移除已有特性，也不改变已有特性。该规则的口号就是：“不要破坏 web 代码”。</p>\n<p>我们可以增加新的特性，使已有的特性更加强大。</p>\n<p>这样一来，新的语言和引擎就不需要版本号了，因为仍然需要能够运行老的代码。 David Herman 称这种避免版本化的方式为“<a href=\"http://exploringjs.com/es6/ch_one-javascript.html#one-js_1\" target=\"_blank\" rel=\"external\">一个 JavaScript </a>”，它避免了 JavaScript 被拆分成不同的版本或者模式。甚至，“一个 JavaScript ”纠正了之前由于严格模式引入的 JavaScript 分支。</p>\n<p>“一个 Javascript ”并不是说就要完全放弃对语言的清理。相对于去掉已有的特性，可以引入新的干净的特性。 <code>let</code> 就是这样干的，它用于声明块级变量，是 <code>var</code> 的改进版。但是它并没有替换掉 <code>var</code> ，只是作为更好的方案与 <code>var</code> 并存。</p>\n<p>将来某个时候，可能会清除掉不再有人使用的特性。实际上，一些 ES6 特性是通过调查 web 上的代码来设计的，比如下面两个：</p>\n<ul>\n<li><code>let</code> 声明很难引入到非严格模式中，因为在非严格模式下 let 并不是保留字。在 ES5 中，有且仅有一种形式的 let 变量是合法的：</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span>[x] = arr;</div></pre></td></tr></table></figure>\n<p>调查发现， web 上没人会在非严格模式下这样使用 <code>let</code> 变量，这就使得 TC39 能够将 <code>let</code> 引入非严格模式中。</p>\n<h2 id=\"严格模式和-ES6\"><a href=\"#严格模式和-ES6\" class=\"headerlink\" title=\"严格模式和 ES6\"></a>严格模式和 ES6</h2><p>ECMAScript 5 引入严格模式来对语言进行清理。在文件或者函数的第一行放入下面的内容就可以打开严格模式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">'use strict'</span>;</div></pre></td></tr></table></figure>\n<p>严格模式带来了三种具有破坏性的改变：</p>\n<ul>\n<li>语法改变：一些之前合法的语法在严格模式下面是不允许的。例如：<ul>\n<li>禁止 with 语句。它允许开发者添加任何对象到作用域链，这会减缓程序的执行速度，并且很难指出某个变量指向哪里。</li>\n<li>删除一个<code>独立的标识符</code>（是一个变量，而不是一个属性）是不允许的。</li>\n<li>函数只能在作用域的顶层声明。</li>\n<li>更多的保留字： implements interface let package private protected public static yield 。</li>\n</ul>\n</li>\n<li>更多类型的错误。例如：<ul>\n<li>给一个未声明的变量赋值会抛出 <code>ReferenceError</code> 。而在非严格模式下，这样做就会创建一个全局变量。</li>\n<li>修改只读的属性（比如字符串的长度属性）会抛出 <code>TypeError</code> 。而在非严格模式下，不会产生任何效果。</li>\n</ul>\n</li>\n<li>不同的语义：在严格模式下，一些结构体会表现得不一样。例如：<ul>\n<li><code>arguments</code> 不再随着当前参数值的改变而改变。</li>\n<li>在非方法的函数中 <code>this</code> 为 <code>undefined</code> 。在非严格模式下，它指向全局对象（ window ）。如果调用一个构造器的时候没有使用 new ，就会创建一些全局变量。</li>\n</ul>\n</li>\n</ul>\n<p>从严格模式的这些破坏性改变中可以看出，版本化是很棘手的：即便能够制定出一个干净版本的 JavaScript ，也很难被大家接受。主要原因在于会破坏很多现有的代码，会减缓执行速度，并且引入到文件很繁琐（更不用说交互式的命令行）。</p>\n<h2 id=\"支持松散（非严格）模式\"><a href=\"#支持松散（非严格）模式\" class=\"headerlink\" title=\"支持松散（非严格）模式\"></a>支持松散（非严格）模式</h2><p><code>一个 JavaScript</code> 意味着我们不能放弃松散模式：此模式将会继续存在（例如在 HTML 属性中）。因此，我们不能基于严格模式来构建 ECMAScript 6 ，必须同时在严格模式和非严格模式（又称为松散模式）中都增加相同的特性。否则，严格模式就会成为语言的一个不同版本，回到了版本化的方式。</p>\n<p>但是很不幸，有两个特性很难引入松散模式： <code>let</code> 声明和块级函数声明。让我们看看为什么很难引入和如何引入。</p>\n<h2 id=\"松散模式中的-let-声明\"><a href=\"#松散模式中的-let-声明\" class=\"headerlink\" title=\"松散模式中的 let 声明\"></a>松散模式中的 <code>let</code> 声明</h2><p><code>let</code> 使你能够声明块级变量。这很难被引入到松散模式，因为 <code>let</code> 仅在严格模式下是保留字。也就是说，下面两条语句在 ES5 的松散模式下是合法的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> <span class=\"keyword\">let</span> = [];</div><div class=\"line\"><span class=\"keyword\">let</span>[x] = <span class=\"string\">'abc'</span>;</div></pre></td></tr></table></figure>\n<p>在 ECMASCript 6 的严格模式下，第一行就会抛出异常。因为使用了 <code>let</code> 作为变量名。然后第二行会被解析为一个 <code>let</code> 变量声明（使用解构）。</p>\n<p>在 ECMAScript 6 的松散模式下，第一行不会抛出异常，但是第二行依然被解析为一个 <code>let</code> 声明。这种使用 <code>let</code> 的方式在 web 上是极少见的，因此 ES6 可以直接这样来解析。 ES5 松散模式下的其他 <code>let</code> 声明的书写方式不会被误解：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> foo = <span class=\"number\">123</span>;</div><div class=\"line\"><span class=\"keyword\">let</span> &#123;x,y&#125; = computeCoordinates();</div></pre></td></tr></table></figure>\n<h2 id=\"松散模式下的块级函数声明\"><a href=\"#松散模式下的块级函数声明\" class=\"headerlink\" title=\"松散模式下的块级函数声明\"></a>松散模式下的块级函数声明</h2><p>ECMAScript 5 严格模式中，是禁止在块中声明函数的；在松散模式下，却可以这么做，但是没说这样做会发生什么。因此，很多 JavaScript 实现都支持块级函数声明，但是处理方式是不一样的。</p>\n<p>ECMAScript 6 想要块中的函数声明本地化（即该函数的作用域就在该块中）。作为 ES5 严格模式的升级，这是没问题的，但是会破坏一些松散模式的代码。因此， ES6 为浏览器提供了“<a href=\"http://www.ecma-international.org/ecma-262/6.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics\" target=\"_blank\" rel=\"external\"> web 遗留的兼容语义</a>”，允许块中的函数声明在函数作用域范围内存在。</p>\n<h2 id=\"其它关键字\"><a href=\"#其它关键字\" class=\"headerlink\" title=\"其它关键字\"></a>其它关键字</h2><p>标识符 <code>yield</code> 和 <code>static</code> 仅在 ES5 的严格模式下是保留字。 ECMAScript 6 使用上下文相关的语法规则来使它们在松散模式下起作用：</p>\n<ul>\n<li>在松散模式下， <code>yield</code> 仅在生成器函数中是保留字。</li>\n<li><code>static</code> 现在仅用于类字面量中，类字面中默认就是严格模式的（见下文）。</li>\n</ul>\n<h2 id=\"隐式的严格模式\"><a href=\"#隐式的严格模式\" class=\"headerlink\" title=\"隐式的严格模式\"></a>隐式的严格模式</h2><p>在 ECMAScript 6 中，模块体和类体默认就是严格模式的–没必要使用 <code>use strict</code> 标记。考虑到将来所有的代码都会位于模块中， ECMAScript 6 有效地将整个语言升级到了严格模式。</p>\n<p>其它语法结构（比如箭头函数和生成器函数）本来也应该隐式地为严格模式，但是考虑到通常情况下这些结构都很小，在非严格模式下使用它们就会造成代码中两种模式的碎片化切换。类，尤其是模块一般是足够大的，这样一来就可以忽略两种模式的碎片化切换问题了。</p>\n<h2 id=\"无法修复的东西\"><a href=\"#无法修复的东西\" class=\"headerlink\" title=\"无法修复的东西\"></a>无法修复的东西</h2><p><code>一个 JavaScript</code>的缺陷就是无法修复已有的怪异行为，尤其是下面这两个。</p>\n<p>第一个， <code>typeof null</code> 应该返回字符串 <code>null</code> 而不是 <code>object</code> ，修正这个就会破坏已有的代码。而另一方面，给新类型的操作数定义新的操作结果是没问题的， ECMAScript 6 的 Symbol 就是一个例子：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; typeof Symbol.iterator</div><div class=\"line\">&apos;symbol&apos;</div></pre></td></tr></table></figure>\n<p>第二个，全局对象（浏览器中的 <code>window</code> 对象）不应该在变量作用域链，现在修正这个也太晚了。但是至少，在模块中不会直接处于全局作用域下，并且 <code>let</code> 永远不会创建全局对象属性，甚至在全局作用域下使用也不会。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p><code>一个 JavaScript</code>意思就是使 ECMAScript 6 完全地向后兼容，很高兴这获得了成功。尤其是模块隐式就是严格模式的（这样一来我们大部分的代码都会处于严格模式下）。</p>\n<p>在短期内，对于制定 ES6 规范和引擎实现来说，给严格模式和松散模式添加 ES6 的语法结构会耗费更多的精力。从长远来看，规范和引擎将会受益于语言不分叉（更少的膨胀等等）。开发人员会立即从一个 JavaScript 中获得好处，因为开始使用 ECMAScript 6 变得更加容易。</p>\n","excerpt":"<p>ES6 使用了“一个 JavaScript ”的方式来避免版本化的问题。</p>\n<p>那么，什么是“版本化”？什么又是“一个 JavaScript”呢？<br>","more":"</p>\n<h2 id=\"版本化\"><a href=\"#版本化\" class=\"headerlink\" title=\"版本化\"></a>版本化</h2><p>一般地，版本化就是说一门语言分成了不同的版本，新版本可以清理老版本中不好的特性，或者改变某些特性的运作方式。这就会导致新的代码无法在老引擎中运行，老的代码也不能在新引擎中运行。很可能某些代码就只能在特定版本的引擎中正常运行，然后针对不同版本的引擎，就要写不同的代码。</p>\n<p>如果代码库升级到新的语言版本，就有两种处理方式。</p>\n<p>第一种，彻底升级代码库中所有的代码。但是如果代码库的代码量很大的话，就很坑爹了。</p>\n<p>第二种，让代码库包含多个语言版本的代码，根据指定的语言版本使用不同的执行引擎。对于 ES6 ，就可以使用媒体类型来标记 ES6 代码，比如在 HTTP 响应头中设置：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Type: application/ecmascript;version=6</div></pre></td></tr></table></figure>\n<p>也可以利用 <code>&lt;script&gt;</code> 标签的 <code>type</code> 属性来标记：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"application/ecmascript;version=6\"</span>&gt;</span><span class=\"undefined\"></div><div class=\"line\">    ···</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>也可以在代码内部标记版本（类似于 <code>&#39;use strict&#39;</code> ，放在 JavaScript 文件第一行）：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">use version <span class=\"number\">6</span>;</div></pre></td></tr></table></figure>\n<p>这两种类型的标记方式都有问题：外部版本标记法很脆弱，容易丢失；内部版本标记法又会使代码显得杂乱。</p>\n<p>一个更根本的问题是，针对不同的语言版本，要维护不同的执行引擎。这就产生了几个问题：</p>\n<ul>\n<li>引擎变得很臃肿，因为要实现所有版本的语法。对于语言分析工具也带来了同样的问题（比如类型检测， JSLint ）。</li>\n<li>开发者需要记住版本之间的不同点。</li>\n<li>代码变得更加难以重构，因为在移动代码的时候需要考虑语言版本的问题。</li>\n</ul>\n<p>因此，应该避免版本化，尤其是 JavaScript 和 web 。</p>\n<h2 id=\"一个-JavaScript\"><a href=\"#一个-JavaScript\" class=\"headerlink\" title=\"一个 JavaScript\"></a>一个 JavaScript</h2><p>既然版本化有这么多弊端，对于 JavaScript 和 web 来说都不适用，那么如何避免版本化呢？</p>\n<p>采用向后兼容的方式。这就是说我们必须放弃一些关于清理 JavaScript 语言的野心：不能引入破坏性的改变。向后兼容就是不移除已有特性，也不改变已有特性。该规则的口号就是：“不要破坏 web 代码”。</p>\n<p>我们可以增加新的特性，使已有的特性更加强大。</p>\n<p>这样一来，新的语言和引擎就不需要版本号了，因为仍然需要能够运行老的代码。 David Herman 称这种避免版本化的方式为“<a href=\"http://exploringjs.com/es6/ch_one-javascript.html#one-js_1\">一个 JavaScript </a>”，它避免了 JavaScript 被拆分成不同的版本或者模式。甚至，“一个 JavaScript ”纠正了之前由于严格模式引入的 JavaScript 分支。</p>\n<p>“一个 Javascript ”并不是说就要完全放弃对语言的清理。相对于去掉已有的特性，可以引入新的干净的特性。 <code>let</code> 就是这样干的，它用于声明块级变量，是 <code>var</code> 的改进版。但是它并没有替换掉 <code>var</code> ，只是作为更好的方案与 <code>var</code> 并存。</p>\n<p>将来某个时候，可能会清除掉不再有人使用的特性。实际上，一些 ES6 特性是通过调查 web 上的代码来设计的，比如下面两个：</p>\n<ul>\n<li><code>let</code> 声明很难引入到非严格模式中，因为在非严格模式下 let 并不是保留字。在 ES5 中，有且仅有一种形式的 let 变量是合法的：</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span>[x] = arr;</div></pre></td></tr></table></figure>\n<p>调查发现， web 上没人会在非严格模式下这样使用 <code>let</code> 变量，这就使得 TC39 能够将 <code>let</code> 引入非严格模式中。</p>\n<h2 id=\"严格模式和-ES6\"><a href=\"#严格模式和-ES6\" class=\"headerlink\" title=\"严格模式和 ES6\"></a>严格模式和 ES6</h2><p>ECMAScript 5 引入严格模式来对语言进行清理。在文件或者函数的第一行放入下面的内容就可以打开严格模式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">'use strict'</span>;</div></pre></td></tr></table></figure>\n<p>严格模式带来了三种具有破坏性的改变：</p>\n<ul>\n<li>语法改变：一些之前合法的语法在严格模式下面是不允许的。例如：<ul>\n<li>禁止 with 语句。它允许开发者添加任何对象到作用域链，这会减缓程序的执行速度，并且很难指出某个变量指向哪里。</li>\n<li>删除一个<code>独立的标识符</code>（是一个变量，而不是一个属性）是不允许的。</li>\n<li>函数只能在作用域的顶层声明。</li>\n<li>更多的保留字： implements interface let package private protected public static yield 。</li>\n</ul>\n</li>\n<li>更多类型的错误。例如：<ul>\n<li>给一个未声明的变量赋值会抛出 <code>ReferenceError</code> 。而在非严格模式下，这样做就会创建一个全局变量。</li>\n<li>修改只读的属性（比如字符串的长度属性）会抛出 <code>TypeError</code> 。而在非严格模式下，不会产生任何效果。</li>\n</ul>\n</li>\n<li>不同的语义：在严格模式下，一些结构体会表现得不一样。例如：<ul>\n<li><code>arguments</code> 不再随着当前参数值的改变而改变。</li>\n<li>在非方法的函数中 <code>this</code> 为 <code>undefined</code> 。在非严格模式下，它指向全局对象（ window ）。如果调用一个构造器的时候没有使用 new ，就会创建一些全局变量。</li>\n</ul>\n</li>\n</ul>\n<p>从严格模式的这些破坏性改变中可以看出，版本化是很棘手的：即便能够制定出一个干净版本的 JavaScript ，也很难被大家接受。主要原因在于会破坏很多现有的代码，会减缓执行速度，并且引入到文件很繁琐（更不用说交互式的命令行）。</p>\n<h2 id=\"支持松散（非严格）模式\"><a href=\"#支持松散（非严格）模式\" class=\"headerlink\" title=\"支持松散（非严格）模式\"></a>支持松散（非严格）模式</h2><p><code>一个 JavaScript</code> 意味着我们不能放弃松散模式：此模式将会继续存在（例如在 HTML 属性中）。因此，我们不能基于严格模式来构建 ECMAScript 6 ，必须同时在严格模式和非严格模式（又称为松散模式）中都增加相同的特性。否则，严格模式就会成为语言的一个不同版本，回到了版本化的方式。</p>\n<p>但是很不幸，有两个特性很难引入松散模式： <code>let</code> 声明和块级函数声明。让我们看看为什么很难引入和如何引入。</p>\n<h2 id=\"松散模式中的-let-声明\"><a href=\"#松散模式中的-let-声明\" class=\"headerlink\" title=\"松散模式中的 let 声明\"></a>松散模式中的 <code>let</code> 声明</h2><p><code>let</code> 使你能够声明块级变量。这很难被引入到松散模式，因为 <code>let</code> 仅在严格模式下是保留字。也就是说，下面两条语句在 ES5 的松散模式下是合法的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> <span class=\"keyword\">let</span> = [];</div><div class=\"line\"><span class=\"keyword\">let</span>[x] = <span class=\"string\">'abc'</span>;</div></pre></td></tr></table></figure>\n<p>在 ECMASCript 6 的严格模式下，第一行就会抛出异常。因为使用了 <code>let</code> 作为变量名。然后第二行会被解析为一个 <code>let</code> 变量声明（使用解构）。</p>\n<p>在 ECMAScript 6 的松散模式下，第一行不会抛出异常，但是第二行依然被解析为一个 <code>let</code> 声明。这种使用 <code>let</code> 的方式在 web 上是极少见的，因此 ES6 可以直接这样来解析。 ES5 松散模式下的其他 <code>let</code> 声明的书写方式不会被误解：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">let</span> foo = <span class=\"number\">123</span>;</div><div class=\"line\"><span class=\"keyword\">let</span> &#123;x,y&#125; = computeCoordinates();</div></pre></td></tr></table></figure>\n<h2 id=\"松散模式下的块级函数声明\"><a href=\"#松散模式下的块级函数声明\" class=\"headerlink\" title=\"松散模式下的块级函数声明\"></a>松散模式下的块级函数声明</h2><p>ECMAScript 5 严格模式中，是禁止在块中声明函数的；在松散模式下，却可以这么做，但是没说这样做会发生什么。因此，很多 JavaScript 实现都支持块级函数声明，但是处理方式是不一样的。</p>\n<p>ECMAScript 6 想要块中的函数声明本地化（即该函数的作用域就在该块中）。作为 ES5 严格模式的升级，这是没问题的，但是会破坏一些松散模式的代码。因此， ES6 为浏览器提供了“<a href=\"http://www.ecma-international.org/ecma-262/6.0/#sec-block-level-function-declarations-web-legacy-compatibility-semantics\"> web 遗留的兼容语义</a>”，允许块中的函数声明在函数作用域范围内存在。</p>\n<h2 id=\"其它关键字\"><a href=\"#其它关键字\" class=\"headerlink\" title=\"其它关键字\"></a>其它关键字</h2><p>标识符 <code>yield</code> 和 <code>static</code> 仅在 ES5 的严格模式下是保留字。 ECMAScript 6 使用上下文相关的语法规则来使它们在松散模式下起作用：</p>\n<ul>\n<li>在松散模式下， <code>yield</code> 仅在生成器函数中是保留字。</li>\n<li><code>static</code> 现在仅用于类字面量中，类字面中默认就是严格模式的（见下文）。</li>\n</ul>\n<h2 id=\"隐式的严格模式\"><a href=\"#隐式的严格模式\" class=\"headerlink\" title=\"隐式的严格模式\"></a>隐式的严格模式</h2><p>在 ECMAScript 6 中，模块体和类体默认就是严格模式的–没必要使用 <code>use strict</code> 标记。考虑到将来所有的代码都会位于模块中， ECMAScript 6 有效地将整个语言升级到了严格模式。</p>\n<p>其它语法结构（比如箭头函数和生成器函数）本来也应该隐式地为严格模式，但是考虑到通常情况下这些结构都很小，在非严格模式下使用它们就会造成代码中两种模式的碎片化切换。类，尤其是模块一般是足够大的，这样一来就可以忽略两种模式的碎片化切换问题了。</p>\n<h2 id=\"无法修复的东西\"><a href=\"#无法修复的东西\" class=\"headerlink\" title=\"无法修复的东西\"></a>无法修复的东西</h2><p><code>一个 JavaScript</code>的缺陷就是无法修复已有的怪异行为，尤其是下面这两个。</p>\n<p>第一个， <code>typeof null</code> 应该返回字符串 <code>null</code> 而不是 <code>object</code> ，修正这个就会破坏已有的代码。而另一方面，给新类型的操作数定义新的操作结果是没问题的， ECMAScript 6 的 Symbol 就是一个例子：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; typeof Symbol.iterator</div><div class=\"line\">&apos;symbol&apos;</div></pre></td></tr></table></figure>\n<p>第二个，全局对象（浏览器中的 <code>window</code> 对象）不应该在变量作用域链，现在修正这个也太晚了。但是至少，在模块中不会直接处于全局作用域下，并且 <code>let</code> 永远不会创建全局对象属性，甚至在全局作用域下使用也不会。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p><code>一个 JavaScript</code>意思就是使 ECMAScript 6 完全地向后兼容，很高兴这获得了成功。尤其是模块隐式就是严格模式的（这样一来我们大部分的代码都会处于严格模式下）。</p>\n<p>在短期内，对于制定 ES6 规范和引擎实现来说，给严格模式和松散模式添加 ES6 的语法结构会耗费更多的精力。从长远来看，规范和引擎将会受益于语言不分叉（更少的膨胀等等）。开发人员会立即从一个 JavaScript 中获得好处，因为开始使用 ECMAScript 6 变得更加容易。</p>"},{"title":"一些 core javascript 的基础知识","date":"2014-10-22T14:13:00.000Z","_content":"\n### 一、 setTimeout\n\n```js\nsetTimtout(function(){\n   alert(2);                           // 后弹出\n},0);\nalert(1);                              // 先弹出\n```\n\n对于如上代码，包含原理如下：\n\n* 1、首先 jsvm 只会执行一个线程；\n* 2、当这个线程遇到 `setTimout()` 的时候，就会将这个 function 放到某个队列里面；\n* 3、当前这个线程空闲的时候，就会执行任务队列轮询的代码，将满足条件的函数拿出来执行。\n<!-- more -->\n\n比较简单典型的一个应用场景就是：\n\n```js\n$(elem).html(xxxxxx);\n\nsetTimeout(function() {\n  // 内部DOM操作很复杂，此处setTimeout用于保证在内部DOM操作结束并且相关内存被释放掉后执行后续代码\n}, 0);\n```\n\n### 二、 eval\n\njs 中除了全局作用域和函数作用域之外，还存在一个 eval 作用域。\n\neval 函数执行的时候，会根据当前执行上下文创建一个作用域。\n\n此处有如下代码：\n\n```js\nfunction a() {\n  var b = new SomeThing();\n  return function() {\n    eval('');\n  };\n}\n```\n\n### 三、预编译\n\n先分别上如下几个片段的代码：\n\n```html\n<html>\n<head>\n<script>\na();\nfunction a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n```html\n<html>\n<head>\n<script>\na();\n</script>\n\n<script>\nfunction a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n```html\n<html>\n<head>\n<script>\na();\nvar b = function a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n执行结果分别是：\n\n* 第一段代码：弹出1；\n* 第二段代码：第一个script片段报错，a不存在；\n* 第三段代码：报错，a不存在；\n\n原因：\n\n* 第一段代码中，jsvm会预编译，构造好a函数，所以访问a函数的顺序是不重要的；\n* 第二段代码中，预编译是会分代码块执行的，每个script都会形成一个代码块，即便script是通过src引入js的；\n* 第三段代码中，a函数的定义由于放在了一个表达式当中，因此jsvm不会预编译。\n\n但是，此处还可以继续深入，第三段代码改成如下所示：\n\n```html\n<html>\n<head>\n<script>\nvar b = function a(){\n  alert(1);\n}\na();\n</script>\n</head>\n<body></body>\n</html>\n```\n\n这段代码也同样会报错， a 不存在。为什么呢？原因就是 a 函数放在了表达式当中， jsvm 会把 a 函数看作一个匿名函数，因此在当前语句执行完， a 就被释放掉了。\n\n但是，请注意，上面讨论的都是根据 w3c 标准得出的结果，在第三段和第四段代码中，IE 6、7、8还是会预编译的，并且不会释放掉a，因此不会报错。\n\n### 四、自执行函数\n\n自执行函数的几种形式：\n\n```js\n(function() {})();\n(function() {}());\n!function(){}();\nvoid function(){}();\n```\n\n其中第三种写法会造成额外的运算，因为要对返回的内容做“非”操作。\n\n### 五、预编译中的变量声明\n\n如下代码：\n\n```js\nfunction a(x){\n  return x*2;\n}\nvar a;\nalert(a);\n```\n\n`var a` 只是声明，并不会干啥， `var a` 只会让当前作用域的 `alert(a)` 不会报 a 不存在的错误， a 实际上是什么，需要显示赋值；如果 `var a` 之前已经存在 a 了，则啥也不干。\n\n### 六、 function 传参\n\n如下代码：\n\n```js\nfunction fn1(a, b, c){\n   a = 1.2;\n   b = 2.2;\n   c.c = 3.2;\n}\n\nvar a = 1;\nvar b = 2;\nvar c = {c:3};\n\nfn1(a,b,c);\n\nalert(a);\nalert(b);\nalert(c.c);\n```\n\n原理不难理解，注意值类型和引用类型的区别。\n\n### 七、作用域链\n\n有如下几点：\n\n* 1、作用域链是在定义的时候就确定下来了的；\n* 2、隐式对象模型：对于一个作用域， jsvm 会创建一个隐式对象，然后在这个对象上面绑定当前作用域的各种变量。多个函数的嵌套定义也就会形成一条作用域链了。如果在某个作用域中要访问一个 a 变量，则会首先在当前作用域中查找是否存在 a 变量，如果不存在，则向上找父作用域隐式对象中是否存在 a 变量，依次类推，如果到了根作用域还找不到 a 变量的话，就会报错了。\n\n### 八、类数组结构\n\n第一个问题，如何构造类数组结构？思路简单，不赘述。\n\njquery 选择器构造出来的就是一个类数组结构。\n\n### 九、工厂模式\n\n```js\nfunction factory() {\n  return new ThisIsAClass();\n}\n```\n","source":"_posts/一些 core javascript 的基础知识.md","raw":"---\ntitle: 一些 core javascript 的基础知识\ndate: 2014-10-22 22:13\ntags:\n- JavaScript\n---\n\n### 一、 setTimeout\n\n```js\nsetTimtout(function(){\n   alert(2);                           // 后弹出\n},0);\nalert(1);                              // 先弹出\n```\n\n对于如上代码，包含原理如下：\n\n* 1、首先 jsvm 只会执行一个线程；\n* 2、当这个线程遇到 `setTimout()` 的时候，就会将这个 function 放到某个队列里面；\n* 3、当前这个线程空闲的时候，就会执行任务队列轮询的代码，将满足条件的函数拿出来执行。\n<!-- more -->\n\n比较简单典型的一个应用场景就是：\n\n```js\n$(elem).html(xxxxxx);\n\nsetTimeout(function() {\n  // 内部DOM操作很复杂，此处setTimeout用于保证在内部DOM操作结束并且相关内存被释放掉后执行后续代码\n}, 0);\n```\n\n### 二、 eval\n\njs 中除了全局作用域和函数作用域之外，还存在一个 eval 作用域。\n\neval 函数执行的时候，会根据当前执行上下文创建一个作用域。\n\n此处有如下代码：\n\n```js\nfunction a() {\n  var b = new SomeThing();\n  return function() {\n    eval('');\n  };\n}\n```\n\n### 三、预编译\n\n先分别上如下几个片段的代码：\n\n```html\n<html>\n<head>\n<script>\na();\nfunction a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n```html\n<html>\n<head>\n<script>\na();\n</script>\n\n<script>\nfunction a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n```html\n<html>\n<head>\n<script>\na();\nvar b = function a(){\n  alert(1);\n}\n</script>\n</head>\n<body></body>\n</html>\n```\n\n执行结果分别是：\n\n* 第一段代码：弹出1；\n* 第二段代码：第一个script片段报错，a不存在；\n* 第三段代码：报错，a不存在；\n\n原因：\n\n* 第一段代码中，jsvm会预编译，构造好a函数，所以访问a函数的顺序是不重要的；\n* 第二段代码中，预编译是会分代码块执行的，每个script都会形成一个代码块，即便script是通过src引入js的；\n* 第三段代码中，a函数的定义由于放在了一个表达式当中，因此jsvm不会预编译。\n\n但是，此处还可以继续深入，第三段代码改成如下所示：\n\n```html\n<html>\n<head>\n<script>\nvar b = function a(){\n  alert(1);\n}\na();\n</script>\n</head>\n<body></body>\n</html>\n```\n\n这段代码也同样会报错， a 不存在。为什么呢？原因就是 a 函数放在了表达式当中， jsvm 会把 a 函数看作一个匿名函数，因此在当前语句执行完， a 就被释放掉了。\n\n但是，请注意，上面讨论的都是根据 w3c 标准得出的结果，在第三段和第四段代码中，IE 6、7、8还是会预编译的，并且不会释放掉a，因此不会报错。\n\n### 四、自执行函数\n\n自执行函数的几种形式：\n\n```js\n(function() {})();\n(function() {}());\n!function(){}();\nvoid function(){}();\n```\n\n其中第三种写法会造成额外的运算，因为要对返回的内容做“非”操作。\n\n### 五、预编译中的变量声明\n\n如下代码：\n\n```js\nfunction a(x){\n  return x*2;\n}\nvar a;\nalert(a);\n```\n\n`var a` 只是声明，并不会干啥， `var a` 只会让当前作用域的 `alert(a)` 不会报 a 不存在的错误， a 实际上是什么，需要显示赋值；如果 `var a` 之前已经存在 a 了，则啥也不干。\n\n### 六、 function 传参\n\n如下代码：\n\n```js\nfunction fn1(a, b, c){\n   a = 1.2;\n   b = 2.2;\n   c.c = 3.2;\n}\n\nvar a = 1;\nvar b = 2;\nvar c = {c:3};\n\nfn1(a,b,c);\n\nalert(a);\nalert(b);\nalert(c.c);\n```\n\n原理不难理解，注意值类型和引用类型的区别。\n\n### 七、作用域链\n\n有如下几点：\n\n* 1、作用域链是在定义的时候就确定下来了的；\n* 2、隐式对象模型：对于一个作用域， jsvm 会创建一个隐式对象，然后在这个对象上面绑定当前作用域的各种变量。多个函数的嵌套定义也就会形成一条作用域链了。如果在某个作用域中要访问一个 a 变量，则会首先在当前作用域中查找是否存在 a 变量，如果不存在，则向上找父作用域隐式对象中是否存在 a 变量，依次类推，如果到了根作用域还找不到 a 变量的话，就会报错了。\n\n### 八、类数组结构\n\n第一个问题，如何构造类数组结构？思路简单，不赘述。\n\njquery 选择器构造出来的就是一个类数组结构。\n\n### 九、工厂模式\n\n```js\nfunction factory() {\n  return new ThisIsAClass();\n}\n```\n","slug":"一些 core javascript 的基础知识","published":1,"updated":"2016-06-15T10:46:51.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02p00110407q993j0ry","content":"<h3 id=\"一、-setTimeout\"><a href=\"#一、-setTimeout\" class=\"headerlink\" title=\"一、 setTimeout\"></a>一、 setTimeout</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">setTimtout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">   alert(<span class=\"number\">2</span>);                           <span class=\"comment\">// 后弹出</span></div><div class=\"line\">&#125;,<span class=\"number\">0</span>);</div><div class=\"line\">alert(<span class=\"number\">1</span>);                              <span class=\"comment\">// 先弹出</span></div></pre></td></tr></table></figure>\n<p>对于如上代码，包含原理如下：</p>\n<ul>\n<li>1、首先 jsvm 只会执行一个线程；</li>\n<li>2、当这个线程遇到 <code>setTimout()</code> 的时候，就会将这个 function 放到某个队列里面；</li>\n<li>3、当前这个线程空闲的时候，就会执行任务队列轮询的代码，将满足条件的函数拿出来执行。<a id=\"more\"></a>\n</li>\n</ul>\n<p>比较简单典型的一个应用场景就是：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$(elem).html(xxxxxx);</div><div class=\"line\"></div><div class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// 内部DOM操作很复杂，此处setTimeout用于保证在内部DOM操作结束并且相关内存被释放掉后执行后续代码</span></div><div class=\"line\">&#125;, <span class=\"number\">0</span>);</div></pre></td></tr></table></figure>\n<h3 id=\"二、-eval\"><a href=\"#二、-eval\" class=\"headerlink\" title=\"二、 eval\"></a>二、 eval</h3><p>js 中除了全局作用域和函数作用域之外，还存在一个 eval 作用域。</p>\n<p>eval 函数执行的时候，会根据当前执行上下文创建一个作用域。</p>\n<p>此处有如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">var</span> b = <span class=\"keyword\">new</span> SomeThing();</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">eval</span>(<span class=\"string\">''</span>);</div><div class=\"line\">  &#125;;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"三、预编译\"><a href=\"#三、预编译\" class=\"headerlink\" title=\"三、预编译\"></a>三、预编译</h3><p>先分别上如下几个片段的代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">a();</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></div><div class=\"line\">a();</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">a();</div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>执行结果分别是：</p>\n<ul>\n<li>第一段代码：弹出1；</li>\n<li>第二段代码：第一个script片段报错，a不存在；</li>\n<li>第三段代码：报错，a不存在；</li>\n</ul>\n<p>原因：</p>\n<ul>\n<li>第一段代码中，jsvm会预编译，构造好a函数，所以访问a函数的顺序是不重要的；</li>\n<li>第二段代码中，预编译是会分代码块执行的，每个script都会形成一个代码块，即便script是通过src引入js的；</li>\n<li>第三段代码中，a函数的定义由于放在了一个表达式当中，因此jsvm不会预编译。</li>\n</ul>\n<p>但是，此处还可以继续深入，第三段代码改成如下所示：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\">a();</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这段代码也同样会报错， a 不存在。为什么呢？原因就是 a 函数放在了表达式当中， jsvm 会把 a 函数看作一个匿名函数，因此在当前语句执行完， a 就被释放掉了。</p>\n<p>但是，请注意，上面讨论的都是根据 w3c 标准得出的结果，在第三段和第四段代码中，IE 6、7、8还是会预编译的，并且不会释放掉a，因此不会报错。</p>\n<h3 id=\"四、自执行函数\"><a href=\"#四、自执行函数\" class=\"headerlink\" title=\"四、自执行函数\"></a>四、自执行函数</h3><p>自执行函数的几种形式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;)();</div><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;());</div><div class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;&#125;();</div><div class=\"line\"><span class=\"keyword\">void</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;&#125;();</div></pre></td></tr></table></figure>\n<p>其中第三种写法会造成额外的运算，因为要对返回的内容做“非”操作。</p>\n<h3 id=\"五、预编译中的变量声明\"><a href=\"#五、预编译中的变量声明\" class=\"headerlink\" title=\"五、预编译中的变量声明\"></a>五、预编译中的变量声明</h3><p>如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\">x</span>)</span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> x*<span class=\"number\">2</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">var</span> a;</div><div class=\"line\">alert(a);</div></pre></td></tr></table></figure>\n<p><code>var a</code> 只是声明，并不会干啥， <code>var a</code> 只会让当前作用域的 <code>alert(a)</code> 不会报 a 不存在的错误， a 实际上是什么，需要显示赋值；如果 <code>var a</code> 之前已经存在 a 了，则啥也不干。</p>\n<h3 id=\"六、-function-传参\"><a href=\"#六、-function-传参\" class=\"headerlink\" title=\"六、 function 传参\"></a>六、 function 传参</h3><p>如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fn1</span>(<span class=\"params\">a, b, c</span>)</span>&#123;</div><div class=\"line\">   a = <span class=\"number\">1.2</span>;</div><div class=\"line\">   b = <span class=\"number\">2.2</span>;</div><div class=\"line\">   c.c = <span class=\"number\">3.2</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> a = <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> c = &#123;<span class=\"attr\">c</span>:<span class=\"number\">3</span>&#125;;</div><div class=\"line\"></div><div class=\"line\">fn1(a,b,c);</div><div class=\"line\"></div><div class=\"line\">alert(a);</div><div class=\"line\">alert(b);</div><div class=\"line\">alert(c.c);</div></pre></td></tr></table></figure>\n<p>原理不难理解，注意值类型和引用类型的区别。</p>\n<h3 id=\"七、作用域链\"><a href=\"#七、作用域链\" class=\"headerlink\" title=\"七、作用域链\"></a>七、作用域链</h3><p>有如下几点：</p>\n<ul>\n<li>1、作用域链是在定义的时候就确定下来了的；</li>\n<li>2、隐式对象模型：对于一个作用域， jsvm 会创建一个隐式对象，然后在这个对象上面绑定当前作用域的各种变量。多个函数的嵌套定义也就会形成一条作用域链了。如果在某个作用域中要访问一个 a 变量，则会首先在当前作用域中查找是否存在 a 变量，如果不存在，则向上找父作用域隐式对象中是否存在 a 变量，依次类推，如果到了根作用域还找不到 a 变量的话，就会报错了。</li>\n</ul>\n<h3 id=\"八、类数组结构\"><a href=\"#八、类数组结构\" class=\"headerlink\" title=\"八、类数组结构\"></a>八、类数组结构</h3><p>第一个问题，如何构造类数组结构？思路简单，不赘述。</p>\n<p>jquery 选择器构造出来的就是一个类数组结构。</p>\n<h3 id=\"九、工厂模式\"><a href=\"#九、工厂模式\" class=\"headerlink\" title=\"九、工厂模式\"></a>九、工厂模式</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">factory</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThisIsAClass();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n","excerpt":"<h3 id=\"一、-setTimeout\"><a href=\"#一、-setTimeout\" class=\"headerlink\" title=\"一、 setTimeout\"></a>一、 setTimeout</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">setTimtout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">   alert(<span class=\"number\">2</span>);                           <span class=\"comment\">// 后弹出</span></div><div class=\"line\">&#125;,<span class=\"number\">0</span>);</div><div class=\"line\">alert(<span class=\"number\">1</span>);                              <span class=\"comment\">// 先弹出</span></div></pre></td></tr></table></figure>\n<p>对于如上代码，包含原理如下：</p>\n<ul>\n<li>1、首先 jsvm 只会执行一个线程；</li>\n<li>2、当这个线程遇到 <code>setTimout()</code> 的时候，就会将这个 function 放到某个队列里面；</li>\n<li>3、当前这个线程空闲的时候，就会执行任务队列轮询的代码，将满足条件的函数拿出来执行。","more":"</li>\n</ul>\n<p>比较简单典型的一个应用场景就是：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$(elem).html(xxxxxx);</div><div class=\"line\"></div><div class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"comment\">// 内部DOM操作很复杂，此处setTimeout用于保证在内部DOM操作结束并且相关内存被释放掉后执行后续代码</span></div><div class=\"line\">&#125;, <span class=\"number\">0</span>);</div></pre></td></tr></table></figure>\n<h3 id=\"二、-eval\"><a href=\"#二、-eval\" class=\"headerlink\" title=\"二、 eval\"></a>二、 eval</h3><p>js 中除了全局作用域和函数作用域之外，还存在一个 eval 作用域。</p>\n<p>eval 函数执行的时候，会根据当前执行上下文创建一个作用域。</p>\n<p>此处有如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">var</span> b = <span class=\"keyword\">new</span> SomeThing();</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">eval</span>(<span class=\"string\">''</span>);</div><div class=\"line\">  &#125;;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"三、预编译\"><a href=\"#三、预编译\" class=\"headerlink\" title=\"三、预编译\"></a>三、预编译</h3><p>先分别上如下几个片段的代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">a();</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></div><div class=\"line\">a();</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\">a();</div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>执行结果分别是：</p>\n<ul>\n<li>第一段代码：弹出1；</li>\n<li>第二段代码：第一个script片段报错，a不存在；</li>\n<li>第三段代码：报错，a不存在；</li>\n</ul>\n<p>原因：</p>\n<ul>\n<li>第一段代码中，jsvm会预编译，构造好a函数，所以访问a函数的顺序是不重要的；</li>\n<li>第二段代码中，预编译是会分代码块执行的，每个script都会形成一个代码块，即便script是通过src引入js的；</li>\n<li>第三段代码中，a函数的定义由于放在了一个表达式当中，因此jsvm不会预编译。</li>\n</ul>\n<p>但是，此处还可以继续深入，第三段代码改成如下所示：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"></div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\"></span>)</span>&#123;</div><div class=\"line\">  alert(<span class=\"number\">1</span>);</div><div class=\"line\">&#125;</div><div class=\"line\">a();</div><div class=\"line\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这段代码也同样会报错， a 不存在。为什么呢？原因就是 a 函数放在了表达式当中， jsvm 会把 a 函数看作一个匿名函数，因此在当前语句执行完， a 就被释放掉了。</p>\n<p>但是，请注意，上面讨论的都是根据 w3c 标准得出的结果，在第三段和第四段代码中，IE 6、7、8还是会预编译的，并且不会释放掉a，因此不会报错。</p>\n<h3 id=\"四、自执行函数\"><a href=\"#四、自执行函数\" class=\"headerlink\" title=\"四、自执行函数\"></a>四、自执行函数</h3><p>自执行函数的几种形式：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;)();</div><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;&#125;());</div><div class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;&#125;();</div><div class=\"line\"><span class=\"keyword\">void</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;&#125;();</div></pre></td></tr></table></figure>\n<p>其中第三种写法会造成额外的运算，因为要对返回的内容做“非”操作。</p>\n<h3 id=\"五、预编译中的变量声明\"><a href=\"#五、预编译中的变量声明\" class=\"headerlink\" title=\"五、预编译中的变量声明\"></a>五、预编译中的变量声明</h3><p>如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\">x</span>)</span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> x*<span class=\"number\">2</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">var</span> a;</div><div class=\"line\">alert(a);</div></pre></td></tr></table></figure>\n<p><code>var a</code> 只是声明，并不会干啥， <code>var a</code> 只会让当前作用域的 <code>alert(a)</code> 不会报 a 不存在的错误， a 实际上是什么，需要显示赋值；如果 <code>var a</code> 之前已经存在 a 了，则啥也不干。</p>\n<h3 id=\"六、-function-传参\"><a href=\"#六、-function-传参\" class=\"headerlink\" title=\"六、 function 传参\"></a>六、 function 传参</h3><p>如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fn1</span>(<span class=\"params\">a, b, c</span>)</span>&#123;</div><div class=\"line\">   a = <span class=\"number\">1.2</span>;</div><div class=\"line\">   b = <span class=\"number\">2.2</span>;</div><div class=\"line\">   c.c = <span class=\"number\">3.2</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> a = <span class=\"number\">1</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> b = <span class=\"number\">2</span>;</div><div class=\"line\"><span class=\"keyword\">var</span> c = &#123;<span class=\"attr\">c</span>:<span class=\"number\">3</span>&#125;;</div><div class=\"line\"></div><div class=\"line\">fn1(a,b,c);</div><div class=\"line\"></div><div class=\"line\">alert(a);</div><div class=\"line\">alert(b);</div><div class=\"line\">alert(c.c);</div></pre></td></tr></table></figure>\n<p>原理不难理解，注意值类型和引用类型的区别。</p>\n<h3 id=\"七、作用域链\"><a href=\"#七、作用域链\" class=\"headerlink\" title=\"七、作用域链\"></a>七、作用域链</h3><p>有如下几点：</p>\n<ul>\n<li>1、作用域链是在定义的时候就确定下来了的；</li>\n<li>2、隐式对象模型：对于一个作用域， jsvm 会创建一个隐式对象，然后在这个对象上面绑定当前作用域的各种变量。多个函数的嵌套定义也就会形成一条作用域链了。如果在某个作用域中要访问一个 a 变量，则会首先在当前作用域中查找是否存在 a 变量，如果不存在，则向上找父作用域隐式对象中是否存在 a 变量，依次类推，如果到了根作用域还找不到 a 变量的话，就会报错了。</li>\n</ul>\n<h3 id=\"八、类数组结构\"><a href=\"#八、类数组结构\" class=\"headerlink\" title=\"八、类数组结构\"></a>八、类数组结构</h3><p>第一个问题，如何构造类数组结构？思路简单，不赘述。</p>\n<p>jquery 选择器构造出来的就是一个类数组结构。</p>\n<h3 id=\"九、工厂模式\"><a href=\"#九、工厂模式\" class=\"headerlink\" title=\"九、工厂模式\"></a>九、工厂模式</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">factory</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThisIsAClass();</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"},{"title":"使用 CSS background 构造一个棋盘","date":"2015-08-24T16:00:00.000Z","_content":"\n[CSS background 的规范文档](http://www.w3.org/TR/css3-background)。\n\n![](https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/6.png)\n<!-- more -->\n\n使用的 CSS 代码如下：\n\n```css\n    div.demo1 {\n        width: 300px;\n        height: 150px;\n\n        background-color: #eee;\n        background-image:\n            linear-gradient(45deg, #bbb 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, #bbb 0),\n            linear-gradient(45deg, #bbb 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, #bbb 0);\n        background-size: 30px 30px;\n        background-position: 0 0, 15px 15px, 15px 15px, 0 0;\n    }\n```\n\n整个 div 的背景色是 #eee 。\n\n这个背景是由四幅代码“制造”的图片构成的，分别对应于四行 linear-gradient 。\n\n第一幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。\n\n第二幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。\n\n第三幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。\n\n第四幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。\n\n为了更清晰的看到每幅图片代码对应的区域，参考一下一段代码及其效果：\n\n```css\n    div.demo2 {\n        width: 300px;\n        height: 150px;\n\n        background-color: #eee;\n        background-image:\n            linear-gradient(45deg, red 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, blue 0),\n            linear-gradient(45deg, green 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, orange 0);\n        background-size: 30px 30px;\n        background-position: 0 0, 15px 15px, 15px 15px, 0 0;\n    }\n```\n\n![](https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/7.png)\n\n### 结语\n\ncss 的 background 属性现在很强大了，利用背景“图片”的层叠，可以做出很多绚丽的背景效果。\n\n### 更多 CSS background 的效果：\n\n{% iframe ../demos/envelope.html 100% 250 %}\n\n{% iframe ../demos/css%20background.html 100% 430 %}\n\n{% iframe ../demos/marching%20ants%20borders.html 100% 240 %}\n","source":"_posts/使用 CSS background 构造一个棋盘.md","raw":"---\ntitle: 使用 CSS background 构造一个棋盘\ndate: 2015-08-25\ntags:\n- CSS\n---\n\n[CSS background 的规范文档](http://www.w3.org/TR/css3-background)。\n\n![](https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/6.png)\n<!-- more -->\n\n使用的 CSS 代码如下：\n\n```css\n    div.demo1 {\n        width: 300px;\n        height: 150px;\n\n        background-color: #eee;\n        background-image:\n            linear-gradient(45deg, #bbb 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, #bbb 0),\n            linear-gradient(45deg, #bbb 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, #bbb 0);\n        background-size: 30px 30px;\n        background-position: 0 0, 15px 15px, 15px 15px, 0 0;\n    }\n```\n\n整个 div 的背景色是 #eee 。\n\n这个背景是由四幅代码“制造”的图片构成的，分别对应于四行 linear-gradient 。\n\n第一幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。\n\n第二幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。\n\n第三幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。\n\n第四幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。\n\n为了更清晰的看到每幅图片代码对应的区域，参考一下一段代码及其效果：\n\n```css\n    div.demo2 {\n        width: 300px;\n        height: 150px;\n\n        background-color: #eee;\n        background-image:\n            linear-gradient(45deg, red 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, blue 0),\n            linear-gradient(45deg, green 25%, transparent 0),\n            linear-gradient(45deg, transparent 75%, orange 0);\n        background-size: 30px 30px;\n        background-position: 0 0, 15px 15px, 15px 15px, 0 0;\n    }\n```\n\n![](https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/7.png)\n\n### 结语\n\ncss 的 background 属性现在很强大了，利用背景“图片”的层叠，可以做出很多绚丽的背景效果。\n\n### 更多 CSS background 的效果：\n\n{% iframe ../demos/envelope.html 100% 250 %}\n\n{% iframe ../demos/css%20background.html 100% 430 %}\n\n{% iframe ../demos/marching%20ants%20borders.html 100% 240 %}\n","slug":"使用 CSS background 构造一个棋盘","published":1,"updated":"2016-06-15T10:46:57.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02r00130407xylfo7ox","content":"<p><a href=\"http://www.w3.org/TR/css3-background\" target=\"_blank\" rel=\"external\">CSS background 的规范文档</a>。</p>\n<p><img src=\"https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/6.png\" alt=\"\"><br><a id=\"more\"></a></p>\n<p>使用的 CSS 代码如下：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">div</span><span class=\"selector-class\">.demo1</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">150px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"number\">#eee</span>;</div><div class=\"line\">    <span class=\"attribute\">background-image</span>:</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, #bbb 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, #bbb 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, #bbb 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, #bbb 0);</div><div class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">30px</span> <span class=\"number\">30px</span>;</div><div class=\"line\">    <span class=\"attribute\">background-position</span>: <span class=\"number\">0</span> <span class=\"number\">0</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">0</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>整个 div 的背景色是 #eee 。</p>\n<p>这个背景是由四幅代码“制造”的图片构成的，分别对应于四行 linear-gradient 。</p>\n<p>第一幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。</p>\n<p>第二幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。</p>\n<p>第三幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。</p>\n<p>第四幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。</p>\n<p>为了更清晰的看到每幅图片代码对应的区域，参考一下一段代码及其效果：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">div</span><span class=\"selector-class\">.demo2</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">150px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"number\">#eee</span>;</div><div class=\"line\">    <span class=\"attribute\">background-image</span>:</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, red 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, blue 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, green 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, orange 0);</div><div class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">30px</span> <span class=\"number\">30px</span>;</div><div class=\"line\">    <span class=\"attribute\">background-position</span>: <span class=\"number\">0</span> <span class=\"number\">0</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">0</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/7.png\" alt=\"\"></p>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>css 的 background 属性现在很强大了，利用背景“图片”的层叠，可以做出很多绚丽的背景效果。</p>\n<h3 id=\"更多-CSS-background-的效果：\"><a href=\"#更多-CSS-background-的效果：\" class=\"headerlink\" title=\"更多 CSS background 的效果：\"></a>更多 CSS background 的效果：</h3><iframe src=\"../demos/envelope.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<iframe src=\"../demos/css%20background.html\" width=\"100%\" height=\"430\" frameborder=\"0\" allowfullscreen></iframe>\n<iframe src=\"../demos/marching%20ants%20borders.html\" width=\"100%\" height=\"240\" frameborder=\"0\" allowfullscreen></iframe>\n","excerpt":"<p><a href=\"http://www.w3.org/TR/css3-background\">CSS background 的规范文档</a>。</p>\n<p><img src=\"https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/6.png\" alt=\"\"><br>","more":"</p>\n<p>使用的 CSS 代码如下：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">div</span><span class=\"selector-class\">.demo1</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">150px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"number\">#eee</span>;</div><div class=\"line\">    <span class=\"attribute\">background-image</span>:</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, #bbb 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, #bbb 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, #bbb 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, #bbb 0);</div><div class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">30px</span> <span class=\"number\">30px</span>;</div><div class=\"line\">    <span class=\"attribute\">background-position</span>: <span class=\"number\">0</span> <span class=\"number\">0</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">0</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>整个 div 的背景色是 #eee 。</p>\n<p>这个背景是由四幅代码“制造”的图片构成的，分别对应于四行 linear-gradient 。</p>\n<p>第一幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。</p>\n<p>第二幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。</p>\n<p>第三幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-25%的颜色是 #bbb ，25%-100%的颜色是透明的（ transparent ），图片的大小是30px*30px的，图片从坐标(15px,15px)处开始绘制。</p>\n<p>第四幅图片，颜色渐变，角度是 45deg ，于是从图片的左下角开始往右上角渐变。0-75%的颜色是透明的（ transparent ），75%-100%的颜色是 #bbb ，图片的大小是30px*30px的，图片从坐标(0,0)处开始绘制。</p>\n<p>为了更清晰的看到每幅图片代码对应的区域，参考一下一段代码及其效果：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-tag\">div</span><span class=\"selector-class\">.demo2</span> &#123;</div><div class=\"line\">    <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</div><div class=\"line\">    <span class=\"attribute\">height</span>: <span class=\"number\">150px</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"attribute\">background-color</span>: <span class=\"number\">#eee</span>;</div><div class=\"line\">    <span class=\"attribute\">background-image</span>:</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, red 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, blue 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, green 25%, transparent 0),</div><div class=\"line\">        <span class=\"built_in\">linear-gradient</span>(45deg, transparent 75%, orange 0);</div><div class=\"line\">    <span class=\"attribute\">background-size</span>: <span class=\"number\">30px</span> <span class=\"number\">30px</span>;</div><div class=\"line\">    <span class=\"attribute\">background-position</span>: <span class=\"number\">0</span> <span class=\"number\">0</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">15px</span> <span class=\"number\">15px</span>, <span class=\"number\">0</span> <span class=\"number\">0</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/yibuyisheng/blogs/master/imgs/7.png\" alt=\"\"></p>\n<h3 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h3><p>css 的 background 属性现在很强大了，利用背景“图片”的层叠，可以做出很多绚丽的背景效果。</p>\n<h3 id=\"更多-CSS-background-的效果：\"><a href=\"#更多-CSS-background-的效果：\" class=\"headerlink\" title=\"更多 CSS background 的效果：\"></a>更多 CSS background 的效果：</h3><iframe src=\"../demos/envelope.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<iframe src=\"../demos/css%20background.html\" width=\"100%\" height=\"430\" frameborder=\"0\" allowfullscreen></iframe>\n<iframe src=\"../demos/marching%20ants%20borders.html\" width=\"100%\" height=\"240\" frameborder=\"0\" allowfullscreen></iframe>"},{"title":"使用 marked 解析 markdown 之缩进","date":"2016-06-15T08:12:00.000Z","_content":"\n在前面一篇文章{% post_link 使用marked解析markdown %}中，大致介绍了一下 marked 使用过程中的一些问题，今天又再次遇到 ETPL 的 markdown 过滤器嵌套带来的问题。\n\n<!-- more -->\n\n# 遇见问题\n\n这次，我想在 table 的 td 里面写 markdown ，期望效果看起来像是这样的：\n\n{% img /images/14.png %}\n\n而 markdown 代码，我是这样写的：\n\n{% img /images/15.png %}\n\n然后出来的效果是这样：\n\n{% img /images/16.png %}\n\n注意黑色的那段代码块，没缩进了！\n\n什么情况？为啥会没缩进呢？\n\n# 初步分析\n\n仔细一看 markdown 代码，发现里面出现了过滤器嵌套，也就是说，里面那块 markdown 代码会被处理两次！\n\n# 尝试解决方案1\n\n既然处理了两次，那么就得想办法只处理一次，于是将 markdown 代码改成这样：\n\n{% img /images/17.png %}\n\n看起来每个 markdown 块都只被处理了一次，应该可以了吧！\n\n于是，我得到了这个效果：\n\n{% img /images/14.png %}\n\n这个看起来好像没啥问题了。\n\n但是，结合 filter 代码：\n\n```js\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    source = source.replace(/(^\\n+|\\n+$)/g, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return marked(source);\n});\n```\n\n发现：第三个 &lt;!-- filter: markdown() --&gt; 会导致自己的 markdown 块缩进出问题。\n\n# 尝试解决方案2\n\n再来仔细玩味一下内嵌 filter 的处理流程吧，希望能找到解决方案。\n\n经过各种 debug ，发现整个处理流程是这样的：\n\n- 1、先处理最里面的 markdown 块（这是是 ETPL 的处理流程），然后生成对应的 HTML 代码，替换掉之前的 markdown 代码；\n- 2、再处理外层的 markdown 块，这个块包含了第一步中生成的 HTML 代码块。于是在替换每行空格的时候，同样会替换掉第一步中生成的 code 标签中每一行前面相应的空格。\n\n好了，现在为啥缩进会出问题的原因已经具体定位了，咋办呢？\n\n在第2步调用 marked 解析之前，完全可以把第一步中生成的 HTML 代码拿出来，这样第2步处理的时候就不会去掉 code 块中的有用空格了。这样一来，过滤器关键部分的代码就变成了：\n\n```js\nvar renderer = new marked.Renderer();\nrequire('etpl').addFilter('markdown', function (source, useExtra) {\n    // 把内嵌的 markdown 拿出来，防止多次转换\n    var nestMarkdowns = [];\n    source = source.replace(/<div class=\"markdown\">(.|\\n)*<\\/div>/g, function (match) {\n        nestMarkdowns.push(match);\n        return '${nestMarkdown}';\n    });\n\n    source = source.replace(/^\\n+/, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return '<div class=\"markdown\">'\n        + marked(source, {renderer: renderer})\n            .replace(/\\${nestMarkdown}/g, function () {\n                return nestMarkdowns.shift();\n            })\n        + '</div>';\n});\n```\n\n刷一下页面，再看，符合预期，完全正常！\n","source":"_posts/使用 marked 解析 markdown 之缩进.md","raw":"---\ntitle: 使用 marked 解析 markdown 之缩进\ndate: 2016-06-15T16:12:00.000Z\ntags:\n- markdown\n- ETPL\n---\n\n在前面一篇文章{% post_link 使用marked解析markdown %}中，大致介绍了一下 marked 使用过程中的一些问题，今天又再次遇到 ETPL 的 markdown 过滤器嵌套带来的问题。\n\n<!-- more -->\n\n# 遇见问题\n\n这次，我想在 table 的 td 里面写 markdown ，期望效果看起来像是这样的：\n\n{% img /images/14.png %}\n\n而 markdown 代码，我是这样写的：\n\n{% img /images/15.png %}\n\n然后出来的效果是这样：\n\n{% img /images/16.png %}\n\n注意黑色的那段代码块，没缩进了！\n\n什么情况？为啥会没缩进呢？\n\n# 初步分析\n\n仔细一看 markdown 代码，发现里面出现了过滤器嵌套，也就是说，里面那块 markdown 代码会被处理两次！\n\n# 尝试解决方案1\n\n既然处理了两次，那么就得想办法只处理一次，于是将 markdown 代码改成这样：\n\n{% img /images/17.png %}\n\n看起来每个 markdown 块都只被处理了一次，应该可以了吧！\n\n于是，我得到了这个效果：\n\n{% img /images/14.png %}\n\n这个看起来好像没啥问题了。\n\n但是，结合 filter 代码：\n\n```js\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    source = source.replace(/(^\\n+|\\n+$)/g, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return marked(source);\n});\n```\n\n发现：第三个 &lt;!-- filter: markdown() --&gt; 会导致自己的 markdown 块缩进出问题。\n\n# 尝试解决方案2\n\n再来仔细玩味一下内嵌 filter 的处理流程吧，希望能找到解决方案。\n\n经过各种 debug ，发现整个处理流程是这样的：\n\n- 1、先处理最里面的 markdown 块（这是是 ETPL 的处理流程），然后生成对应的 HTML 代码，替换掉之前的 markdown 代码；\n- 2、再处理外层的 markdown 块，这个块包含了第一步中生成的 HTML 代码块。于是在替换每行空格的时候，同样会替换掉第一步中生成的 code 标签中每一行前面相应的空格。\n\n好了，现在为啥缩进会出问题的原因已经具体定位了，咋办呢？\n\n在第2步调用 marked 解析之前，完全可以把第一步中生成的 HTML 代码拿出来，这样第2步处理的时候就不会去掉 code 块中的有用空格了。这样一来，过滤器关键部分的代码就变成了：\n\n```js\nvar renderer = new marked.Renderer();\nrequire('etpl').addFilter('markdown', function (source, useExtra) {\n    // 把内嵌的 markdown 拿出来，防止多次转换\n    var nestMarkdowns = [];\n    source = source.replace(/<div class=\"markdown\">(.|\\n)*<\\/div>/g, function (match) {\n        nestMarkdowns.push(match);\n        return '${nestMarkdown}';\n    });\n\n    source = source.replace(/^\\n+/, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return '<div class=\"markdown\">'\n        + marked(source, {renderer: renderer})\n            .replace(/\\${nestMarkdown}/g, function () {\n                return nestMarkdowns.shift();\n            })\n        + '</div>';\n});\n```\n\n刷一下页面，再看，符合预期，完全正常！\n","slug":"使用 marked 解析 markdown 之缩进","published":1,"updated":"2016-06-17T12:56:10.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02u00160407nyowugdu","content":"<p>在前面一篇文章<a href=\"/blogs/site//blogs/使用marked解析markdown.html\" title=\"使用 marked 解析 markdown\">使用 marked 解析 markdown</a>中，大致介绍了一下 marked 使用过程中的一些问题，今天又再次遇到 ETPL 的 markdown 过滤器嵌套带来的问题。</p>\n<a id=\"more\"></a>\n<h1 id=\"遇见问题\"><a href=\"#遇见问题\" class=\"headerlink\" title=\"遇见问题\"></a>遇见问题</h1><p>这次，我想在 table 的 td 里面写 markdown ，期望效果看起来像是这样的：</p>\n<img src=\"/blogs/site/images/14.png\">\n<p>而 markdown 代码，我是这样写的：</p>\n<img src=\"/blogs/site/images/15.png\">\n<p>然后出来的效果是这样：</p>\n<img src=\"/blogs/site/images/16.png\">\n<p>注意黑色的那段代码块，没缩进了！</p>\n<p>什么情况？为啥会没缩进呢？</p>\n<h1 id=\"初步分析\"><a href=\"#初步分析\" class=\"headerlink\" title=\"初步分析\"></a>初步分析</h1><p>仔细一看 markdown 代码，发现里面出现了过滤器嵌套，也就是说，里面那块 markdown 代码会被处理两次！</p>\n<h1 id=\"尝试解决方案1\"><a href=\"#尝试解决方案1\" class=\"headerlink\" title=\"尝试解决方案1\"></a>尝试解决方案1</h1><p>既然处理了两次，那么就得想办法只处理一次，于是将 markdown 代码改成这样：</p>\n<img src=\"/blogs/site/images/17.png\">\n<p>看起来每个 markdown 块都只被处理了一次，应该可以了吧！</p>\n<p>于是，我得到了这个效果：</p>\n<img src=\"/blogs/site/images/14.png\">\n<p>这个看起来好像没啥问题了。</p>\n<p>但是，结合 filter 代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/(^\\n+|\\n+$)/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>发现：第三个 &lt;!– filter: markdown() –&gt; 会导致自己的 markdown 块缩进出问题。</p>\n<h1 id=\"尝试解决方案2\"><a href=\"#尝试解决方案2\" class=\"headerlink\" title=\"尝试解决方案2\"></a>尝试解决方案2</h1><p>再来仔细玩味一下内嵌 filter 的处理流程吧，希望能找到解决方案。</p>\n<p>经过各种 debug ，发现整个处理流程是这样的：</p>\n<ul>\n<li>1、先处理最里面的 markdown 块（这是是 ETPL 的处理流程），然后生成对应的 HTML 代码，替换掉之前的 markdown 代码；</li>\n<li>2、再处理外层的 markdown 块，这个块包含了第一步中生成的 HTML 代码块。于是在替换每行空格的时候，同样会替换掉第一步中生成的 code 标签中每一行前面相应的空格。</li>\n</ul>\n<p>好了，现在为啥缩进会出问题的原因已经具体定位了，咋办呢？</p>\n<p>在第2步调用 marked 解析之前，完全可以把第一步中生成的 HTML 代码拿出来，这样第2步处理的时候就不会去掉 code 块中的有用空格了。这样一来，过滤器关键部分的代码就变成了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> renderer = <span class=\"keyword\">new</span> marked.Renderer();</div><div class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>).addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 把内嵌的 markdown 拿出来，防止多次转换</span></div><div class=\"line\">    <span class=\"keyword\">var</span> nestMarkdowns = [];</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/&lt;div class=\"markdown\"&gt;(.|\\n)*&lt;\\/div&gt;/g</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">match</span>) </span>&#123;</div><div class=\"line\">        nestMarkdowns.push(match);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">'$&#123;nestMarkdown&#125;'</span>;</div><div class=\"line\">    &#125;);</div><div class=\"line\"></div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/^\\n+/</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'&lt;div class=\"markdown\"&gt;'</span></div><div class=\"line\">        + marked(source, &#123;<span class=\"attr\">renderer</span>: renderer&#125;)</div><div class=\"line\">            .replace(<span class=\"regexp\">/\\$&#123;nestMarkdown&#125;/g</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> nestMarkdowns.shift();</div><div class=\"line\">            &#125;)</div><div class=\"line\">        + <span class=\"string\">'&lt;/div&gt;'</span>;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>刷一下页面，再看，符合预期，完全正常！</p>\n","excerpt":"<p>在前面一篇文章<a href=\"/blogs/site//blogs/使用marked解析markdown.html\" title=\"使用 marked 解析 markdown\">使用 marked 解析 markdown</a>中，大致介绍了一下 marked 使用过程中的一些问题，今天又再次遇到 ETPL 的 markdown 过滤器嵌套带来的问题。</p>","more":"<h1 id=\"遇见问题\"><a href=\"#遇见问题\" class=\"headerlink\" title=\"遇见问题\"></a>遇见问题</h1><p>这次，我想在 table 的 td 里面写 markdown ，期望效果看起来像是这样的：</p>\n<img src=\"/blogs/site/images/14.png\">\n<p>而 markdown 代码，我是这样写的：</p>\n<img src=\"/blogs/site/images/15.png\">\n<p>然后出来的效果是这样：</p>\n<img src=\"/blogs/site/images/16.png\">\n<p>注意黑色的那段代码块，没缩进了！</p>\n<p>什么情况？为啥会没缩进呢？</p>\n<h1 id=\"初步分析\"><a href=\"#初步分析\" class=\"headerlink\" title=\"初步分析\"></a>初步分析</h1><p>仔细一看 markdown 代码，发现里面出现了过滤器嵌套，也就是说，里面那块 markdown 代码会被处理两次！</p>\n<h1 id=\"尝试解决方案1\"><a href=\"#尝试解决方案1\" class=\"headerlink\" title=\"尝试解决方案1\"></a>尝试解决方案1</h1><p>既然处理了两次，那么就得想办法只处理一次，于是将 markdown 代码改成这样：</p>\n<img src=\"/blogs/site/images/17.png\">\n<p>看起来每个 markdown 块都只被处理了一次，应该可以了吧！</p>\n<p>于是，我得到了这个效果：</p>\n<img src=\"/blogs/site/images/14.png\">\n<p>这个看起来好像没啥问题了。</p>\n<p>但是，结合 filter 代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/(^\\n+|\\n+$)/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>发现：第三个 &lt;!– filter: markdown() –&gt; 会导致自己的 markdown 块缩进出问题。</p>\n<h1 id=\"尝试解决方案2\"><a href=\"#尝试解决方案2\" class=\"headerlink\" title=\"尝试解决方案2\"></a>尝试解决方案2</h1><p>再来仔细玩味一下内嵌 filter 的处理流程吧，希望能找到解决方案。</p>\n<p>经过各种 debug ，发现整个处理流程是这样的：</p>\n<ul>\n<li>1、先处理最里面的 markdown 块（这是是 ETPL 的处理流程），然后生成对应的 HTML 代码，替换掉之前的 markdown 代码；</li>\n<li>2、再处理外层的 markdown 块，这个块包含了第一步中生成的 HTML 代码块。于是在替换每行空格的时候，同样会替换掉第一步中生成的 code 标签中每一行前面相应的空格。</li>\n</ul>\n<p>好了，现在为啥缩进会出问题的原因已经具体定位了，咋办呢？</p>\n<p>在第2步调用 marked 解析之前，完全可以把第一步中生成的 HTML 代码拿出来，这样第2步处理的时候就不会去掉 code 块中的有用空格了。这样一来，过滤器关键部分的代码就变成了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> renderer = <span class=\"keyword\">new</span> marked.Renderer();</div><div class=\"line\"><span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>).addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 把内嵌的 markdown 拿出来，防止多次转换</span></div><div class=\"line\">    <span class=\"keyword\">var</span> nestMarkdowns = [];</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/&lt;div class=\"markdown\"&gt;(.|\\n)*&lt;\\/div&gt;/g</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">match</span>) </span>&#123;</div><div class=\"line\">        nestMarkdowns.push(match);</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">'$&#123;nestMarkdown&#125;'</span>;</div><div class=\"line\">    &#125;);</div><div class=\"line\"></div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/^\\n+/</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'&lt;div class=\"markdown\"&gt;'</span></div><div class=\"line\">        + marked(source, &#123;<span class=\"attr\">renderer</span>: renderer&#125;)</div><div class=\"line\">            .replace(<span class=\"regexp\">/\\$&#123;nestMarkdown&#125;/g</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">                <span class=\"keyword\">return</span> nestMarkdowns.shift();</div><div class=\"line\">            &#125;)</div><div class=\"line\">        + <span class=\"string\">'&lt;/div&gt;'</span>;</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>刷一下页面，再看，符合预期，完全正常！</p>"},{"title":"使用 marked 解析 markdown","date":"2016-05-20T05:49:00.000Z","_content":"\n[marked](https://github.com/chjj/marked) 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。\n\n最简单直接的一种使用方式：\n\n```javascript\nvar marked = require('marked');\nconsole.log(marked('I am using __markdown__.'));\n// Outputs: <p>I am using <strong>markdown</strong>.</p>\n```\n\n<!-- more -->\n\n marked 库主要提供了一个 marked 函数，该函数声明为：\n\n```\ntype OptionsType = {\n    highlight: (function(code: string, lang: string, callback: function(err: Error, code: string)))=,\n    renderer: marked.Renderer=,\n    gfm: boolean=,\n    tables: boolean=,\n    breaks: boolean=,\n    pedantic: boolean=,\n    sanitize: boolean=,\n    smartLists: boolean=\n};\nmarked(markdownString: string, options: OptionsType=, callback: Function=): string;\n```\n\n其中，marked 可以通过 renderer 配置提供了自定义解析途径。\n\nrenderer 配置对应的是一个 marked.Renderer 类，此类主要包含了如下的钩子方法：\n\n- code(string code, string language)\n- blockquote(string quote)\n- html(string html)\n- heading(string text, number level)\n- hr()\n- list(string body, boolean ordered)\n- listitem(string text)\n- paragraph(string text)\n- table(string header, string body)\n- tablerow(string content)\n- tablecell(string content, object flags)\n- strong(string text)\n- em(string text)\n- codespan(string code)\n- br()\n- del(string text)\n- link(string href, string title, string text)\n- image(string href, string title, string text)\n\n所有的这些方法，都可以在 renderer 实例上面覆盖掉。marked 在解析到 markdown 标记的时候，都会去调用相应的钩子方法，而钩子方法的返回结果，就会是该标记最终的解析结果。这样一来，就生成了自定义的解析结果。\n\nmarked 还有一个重要的配置：highlight，可以对代码块进行解析，配合相应的 css ，达到语法高亮效果。\n\n以上就是 marked 最基本最核心的用法了。\n\n其实本文的重点是记录在使用过程中遇到的一些坑，下面进入重点。\n\n# markdown 缩进问题\n\n在 markdown 的语法中，标题下面（换行之后）标记是不能缩进的，而列表项下面的标记是可以缩进的。\n\n现在前端开发，经常会使用一些模板引擎，比如 [ETPL](https://github.com/ecomfe/etpl) ，这些模板，一般都会提供过滤器的功能。以 ETPL 为例，可以在 js 代码中这样添加一个过滤器：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    return marked(source);\n});\n```\n\n此时在对应的模板中，就可以使用该过滤器了：\n\n```html\n<div>\n    <!-- filter: markdown() -->\n    ### 标题\n\n    内容\n    <!-- /filter -->\n</div>\n```\n\n此时，解析出来的样子会让人瞠目结舌：过滤器里面的 markdown 标记根本不会被解析掉，整个 markdown 标记块会被当成代码块。\n\n为什么会这样呢？\n\n如果打印一下 markdown 过滤器处理函数中的 source 参数：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    console.log(source);\n    return marked(source);\n});\n```\n\n可以发现，打印出来的内容会是这个样子：\n\n```\n\"\n    ### 标题\n\n    内容\n    \"\n```\n\n第一行没啥内容，第二行并没有顶行，而是有缩进的，然后最后一行没实际内容，只有一个缩进。\n\n这明显跟 markdown 语法有冲突，必须要进行如下处理：\n\n- 1、第一行和最后一行没啥实际内容，可以去掉；\n- 2、检测第一行前面的缩进空格数（这里假定缩进用的是空格），记录下来，假设为 `n` ；\n- 3、将每一行前面的 `n` 个空格去掉。\n\n具体的代码实现如下：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    source = source.replace(/(^\\n+|\\n+$)/g, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return marked(source);\n});\n```\n\n# HTML 标签\n\n有的时候，可能想给 markdown 标记的某一块加上背景色，比如：\n\n```html\n<!-- filter: markdown() -->\n<div class=\"background-red\">\n### 标题\n\n内容\n</div>\n<!-- /filter -->\n```\n\n这样写又会崩溃了， div 内部的 markdown 标记并不会被解析！\n\n解决方法就是把 div 放过滤器外边吧：\n\n```html\n<div class=\"background-red\">\n<!-- filter: markdown() -->\n### 标题\n\n内容\n<!-- /filter -->\n</div>\n```\n","source":"_posts/使用marked解析markdown.md","raw":"---\ntitle: 使用 marked 解析 markdown\ndate: 2016-05-20T13:49:00.000Z\ntags:\n- markdown\n- ETPL\n---\n\n[marked](https://github.com/chjj/marked) 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。\n\n最简单直接的一种使用方式：\n\n```javascript\nvar marked = require('marked');\nconsole.log(marked('I am using __markdown__.'));\n// Outputs: <p>I am using <strong>markdown</strong>.</p>\n```\n\n<!-- more -->\n\n marked 库主要提供了一个 marked 函数，该函数声明为：\n\n```\ntype OptionsType = {\n    highlight: (function(code: string, lang: string, callback: function(err: Error, code: string)))=,\n    renderer: marked.Renderer=,\n    gfm: boolean=,\n    tables: boolean=,\n    breaks: boolean=,\n    pedantic: boolean=,\n    sanitize: boolean=,\n    smartLists: boolean=\n};\nmarked(markdownString: string, options: OptionsType=, callback: Function=): string;\n```\n\n其中，marked 可以通过 renderer 配置提供了自定义解析途径。\n\nrenderer 配置对应的是一个 marked.Renderer 类，此类主要包含了如下的钩子方法：\n\n- code(string code, string language)\n- blockquote(string quote)\n- html(string html)\n- heading(string text, number level)\n- hr()\n- list(string body, boolean ordered)\n- listitem(string text)\n- paragraph(string text)\n- table(string header, string body)\n- tablerow(string content)\n- tablecell(string content, object flags)\n- strong(string text)\n- em(string text)\n- codespan(string code)\n- br()\n- del(string text)\n- link(string href, string title, string text)\n- image(string href, string title, string text)\n\n所有的这些方法，都可以在 renderer 实例上面覆盖掉。marked 在解析到 markdown 标记的时候，都会去调用相应的钩子方法，而钩子方法的返回结果，就会是该标记最终的解析结果。这样一来，就生成了自定义的解析结果。\n\nmarked 还有一个重要的配置：highlight，可以对代码块进行解析，配合相应的 css ，达到语法高亮效果。\n\n以上就是 marked 最基本最核心的用法了。\n\n其实本文的重点是记录在使用过程中遇到的一些坑，下面进入重点。\n\n# markdown 缩进问题\n\n在 markdown 的语法中，标题下面（换行之后）标记是不能缩进的，而列表项下面的标记是可以缩进的。\n\n现在前端开发，经常会使用一些模板引擎，比如 [ETPL](https://github.com/ecomfe/etpl) ，这些模板，一般都会提供过滤器的功能。以 ETPL 为例，可以在 js 代码中这样添加一个过滤器：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    return marked(source);\n});\n```\n\n此时在对应的模板中，就可以使用该过滤器了：\n\n```html\n<div>\n    <!-- filter: markdown() -->\n    ### 标题\n\n    内容\n    <!-- /filter -->\n</div>\n```\n\n此时，解析出来的样子会让人瞠目结舌：过滤器里面的 markdown 标记根本不会被解析掉，整个 markdown 标记块会被当成代码块。\n\n为什么会这样呢？\n\n如果打印一下 markdown 过滤器处理函数中的 source 参数：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    console.log(source);\n    return marked(source);\n});\n```\n\n可以发现，打印出来的内容会是这个样子：\n\n```\n\"\n    ### 标题\n\n    内容\n    \"\n```\n\n第一行没啥内容，第二行并没有顶行，而是有缩进的，然后最后一行没实际内容，只有一个缩进。\n\n这明显跟 markdown 语法有冲突，必须要进行如下处理：\n\n- 1、第一行和最后一行没啥实际内容，可以去掉；\n- 2、检测第一行前面的缩进空格数（这里假定缩进用的是空格），记录下来，假设为 `n` ；\n- 3、将每一行前面的 `n` 个空格去掉。\n\n具体的代码实现如下：\n\n```javascript\nvar etpl = require('etpl');\nvar marked = require('marked');\netpl.addFilter('markdown', function (source, useExtra) {\n    source = source.replace(/(^\\n+|\\n+$)/g, '');\n    var uselessSpaceCount = source.match(/^\\s*/)[0].length;\n    source = source.replace(new RegExp('^ {' + uselessSpaceCount + '}', 'gm'), '');\n    return marked(source);\n});\n```\n\n# HTML 标签\n\n有的时候，可能想给 markdown 标记的某一块加上背景色，比如：\n\n```html\n<!-- filter: markdown() -->\n<div class=\"background-red\">\n### 标题\n\n内容\n</div>\n<!-- /filter -->\n```\n\n这样写又会崩溃了， div 内部的 markdown 标记并不会被解析！\n\n解决方法就是把 div 放过滤器外边吧：\n\n```html\n<div class=\"background-red\">\n<!-- filter: markdown() -->\n### 标题\n\n内容\n<!-- /filter -->\n</div>\n```\n","slug":"使用marked解析markdown","published":1,"updated":"2016-06-15T10:44:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02w00180407hicg4bc1","content":"<p><a href=\"https://github.com/chjj/marked\" target=\"_blank\" rel=\"external\">marked</a> 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。</p>\n<p>最简单直接的一种使用方式：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\"><span class=\"built_in\">console</span>.log(marked(<span class=\"string\">'I am using __markdown__.'</span>));</div><div class=\"line\"><span class=\"comment\">// Outputs: &lt;p&gt;I am using &lt;strong&gt;markdown&lt;/strong&gt;.&lt;/p&gt;</span></div></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<p> marked 库主要提供了一个 marked 函数，该函数声明为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">type OptionsType = &#123;</div><div class=\"line\">    highlight: (function(code: string, lang: string, callback: function(err: Error, code: string)))=,</div><div class=\"line\">    renderer: marked.Renderer=,</div><div class=\"line\">    gfm: boolean=,</div><div class=\"line\">    tables: boolean=,</div><div class=\"line\">    breaks: boolean=,</div><div class=\"line\">    pedantic: boolean=,</div><div class=\"line\">    sanitize: boolean=,</div><div class=\"line\">    smartLists: boolean=</div><div class=\"line\">&#125;;</div><div class=\"line\">marked(markdownString: string, options: OptionsType=, callback: Function=): string;</div></pre></td></tr></table></figure>\n<p>其中，marked 可以通过 renderer 配置提供了自定义解析途径。</p>\n<p>renderer 配置对应的是一个 marked.Renderer 类，此类主要包含了如下的钩子方法：</p>\n<ul>\n<li>code(string code, string language)</li>\n<li>blockquote(string quote)</li>\n<li>html(string html)</li>\n<li>heading(string text, number level)</li>\n<li>hr()</li>\n<li>list(string body, boolean ordered)</li>\n<li>listitem(string text)</li>\n<li>paragraph(string text)</li>\n<li>table(string header, string body)</li>\n<li>tablerow(string content)</li>\n<li>tablecell(string content, object flags)</li>\n<li>strong(string text)</li>\n<li>em(string text)</li>\n<li>codespan(string code)</li>\n<li>br()</li>\n<li>del(string text)</li>\n<li>link(string href, string title, string text)</li>\n<li>image(string href, string title, string text)</li>\n</ul>\n<p>所有的这些方法，都可以在 renderer 实例上面覆盖掉。marked 在解析到 markdown 标记的时候，都会去调用相应的钩子方法，而钩子方法的返回结果，就会是该标记最终的解析结果。这样一来，就生成了自定义的解析结果。</p>\n<p>marked 还有一个重要的配置：highlight，可以对代码块进行解析，配合相应的 css ，达到语法高亮效果。</p>\n<p>以上就是 marked 最基本最核心的用法了。</p>\n<p>其实本文的重点是记录在使用过程中遇到的一些坑，下面进入重点。</p>\n<h1 id=\"markdown-缩进问题\"><a href=\"#markdown-缩进问题\" class=\"headerlink\" title=\"markdown 缩进问题\"></a>markdown 缩进问题</h1><p>在 markdown 的语法中，标题下面（换行之后）标记是不能缩进的，而列表项下面的标记是可以缩进的。</p>\n<p>现在前端开发，经常会使用一些模板引擎，比如 <a href=\"https://github.com/ecomfe/etpl\" target=\"_blank\" rel=\"external\">ETPL</a> ，这些模板，一般都会提供过滤器的功能。以 ETPL 为例，可以在 js 代码中这样添加一个过滤器：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>此时在对应的模板中，就可以使用该过滤器了：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\">    ### 标题</div><div class=\"line\"></div><div class=\"line\">    内容</div><div class=\"line\">    <span class=\"comment\">&lt;!-- /filter --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>此时，解析出来的样子会让人瞠目结舌：过滤器里面的 markdown 标记根本不会被解析掉，整个 markdown 标记块会被当成代码块。</p>\n<p>为什么会这样呢？</p>\n<p>如果打印一下 markdown 过滤器处理函数中的 source 参数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(source);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>可以发现，打印出来的内容会是这个样子：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&quot;</div><div class=\"line\">    ### 标题</div><div class=\"line\"></div><div class=\"line\">    内容</div><div class=\"line\">    &quot;</div></pre></td></tr></table></figure>\n<p>第一行没啥内容，第二行并没有顶行，而是有缩进的，然后最后一行没实际内容，只有一个缩进。</p>\n<p>这明显跟 markdown 语法有冲突，必须要进行如下处理：</p>\n<ul>\n<li>1、第一行和最后一行没啥实际内容，可以去掉；</li>\n<li>2、检测第一行前面的缩进空格数（这里假定缩进用的是空格），记录下来，假设为 <code>n</code> ；</li>\n<li>3、将每一行前面的 <code>n</code> 个空格去掉。</li>\n</ul>\n<p>具体的代码实现如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/(^\\n+|\\n+$)/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h1 id=\"HTML-标签\"><a href=\"#HTML-标签\" class=\"headerlink\" title=\"HTML 标签\"></a>HTML 标签</h1><p>有的时候，可能想给 markdown 标记的某一块加上背景色，比如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"background-red\"</span>&gt;</span></div><div class=\"line\">### 标题</div><div class=\"line\"></div><div class=\"line\">内容</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"comment\">&lt;!-- /filter --&gt;</span></div></pre></td></tr></table></figure>\n<p>这样写又会崩溃了， div 内部的 markdown 标记并不会被解析！</p>\n<p>解决方法就是把 div 放过滤器外边吧：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"background-red\"</span>&gt;</span></div><div class=\"line\"><span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\">### 标题</div><div class=\"line\"></div><div class=\"line\">内容</div><div class=\"line\"><span class=\"comment\">&lt;!-- /filter --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n","excerpt":"<p><a href=\"https://github.com/chjj/marked\">marked</a> 是一个解析 markdown 的 JavaScript 库，可以运行在 Node 环境或者浏览器环境。</p>\n<p>最简单直接的一种使用方式：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\"><span class=\"built_in\">console</span>.log(marked(<span class=\"string\">'I am using __markdown__.'</span>));</div><div class=\"line\"><span class=\"comment\">// Outputs: &lt;p&gt;I am using &lt;strong&gt;markdown&lt;/strong&gt;.&lt;/p&gt;</span></div></pre></td></tr></table></figure>","more":"<p> marked 库主要提供了一个 marked 函数，该函数声明为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">type OptionsType = &#123;</div><div class=\"line\">    highlight: (function(code: string, lang: string, callback: function(err: Error, code: string)))=,</div><div class=\"line\">    renderer: marked.Renderer=,</div><div class=\"line\">    gfm: boolean=,</div><div class=\"line\">    tables: boolean=,</div><div class=\"line\">    breaks: boolean=,</div><div class=\"line\">    pedantic: boolean=,</div><div class=\"line\">    sanitize: boolean=,</div><div class=\"line\">    smartLists: boolean=</div><div class=\"line\">&#125;;</div><div class=\"line\">marked(markdownString: string, options: OptionsType=, callback: Function=): string;</div></pre></td></tr></table></figure>\n<p>其中，marked 可以通过 renderer 配置提供了自定义解析途径。</p>\n<p>renderer 配置对应的是一个 marked.Renderer 类，此类主要包含了如下的钩子方法：</p>\n<ul>\n<li>code(string code, string language)</li>\n<li>blockquote(string quote)</li>\n<li>html(string html)</li>\n<li>heading(string text, number level)</li>\n<li>hr()</li>\n<li>list(string body, boolean ordered)</li>\n<li>listitem(string text)</li>\n<li>paragraph(string text)</li>\n<li>table(string header, string body)</li>\n<li>tablerow(string content)</li>\n<li>tablecell(string content, object flags)</li>\n<li>strong(string text)</li>\n<li>em(string text)</li>\n<li>codespan(string code)</li>\n<li>br()</li>\n<li>del(string text)</li>\n<li>link(string href, string title, string text)</li>\n<li>image(string href, string title, string text)</li>\n</ul>\n<p>所有的这些方法，都可以在 renderer 实例上面覆盖掉。marked 在解析到 markdown 标记的时候，都会去调用相应的钩子方法，而钩子方法的返回结果，就会是该标记最终的解析结果。这样一来，就生成了自定义的解析结果。</p>\n<p>marked 还有一个重要的配置：highlight，可以对代码块进行解析，配合相应的 css ，达到语法高亮效果。</p>\n<p>以上就是 marked 最基本最核心的用法了。</p>\n<p>其实本文的重点是记录在使用过程中遇到的一些坑，下面进入重点。</p>\n<h1 id=\"markdown-缩进问题\"><a href=\"#markdown-缩进问题\" class=\"headerlink\" title=\"markdown 缩进问题\"></a>markdown 缩进问题</h1><p>在 markdown 的语法中，标题下面（换行之后）标记是不能缩进的，而列表项下面的标记是可以缩进的。</p>\n<p>现在前端开发，经常会使用一些模板引擎，比如 <a href=\"https://github.com/ecomfe/etpl\">ETPL</a> ，这些模板，一般都会提供过滤器的功能。以 ETPL 为例，可以在 js 代码中这样添加一个过滤器：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>此时在对应的模板中，就可以使用该过滤器了：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\">    ### 标题</div><div class=\"line\"></div><div class=\"line\">    内容</div><div class=\"line\">    <span class=\"comment\">&lt;!-- /filter --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>此时，解析出来的样子会让人瞠目结舌：过滤器里面的 markdown 标记根本不会被解析掉，整个 markdown 标记块会被当成代码块。</p>\n<p>为什么会这样呢？</p>\n<p>如果打印一下 markdown 过滤器处理函数中的 source 参数：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(source);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<p>可以发现，打印出来的内容会是这个样子：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&quot;</div><div class=\"line\">    ### 标题</div><div class=\"line\"></div><div class=\"line\">    内容</div><div class=\"line\">    &quot;</div></pre></td></tr></table></figure>\n<p>第一行没啥内容，第二行并没有顶行，而是有缩进的，然后最后一行没实际内容，只有一个缩进。</p>\n<p>这明显跟 markdown 语法有冲突，必须要进行如下处理：</p>\n<ul>\n<li>1、第一行和最后一行没啥实际内容，可以去掉；</li>\n<li>2、检测第一行前面的缩进空格数（这里假定缩进用的是空格），记录下来，假设为 <code>n</code> ；</li>\n<li>3、将每一行前面的 <code>n</code> 个空格去掉。</li>\n</ul>\n<p>具体的代码实现如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> etpl = <span class=\"built_in\">require</span>(<span class=\"string\">'etpl'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> marked = <span class=\"built_in\">require</span>(<span class=\"string\">'marked'</span>);</div><div class=\"line\">etpl.addFilter(<span class=\"string\">'markdown'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">source, useExtra</span>) </span>&#123;</div><div class=\"line\">    source = source.replace(<span class=\"regexp\">/(^\\n+|\\n+$)/g</span>, <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">var</span> uselessSpaceCount = source.match(<span class=\"regexp\">/^\\s*/</span>)[<span class=\"number\">0</span>].length;</div><div class=\"line\">    source = source.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'^ &#123;'</span> + uselessSpaceCount + <span class=\"string\">'&#125;'</span>, <span class=\"string\">'gm'</span>), <span class=\"string\">''</span>);</div><div class=\"line\">    <span class=\"keyword\">return</span> marked(source);</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h1 id=\"HTML-标签\"><a href=\"#HTML-标签\" class=\"headerlink\" title=\"HTML 标签\"></a>HTML 标签</h1><p>有的时候，可能想给 markdown 标记的某一块加上背景色，比如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"background-red\"</span>&gt;</span></div><div class=\"line\">### 标题</div><div class=\"line\"></div><div class=\"line\">内容</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"comment\">&lt;!-- /filter --&gt;</span></div></pre></td></tr></table></figure>\n<p>这样写又会崩溃了， div 内部的 markdown 标记并不会被解析！</p>\n<p>解决方法就是把 div 放过滤器外边吧：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"background-red\"</span>&gt;</span></div><div class=\"line\"><span class=\"comment\">&lt;!-- filter: markdown() --&gt;</span></div><div class=\"line\">### 标题</div><div class=\"line\"></div><div class=\"line\">内容</div><div class=\"line\"><span class=\"comment\">&lt;!-- /filter --&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>"},{"title":"受保护的对象","date":"2016-06-19T08:27:44.000Z","_content":"\n虽然 JavaScript 没有多线程变量共享的问题，但是在一些场景中，我们还是希望能对某些对象进行适当的保护（锁定），防止发生一些不可预期的错误。\n\n本文主要从如下两个实际场景展开：\n\n- 任务执行器；\n- 事件基类。\n\n<!-- more -->\n\n# 任务执行器\n\n现在，我们需要一个 DOM 操作的任务执行器，这个任务执行器满足的主要功能有：\n\n- 能够添加任务；\n- 能够批量执行任务；\n- 能够随时启动和停止任务的执行。\n\n为啥需要这么个东西呢？假设其中有下面三步 DOM 操作：\n\n- 设置节点 a 的文本： `a.innerText = 'text1'` ；\n- 设置节点 a 的文本： `a.innerText = 'text2'` ；\n- 设置节点 a 的文本： `a.innerText = 'text3'` 。\n\n如果老老实实设置三次，感觉太不划算了！实际上只需要设置最后一次就好了，这样就可以减少两次无谓的 DOM 操作了。\n\n初步看起来，我们的任务执行器代码大致会像这个样子：\n\n```javascript\nconst TASKS = Symbol('tasks');\nconst COUNTER = Symbol('counter');\nconst EXECUTE = Symbol('execute');\nconst IS_RUNNING = Symbol('isRunning');\n\nexport default class DomUpdater {\n    constructor() {\n        this[TASKS] = {};\n        this[COUNTER] = 0;\n    }\n\n    /**\n     * 获取任务ID，每一种类型操作对应一个任务ID，\n     * 比如对某个节点的innerText就可以算是一种类型的操作，具有唯一的任务ID\n     *\n     * @public\n     * @return {string} 任务ID\n     */\n    getTaskId() {\n        return '' + ++this[COUNTER];\n    }\n\n    /**\n     * 添加任务函数\n     *\n     * @public\n     * @param {Function} taskFn   任务函数\n     * @param {Function} notifyFn 任务执行完成之后的回调函数\n     */\n    add(taskId, taskFn, notifyFn) {\n        const task = this[TASKS][taskId] || {};\n\n        task.taskFn = taskFn;\n\n        // 为啥notifyFns会是一个数组，而taskFn不是数组呢？\n        // 因为我们期望后续同类型的（taskId相同）的任务能够覆盖掉之前的任务，\n        // 而之前任务的回调函数需要保留，这样就可以保证一定会通知外界某个任务已经执行完成了。\n        task.notifyFns = task.notifyFns || [];\n        task.notifyFns.push(notifyFn);\n\n        this[TASKS][taskId] = task;\n\n        this[EXECUTE]();\n    }\n\n    /**\n     * 启动任务执行\n     *\n     * @public\n     */\n    start() {\n        this[IS_RUNNING] = true;\n        this[EXECUTE]();\n    }\n\n    stop() {\n        this[IS_RUNNING] = false;\n    }\n\n    /**\n     * 执行任务\n     *\n     * @private\n     */\n    [EXECUTE]() {\n        if (!this[IS_RUNNING]) {\n            return;\n        }\n\n        window.requestAnimationFrame(() => {\n            for (let taskId in this[TASKS]) {\n                const task = this[TASKS][taskId];\n                if (!task) {\n                    continue;\n                }\n\n                let result;\n                let error;\n                try {\n                    result = task.taskFn();\n                }\n                catch (err) {\n                    error = err;\n                }\n\n                for (let i = 0, il = task.notifyFns.length; i < il; ++i) {\n                    task.notifyFns[i](error, result);\n                }\n\n                this[TASKS][taskId] = null;\n            }\n        });\n    }\n\n    destroy() {\n        this[TASKS] = null;\n    }\n}\n```\n\n好了，看起来似乎可以了，那就到实际环境遛遛吧！\n\n不遛不知道，一遛吓一跳，跳出来一些莫名其妙的问题：\n\n- 代码的第90行报`this[TASKS]`不存在；\n- 总是会有任务的回调函数没有被调用。\n\n仔细分析一下代码，可以发现：\n\n- 对于第一个问题，在执行传入 `requestAnimationFrame` 的回调函数的时候，某个 taskFn 或者 notifyFn 可能会调用 `destroy()` 方法，从而将 `this[TASKS]` 设为了 false ，然后再执行到90行，就报错了。\n- 对于第二个问题，假设有两个同类型的任务，在 'EXECUTE' 中调用第一个任务的 `notifyFn` 的时候，添加进第二个任务（调用了 add() 方法），然后执行到90行，将该类型任务置为 null ，这样一来，第二个任务的回调函数就没有机会执行了。\n\n所以，问题的根源就在任务执行过程中调用了不可控的外部函数，从而导致 `this[TASKS]` 发生变化。\n\n对于第一个类型的问题，可以简单地使用 IS_RUNNING 状态绕开。对于第二种类型的问题，就最好找一种更优雅通用的解决方案了。\n\n我们注意到，传入 `requestAnimationFrame` 的回调函数体（行范围：[72-90]）是一个敏感地带，执行这块代码的时候，应该将 `this[TASKS]` 锁定，防止不可控的外部函数（ taskFn 和 notifyFn ）对其进行干扰。\n\n其实简单说起来，这类问题就是 `for in` 循环中，被遍历的对象应该是`可读的`的一个变体，所以，可以抽离出来一个比较通用的类，具体实现代码请移步到[这里](https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js)。\n\n现在，我们的`DOM 操作任务执行器`看起来就像[这样了](https://github.com/elegant-view/vtpl/blob/master/src/DomUpdater.js)。\n\n目前看来，这个 `DomUpdater` 还有些小地方需要优化：\n\n- TASKS 任务遍历顺序不应该依赖于对象上键的遍历顺序。\n- TASKS 对象的键并没有销毁，所以每次任务执行的时候，遍历次数都会只增不减。\n\n# 事件基类\n\n在搭建前端框架的时候，一般都会期望各个功能模块能够解耦合。通常情况下，会使用事件来达到这个效果。\n\n第一次写这个类的话，很有可能就写成了这样：\n\n```javascript\nimport {isFunction} from './util';\n\nconst EVENTS = Symbol('events');\nconst STATE = Symbol('state');\nconst STATE_READY = Symbol('stateReady');\nconst STATE_DESTROIED = Symbol('stateDestroied');\nconst CHECK_READY = Symbol('checkReady');\n\nexport default class Event {\n    constructor() {\n        this[EVENTS] = {};\n        this[STATE] = STATE_READY;\n    }\n\n    /**\n     * 在调用on、trigger、safeTrigger、asyncTrigger、off的时候，要检查一下当前event对象的状态。\n     *\n     * @private\n     */\n    [CHECK_READY]() {\n        if (this[STATE] !== STATE_READY) {\n            throw new Error('wrong event state: the event object is not ready.');\n        }\n    }\n\n    /**\n     * 绑定事件\n     *\n     * @public\n     * @param  {string}   eventName 事件名字\n     * @param  {Function} fn        回调函数\n     * @param  {Object=}   context   上下文对象\n     */\n    on(eventName, fn, context) {\n        this[CHECK_READY]();\n\n        if (!isFunction(fn)) {\n            return;\n        }\n\n        let events = this[EVENTS];\n        events[eventName] = events[eventName] || [];\n        events[eventName].push({fn, context});\n    }\n\n    /**\n     * 同步触发事件\n     *\n     * @public\n     * @param  {string}    eventName 事件名字\n     * @param  {...[*]} args      要传给事件回调函数的参数列表\n     */\n    trigger(eventName, ...args) {\n        this[CHECK_READY]();\n\n        let fnObjs = this[EVENTS][eventName];\n        for (let fnObj of fnObjs) {\n            fnObj.context::fnObj.fn(...args);\n        }\n    }\n\n    /**\n     * 移除事件回调\n     *\n     * @public\n     * @param  {...[*]} args eventName，fn，context\n     * @param  {string=} args.0 参数名字\n     * @param  {function=} args.1 回调函数\n     * @param  {Object=} args.2 上下文对象\n     */\n    off(...args) {\n        this[CHECK_READY]();\n\n        let [eventName, fn, context] = args;\n        if (args.length === 0) {\n            this[EVENTS] = {};\n        }\n\n        let iterator = checkFn => {\n            let fnObjs = this[EVENTS][eventName];\n            let newFnObjs = [];\n            for (let fnObj of fnObjs) {\n                if (checkFn(fnObj)) {\n                    newFnObjs.push(fnObj);\n                }\n            }\n            this[EVENTS][eventName] = newFnObjs;\n        };\n\n        if (args.length === 1) {\n            this[EVENTS][eventName] = null;\n        }\n        else if (args.length === 2) {\n            iterator(fnObj => fn !== fnObj.fn);\n        }\n        else if (args.length === 3) {\n            iterator(fnObj => fn !== fnObj.fn || context !== fnObj.context);\n        }\n    }\n\n    destroy() {\n        this[EVENTS] = null;\n        this[STATE] = STATE_DESTROIED;\n    }\n}\n```\n\n在 `trigger()` 循环事件处理器的时候，事件回调函数很可能会通过 `on()` 间接修改 `this[EVENTS]` ，因此，我们需要使用 [ProtectObject](https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js) 来对 `this[EVENTS]` 进行锁定。\n\n# 总结\n\n本质上，这类问题就是传入的函数中做了不希望做的事情，所以如何禁止或者兼容这些`不希望做的事情`是关键点。\n\n本文为作者在实践中总结出来的方案，能力有限，期待读者提出更好的方案。\n","source":"_posts/受保护的对象.md","raw":"---\ntitle: 受保护的对象\ndate: 2016-06-19 16:27:44\ntags:\n- JavaScript\n---\n\n虽然 JavaScript 没有多线程变量共享的问题，但是在一些场景中，我们还是希望能对某些对象进行适当的保护（锁定），防止发生一些不可预期的错误。\n\n本文主要从如下两个实际场景展开：\n\n- 任务执行器；\n- 事件基类。\n\n<!-- more -->\n\n# 任务执行器\n\n现在，我们需要一个 DOM 操作的任务执行器，这个任务执行器满足的主要功能有：\n\n- 能够添加任务；\n- 能够批量执行任务；\n- 能够随时启动和停止任务的执行。\n\n为啥需要这么个东西呢？假设其中有下面三步 DOM 操作：\n\n- 设置节点 a 的文本： `a.innerText = 'text1'` ；\n- 设置节点 a 的文本： `a.innerText = 'text2'` ；\n- 设置节点 a 的文本： `a.innerText = 'text3'` 。\n\n如果老老实实设置三次，感觉太不划算了！实际上只需要设置最后一次就好了，这样就可以减少两次无谓的 DOM 操作了。\n\n初步看起来，我们的任务执行器代码大致会像这个样子：\n\n```javascript\nconst TASKS = Symbol('tasks');\nconst COUNTER = Symbol('counter');\nconst EXECUTE = Symbol('execute');\nconst IS_RUNNING = Symbol('isRunning');\n\nexport default class DomUpdater {\n    constructor() {\n        this[TASKS] = {};\n        this[COUNTER] = 0;\n    }\n\n    /**\n     * 获取任务ID，每一种类型操作对应一个任务ID，\n     * 比如对某个节点的innerText就可以算是一种类型的操作，具有唯一的任务ID\n     *\n     * @public\n     * @return {string} 任务ID\n     */\n    getTaskId() {\n        return '' + ++this[COUNTER];\n    }\n\n    /**\n     * 添加任务函数\n     *\n     * @public\n     * @param {Function} taskFn   任务函数\n     * @param {Function} notifyFn 任务执行完成之后的回调函数\n     */\n    add(taskId, taskFn, notifyFn) {\n        const task = this[TASKS][taskId] || {};\n\n        task.taskFn = taskFn;\n\n        // 为啥notifyFns会是一个数组，而taskFn不是数组呢？\n        // 因为我们期望后续同类型的（taskId相同）的任务能够覆盖掉之前的任务，\n        // 而之前任务的回调函数需要保留，这样就可以保证一定会通知外界某个任务已经执行完成了。\n        task.notifyFns = task.notifyFns || [];\n        task.notifyFns.push(notifyFn);\n\n        this[TASKS][taskId] = task;\n\n        this[EXECUTE]();\n    }\n\n    /**\n     * 启动任务执行\n     *\n     * @public\n     */\n    start() {\n        this[IS_RUNNING] = true;\n        this[EXECUTE]();\n    }\n\n    stop() {\n        this[IS_RUNNING] = false;\n    }\n\n    /**\n     * 执行任务\n     *\n     * @private\n     */\n    [EXECUTE]() {\n        if (!this[IS_RUNNING]) {\n            return;\n        }\n\n        window.requestAnimationFrame(() => {\n            for (let taskId in this[TASKS]) {\n                const task = this[TASKS][taskId];\n                if (!task) {\n                    continue;\n                }\n\n                let result;\n                let error;\n                try {\n                    result = task.taskFn();\n                }\n                catch (err) {\n                    error = err;\n                }\n\n                for (let i = 0, il = task.notifyFns.length; i < il; ++i) {\n                    task.notifyFns[i](error, result);\n                }\n\n                this[TASKS][taskId] = null;\n            }\n        });\n    }\n\n    destroy() {\n        this[TASKS] = null;\n    }\n}\n```\n\n好了，看起来似乎可以了，那就到实际环境遛遛吧！\n\n不遛不知道，一遛吓一跳，跳出来一些莫名其妙的问题：\n\n- 代码的第90行报`this[TASKS]`不存在；\n- 总是会有任务的回调函数没有被调用。\n\n仔细分析一下代码，可以发现：\n\n- 对于第一个问题，在执行传入 `requestAnimationFrame` 的回调函数的时候，某个 taskFn 或者 notifyFn 可能会调用 `destroy()` 方法，从而将 `this[TASKS]` 设为了 false ，然后再执行到90行，就报错了。\n- 对于第二个问题，假设有两个同类型的任务，在 'EXECUTE' 中调用第一个任务的 `notifyFn` 的时候，添加进第二个任务（调用了 add() 方法），然后执行到90行，将该类型任务置为 null ，这样一来，第二个任务的回调函数就没有机会执行了。\n\n所以，问题的根源就在任务执行过程中调用了不可控的外部函数，从而导致 `this[TASKS]` 发生变化。\n\n对于第一个类型的问题，可以简单地使用 IS_RUNNING 状态绕开。对于第二种类型的问题，就最好找一种更优雅通用的解决方案了。\n\n我们注意到，传入 `requestAnimationFrame` 的回调函数体（行范围：[72-90]）是一个敏感地带，执行这块代码的时候，应该将 `this[TASKS]` 锁定，防止不可控的外部函数（ taskFn 和 notifyFn ）对其进行干扰。\n\n其实简单说起来，这类问题就是 `for in` 循环中，被遍历的对象应该是`可读的`的一个变体，所以，可以抽离出来一个比较通用的类，具体实现代码请移步到[这里](https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js)。\n\n现在，我们的`DOM 操作任务执行器`看起来就像[这样了](https://github.com/elegant-view/vtpl/blob/master/src/DomUpdater.js)。\n\n目前看来，这个 `DomUpdater` 还有些小地方需要优化：\n\n- TASKS 任务遍历顺序不应该依赖于对象上键的遍历顺序。\n- TASKS 对象的键并没有销毁，所以每次任务执行的时候，遍历次数都会只增不减。\n\n# 事件基类\n\n在搭建前端框架的时候，一般都会期望各个功能模块能够解耦合。通常情况下，会使用事件来达到这个效果。\n\n第一次写这个类的话，很有可能就写成了这样：\n\n```javascript\nimport {isFunction} from './util';\n\nconst EVENTS = Symbol('events');\nconst STATE = Symbol('state');\nconst STATE_READY = Symbol('stateReady');\nconst STATE_DESTROIED = Symbol('stateDestroied');\nconst CHECK_READY = Symbol('checkReady');\n\nexport default class Event {\n    constructor() {\n        this[EVENTS] = {};\n        this[STATE] = STATE_READY;\n    }\n\n    /**\n     * 在调用on、trigger、safeTrigger、asyncTrigger、off的时候，要检查一下当前event对象的状态。\n     *\n     * @private\n     */\n    [CHECK_READY]() {\n        if (this[STATE] !== STATE_READY) {\n            throw new Error('wrong event state: the event object is not ready.');\n        }\n    }\n\n    /**\n     * 绑定事件\n     *\n     * @public\n     * @param  {string}   eventName 事件名字\n     * @param  {Function} fn        回调函数\n     * @param  {Object=}   context   上下文对象\n     */\n    on(eventName, fn, context) {\n        this[CHECK_READY]();\n\n        if (!isFunction(fn)) {\n            return;\n        }\n\n        let events = this[EVENTS];\n        events[eventName] = events[eventName] || [];\n        events[eventName].push({fn, context});\n    }\n\n    /**\n     * 同步触发事件\n     *\n     * @public\n     * @param  {string}    eventName 事件名字\n     * @param  {...[*]} args      要传给事件回调函数的参数列表\n     */\n    trigger(eventName, ...args) {\n        this[CHECK_READY]();\n\n        let fnObjs = this[EVENTS][eventName];\n        for (let fnObj of fnObjs) {\n            fnObj.context::fnObj.fn(...args);\n        }\n    }\n\n    /**\n     * 移除事件回调\n     *\n     * @public\n     * @param  {...[*]} args eventName，fn，context\n     * @param  {string=} args.0 参数名字\n     * @param  {function=} args.1 回调函数\n     * @param  {Object=} args.2 上下文对象\n     */\n    off(...args) {\n        this[CHECK_READY]();\n\n        let [eventName, fn, context] = args;\n        if (args.length === 0) {\n            this[EVENTS] = {};\n        }\n\n        let iterator = checkFn => {\n            let fnObjs = this[EVENTS][eventName];\n            let newFnObjs = [];\n            for (let fnObj of fnObjs) {\n                if (checkFn(fnObj)) {\n                    newFnObjs.push(fnObj);\n                }\n            }\n            this[EVENTS][eventName] = newFnObjs;\n        };\n\n        if (args.length === 1) {\n            this[EVENTS][eventName] = null;\n        }\n        else if (args.length === 2) {\n            iterator(fnObj => fn !== fnObj.fn);\n        }\n        else if (args.length === 3) {\n            iterator(fnObj => fn !== fnObj.fn || context !== fnObj.context);\n        }\n    }\n\n    destroy() {\n        this[EVENTS] = null;\n        this[STATE] = STATE_DESTROIED;\n    }\n}\n```\n\n在 `trigger()` 循环事件处理器的时候，事件回调函数很可能会通过 `on()` 间接修改 `this[EVENTS]` ，因此，我们需要使用 [ProtectObject](https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js) 来对 `this[EVENTS]` 进行锁定。\n\n# 总结\n\n本质上，这类问题就是传入的函数中做了不希望做的事情，所以如何禁止或者兼容这些`不希望做的事情`是关键点。\n\n本文为作者在实践中总结出来的方案，能力有限，期待读者提出更好的方案。\n","slug":"受保护的对象","published":1,"updated":"2016-07-01T03:56:57.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy02y001b04078dbh3uzq","content":"<p>虽然 JavaScript 没有多线程变量共享的问题，但是在一些场景中，我们还是希望能对某些对象进行适当的保护（锁定），防止发生一些不可预期的错误。</p>\n<p>本文主要从如下两个实际场景展开：</p>\n<ul>\n<li>任务执行器；</li>\n<li>事件基类。</li>\n</ul>\n<a id=\"more\"></a>\n<h1 id=\"任务执行器\"><a href=\"#任务执行器\" class=\"headerlink\" title=\"任务执行器\"></a>任务执行器</h1><p>现在，我们需要一个 DOM 操作的任务执行器，这个任务执行器满足的主要功能有：</p>\n<ul>\n<li>能够添加任务；</li>\n<li>能够批量执行任务；</li>\n<li>能够随时启动和停止任务的执行。</li>\n</ul>\n<p>为啥需要这么个东西呢？假设其中有下面三步 DOM 操作：</p>\n<ul>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text1&#39;</code> ；</li>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text2&#39;</code> ；</li>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text3&#39;</code> 。</li>\n</ul>\n<p>如果老老实实设置三次，感觉太不划算了！实际上只需要设置最后一次就好了，这样就可以减少两次无谓的 DOM 操作了。</p>\n<p>初步看起来，我们的任务执行器代码大致会像这个样子：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> TASKS = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'tasks'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> COUNTER = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'counter'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> EXECUTE = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'execute'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> IS_RUNNING = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'isRunning'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DomUpdater</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS] = &#123;&#125;;</div><div class=\"line\">        <span class=\"keyword\">this</span>[COUNTER] = <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 获取任务ID，每一种类型操作对应一个任务ID，</div><div class=\"line\">     * 比如对某个节点的innerText就可以算是一种类型的操作，具有唯一的任务ID</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @return &#123;string&#125; 任务ID</div><div class=\"line\">     */</div><div class=\"line\">    getTaskId() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">''</span> + ++<span class=\"keyword\">this</span>[COUNTER];</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 添加任务函数</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param &#123;Function&#125; taskFn   任务函数</div><div class=\"line\">     * @param &#123;Function&#125; notifyFn 任务执行完成之后的回调函数</div><div class=\"line\">     */</div><div class=\"line\">    add(taskId, taskFn, notifyFn) &#123;</div><div class=\"line\">        <span class=\"keyword\">const</span> task = <span class=\"keyword\">this</span>[TASKS][taskId] || &#123;&#125;;</div><div class=\"line\"></div><div class=\"line\">        task.taskFn = taskFn;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 为啥notifyFns会是一个数组，而taskFn不是数组呢？</span></div><div class=\"line\">        <span class=\"comment\">// 因为我们期望后续同类型的（taskId相同）的任务能够覆盖掉之前的任务，</span></div><div class=\"line\">        <span class=\"comment\">// 而之前任务的回调函数需要保留，这样就可以保证一定会通知外界某个任务已经执行完成了。</span></div><div class=\"line\">        task.notifyFns = task.notifyFns || [];</div><div class=\"line\">        task.notifyFns.push(notifyFn);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS][taskId] = task;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>[EXECUTE]();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 启动任务执行</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     */</div><div class=\"line\">    start() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[IS_RUNNING] = <span class=\"literal\">true</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EXECUTE]();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    stop() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[IS_RUNNING] = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 执行任务</div><div class=\"line\">     *</div><div class=\"line\">     * @private</div><div class=\"line\">     */</div><div class=\"line\">    [EXECUTE]() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>[IS_RUNNING]) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"built_in\">window</span>.requestAnimationFrame(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> taskId <span class=\"keyword\">in</span> <span class=\"keyword\">this</span>[TASKS]) &#123;</div><div class=\"line\">                <span class=\"keyword\">const</span> task = <span class=\"keyword\">this</span>[TASKS][taskId];</div><div class=\"line\">                <span class=\"keyword\">if</span> (!task) &#123;</div><div class=\"line\">                    <span class=\"keyword\">continue</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">let</span> result;</div><div class=\"line\">                <span class=\"keyword\">let</span> error;</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    result = task.taskFn();</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">catch</span> (err) &#123;</div><div class=\"line\">                    error = err;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>, il = task.notifyFns.length; i &lt; il; ++i) &#123;</div><div class=\"line\">                    task.notifyFns[i](error, result);</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">this</span>[TASKS][taskId] = <span class=\"literal\">null</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    destroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS] = <span class=\"literal\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>好了，看起来似乎可以了，那就到实际环境遛遛吧！</p>\n<p>不遛不知道，一遛吓一跳，跳出来一些莫名其妙的问题：</p>\n<ul>\n<li>代码的第90行报<code>this[TASKS]</code>不存在；</li>\n<li>总是会有任务的回调函数没有被调用。</li>\n</ul>\n<p>仔细分析一下代码，可以发现：</p>\n<ul>\n<li>对于第一个问题，在执行传入 <code>requestAnimationFrame</code> 的回调函数的时候，某个 taskFn 或者 notifyFn 可能会调用 <code>destroy()</code> 方法，从而将 <code>this[TASKS]</code> 设为了 false ，然后再执行到90行，就报错了。</li>\n<li>对于第二个问题，假设有两个同类型的任务，在 ‘EXECUTE’ 中调用第一个任务的 <code>notifyFn</code> 的时候，添加进第二个任务（调用了 add() 方法），然后执行到90行，将该类型任务置为 null ，这样一来，第二个任务的回调函数就没有机会执行了。</li>\n</ul>\n<p>所以，问题的根源就在任务执行过程中调用了不可控的外部函数，从而导致 <code>this[TASKS]</code> 发生变化。</p>\n<p>对于第一个类型的问题，可以简单地使用 IS_RUNNING 状态绕开。对于第二种类型的问题，就最好找一种更优雅通用的解决方案了。</p>\n<p>我们注意到，传入 <code>requestAnimationFrame</code> 的回调函数体（行范围：[72-90]）是一个敏感地带，执行这块代码的时候，应该将 <code>this[TASKS]</code> 锁定，防止不可控的外部函数（ taskFn 和 notifyFn ）对其进行干扰。</p>\n<p>其实简单说起来，这类问题就是 <code>for in</code> 循环中，被遍历的对象应该是<code>可读的</code>的一个变体，所以，可以抽离出来一个比较通用的类，具体实现代码请移步到<a href=\"https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js\" target=\"_blank\" rel=\"external\">这里</a>。</p>\n<p>现在，我们的<code>DOM 操作任务执行器</code>看起来就像<a href=\"https://github.com/elegant-view/vtpl/blob/master/src/DomUpdater.js\" target=\"_blank\" rel=\"external\">这样了</a>。</p>\n<p>目前看来，这个 <code>DomUpdater</code> 还有些小地方需要优化：</p>\n<ul>\n<li>TASKS 任务遍历顺序不应该依赖于对象上键的遍历顺序。</li>\n<li>TASKS 对象的键并没有销毁，所以每次任务执行的时候，遍历次数都会只增不减。</li>\n</ul>\n<h1 id=\"事件基类\"><a href=\"#事件基类\" class=\"headerlink\" title=\"事件基类\"></a>事件基类</h1><p>在搭建前端框架的时候，一般都会期望各个功能模块能够解耦合。通常情况下，会使用事件来达到这个效果。</p>\n<p>第一次写这个类的话，很有可能就写成了这样：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> &#123;isFunction&#125; <span class=\"keyword\">from</span> <span class=\"string\">'./util'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">const</span> EVENTS = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'events'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'state'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE_READY = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'stateReady'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE_DESTROIED = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'stateDestroied'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> CHECK_READY = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'checkReady'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Event</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EVENTS] = &#123;&#125;;</div><div class=\"line\">        <span class=\"keyword\">this</span>[STATE] = STATE_READY;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 在调用on、trigger、safeTrigger、asyncTrigger、off的时候，要检查一下当前event对象的状态。</div><div class=\"line\">     *</div><div class=\"line\">     * @private</div><div class=\"line\">     */</div><div class=\"line\">    [CHECK_READY]() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>[STATE] !== STATE_READY) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'wrong event state: the event object is not ready.'</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 绑定事件</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;string&#125;   eventName 事件名字</div><div class=\"line\">     * @param  &#123;Function&#125; fn        回调函数</div><div class=\"line\">     * @param  &#123;Object=&#125;   context   上下文对象</div><div class=\"line\">     */</div><div class=\"line\">    on(eventName, fn, context) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (!isFunction(fn)) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> events = <span class=\"keyword\">this</span>[EVENTS];</div><div class=\"line\">        events[eventName] = events[eventName] || [];</div><div class=\"line\">        events[eventName].push(&#123;fn, context&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 同步触发事件</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;string&#125;    eventName 事件名字</div><div class=\"line\">     * @param  &#123;...[*]&#125; args      要传给事件回调函数的参数列表</div><div class=\"line\">     */</div><div class=\"line\">    trigger(eventName, ...args) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> fnObjs = <span class=\"keyword\">this</span>[EVENTS][eventName];</div><div class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> fnObj <span class=\"keyword\">of</span> fnObjs) &#123;</div><div class=\"line\">            fnObj.context::fnObj.fn(...args);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</span></div><div class=\"line\">     * 移除事件回调</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;...[*]&#125; args eventName，fn，context</div><div class=\"line\">     * @param  &#123;string=&#125; args.0 参数名字</div><div class=\"line\">     * @param  &#123;function=&#125; args.1 回调函数</div><div class=\"line\">     * @param  &#123;Object=&#125; args.2 上下文对象</div><div class=\"line\">     */</div><div class=\"line\">    off(...args) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> [eventName, fn, context] = args;</div><div class=\"line\">        <span class=\"keyword\">if</span> (args.length === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS] = &#123;&#125;;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> iterator = <span class=\"function\"><span class=\"params\">checkFn</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">let</span> fnObjs = <span class=\"keyword\">this</span>[EVENTS][eventName];</div><div class=\"line\">            <span class=\"keyword\">let</span> newFnObjs = [];</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> fnObj <span class=\"keyword\">of</span> fnObjs) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (checkFn(fnObj)) &#123;</div><div class=\"line\">                    newFnObjs.push(fnObj);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS][eventName] = newFnObjs;</div><div class=\"line\">        &#125;;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (args.length === <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS][eventName] = <span class=\"literal\">null</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (args.length === <span class=\"number\">2</span>) &#123;</div><div class=\"line\">            iterator(<span class=\"function\"><span class=\"params\">fnObj</span> =&gt;</span> fn !== fnObj.fn);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (args.length === <span class=\"number\">3</span>) &#123;</div><div class=\"line\">            iterator(<span class=\"function\"><span class=\"params\">fnObj</span> =&gt;</span> fn !== fnObj.fn || context !== fnObj.context);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    destroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EVENTS] = <span class=\"literal\">null</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>[STATE] = STATE_DESTROIED;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 <code>trigger()</code> 循环事件处理器的时候，事件回调函数很可能会通过 <code>on()</code> 间接修改 <code>this[EVENTS]</code> ，因此，我们需要使用 <a href=\"https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js\" target=\"_blank\" rel=\"external\">ProtectObject</a> 来对 <code>this[EVENTS]</code> 进行锁定。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>本质上，这类问题就是传入的函数中做了不希望做的事情，所以如何禁止或者兼容这些<code>不希望做的事情</code>是关键点。</p>\n<p>本文为作者在实践中总结出来的方案，能力有限，期待读者提出更好的方案。</p>\n","excerpt":"<p>虽然 JavaScript 没有多线程变量共享的问题，但是在一些场景中，我们还是希望能对某些对象进行适当的保护（锁定），防止发生一些不可预期的错误。</p>\n<p>本文主要从如下两个实际场景展开：</p>\n<ul>\n<li>任务执行器；</li>\n<li>事件基类。</li>\n</ul>","more":"<h1 id=\"任务执行器\"><a href=\"#任务执行器\" class=\"headerlink\" title=\"任务执行器\"></a>任务执行器</h1><p>现在，我们需要一个 DOM 操作的任务执行器，这个任务执行器满足的主要功能有：</p>\n<ul>\n<li>能够添加任务；</li>\n<li>能够批量执行任务；</li>\n<li>能够随时启动和停止任务的执行。</li>\n</ul>\n<p>为啥需要这么个东西呢？假设其中有下面三步 DOM 操作：</p>\n<ul>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text1&#39;</code> ；</li>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text2&#39;</code> ；</li>\n<li>设置节点 a 的文本： <code>a.innerText = &#39;text3&#39;</code> 。</li>\n</ul>\n<p>如果老老实实设置三次，感觉太不划算了！实际上只需要设置最后一次就好了，这样就可以减少两次无谓的 DOM 操作了。</p>\n<p>初步看起来，我们的任务执行器代码大致会像这个样子：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">const</span> TASKS = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'tasks'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> COUNTER = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'counter'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> EXECUTE = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'execute'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> IS_RUNNING = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'isRunning'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DomUpdater</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS] = &#123;&#125;;</div><div class=\"line\">        <span class=\"keyword\">this</span>[COUNTER] = <span class=\"number\">0</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 获取任务ID，每一种类型操作对应一个任务ID，</div><div class=\"line\">     * 比如对某个节点的innerText就可以算是一种类型的操作，具有唯一的任务ID</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @return &#123;string&#125; 任务ID</div><div class=\"line\">     */</span></div><div class=\"line\">    getTaskId() &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">''</span> + ++<span class=\"keyword\">this</span>[COUNTER];</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 添加任务函数</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param &#123;Function&#125; taskFn   任务函数</div><div class=\"line\">     * @param &#123;Function&#125; notifyFn 任务执行完成之后的回调函数</div><div class=\"line\">     */</span></div><div class=\"line\">    add(taskId, taskFn, notifyFn) &#123;</div><div class=\"line\">        <span class=\"keyword\">const</span> task = <span class=\"keyword\">this</span>[TASKS][taskId] || &#123;&#125;;</div><div class=\"line\"></div><div class=\"line\">        task.taskFn = taskFn;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 为啥notifyFns会是一个数组，而taskFn不是数组呢？</span></div><div class=\"line\">        <span class=\"comment\">// 因为我们期望后续同类型的（taskId相同）的任务能够覆盖掉之前的任务，</span></div><div class=\"line\">        <span class=\"comment\">// 而之前任务的回调函数需要保留，这样就可以保证一定会通知外界某个任务已经执行完成了。</span></div><div class=\"line\">        task.notifyFns = task.notifyFns || [];</div><div class=\"line\">        task.notifyFns.push(notifyFn);</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS][taskId] = task;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">this</span>[EXECUTE]();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 启动任务执行</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     */</span></div><div class=\"line\">    start() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[IS_RUNNING] = <span class=\"literal\">true</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EXECUTE]();</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    stop() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[IS_RUNNING] = <span class=\"literal\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 执行任务</div><div class=\"line\">     *</div><div class=\"line\">     * @private</div><div class=\"line\">     */</span></div><div class=\"line\">    [EXECUTE]() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>[IS_RUNNING]) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"built_in\">window</span>.requestAnimationFrame(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> taskId <span class=\"keyword\">in</span> <span class=\"keyword\">this</span>[TASKS]) &#123;</div><div class=\"line\">                <span class=\"keyword\">const</span> task = <span class=\"keyword\">this</span>[TASKS][taskId];</div><div class=\"line\">                <span class=\"keyword\">if</span> (!task) &#123;</div><div class=\"line\">                    <span class=\"keyword\">continue</span>;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">let</span> result;</div><div class=\"line\">                <span class=\"keyword\">let</span> error;</div><div class=\"line\">                <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">                    result = task.taskFn();</div><div class=\"line\">                &#125;</div><div class=\"line\">                <span class=\"keyword\">catch</span> (err) &#123;</div><div class=\"line\">                    error = err;</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>, il = task.notifyFns.length; i &lt; il; ++i) &#123;</div><div class=\"line\">                    task.notifyFns[i](error, result);</div><div class=\"line\">                &#125;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">this</span>[TASKS][taskId] = <span class=\"literal\">null</span>;</div><div class=\"line\">            &#125;</div><div class=\"line\">        &#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    destroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[TASKS] = <span class=\"literal\">null</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>好了，看起来似乎可以了，那就到实际环境遛遛吧！</p>\n<p>不遛不知道，一遛吓一跳，跳出来一些莫名其妙的问题：</p>\n<ul>\n<li>代码的第90行报<code>this[TASKS]</code>不存在；</li>\n<li>总是会有任务的回调函数没有被调用。</li>\n</ul>\n<p>仔细分析一下代码，可以发现：</p>\n<ul>\n<li>对于第一个问题，在执行传入 <code>requestAnimationFrame</code> 的回调函数的时候，某个 taskFn 或者 notifyFn 可能会调用 <code>destroy()</code> 方法，从而将 <code>this[TASKS]</code> 设为了 false ，然后再执行到90行，就报错了。</li>\n<li>对于第二个问题，假设有两个同类型的任务，在 ‘EXECUTE’ 中调用第一个任务的 <code>notifyFn</code> 的时候，添加进第二个任务（调用了 add() 方法），然后执行到90行，将该类型任务置为 null ，这样一来，第二个任务的回调函数就没有机会执行了。</li>\n</ul>\n<p>所以，问题的根源就在任务执行过程中调用了不可控的外部函数，从而导致 <code>this[TASKS]</code> 发生变化。</p>\n<p>对于第一个类型的问题，可以简单地使用 IS_RUNNING 状态绕开。对于第二种类型的问题，就最好找一种更优雅通用的解决方案了。</p>\n<p>我们注意到，传入 <code>requestAnimationFrame</code> 的回调函数体（行范围：[72-90]）是一个敏感地带，执行这块代码的时候，应该将 <code>this[TASKS]</code> 锁定，防止不可控的外部函数（ taskFn 和 notifyFn ）对其进行干扰。</p>\n<p>其实简单说起来，这类问题就是 <code>for in</code> 循环中，被遍历的对象应该是<code>可读的</code>的一个变体，所以，可以抽离出来一个比较通用的类，具体实现代码请移步到<a href=\"https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js\">这里</a>。</p>\n<p>现在，我们的<code>DOM 操作任务执行器</code>看起来就像<a href=\"https://github.com/elegant-view/vtpl/blob/master/src/DomUpdater.js\">这样了</a>。</p>\n<p>目前看来，这个 <code>DomUpdater</code> 还有些小地方需要优化：</p>\n<ul>\n<li>TASKS 任务遍历顺序不应该依赖于对象上键的遍历顺序。</li>\n<li>TASKS 对象的键并没有销毁，所以每次任务执行的时候，遍历次数都会只增不减。</li>\n</ul>\n<h1 id=\"事件基类\"><a href=\"#事件基类\" class=\"headerlink\" title=\"事件基类\"></a>事件基类</h1><p>在搭建前端框架的时候，一般都会期望各个功能模块能够解耦合。通常情况下，会使用事件来达到这个效果。</p>\n<p>第一次写这个类的话，很有可能就写成了这样：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> &#123;isFunction&#125; <span class=\"keyword\">from</span> <span class=\"string\">'./util'</span>;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">const</span> EVENTS = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'events'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'state'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE_READY = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'stateReady'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> STATE_DESTROIED = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'stateDestroied'</span>);</div><div class=\"line\"><span class=\"keyword\">const</span> CHECK_READY = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'checkReady'</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Event</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">constructor</span>() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EVENTS] = &#123;&#125;;</div><div class=\"line\">        <span class=\"keyword\">this</span>[STATE] = STATE_READY;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 在调用on、trigger、safeTrigger、asyncTrigger、off的时候，要检查一下当前event对象的状态。</div><div class=\"line\">     *</div><div class=\"line\">     * @private</div><div class=\"line\">     */</span></div><div class=\"line\">    [CHECK_READY]() &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>[STATE] !== STATE_READY) &#123;</div><div class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'wrong event state: the event object is not ready.'</span>);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 绑定事件</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;string&#125;   eventName 事件名字</div><div class=\"line\">     * @param  &#123;Function&#125; fn        回调函数</div><div class=\"line\">     * @param  &#123;Object=&#125;   context   上下文对象</div><div class=\"line\">     */</span></div><div class=\"line\">    on(eventName, fn, context) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (!isFunction(fn)) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> events = <span class=\"keyword\">this</span>[EVENTS];</div><div class=\"line\">        events[eventName] = events[eventName] || [];</div><div class=\"line\">        events[eventName].push(&#123;fn, context&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 同步触发事件</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;string&#125;    eventName 事件名字</div><div class=\"line\">     * @param  &#123;...[*]&#125; args      要传给事件回调函数的参数列表</div><div class=\"line\">     */</span></div><div class=\"line\">    trigger(eventName, ...args) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> fnObjs = <span class=\"keyword\">this</span>[EVENTS][eventName];</div><div class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> fnObj <span class=\"keyword\">of</span> fnObjs) &#123;</div><div class=\"line\">            fnObj.context::fnObj.fn(...args);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">/**</div><div class=\"line\">     * 移除事件回调</div><div class=\"line\">     *</div><div class=\"line\">     * @public</div><div class=\"line\">     * @param  &#123;...[*]&#125; args eventName，fn，context</div><div class=\"line\">     * @param  &#123;string=&#125; args.0 参数名字</div><div class=\"line\">     * @param  &#123;function=&#125; args.1 回调函数</div><div class=\"line\">     * @param  &#123;Object=&#125; args.2 上下文对象</div><div class=\"line\">     */</span></div><div class=\"line\">    off(...args) &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[CHECK_READY]();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> [eventName, fn, context] = args;</div><div class=\"line\">        <span class=\"keyword\">if</span> (args.length === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS] = &#123;&#125;;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">let</span> iterator = <span class=\"function\"><span class=\"params\">checkFn</span> =&gt;</span> &#123;</div><div class=\"line\">            <span class=\"keyword\">let</span> fnObjs = <span class=\"keyword\">this</span>[EVENTS][eventName];</div><div class=\"line\">            <span class=\"keyword\">let</span> newFnObjs = [];</div><div class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> fnObj <span class=\"keyword\">of</span> fnObjs) &#123;</div><div class=\"line\">                <span class=\"keyword\">if</span> (checkFn(fnObj)) &#123;</div><div class=\"line\">                    newFnObjs.push(fnObj);</div><div class=\"line\">                &#125;</div><div class=\"line\">            &#125;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS][eventName] = newFnObjs;</div><div class=\"line\">        &#125;;</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (args.length === <span class=\"number\">1</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">this</span>[EVENTS][eventName] = <span class=\"literal\">null</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (args.length === <span class=\"number\">2</span>) &#123;</div><div class=\"line\">            iterator(<span class=\"function\"><span class=\"params\">fnObj</span> =&gt;</span> fn !== fnObj.fn);</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (args.length === <span class=\"number\">3</span>) &#123;</div><div class=\"line\">            iterator(<span class=\"function\"><span class=\"params\">fnObj</span> =&gt;</span> fn !== fnObj.fn || context !== fnObj.context);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    destroy() &#123;</div><div class=\"line\">        <span class=\"keyword\">this</span>[EVENTS] = <span class=\"literal\">null</span>;</div><div class=\"line\">        <span class=\"keyword\">this</span>[STATE] = STATE_DESTROIED;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>在 <code>trigger()</code> 循环事件处理器的时候，事件回调函数很可能会通过 <code>on()</code> 间接修改 <code>this[EVENTS]</code> ，因此，我们需要使用 <a href=\"https://github.com/elegant-view/vtpl/blob/master/src/ProtectObject.js\">ProtectObject</a> 来对 <code>this[EVENTS]</code> 进行锁定。</p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>本质上，这类问题就是传入的函数中做了不希望做的事情，所以如何禁止或者兼容这些<code>不希望做的事情</code>是关键点。</p>\n<p>本文为作者在实践中总结出来的方案，能力有限，期待读者提出更好的方案。</p>"},{"title":"如何展示表单控件","date":"2016-12-15T14:34:00.000Z","_content":"\n在 Web 开发中，经常需要展示左右结构的表单。<!-- more -->如下所示：\n\n![](../images/2016-12-15/form.png)\n\n面对这张图，最先想到的实现方式就是借助浮动：\n\n{% iframe ../demos/2016-12-15/form1.html 100% 250 %}\n\n基本的结构就这样，看起来挺好的。\n\n但是有一个忧伤的地方，左侧`form-key`部分的宽度太烦人，不同的表单`form-key`部分存在宽度差异，很难统一。如果把`form-key`部分统一设置成一个比较大的值，那么在`form-key`比较短的表单里面会非常难看。这样一来，只能选择不同的表单设置不同的`form-key`的宽度值，很烦人。\n\n**如何让左侧的宽度自适应呢？**\n\n从一位前端牛人学习到如下利用`table`布局的写法：\n\n{% iframe ../demos/2016-12-15/form2.html 100% 250 %}\n\n此处`form-operations`部分有点小问题，`form-operations`是一个`table-row`，所以直接子元素应该是`table-cell`，改一改就好了。\n\n同时也因为这个手误，发现在 IE9 中，鼠标 hover 到`table-row`上面去之后，会触发下面第一个`button`的 hover 效果。\n","source":"_posts/如何展示表单控件.md","raw":"---\ntitle: 如何展示表单控件\ndate: 2016-12-15 22:34\n---\n\n在 Web 开发中，经常需要展示左右结构的表单。<!-- more -->如下所示：\n\n![](../images/2016-12-15/form.png)\n\n面对这张图，最先想到的实现方式就是借助浮动：\n\n{% iframe ../demos/2016-12-15/form1.html 100% 250 %}\n\n基本的结构就这样，看起来挺好的。\n\n但是有一个忧伤的地方，左侧`form-key`部分的宽度太烦人，不同的表单`form-key`部分存在宽度差异，很难统一。如果把`form-key`部分统一设置成一个比较大的值，那么在`form-key`比较短的表单里面会非常难看。这样一来，只能选择不同的表单设置不同的`form-key`的宽度值，很烦人。\n\n**如何让左侧的宽度自适应呢？**\n\n从一位前端牛人学习到如下利用`table`布局的写法：\n\n{% iframe ../demos/2016-12-15/form2.html 100% 250 %}\n\n此处`form-operations`部分有点小问题，`form-operations`是一个`table-row`，所以直接子元素应该是`table-cell`，改一改就好了。\n\n同时也因为这个手误，发现在 IE9 中，鼠标 hover 到`table-row`上面去之后，会触发下面第一个`button`的 hover 效果。\n","slug":"如何展示表单控件","published":1,"updated":"2016-12-15T15:28:42.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy030001d0407l0uj3vy3","content":"<p>在 Web 开发中，经常需要展示左右结构的表单。<a id=\"more\"></a>如下所示：</p>\n<p><img src=\"../images/2016-12-15/form.png\" alt=\"\"></p>\n<p>面对这张图，最先想到的实现方式就是借助浮动：</p>\n<iframe src=\"../demos/2016-12-15/form1.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<p>基本的结构就这样，看起来挺好的。</p>\n<p>但是有一个忧伤的地方，左侧<code>form-key</code>部分的宽度太烦人，不同的表单<code>form-key</code>部分存在宽度差异，很难统一。如果把<code>form-key</code>部分统一设置成一个比较大的值，那么在<code>form-key</code>比较短的表单里面会非常难看。这样一来，只能选择不同的表单设置不同的<code>form-key</code>的宽度值，很烦人。</p>\n<p><strong>如何让左侧的宽度自适应呢？</strong></p>\n<p>从一位前端牛人学习到如下利用<code>table</code>布局的写法：</p>\n<iframe src=\"../demos/2016-12-15/form2.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<p>此处<code>form-operations</code>部分有点小问题，<code>form-operations</code>是一个<code>table-row</code>，所以直接子元素应该是<code>table-cell</code>，改一改就好了。</p>\n<p>同时也因为这个手误，发现在 IE9 中，鼠标 hover 到<code>table-row</code>上面去之后，会触发下面第一个<code>button</code>的 hover 效果。</p>\n","excerpt":"<p>在 Web 开发中，经常需要展示左右结构的表单。","more":"如下所示：</p>\n<p><img src=\"../images/2016-12-15/form.png\" alt=\"\"></p>\n<p>面对这张图，最先想到的实现方式就是借助浮动：</p>\n<iframe src=\"../demos/2016-12-15/form1.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<p>基本的结构就这样，看起来挺好的。</p>\n<p>但是有一个忧伤的地方，左侧<code>form-key</code>部分的宽度太烦人，不同的表单<code>form-key</code>部分存在宽度差异，很难统一。如果把<code>form-key</code>部分统一设置成一个比较大的值，那么在<code>form-key</code>比较短的表单里面会非常难看。这样一来，只能选择不同的表单设置不同的<code>form-key</code>的宽度值，很烦人。</p>\n<p><strong>如何让左侧的宽度自适应呢？</strong></p>\n<p>从一位前端牛人学习到如下利用<code>table</code>布局的写法：</p>\n<iframe src=\"../demos/2016-12-15/form2.html\" width=\"100%\" height=\"250\" frameborder=\"0\" allowfullscreen></iframe>\n<p>此处<code>form-operations</code>部分有点小问题，<code>form-operations</code>是一个<code>table-row</code>，所以直接子元素应该是<code>table-cell</code>，改一改就好了。</p>\n<p>同时也因为这个手误，发现在 IE9 中，鼠标 hover 到<code>table-row</code>上面去之后，会触发下面第一个<code>button</code>的 hover 效果。</p>"},{"title":"实现第一个 vscode 扩展","date":"2016-01-10T10:20:00.000Z","_content":"\n\n> 提前声明：<br>\n> 此处使用的 vscode 版本是0.10.6\n\nvscode 是微软最近弄出来的代码编辑器，基于 Electron ，对于前端程序员来说，颇亲切。\n\n个人觉得，到目前这个版本为止， vscode 还不是很成熟，总体体验上离 sublime 还有一定差距。\n<!-- more -->\n\n但是我个人很看重 vscode 的这些点：\n\n* 1、虽然使用 Electron ，但是代码各方面处理还是挺快的，特别是打开比较大的 js 文件，基本不会挂掉，性能堪比 sublime ；\n* 2、里面全是 js 系列的东西（虽然加了一层 ts ），对于前端来说，很是亲切，如果成熟到一定程度的话，将会有大把的前端程序员参与插件的开发。相比于 sublime 使用 python ， vscode 真是太爽了，深度定制的时候少了语言的门槛。\n\n目前个人感觉的小缺点有：\n\n* 1、无法代码折叠；\n* 2、扩展 API 还不完善，有些比较酷的功能依据现有 API 还无法实现。\n\n废话不对说，走一个插件先。\n\n### 插件功能\n\n对 JavaScript 代码进行检查，基于的检查规则是 `fecs` 。\n\n### 安装必要的东西\n\n> npm install -g yo generator-code\n\n### 生成扩展项目\n\n执行下面的代码：\n\n> yo code\n\n然后会出现这样的选择界面：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/13.png?raw=true)\n\n选择：\n\n> New Extension (JavaScript)\n\n这样就会生成使用 JavaScript 进行插件开发的项目结构。\n\n后续还会设置扩展的名字（此处设为 test ）、扩展的唯一标识、扩展的描述、扩展的发布者名字、是否初始化为 Git 仓库。根据提示做相应设置就好了。设置完之后就会自动运行 `npm install` ，安装好 vscode 模块。\n\n一切结束之后，你会发现在当前目录下生成了一个叫 `test` 的目录，进入这个目录，下面就有了一堆文件。\n\n### 修改 package.json 文件\n\n更改 `activationEvents` 配置项，设为：\n\n```js\n[\n    \"onLanguage:javascript\"\n]\n```\n\n意思就是在打开 JavaScript 文件的时候会激活这个扩展。\n\n删掉 `contributes` 配置项，此处用不上这个配置。\n\n### 修改 extension.js 文件\n\n这个文件是 package.json 里面 `main` 配置指向的文件，扩展激活的时候会调用这个文件提供的 activate 方法。\n\n对于该扩展，其执行流程为：\n\n* 1、在用户打开 js 文件的时候激活扩展，注册好文件保存的回调方法；\n* 2、在用户保存文件的时候，执行 fecs 检查；\n* 3、将第二步中检查出的错误和警告等信息显示到编辑器中。\n\n#### 开发过程\n\n在开发扩展的时候，要使用到 `vscode` 和 `fecs` 两个模块：\n\n```js\nvar vscode = require('vscode');\nvar fecs = require('fecs');\n```\n\n然后注册文件保存的回调函数：\n\n```js\nvar disposable = vscode.workspace.onDidSaveTextDocument(function (event) {\n    // do something while saving\n});\ncontext.subscriptions.push(diagnosticCollection);\n```\n\n> **注意：**<br>\n> 此处 `onDidSaveTextDocument` 返回了一个 disposable 对象，这个对象有一个 `dispose` 方法，在扩展销毁的时候，会调用这个方法。因此，这个对象要事先放到 `context.subscriptions` ，`context` 是 `activate` 方法调用的时候传入的上下文对象。\n\n在这个回调函数里面就可以执行 fecs 检查了：\n\n```js\nfecs.check(\n    {\n        type: 'js',\n        name: 'FECS JS',\n        _: [event.uri.path],\n        stream: false\n    },\n    function (hasNoError, errors) {\n        // the result of check\n    }\n);\n```\n\n`hasNoError` 和 `errors` 表明了检查结果。此处可以忽略 `hasNoError` ，直接将 errors 转换成 vscode 能够展示的错误。\n\nvscode 提供了 `DiagnosticCollection` ，用于向界面上展示错误信息。那么如何操作呢？\n\n首先要拿到一个 `DiagnosticCollection` 对象：\n\n```js\nvar diagnosticCollection = vscode.languages.createDiagnosticCollection('fecs');\n```\n\n然后往这个对象里面塞错误信息：\n\n```js\ndiagnosticCollection.set(someErrorObject);\n```\n\n#### 整合所有代码之后的样子\n\n整个 `extension.js` 的代码整合起来如下：\n\n```js\nvar path = require('path');\nvar vscode = require('vscode');\nvar fecs = require('fecs');\n\nfecs.leadName = 'fecs';\n\nexports.activate = function activate(context) {\n    var diagnosticCollection = vscode.languages.createDiagnosticCollection('fecs');\n    context.subscriptions.push(diagnosticCollection);\n\n    vscode.workspace.onDidSaveTextDocument(function (event) {\n        diagnosticCollection.clear();\n        fecs.check(\n            {\n                type: 'js',\n                name: 'FECS JS',\n                _: [event.uri.path],\n                stream: false\n            },\n            function (hasNoError, errors) {\n                diagnosticCollection.set(convertErrors(errors));\n            }\n        );\n    });\n};\n\nfunction convertErrors(fecsErrors) {\n    return fecsErrors.map(function (error) {\n        return [\n            vscode.Uri.file(error.path),\n            error.errors.map(function (fileError) {\n                // fecs的行号和列号与vscode有差异。。。。\n                var line = fileError.line - 1;\n                var column = fileError.column - 1;\n\n                return new vscode.Diagnostic(\n                    new vscode.Range(line, column, line, column + 1),\n                    `[FECS]: ${fileError.message}  (${fileError.rule})`,\n                    {\n                        1: vscode.DiagnosticSeverity.Warning,\n                        2: vscode.DiagnosticSeverity.Error\n                    }[fileError.severity]\n                );\n            })\n        ];\n    });\n}\n```\n\n> **注：** [fecs 是什么？](http://fecs.baidu.com/)\n","source":"_posts/实现第一个 vscode 扩展.md","raw":"---\ntitle: 实现第一个 vscode 扩展\ndate: 2016-01-10 18:20\ntags:\n- vscode\n---\n\n\n> 提前声明：<br>\n> 此处使用的 vscode 版本是0.10.6\n\nvscode 是微软最近弄出来的代码编辑器，基于 Electron ，对于前端程序员来说，颇亲切。\n\n个人觉得，到目前这个版本为止， vscode 还不是很成熟，总体体验上离 sublime 还有一定差距。\n<!-- more -->\n\n但是我个人很看重 vscode 的这些点：\n\n* 1、虽然使用 Electron ，但是代码各方面处理还是挺快的，特别是打开比较大的 js 文件，基本不会挂掉，性能堪比 sublime ；\n* 2、里面全是 js 系列的东西（虽然加了一层 ts ），对于前端来说，很是亲切，如果成熟到一定程度的话，将会有大把的前端程序员参与插件的开发。相比于 sublime 使用 python ， vscode 真是太爽了，深度定制的时候少了语言的门槛。\n\n目前个人感觉的小缺点有：\n\n* 1、无法代码折叠；\n* 2、扩展 API 还不完善，有些比较酷的功能依据现有 API 还无法实现。\n\n废话不对说，走一个插件先。\n\n### 插件功能\n\n对 JavaScript 代码进行检查，基于的检查规则是 `fecs` 。\n\n### 安装必要的东西\n\n> npm install -g yo generator-code\n\n### 生成扩展项目\n\n执行下面的代码：\n\n> yo code\n\n然后会出现这样的选择界面：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/13.png?raw=true)\n\n选择：\n\n> New Extension (JavaScript)\n\n这样就会生成使用 JavaScript 进行插件开发的项目结构。\n\n后续还会设置扩展的名字（此处设为 test ）、扩展的唯一标识、扩展的描述、扩展的发布者名字、是否初始化为 Git 仓库。根据提示做相应设置就好了。设置完之后就会自动运行 `npm install` ，安装好 vscode 模块。\n\n一切结束之后，你会发现在当前目录下生成了一个叫 `test` 的目录，进入这个目录，下面就有了一堆文件。\n\n### 修改 package.json 文件\n\n更改 `activationEvents` 配置项，设为：\n\n```js\n[\n    \"onLanguage:javascript\"\n]\n```\n\n意思就是在打开 JavaScript 文件的时候会激活这个扩展。\n\n删掉 `contributes` 配置项，此处用不上这个配置。\n\n### 修改 extension.js 文件\n\n这个文件是 package.json 里面 `main` 配置指向的文件，扩展激活的时候会调用这个文件提供的 activate 方法。\n\n对于该扩展，其执行流程为：\n\n* 1、在用户打开 js 文件的时候激活扩展，注册好文件保存的回调方法；\n* 2、在用户保存文件的时候，执行 fecs 检查；\n* 3、将第二步中检查出的错误和警告等信息显示到编辑器中。\n\n#### 开发过程\n\n在开发扩展的时候，要使用到 `vscode` 和 `fecs` 两个模块：\n\n```js\nvar vscode = require('vscode');\nvar fecs = require('fecs');\n```\n\n然后注册文件保存的回调函数：\n\n```js\nvar disposable = vscode.workspace.onDidSaveTextDocument(function (event) {\n    // do something while saving\n});\ncontext.subscriptions.push(diagnosticCollection);\n```\n\n> **注意：**<br>\n> 此处 `onDidSaveTextDocument` 返回了一个 disposable 对象，这个对象有一个 `dispose` 方法，在扩展销毁的时候，会调用这个方法。因此，这个对象要事先放到 `context.subscriptions` ，`context` 是 `activate` 方法调用的时候传入的上下文对象。\n\n在这个回调函数里面就可以执行 fecs 检查了：\n\n```js\nfecs.check(\n    {\n        type: 'js',\n        name: 'FECS JS',\n        _: [event.uri.path],\n        stream: false\n    },\n    function (hasNoError, errors) {\n        // the result of check\n    }\n);\n```\n\n`hasNoError` 和 `errors` 表明了检查结果。此处可以忽略 `hasNoError` ，直接将 errors 转换成 vscode 能够展示的错误。\n\nvscode 提供了 `DiagnosticCollection` ，用于向界面上展示错误信息。那么如何操作呢？\n\n首先要拿到一个 `DiagnosticCollection` 对象：\n\n```js\nvar diagnosticCollection = vscode.languages.createDiagnosticCollection('fecs');\n```\n\n然后往这个对象里面塞错误信息：\n\n```js\ndiagnosticCollection.set(someErrorObject);\n```\n\n#### 整合所有代码之后的样子\n\n整个 `extension.js` 的代码整合起来如下：\n\n```js\nvar path = require('path');\nvar vscode = require('vscode');\nvar fecs = require('fecs');\n\nfecs.leadName = 'fecs';\n\nexports.activate = function activate(context) {\n    var diagnosticCollection = vscode.languages.createDiagnosticCollection('fecs');\n    context.subscriptions.push(diagnosticCollection);\n\n    vscode.workspace.onDidSaveTextDocument(function (event) {\n        diagnosticCollection.clear();\n        fecs.check(\n            {\n                type: 'js',\n                name: 'FECS JS',\n                _: [event.uri.path],\n                stream: false\n            },\n            function (hasNoError, errors) {\n                diagnosticCollection.set(convertErrors(errors));\n            }\n        );\n    });\n};\n\nfunction convertErrors(fecsErrors) {\n    return fecsErrors.map(function (error) {\n        return [\n            vscode.Uri.file(error.path),\n            error.errors.map(function (fileError) {\n                // fecs的行号和列号与vscode有差异。。。。\n                var line = fileError.line - 1;\n                var column = fileError.column - 1;\n\n                return new vscode.Diagnostic(\n                    new vscode.Range(line, column, line, column + 1),\n                    `[FECS]: ${fileError.message}  (${fileError.rule})`,\n                    {\n                        1: vscode.DiagnosticSeverity.Warning,\n                        2: vscode.DiagnosticSeverity.Error\n                    }[fileError.severity]\n                );\n            })\n        ];\n    });\n}\n```\n\n> **注：** [fecs 是什么？](http://fecs.baidu.com/)\n","slug":"实现第一个 vscode 扩展","published":1,"updated":"2016-06-15T10:47:07.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy031001f0407pzygeecs","content":"<blockquote>\n<p>提前声明：<br><br>此处使用的 vscode 版本是0.10.6</p>\n</blockquote>\n<p>vscode 是微软最近弄出来的代码编辑器，基于 Electron ，对于前端程序员来说，颇亲切。</p>\n<p>个人觉得，到目前这个版本为止， vscode 还不是很成熟，总体体验上离 sublime 还有一定差距。<br><a id=\"more\"></a></p>\n<p>但是我个人很看重 vscode 的这些点：</p>\n<ul>\n<li>1、虽然使用 Electron ，但是代码各方面处理还是挺快的，特别是打开比较大的 js 文件，基本不会挂掉，性能堪比 sublime ；</li>\n<li>2、里面全是 js 系列的东西（虽然加了一层 ts ），对于前端来说，很是亲切，如果成熟到一定程度的话，将会有大把的前端程序员参与插件的开发。相比于 sublime 使用 python ， vscode 真是太爽了，深度定制的时候少了语言的门槛。</li>\n</ul>\n<p>目前个人感觉的小缺点有：</p>\n<ul>\n<li>1、无法代码折叠；</li>\n<li>2、扩展 API 还不完善，有些比较酷的功能依据现有 API 还无法实现。</li>\n</ul>\n<p>废话不对说，走一个插件先。</p>\n<h3 id=\"插件功能\"><a href=\"#插件功能\" class=\"headerlink\" title=\"插件功能\"></a>插件功能</h3><p>对 JavaScript 代码进行检查，基于的检查规则是 <code>fecs</code> 。</p>\n<h3 id=\"安装必要的东西\"><a href=\"#安装必要的东西\" class=\"headerlink\" title=\"安装必要的东西\"></a>安装必要的东西</h3><blockquote>\n<p>npm install -g yo generator-code</p>\n</blockquote>\n<h3 id=\"生成扩展项目\"><a href=\"#生成扩展项目\" class=\"headerlink\" title=\"生成扩展项目\"></a>生成扩展项目</h3><p>执行下面的代码：</p>\n<blockquote>\n<p>yo code</p>\n</blockquote>\n<p>然后会出现这样的选择界面：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/13.png?raw=true\" alt=\"\"></p>\n<p>选择：</p>\n<blockquote>\n<p>New Extension (JavaScript)</p>\n</blockquote>\n<p>这样就会生成使用 JavaScript 进行插件开发的项目结构。</p>\n<p>后续还会设置扩展的名字（此处设为 test ）、扩展的唯一标识、扩展的描述、扩展的发布者名字、是否初始化为 Git 仓库。根据提示做相应设置就好了。设置完之后就会自动运行 <code>npm install</code> ，安装好 vscode 模块。</p>\n<p>一切结束之后，你会发现在当前目录下生成了一个叫 <code>test</code> 的目录，进入这个目录，下面就有了一堆文件。</p>\n<h3 id=\"修改-package-json-文件\"><a href=\"#修改-package-json-文件\" class=\"headerlink\" title=\"修改 package.json 文件\"></a>修改 package.json 文件</h3><p>更改 <code>activationEvents</code> 配置项，设为：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[</div><div class=\"line\">    <span class=\"string\">\"onLanguage:javascript\"</span></div><div class=\"line\">]</div></pre></td></tr></table></figure>\n<p>意思就是在打开 JavaScript 文件的时候会激活这个扩展。</p>\n<p>删掉 <code>contributes</code> 配置项，此处用不上这个配置。</p>\n<h3 id=\"修改-extension-js-文件\"><a href=\"#修改-extension-js-文件\" class=\"headerlink\" title=\"修改 extension.js 文件\"></a>修改 extension.js 文件</h3><p>这个文件是 package.json 里面 <code>main</code> 配置指向的文件，扩展激活的时候会调用这个文件提供的 activate 方法。</p>\n<p>对于该扩展，其执行流程为：</p>\n<ul>\n<li>1、在用户打开 js 文件的时候激活扩展，注册好文件保存的回调方法；</li>\n<li>2、在用户保存文件的时候，执行 fecs 检查；</li>\n<li>3、将第二步中检查出的错误和警告等信息显示到编辑器中。</li>\n</ul>\n<h4 id=\"开发过程\"><a href=\"#开发过程\" class=\"headerlink\" title=\"开发过程\"></a>开发过程</h4><p>在开发扩展的时候，要使用到 <code>vscode</code> 和 <code>fecs</code> 两个模块：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> vscode = <span class=\"built_in\">require</span>(<span class=\"string\">'vscode'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> fecs = <span class=\"built_in\">require</span>(<span class=\"string\">'fecs'</span>);</div></pre></td></tr></table></figure>\n<p>然后注册文件保存的回调函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> disposable = vscode.workspace.onDidSaveTextDocument(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// do something while saving</span></div><div class=\"line\">&#125;);</div><div class=\"line\">context.subscriptions.push(diagnosticCollection);</div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>注意：</strong><br><br>此处 <code>onDidSaveTextDocument</code> 返回了一个 disposable 对象，这个对象有一个 <code>dispose</code> 方法，在扩展销毁的时候，会调用这个方法。因此，这个对象要事先放到 <code>context.subscriptions</code> ，<code>context</code> 是 <code>activate</code> 方法调用的时候传入的上下文对象。</p>\n</blockquote>\n<p>在这个回调函数里面就可以执行 fecs 检查了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">fecs.check(</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">type</span>: <span class=\"string\">'js'</span>,</div><div class=\"line\">        <span class=\"attr\">name</span>: <span class=\"string\">'FECS JS'</span>,</div><div class=\"line\">        <span class=\"attr\">_</span>: [event.uri.path],</div><div class=\"line\">        <span class=\"attr\">stream</span>: <span class=\"literal\">false</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">hasNoError, errors</span>) </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// the result of check</span></div><div class=\"line\">    &#125;</div><div class=\"line\">);</div></pre></td></tr></table></figure>\n<p><code>hasNoError</code> 和 <code>errors</code> 表明了检查结果。此处可以忽略 <code>hasNoError</code> ，直接将 errors 转换成 vscode 能够展示的错误。</p>\n<p>vscode 提供了 <code>DiagnosticCollection</code> ，用于向界面上展示错误信息。那么如何操作呢？</p>\n<p>首先要拿到一个 <code>DiagnosticCollection</code> 对象：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> diagnosticCollection = vscode.languages.createDiagnosticCollection(<span class=\"string\">'fecs'</span>);</div></pre></td></tr></table></figure>\n<p>然后往这个对象里面塞错误信息：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">diagnosticCollection.set(someErrorObject);</div></pre></td></tr></table></figure>\n<h4 id=\"整合所有代码之后的样子\"><a href=\"#整合所有代码之后的样子\" class=\"headerlink\" title=\"整合所有代码之后的样子\"></a>整合所有代码之后的样子</h4><p>整个 <code>extension.js</code> 的代码整合起来如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> vscode = <span class=\"built_in\">require</span>(<span class=\"string\">'vscode'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> fecs = <span class=\"built_in\">require</span>(<span class=\"string\">'fecs'</span>);</div><div class=\"line\"></div><div class=\"line\">fecs.leadName = <span class=\"string\">'fecs'</span>;</div><div class=\"line\"></div><div class=\"line\">exports.activate = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">activate</span>(<span class=\"params\">context</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> diagnosticCollection = vscode.languages.createDiagnosticCollection(<span class=\"string\">'fecs'</span>);</div><div class=\"line\">    context.subscriptions.push(diagnosticCollection);</div><div class=\"line\"></div><div class=\"line\">    vscode.workspace.onDidSaveTextDocument(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">        diagnosticCollection.clear();</div><div class=\"line\">        fecs.check(</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">type</span>: <span class=\"string\">'js'</span>,</div><div class=\"line\">                <span class=\"attr\">name</span>: <span class=\"string\">'FECS JS'</span>,</div><div class=\"line\">                <span class=\"attr\">_</span>: [event.uri.path],</div><div class=\"line\">                <span class=\"attr\">stream</span>: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;,</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">hasNoError, errors</span>) </span>&#123;</div><div class=\"line\">                diagnosticCollection.set(convertErrors(errors));</div><div class=\"line\">            &#125;</div><div class=\"line\">        );</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">convertErrors</span>(<span class=\"params\">fecsErrors</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> fecsErrors.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> [</div><div class=\"line\">            vscode.Uri.file(error.path),</div><div class=\"line\">            error.errors.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">fileError</span>) </span>&#123;</div><div class=\"line\">                <span class=\"comment\">// fecs的行号和列号与vscode有差异。。。。</span></div><div class=\"line\">                <span class=\"keyword\">var</span> line = fileError.line - <span class=\"number\">1</span>;</div><div class=\"line\">                <span class=\"keyword\">var</span> column = fileError.column - <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> vscode.Diagnostic(</div><div class=\"line\">                    <span class=\"keyword\">new</span> vscode.Range(line, column, line, column + <span class=\"number\">1</span>),</div><div class=\"line\">                    <span class=\"string\">`[FECS]: <span class=\"subst\">$&#123;fileError.message&#125;</span>  (<span class=\"subst\">$&#123;fileError.rule&#125;</span>)`</span>,</div><div class=\"line\">                    &#123;</div><div class=\"line\">                        <span class=\"number\">1</span>: vscode.DiagnosticSeverity.Warning,</div><div class=\"line\">                        <span class=\"number\">2</span>: vscode.DiagnosticSeverity.Error</div><div class=\"line\">                    &#125;[fileError.severity]</div><div class=\"line\">                );</div><div class=\"line\">            &#125;)</div><div class=\"line\">        ];</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>注：</strong> <a href=\"http://fecs.baidu.com/\" target=\"_blank\" rel=\"external\">fecs 是什么？</a></p>\n</blockquote>\n","excerpt":"<blockquote>\n<p>提前声明：<br><br>此处使用的 vscode 版本是0.10.6</p>\n</blockquote>\n<p>vscode 是微软最近弄出来的代码编辑器，基于 Electron ，对于前端程序员来说，颇亲切。</p>\n<p>个人觉得，到目前这个版本为止， vscode 还不是很成熟，总体体验上离 sublime 还有一定差距。<br>","more":"</p>\n<p>但是我个人很看重 vscode 的这些点：</p>\n<ul>\n<li>1、虽然使用 Electron ，但是代码各方面处理还是挺快的，特别是打开比较大的 js 文件，基本不会挂掉，性能堪比 sublime ；</li>\n<li>2、里面全是 js 系列的东西（虽然加了一层 ts ），对于前端来说，很是亲切，如果成熟到一定程度的话，将会有大把的前端程序员参与插件的开发。相比于 sublime 使用 python ， vscode 真是太爽了，深度定制的时候少了语言的门槛。</li>\n</ul>\n<p>目前个人感觉的小缺点有：</p>\n<ul>\n<li>1、无法代码折叠；</li>\n<li>2、扩展 API 还不完善，有些比较酷的功能依据现有 API 还无法实现。</li>\n</ul>\n<p>废话不对说，走一个插件先。</p>\n<h3 id=\"插件功能\"><a href=\"#插件功能\" class=\"headerlink\" title=\"插件功能\"></a>插件功能</h3><p>对 JavaScript 代码进行检查，基于的检查规则是 <code>fecs</code> 。</p>\n<h3 id=\"安装必要的东西\"><a href=\"#安装必要的东西\" class=\"headerlink\" title=\"安装必要的东西\"></a>安装必要的东西</h3><blockquote>\n<p>npm install -g yo generator-code</p>\n</blockquote>\n<h3 id=\"生成扩展项目\"><a href=\"#生成扩展项目\" class=\"headerlink\" title=\"生成扩展项目\"></a>生成扩展项目</h3><p>执行下面的代码：</p>\n<blockquote>\n<p>yo code</p>\n</blockquote>\n<p>然后会出现这样的选择界面：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/13.png?raw=true\" alt=\"\"></p>\n<p>选择：</p>\n<blockquote>\n<p>New Extension (JavaScript)</p>\n</blockquote>\n<p>这样就会生成使用 JavaScript 进行插件开发的项目结构。</p>\n<p>后续还会设置扩展的名字（此处设为 test ）、扩展的唯一标识、扩展的描述、扩展的发布者名字、是否初始化为 Git 仓库。根据提示做相应设置就好了。设置完之后就会自动运行 <code>npm install</code> ，安装好 vscode 模块。</p>\n<p>一切结束之后，你会发现在当前目录下生成了一个叫 <code>test</code> 的目录，进入这个目录，下面就有了一堆文件。</p>\n<h3 id=\"修改-package-json-文件\"><a href=\"#修改-package-json-文件\" class=\"headerlink\" title=\"修改 package.json 文件\"></a>修改 package.json 文件</h3><p>更改 <code>activationEvents</code> 配置项，设为：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[</div><div class=\"line\">    <span class=\"string\">\"onLanguage:javascript\"</span></div><div class=\"line\">]</div></pre></td></tr></table></figure>\n<p>意思就是在打开 JavaScript 文件的时候会激活这个扩展。</p>\n<p>删掉 <code>contributes</code> 配置项，此处用不上这个配置。</p>\n<h3 id=\"修改-extension-js-文件\"><a href=\"#修改-extension-js-文件\" class=\"headerlink\" title=\"修改 extension.js 文件\"></a>修改 extension.js 文件</h3><p>这个文件是 package.json 里面 <code>main</code> 配置指向的文件，扩展激活的时候会调用这个文件提供的 activate 方法。</p>\n<p>对于该扩展，其执行流程为：</p>\n<ul>\n<li>1、在用户打开 js 文件的时候激活扩展，注册好文件保存的回调方法；</li>\n<li>2、在用户保存文件的时候，执行 fecs 检查；</li>\n<li>3、将第二步中检查出的错误和警告等信息显示到编辑器中。</li>\n</ul>\n<h4 id=\"开发过程\"><a href=\"#开发过程\" class=\"headerlink\" title=\"开发过程\"></a>开发过程</h4><p>在开发扩展的时候，要使用到 <code>vscode</code> 和 <code>fecs</code> 两个模块：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> vscode = <span class=\"built_in\">require</span>(<span class=\"string\">'vscode'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> fecs = <span class=\"built_in\">require</span>(<span class=\"string\">'fecs'</span>);</div></pre></td></tr></table></figure>\n<p>然后注册文件保存的回调函数：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> disposable = vscode.workspace.onDidSaveTextDocument(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// do something while saving</span></div><div class=\"line\">&#125;);</div><div class=\"line\">context.subscriptions.push(diagnosticCollection);</div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>注意：</strong><br><br>此处 <code>onDidSaveTextDocument</code> 返回了一个 disposable 对象，这个对象有一个 <code>dispose</code> 方法，在扩展销毁的时候，会调用这个方法。因此，这个对象要事先放到 <code>context.subscriptions</code> ，<code>context</code> 是 <code>activate</code> 方法调用的时候传入的上下文对象。</p>\n</blockquote>\n<p>在这个回调函数里面就可以执行 fecs 检查了：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">fecs.check(</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">type</span>: <span class=\"string\">'js'</span>,</div><div class=\"line\">        <span class=\"attr\">name</span>: <span class=\"string\">'FECS JS'</span>,</div><div class=\"line\">        <span class=\"attr\">_</span>: [event.uri.path],</div><div class=\"line\">        <span class=\"attr\">stream</span>: <span class=\"literal\">false</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">hasNoError, errors</span>) </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// the result of check</span></div><div class=\"line\">    &#125;</div><div class=\"line\">);</div></pre></td></tr></table></figure>\n<p><code>hasNoError</code> 和 <code>errors</code> 表明了检查结果。此处可以忽略 <code>hasNoError</code> ，直接将 errors 转换成 vscode 能够展示的错误。</p>\n<p>vscode 提供了 <code>DiagnosticCollection</code> ，用于向界面上展示错误信息。那么如何操作呢？</p>\n<p>首先要拿到一个 <code>DiagnosticCollection</code> 对象：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> diagnosticCollection = vscode.languages.createDiagnosticCollection(<span class=\"string\">'fecs'</span>);</div></pre></td></tr></table></figure>\n<p>然后往这个对象里面塞错误信息：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">diagnosticCollection.set(someErrorObject);</div></pre></td></tr></table></figure>\n<h4 id=\"整合所有代码之后的样子\"><a href=\"#整合所有代码之后的样子\" class=\"headerlink\" title=\"整合所有代码之后的样子\"></a>整合所有代码之后的样子</h4><p>整个 <code>extension.js</code> 的代码整合起来如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">'path'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> vscode = <span class=\"built_in\">require</span>(<span class=\"string\">'vscode'</span>);</div><div class=\"line\"><span class=\"keyword\">var</span> fecs = <span class=\"built_in\">require</span>(<span class=\"string\">'fecs'</span>);</div><div class=\"line\"></div><div class=\"line\">fecs.leadName = <span class=\"string\">'fecs'</span>;</div><div class=\"line\"></div><div class=\"line\">exports.activate = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">activate</span>(<span class=\"params\">context</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> diagnosticCollection = vscode.languages.createDiagnosticCollection(<span class=\"string\">'fecs'</span>);</div><div class=\"line\">    context.subscriptions.push(diagnosticCollection);</div><div class=\"line\"></div><div class=\"line\">    vscode.workspace.onDidSaveTextDocument(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">        diagnosticCollection.clear();</div><div class=\"line\">        fecs.check(</div><div class=\"line\">            &#123;</div><div class=\"line\">                <span class=\"attr\">type</span>: <span class=\"string\">'js'</span>,</div><div class=\"line\">                <span class=\"attr\">name</span>: <span class=\"string\">'FECS JS'</span>,</div><div class=\"line\">                <span class=\"attr\">_</span>: [event.uri.path],</div><div class=\"line\">                <span class=\"attr\">stream</span>: <span class=\"literal\">false</span></div><div class=\"line\">            &#125;,</div><div class=\"line\">            <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">hasNoError, errors</span>) </span>&#123;</div><div class=\"line\">                diagnosticCollection.set(convertErrors(errors));</div><div class=\"line\">            &#125;</div><div class=\"line\">        );</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">convertErrors</span>(<span class=\"params\">fecsErrors</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> fecsErrors.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> [</div><div class=\"line\">            vscode.Uri.file(error.path),</div><div class=\"line\">            error.errors.map(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">fileError</span>) </span>&#123;</div><div class=\"line\">                <span class=\"comment\">// fecs的行号和列号与vscode有差异。。。。</span></div><div class=\"line\">                <span class=\"keyword\">var</span> line = fileError.line - <span class=\"number\">1</span>;</div><div class=\"line\">                <span class=\"keyword\">var</span> column = fileError.column - <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> vscode.Diagnostic(</div><div class=\"line\">                    <span class=\"keyword\">new</span> vscode.Range(line, column, line, column + <span class=\"number\">1</span>),</div><div class=\"line\">                    <span class=\"string\">`[FECS]: <span class=\"subst\">$&#123;fileError.message&#125;</span>  (<span class=\"subst\">$&#123;fileError.rule&#125;</span>)`</span>,</div><div class=\"line\">                    &#123;</div><div class=\"line\">                        <span class=\"number\">1</span>: vscode.DiagnosticSeverity.Warning,</div><div class=\"line\">                        <span class=\"number\">2</span>: vscode.DiagnosticSeverity.Error</div><div class=\"line\">                    &#125;[fileError.severity]</div><div class=\"line\">                );</div><div class=\"line\">            &#125;)</div><div class=\"line\">        ];</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>注：</strong> <a href=\"http://fecs.baidu.com/\">fecs 是什么？</a></p>\n</blockquote>"},{"title":"爬虫与编码","date":"2016-01-09T05:23:00.000Z","_content":"\n作为一名 web 开发人员，时不时爬爬别人家的网站还是很有趣的。\n<!-- more -->\n\n其实，爬一个网站的数据也是爬取者和被爬取者的一种攻防较量：一般情况下，被爬取者总是会想方设法地阻止爬取者爬取自家网站数据。\n\n于是，一些网站就会采取一些措施来阻止非正常访问：\n\n* 某某关键接口只能每分钟调用若干次；\n* 某某 IP 访问网站太频繁，直接拒绝掉该 IP 发过来的请求。\n\n当然，这些措施都只是治标不治本，不能从根本上杜绝自己网站数据被爬。\n\n从爬取者的角度来看，要突破层层限制，拿到目标网站的数据，还是要做一些事情的：\n\n* 如果要爬取的目标网页需要登录才能访问到，那么可以采用 phantomjs 来简化掉 session 的处理；\n* 在爬取的过程中，如果发现服务器从某个时刻开始一直拒绝掉自己的请求，那么就要怀疑自己的 IP 是否被屏蔽掉了，或者某个接口是否访问太频繁了；\n* 对于有 IP 限制策略的网站，尽量模拟正常用户访问，频率不要太快，最好做多个节点来爬取。\n\n**等等，有点偏题了！下面进入正轨：**\n\n在初次写爬虫代码的时候，很容易遇到解析出来的数据是乱码的问题：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/12.png?raw=true)\n\n面对这些乱码，如何解决呢？\n\n### 注意 HTTP 响应的头部\n\n留意一下 HTTP 响应的头部是否有用 gzip 压缩过：\n\n```\nContent-Encoding:gzip\n```\n\n如果有这种字眼，那么响应正文部分就是使用 gzip 压缩过的，在拿到这种压缩过的数据之后，要先解压。\n\nNode.js 中，提供了 zlib 模块，用于处理 gzip 相关的操作。对于解压 gzip ，可以这样做：\n\n```js\n// `res` 是响应对象，http.IncommingMessage 类型的\n\nvar buffers = [];// 暂存 gzip 解压过后的 buffer\nvar size = 0;// 记录整个响应体解压后的数据大小\nvar gunzipStream = zlib.createGunzip();\nres.pipe(gunzipStream);\ngunzipStream.on('data', function (buffer) {\n    buffers.push(buffer);\n    size += buffer.length;\n});\ngunzipStream.on('error', function (error) {\n    // 发生了错误，处理下吧！\n});\ngunzipStream.on('end', function () {\n    var unzipedBuffer = Buffer.concat(buffers, size); // unzipedBuffer 就是解压过后的数据\n});\n```\n\n### 注意文本编码\n\n拿着最终 gzip 解压出来的数据，开心的去进行后续处理，结果继续乱码，为什么会这样？\n\nNode.js 里面默认字符串是 `utf-8` 编码的，如果 gzip 解压出来的数据不是 `utf-8` 编码的话，那么把这堆 buffer 数据转换成字符串的时候就可能产生乱码。 到目前为止，Node.js 内置支持的解码方式很有限，只能依靠一些第三方模块进行某些文本解码。\n\n怎么办呢？\n\n留意一下响应头当中的 `Content-Type` 部分，如果 charset 是非 `utf-8` 的话，那就要考虑继续对数据进行解码了。\n\n对于中文网站，可能会使用 `GBK` 或者 `GB2312` 进行编码，对于此种场景，需要用到第三方的解码工具，此处选用了 `iconv-lite` 。解码过程如下：\n\n```js\nvar finallyResponseText = require('iconv-lite').decode(unzipedBuffer, 'gbk');\n```\n\n这样，就拿到了最终想要的文本数据。\n","source":"_posts/爬虫与编码.md","raw":"---\ntitle: 爬虫与编码\ndate: 2016-01-09 13:23\n---\n\n作为一名 web 开发人员，时不时爬爬别人家的网站还是很有趣的。\n<!-- more -->\n\n其实，爬一个网站的数据也是爬取者和被爬取者的一种攻防较量：一般情况下，被爬取者总是会想方设法地阻止爬取者爬取自家网站数据。\n\n于是，一些网站就会采取一些措施来阻止非正常访问：\n\n* 某某关键接口只能每分钟调用若干次；\n* 某某 IP 访问网站太频繁，直接拒绝掉该 IP 发过来的请求。\n\n当然，这些措施都只是治标不治本，不能从根本上杜绝自己网站数据被爬。\n\n从爬取者的角度来看，要突破层层限制，拿到目标网站的数据，还是要做一些事情的：\n\n* 如果要爬取的目标网页需要登录才能访问到，那么可以采用 phantomjs 来简化掉 session 的处理；\n* 在爬取的过程中，如果发现服务器从某个时刻开始一直拒绝掉自己的请求，那么就要怀疑自己的 IP 是否被屏蔽掉了，或者某个接口是否访问太频繁了；\n* 对于有 IP 限制策略的网站，尽量模拟正常用户访问，频率不要太快，最好做多个节点来爬取。\n\n**等等，有点偏题了！下面进入正轨：**\n\n在初次写爬虫代码的时候，很容易遇到解析出来的数据是乱码的问题：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/12.png?raw=true)\n\n面对这些乱码，如何解决呢？\n\n### 注意 HTTP 响应的头部\n\n留意一下 HTTP 响应的头部是否有用 gzip 压缩过：\n\n```\nContent-Encoding:gzip\n```\n\n如果有这种字眼，那么响应正文部分就是使用 gzip 压缩过的，在拿到这种压缩过的数据之后，要先解压。\n\nNode.js 中，提供了 zlib 模块，用于处理 gzip 相关的操作。对于解压 gzip ，可以这样做：\n\n```js\n// `res` 是响应对象，http.IncommingMessage 类型的\n\nvar buffers = [];// 暂存 gzip 解压过后的 buffer\nvar size = 0;// 记录整个响应体解压后的数据大小\nvar gunzipStream = zlib.createGunzip();\nres.pipe(gunzipStream);\ngunzipStream.on('data', function (buffer) {\n    buffers.push(buffer);\n    size += buffer.length;\n});\ngunzipStream.on('error', function (error) {\n    // 发生了错误，处理下吧！\n});\ngunzipStream.on('end', function () {\n    var unzipedBuffer = Buffer.concat(buffers, size); // unzipedBuffer 就是解压过后的数据\n});\n```\n\n### 注意文本编码\n\n拿着最终 gzip 解压出来的数据，开心的去进行后续处理，结果继续乱码，为什么会这样？\n\nNode.js 里面默认字符串是 `utf-8` 编码的，如果 gzip 解压出来的数据不是 `utf-8` 编码的话，那么把这堆 buffer 数据转换成字符串的时候就可能产生乱码。 到目前为止，Node.js 内置支持的解码方式很有限，只能依靠一些第三方模块进行某些文本解码。\n\n怎么办呢？\n\n留意一下响应头当中的 `Content-Type` 部分，如果 charset 是非 `utf-8` 的话，那就要考虑继续对数据进行解码了。\n\n对于中文网站，可能会使用 `GBK` 或者 `GB2312` 进行编码，对于此种场景，需要用到第三方的解码工具，此处选用了 `iconv-lite` 。解码过程如下：\n\n```js\nvar finallyResponseText = require('iconv-lite').decode(unzipedBuffer, 'gbk');\n```\n\n这样，就拿到了最终想要的文本数据。\n","slug":"爬虫与编码","published":1,"updated":"2016-06-08T09:52:21.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy034001i0407ggfzm9w2","content":"<p>作为一名 web 开发人员，时不时爬爬别人家的网站还是很有趣的。<br><a id=\"more\"></a></p>\n<p>其实，爬一个网站的数据也是爬取者和被爬取者的一种攻防较量：一般情况下，被爬取者总是会想方设法地阻止爬取者爬取自家网站数据。</p>\n<p>于是，一些网站就会采取一些措施来阻止非正常访问：</p>\n<ul>\n<li>某某关键接口只能每分钟调用若干次；</li>\n<li>某某 IP 访问网站太频繁，直接拒绝掉该 IP 发过来的请求。</li>\n</ul>\n<p>当然，这些措施都只是治标不治本，不能从根本上杜绝自己网站数据被爬。</p>\n<p>从爬取者的角度来看，要突破层层限制，拿到目标网站的数据，还是要做一些事情的：</p>\n<ul>\n<li>如果要爬取的目标网页需要登录才能访问到，那么可以采用 phantomjs 来简化掉 session 的处理；</li>\n<li>在爬取的过程中，如果发现服务器从某个时刻开始一直拒绝掉自己的请求，那么就要怀疑自己的 IP 是否被屏蔽掉了，或者某个接口是否访问太频繁了；</li>\n<li>对于有 IP 限制策略的网站，尽量模拟正常用户访问，频率不要太快，最好做多个节点来爬取。</li>\n</ul>\n<p><strong>等等，有点偏题了！下面进入正轨：</strong></p>\n<p>在初次写爬虫代码的时候，很容易遇到解析出来的数据是乱码的问题：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/12.png?raw=true\" alt=\"\"></p>\n<p>面对这些乱码，如何解决呢？</p>\n<h3 id=\"注意-HTTP-响应的头部\"><a href=\"#注意-HTTP-响应的头部\" class=\"headerlink\" title=\"注意 HTTP 响应的头部\"></a>注意 HTTP 响应的头部</h3><p>留意一下 HTTP 响应的头部是否有用 gzip 压缩过：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Encoding:gzip</div></pre></td></tr></table></figure>\n<p>如果有这种字眼，那么响应正文部分就是使用 gzip 压缩过的，在拿到这种压缩过的数据之后，要先解压。</p>\n<p>Node.js 中，提供了 zlib 模块，用于处理 gzip 相关的操作。对于解压 gzip ，可以这样做：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// `res` 是响应对象，http.IncommingMessage 类型的</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> buffers = [];<span class=\"comment\">// 暂存 gzip 解压过后的 buffer</span></div><div class=\"line\"><span class=\"keyword\">var</span> size = <span class=\"number\">0</span>;<span class=\"comment\">// 记录整个响应体解压后的数据大小</span></div><div class=\"line\"><span class=\"keyword\">var</span> gunzipStream = zlib.createGunzip();</div><div class=\"line\">res.pipe(gunzipStream);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'data'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">buffer</span>) </span>&#123;</div><div class=\"line\">    buffers.push(buffer);</div><div class=\"line\">    size += buffer.length;</div><div class=\"line\">&#125;);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'error'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 发生了错误，处理下吧！</span></div><div class=\"line\">&#125;);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'end'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> unzipedBuffer = Buffer.concat(buffers, size); <span class=\"comment\">// unzipedBuffer 就是解压过后的数据</span></div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h3 id=\"注意文本编码\"><a href=\"#注意文本编码\" class=\"headerlink\" title=\"注意文本编码\"></a>注意文本编码</h3><p>拿着最终 gzip 解压出来的数据，开心的去进行后续处理，结果继续乱码，为什么会这样？</p>\n<p>Node.js 里面默认字符串是 <code>utf-8</code> 编码的，如果 gzip 解压出来的数据不是 <code>utf-8</code> 编码的话，那么把这堆 buffer 数据转换成字符串的时候就可能产生乱码。 到目前为止，Node.js 内置支持的解码方式很有限，只能依靠一些第三方模块进行某些文本解码。</p>\n<p>怎么办呢？</p>\n<p>留意一下响应头当中的 <code>Content-Type</code> 部分，如果 charset 是非 <code>utf-8</code> 的话，那就要考虑继续对数据进行解码了。</p>\n<p>对于中文网站，可能会使用 <code>GBK</code> 或者 <code>GB2312</code> 进行编码，对于此种场景，需要用到第三方的解码工具，此处选用了 <code>iconv-lite</code> 。解码过程如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> finallyResponseText = <span class=\"built_in\">require</span>(<span class=\"string\">'iconv-lite'</span>).decode(unzipedBuffer, <span class=\"string\">'gbk'</span>);</div></pre></td></tr></table></figure>\n<p>这样，就拿到了最终想要的文本数据。</p>\n","excerpt":"<p>作为一名 web 开发人员，时不时爬爬别人家的网站还是很有趣的。<br>","more":"</p>\n<p>其实，爬一个网站的数据也是爬取者和被爬取者的一种攻防较量：一般情况下，被爬取者总是会想方设法地阻止爬取者爬取自家网站数据。</p>\n<p>于是，一些网站就会采取一些措施来阻止非正常访问：</p>\n<ul>\n<li>某某关键接口只能每分钟调用若干次；</li>\n<li>某某 IP 访问网站太频繁，直接拒绝掉该 IP 发过来的请求。</li>\n</ul>\n<p>当然，这些措施都只是治标不治本，不能从根本上杜绝自己网站数据被爬。</p>\n<p>从爬取者的角度来看，要突破层层限制，拿到目标网站的数据，还是要做一些事情的：</p>\n<ul>\n<li>如果要爬取的目标网页需要登录才能访问到，那么可以采用 phantomjs 来简化掉 session 的处理；</li>\n<li>在爬取的过程中，如果发现服务器从某个时刻开始一直拒绝掉自己的请求，那么就要怀疑自己的 IP 是否被屏蔽掉了，或者某个接口是否访问太频繁了；</li>\n<li>对于有 IP 限制策略的网站，尽量模拟正常用户访问，频率不要太快，最好做多个节点来爬取。</li>\n</ul>\n<p><strong>等等，有点偏题了！下面进入正轨：</strong></p>\n<p>在初次写爬虫代码的时候，很容易遇到解析出来的数据是乱码的问题：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/12.png?raw=true\" alt=\"\"></p>\n<p>面对这些乱码，如何解决呢？</p>\n<h3 id=\"注意-HTTP-响应的头部\"><a href=\"#注意-HTTP-响应的头部\" class=\"headerlink\" title=\"注意 HTTP 响应的头部\"></a>注意 HTTP 响应的头部</h3><p>留意一下 HTTP 响应的头部是否有用 gzip 压缩过：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Content-Encoding:gzip</div></pre></td></tr></table></figure>\n<p>如果有这种字眼，那么响应正文部分就是使用 gzip 压缩过的，在拿到这种压缩过的数据之后，要先解压。</p>\n<p>Node.js 中，提供了 zlib 模块，用于处理 gzip 相关的操作。对于解压 gzip ，可以这样做：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// `res` 是响应对象，http.IncommingMessage 类型的</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">var</span> buffers = [];<span class=\"comment\">// 暂存 gzip 解压过后的 buffer</span></div><div class=\"line\"><span class=\"keyword\">var</span> size = <span class=\"number\">0</span>;<span class=\"comment\">// 记录整个响应体解压后的数据大小</span></div><div class=\"line\"><span class=\"keyword\">var</span> gunzipStream = zlib.createGunzip();</div><div class=\"line\">res.pipe(gunzipStream);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'data'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">buffer</span>) </span>&#123;</div><div class=\"line\">    buffers.push(buffer);</div><div class=\"line\">    size += buffer.length;</div><div class=\"line\">&#125;);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'error'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">error</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 发生了错误，处理下吧！</span></div><div class=\"line\">&#125;);</div><div class=\"line\">gunzipStream.on(<span class=\"string\">'end'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> unzipedBuffer = Buffer.concat(buffers, size); <span class=\"comment\">// unzipedBuffer 就是解压过后的数据</span></div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n<h3 id=\"注意文本编码\"><a href=\"#注意文本编码\" class=\"headerlink\" title=\"注意文本编码\"></a>注意文本编码</h3><p>拿着最终 gzip 解压出来的数据，开心的去进行后续处理，结果继续乱码，为什么会这样？</p>\n<p>Node.js 里面默认字符串是 <code>utf-8</code> 编码的，如果 gzip 解压出来的数据不是 <code>utf-8</code> 编码的话，那么把这堆 buffer 数据转换成字符串的时候就可能产生乱码。 到目前为止，Node.js 内置支持的解码方式很有限，只能依靠一些第三方模块进行某些文本解码。</p>\n<p>怎么办呢？</p>\n<p>留意一下响应头当中的 <code>Content-Type</code> 部分，如果 charset 是非 <code>utf-8</code> 的话，那就要考虑继续对数据进行解码了。</p>\n<p>对于中文网站，可能会使用 <code>GBK</code> 或者 <code>GB2312</code> 进行编码，对于此种场景，需要用到第三方的解码工具，此处选用了 <code>iconv-lite</code> 。解码过程如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> finallyResponseText = <span class=\"built_in\">require</span>(<span class=\"string\">'iconv-lite'</span>).decode(unzipedBuffer, <span class=\"string\">'gbk'</span>);</div></pre></td></tr></table></figure>\n<p>这样，就拿到了最终想要的文本数据。</p>"},{"title":"生成器（ generator ）","date":"2015-07-12T16:00:00.000Z","_content":"\n### 什么是 generator ？\n\n可以暂停（ pause ）和唤醒（ resume ）的函数。\n<!-- more -->\n\n### 实现一个迭代器\n\n```js\nfunction* gen() {\n    for (let a of [1, 2, 3]) {\n        yield a + 1;\n    }\n\n    return 5;\n}\n\n// 下面的 for 循环输出：\n// 2\n// 3\n// 4\nfor (let b of gen()) {\n    print(JSON.stringify(b));\n}\n\nlet it = gen();\nprint(JSON.stringify(it.next())); // 输出： {value: 2, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 3, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 4, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 5, done: true}\n\nprint(JSON.stringify([...gen()])); // 输出： [2, 3, 4]\n```\n\n### 创建 generator 的方式\n\n```js\n// 第一种\nfunction* genFunc() { ··· }\nlet genObj = genFunc();\n\n// 第二种\nconst genFunc = function* () { ··· };\nlet genObj = genFunc();\n\n// 第三种\nlet obj = {\n    * generatorMethod() {\n        ···\n    }\n};\nlet genObj = obj.generatorMethod();\n\n// 第四种\nclass MyClass {\n    * generatorMethod() {\n        ···\n    }\n}\nlet myInst = new MyClass();\nlet genObj = myInst.generatorMethod();\n```\n\n### generator 嵌套： yield*\n\n```js\nfunction* gen1() {\n    yield 2;\n    yield 3;\n    return 'result of gen1';\n}\nfunction* gen2() {\n    yield 1;\n\n    // `yield* gen1()` 类似于\n    // for (let x of gen1()) {\n    //      yield x;\n    // }\n    print(JSON.stringify(yield* gen1()));\n\n    yield 4;\n}\n// 输出：\n// 'result of gen1'\n// [1, 2, 3, 4]\nprint(JSON.stringify([...gen2()]));\n\nfunction* gen3() {\n    yield 1;\n    yield* [2, 3];\n    yield 4;\n}\nprint(JSON.stringify([...gen3()])); // 输出： [1, 2, 3, 4]\n```\n\n### next 传值\n\n```js\nfunction* gen1() {\n    print(JSON.stringify(yield));\n}\nlet it = gen1();\n// 输出：\n// {value: undefined, done: false}\n// outer value\n// {value: undefined, done: true}\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.next('outer value')));\n```\n\n### `return()` 外部终止 generator\n\n```js\nfunction* gen1() {\n    print('a');\n    yield 1;\n    print('b');\n    yield 2;\n    print('c');\n}\n// 输出：\n// a\n// {value: 1, done: false}\n// {value: 'result', done: true}\nlet it = gen1();\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.return('result')));\n```\n\n### `throw()` 抛出异常\n\n```js\nfunction* gen() {\n    try {\n        print('Started');\n        yield;\n    } catch (error) {\n        print('Caught: ' + error.message);\n    }\n    return 'return result';\n}\n// 输出：\n// Started\n// {value: undefined, done: false}\n// Caught: error\n// {value: 'return result', done: true}\nlet it = gen();\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.throw(new Error('error'))));\n```\n\n### 很有有趣也有用的例子\n\n```js\n// for 循环延迟执行\nfunction* fn1(iterable) {\n    for (let x of iterable) {\n        if (x === 0) {\n            continue;\n        }\n        yield x;\n    }\n}\nfunction* fn2(iterable) {\n    for (let x of iterable) {\n        yield x + 1;\n    }\n}\nfunction* fn3(iterable) {\n    for (let x of iterable) {\n        yield x / 2;\n    }\n}\nlet newArr = [...fn3(fn2(fn1([1, 2, 3])))];\nprint(JSON.stringify(newArr)); // [1, 1.5, 2]\n```\n\n### generator 类图\n\n规范里面有一张[很大的图](http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects)，有点复杂。所以，看一张小图：\n\n![](./imgs/9.jpg)\n\n说明：\n\n* 空心箭头表示两个对象的继承关系。换句话说，从 x 指向 y 的箭头意味着 `Object.getPrototypeOf(x) === y` 。\n* 圆括号表示当前被包起来的对象是存在的，但是不能通过全局变量来访问。\n* 带有 `instanceof` 字眼的箭头如果从 x 指向 y ，就表明 `x instanceof y` 。\n    * `o instanceof C` 实际上就相当于 `C.prototype.isPrototypeOf(o)`\n* 带有 `prototype` 字眼的箭头如果从 x 指向 y ，就表明 `x.prototype === y` 。\n\n此图看完可能没有直观的感受，看两个例子先。\n\n第一个， generator 函数表现得很像一个构造函数，因为通过 `new` 调用和直接调用，两者的效果是一样的，都返回 generator 对象，如下所示：\n\n```\n> function* g() {}\n> g.prototype.hello = function () { return 'hi!'};\n> let obj = g();\n> obj instanceof g\ntrue\n> obj.hello()\n'hi!'\n```\n\n第二个，如果想给所有的 generator 对象添加一个方法，就可以放在 `(Generator).prototype` 上面，如下所示：\n\n```\n> let Generator_prototype = Object.getPrototypeOf(function* () {}).prototype;\n> Generator_prototype.hello = function () { return 'hi!'};\n> let generatorObject = (function* () {})();\n> generatorObject.hello()\n'hi!'\n```\n\ngenerator 内部的 `this` 是有一些猫腻的：\n\n```js\nfunction* gen1() {\n    'use strict'; // just in case\n    yield this;\n}\n\n// Retrieve the yielded value via destructuring\nlet [functionThis] = gen1();\nconsole.log(functionThis); // undefined\n\nlet obj = { method: gen1 };\nlet [methodThis] = obj.method();\nconsole.log(methodThis === obj); // true\n\nfunction* gen2() {\n    console.log(this); // ReferenceError\n}\nnew gen2();\n```\n\n### 一个简单的类似于 tj co 库的东西\n\n```js\n// 此段代码使用 node --harmony 执行\nexecuteGeneratorFn(function* () {\n    var result = yield request.bind(null, 'http://www.baidu.com', {userId: 1});\n    console.log(result);\n});\n\nexecuteGeneratorFn(function* () {\n    var userList = [];\n    for (var param of [{userId: 1}, {userId: 2}]) {\n        userList.push(yield request.bind(null, 'http://www.baidu.com', param));\n    }\n    console.log(userList);\n});\n\nfunction request(url, params, callback) {\n    setTimeout(() => callback('request result: ' + Math.random()), 3000);\n}\n\nfunction executeGeneratorFn(genFn, callback) {\n    var iterator = genFn();\n    next();\n\n    function next() {\n        try {\n            execute(iterator.next(arguments));\n        } catch (e) {\n            callback instanceof Function && callback(e);\n        }\n    }\n\n    function execute(nextValue) {\n        if (!nextValue.done) {\n            nextValue.value(next);\n        } else {\n            callback instanceof Function && callback(null, nextValue.value);\n        }\n    }\n}\n```\n","source":"_posts/生成器（ generator ）.md","raw":"---\ntitle: 生成器（ generator ）\ndate: 2015-07-13\ntags:\n- JavaScript\n- ECMAScript 6\n---\n\n### 什么是 generator ？\n\n可以暂停（ pause ）和唤醒（ resume ）的函数。\n<!-- more -->\n\n### 实现一个迭代器\n\n```js\nfunction* gen() {\n    for (let a of [1, 2, 3]) {\n        yield a + 1;\n    }\n\n    return 5;\n}\n\n// 下面的 for 循环输出：\n// 2\n// 3\n// 4\nfor (let b of gen()) {\n    print(JSON.stringify(b));\n}\n\nlet it = gen();\nprint(JSON.stringify(it.next())); // 输出： {value: 2, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 3, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 4, done: false}\nprint(JSON.stringify(it.next())); // 输出： {value: 5, done: true}\n\nprint(JSON.stringify([...gen()])); // 输出： [2, 3, 4]\n```\n\n### 创建 generator 的方式\n\n```js\n// 第一种\nfunction* genFunc() { ··· }\nlet genObj = genFunc();\n\n// 第二种\nconst genFunc = function* () { ··· };\nlet genObj = genFunc();\n\n// 第三种\nlet obj = {\n    * generatorMethod() {\n        ···\n    }\n};\nlet genObj = obj.generatorMethod();\n\n// 第四种\nclass MyClass {\n    * generatorMethod() {\n        ···\n    }\n}\nlet myInst = new MyClass();\nlet genObj = myInst.generatorMethod();\n```\n\n### generator 嵌套： yield*\n\n```js\nfunction* gen1() {\n    yield 2;\n    yield 3;\n    return 'result of gen1';\n}\nfunction* gen2() {\n    yield 1;\n\n    // `yield* gen1()` 类似于\n    // for (let x of gen1()) {\n    //      yield x;\n    // }\n    print(JSON.stringify(yield* gen1()));\n\n    yield 4;\n}\n// 输出：\n// 'result of gen1'\n// [1, 2, 3, 4]\nprint(JSON.stringify([...gen2()]));\n\nfunction* gen3() {\n    yield 1;\n    yield* [2, 3];\n    yield 4;\n}\nprint(JSON.stringify([...gen3()])); // 输出： [1, 2, 3, 4]\n```\n\n### next 传值\n\n```js\nfunction* gen1() {\n    print(JSON.stringify(yield));\n}\nlet it = gen1();\n// 输出：\n// {value: undefined, done: false}\n// outer value\n// {value: undefined, done: true}\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.next('outer value')));\n```\n\n### `return()` 外部终止 generator\n\n```js\nfunction* gen1() {\n    print('a');\n    yield 1;\n    print('b');\n    yield 2;\n    print('c');\n}\n// 输出：\n// a\n// {value: 1, done: false}\n// {value: 'result', done: true}\nlet it = gen1();\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.return('result')));\n```\n\n### `throw()` 抛出异常\n\n```js\nfunction* gen() {\n    try {\n        print('Started');\n        yield;\n    } catch (error) {\n        print('Caught: ' + error.message);\n    }\n    return 'return result';\n}\n// 输出：\n// Started\n// {value: undefined, done: false}\n// Caught: error\n// {value: 'return result', done: true}\nlet it = gen();\nprint(JSON.stringify(it.next()));\nprint(JSON.stringify(it.throw(new Error('error'))));\n```\n\n### 很有有趣也有用的例子\n\n```js\n// for 循环延迟执行\nfunction* fn1(iterable) {\n    for (let x of iterable) {\n        if (x === 0) {\n            continue;\n        }\n        yield x;\n    }\n}\nfunction* fn2(iterable) {\n    for (let x of iterable) {\n        yield x + 1;\n    }\n}\nfunction* fn3(iterable) {\n    for (let x of iterable) {\n        yield x / 2;\n    }\n}\nlet newArr = [...fn3(fn2(fn1([1, 2, 3])))];\nprint(JSON.stringify(newArr)); // [1, 1.5, 2]\n```\n\n### generator 类图\n\n规范里面有一张[很大的图](http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects)，有点复杂。所以，看一张小图：\n\n![](./imgs/9.jpg)\n\n说明：\n\n* 空心箭头表示两个对象的继承关系。换句话说，从 x 指向 y 的箭头意味着 `Object.getPrototypeOf(x) === y` 。\n* 圆括号表示当前被包起来的对象是存在的，但是不能通过全局变量来访问。\n* 带有 `instanceof` 字眼的箭头如果从 x 指向 y ，就表明 `x instanceof y` 。\n    * `o instanceof C` 实际上就相当于 `C.prototype.isPrototypeOf(o)`\n* 带有 `prototype` 字眼的箭头如果从 x 指向 y ，就表明 `x.prototype === y` 。\n\n此图看完可能没有直观的感受，看两个例子先。\n\n第一个， generator 函数表现得很像一个构造函数，因为通过 `new` 调用和直接调用，两者的效果是一样的，都返回 generator 对象，如下所示：\n\n```\n> function* g() {}\n> g.prototype.hello = function () { return 'hi!'};\n> let obj = g();\n> obj instanceof g\ntrue\n> obj.hello()\n'hi!'\n```\n\n第二个，如果想给所有的 generator 对象添加一个方法，就可以放在 `(Generator).prototype` 上面，如下所示：\n\n```\n> let Generator_prototype = Object.getPrototypeOf(function* () {}).prototype;\n> Generator_prototype.hello = function () { return 'hi!'};\n> let generatorObject = (function* () {})();\n> generatorObject.hello()\n'hi!'\n```\n\ngenerator 内部的 `this` 是有一些猫腻的：\n\n```js\nfunction* gen1() {\n    'use strict'; // just in case\n    yield this;\n}\n\n// Retrieve the yielded value via destructuring\nlet [functionThis] = gen1();\nconsole.log(functionThis); // undefined\n\nlet obj = { method: gen1 };\nlet [methodThis] = obj.method();\nconsole.log(methodThis === obj); // true\n\nfunction* gen2() {\n    console.log(this); // ReferenceError\n}\nnew gen2();\n```\n\n### 一个简单的类似于 tj co 库的东西\n\n```js\n// 此段代码使用 node --harmony 执行\nexecuteGeneratorFn(function* () {\n    var result = yield request.bind(null, 'http://www.baidu.com', {userId: 1});\n    console.log(result);\n});\n\nexecuteGeneratorFn(function* () {\n    var userList = [];\n    for (var param of [{userId: 1}, {userId: 2}]) {\n        userList.push(yield request.bind(null, 'http://www.baidu.com', param));\n    }\n    console.log(userList);\n});\n\nfunction request(url, params, callback) {\n    setTimeout(() => callback('request result: ' + Math.random()), 3000);\n}\n\nfunction executeGeneratorFn(genFn, callback) {\n    var iterator = genFn();\n    next();\n\n    function next() {\n        try {\n            execute(iterator.next(arguments));\n        } catch (e) {\n            callback instanceof Function && callback(e);\n        }\n    }\n\n    function execute(nextValue) {\n        if (!nextValue.done) {\n            nextValue.value(next);\n        } else {\n            callback instanceof Function && callback(null, nextValue.value);\n        }\n    }\n}\n```\n","slug":"生成器（ generator ）","published":1,"updated":"2016-06-15T10:47:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy035001k0407tt55vvpg","content":"<h3 id=\"什么是-generator-？\"><a href=\"#什么是-generator-？\" class=\"headerlink\" title=\"什么是 generator ？\"></a>什么是 generator ？</h3><p>可以暂停（ pause ）和唤醒（ resume ）的函数。<br><a id=\"more\"></a></p>\n<h3 id=\"实现一个迭代器\"><a href=\"#实现一个迭代器\" class=\"headerlink\" title=\"实现一个迭代器\"></a>实现一个迭代器</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> a <span class=\"keyword\">of</span> [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>]) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> a + <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">5</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 下面的 for 循环输出：</span></div><div class=\"line\"><span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> b <span class=\"keyword\">of</span> gen()) &#123;</div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(b));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 2, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 3, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 4, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 5, done: true&#125;</span></div><div class=\"line\"></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen()])); <span class=\"comment\">// 输出： [2, 3, 4]</span></div></pre></td></tr></table></figure>\n<h3 id=\"创建-generator-的方式\"><a href=\"#创建-generator-的方式\" class=\"headerlink\" title=\"创建 generator 的方式\"></a>创建 generator 的方式</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 第一种</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">genFunc</span>(<span class=\"params\"></span>) </span>&#123; ··· &#125;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = genFunc();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第二种</span></div><div class=\"line\"><span class=\"keyword\">const</span> genFunc = <span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123; ··· &#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = genFunc();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第三种</span></div><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123;</div><div class=\"line\">    * generatorMethod() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = obj.generatorMethod();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第四种</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyClass</span> </span>&#123;</div><div class=\"line\">    * generatorMethod() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> myInst = <span class=\"keyword\">new</span> MyClass();</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = myInst.generatorMethod();</div></pre></td></tr></table></figure>\n<h3 id=\"generator-嵌套：-yield\"><a href=\"#generator-嵌套：-yield\" class=\"headerlink\" title=\"generator 嵌套： yield*\"></a>generator 嵌套： yield*</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">2</span>;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'result of gen1'</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen2</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// `yield* gen1()` 类似于</span></div><div class=\"line\">    <span class=\"comment\">// for (let x of gen1()) &#123;</span></div><div class=\"line\">    <span class=\"comment\">//      yield x;</span></div><div class=\"line\">    <span class=\"comment\">// &#125;</span></div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">yield</span>* gen1()));</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">4</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// 'result of gen1'</span></div><div class=\"line\"><span class=\"comment\">// [1, 2, 3, 4]</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen2()]));</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen3</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">yield</span>* [<span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">4</span>;</div><div class=\"line\">&#125;</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen3()])); <span class=\"comment\">// 输出： [1, 2, 3, 4]</span></div></pre></td></tr></table></figure>\n<h3 id=\"next-传值\"><a href=\"#next-传值\" class=\"headerlink\" title=\"next 传值\"></a>next 传值</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">yield</span>));</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> it = gen1();</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// outer value</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: true&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next(<span class=\"string\">'outer value'</span>)));</div></pre></td></tr></table></figure>\n<h3 id=\"return-外部终止-generator\"><a href=\"#return-外部终止-generator\" class=\"headerlink\" title=\"return() 外部终止 generator\"></a><code>return()</code> 外部终止 generator</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    print(<span class=\"string\">'a'</span>);</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\">    print(<span class=\"string\">'b'</span>);</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">2</span>;</div><div class=\"line\">    print(<span class=\"string\">'c'</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// a</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 1, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 'result', done: true&#125;</span></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen1();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.return(<span class=\"string\">'result'</span>)));</div></pre></td></tr></table></figure>\n<h3 id=\"throw-抛出异常\"><a href=\"#throw-抛出异常\" class=\"headerlink\" title=\"throw() 抛出异常\"></a><code>throw()</code> 抛出异常</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        print(<span class=\"string\">'Started'</span>);</div><div class=\"line\">        <span class=\"keyword\">yield</span>;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;</div><div class=\"line\">        print(<span class=\"string\">'Caught: '</span> + error.message);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return result'</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// Started</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// Caught: error</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 'return result', done: true&#125;</span></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.throw(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'error'</span>))));</div></pre></td></tr></table></figure>\n<h3 id=\"很有有趣也有用的例子\"><a href=\"#很有有趣也有用的例子\" class=\"headerlink\" title=\"很有有趣也有用的例子\"></a>很有有趣也有用的例子</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// for 循环延迟执行</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn1</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (x === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">continue</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn2</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x + <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn3</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x / <span class=\"number\">2</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> newArr = [...fn3(fn2(fn1([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>])))];</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(newArr)); <span class=\"comment\">// [1, 1.5, 2]</span></div></pre></td></tr></table></figure>\n<h3 id=\"generator-类图\"><a href=\"#generator-类图\" class=\"headerlink\" title=\"generator 类图\"></a>generator 类图</h3><p>规范里面有一张<a href=\"http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects\" target=\"_blank\" rel=\"external\">很大的图</a>，有点复杂。所以，看一张小图：</p>\n<p><img src=\"./imgs/9.jpg\" alt=\"\"></p>\n<p>说明：</p>\n<ul>\n<li>空心箭头表示两个对象的继承关系。换句话说，从 x 指向 y 的箭头意味着 <code>Object.getPrototypeOf(x) === y</code> 。</li>\n<li>圆括号表示当前被包起来的对象是存在的，但是不能通过全局变量来访问。</li>\n<li>带有 <code>instanceof</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x instanceof y</code> 。<ul>\n<li><code>o instanceof C</code> 实际上就相当于 <code>C.prototype.isPrototypeOf(o)</code></li>\n</ul>\n</li>\n<li>带有 <code>prototype</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x.prototype === y</code> 。</li>\n</ul>\n<p>此图看完可能没有直观的感受，看两个例子先。</p>\n<p>第一个， generator 函数表现得很像一个构造函数，因为通过 <code>new</code> 调用和直接调用，两者的效果是一样的，都返回 generator 对象，如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; function* g() &#123;&#125;</div><div class=\"line\">&gt; g.prototype.hello = function () &#123; return &apos;hi!&apos;&#125;;</div><div class=\"line\">&gt; let obj = g();</div><div class=\"line\">&gt; obj instanceof g</div><div class=\"line\">true</div><div class=\"line\">&gt; obj.hello()</div><div class=\"line\">&apos;hi!&apos;</div></pre></td></tr></table></figure>\n<p>第二个，如果想给所有的 generator 对象添加一个方法，就可以放在 <code>(Generator).prototype</code> 上面，如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; let Generator_prototype = Object.getPrototypeOf(function* () &#123;&#125;).prototype;</div><div class=\"line\">&gt; Generator_prototype.hello = function () &#123; return &apos;hi!&apos;&#125;;</div><div class=\"line\">&gt; let generatorObject = (function* () &#123;&#125;)();</div><div class=\"line\">&gt; generatorObject.hello()</div><div class=\"line\">&apos;hi!&apos;</div></pre></td></tr></table></figure>\n<p>generator 内部的 <code>this</code> 是有一些猫腻的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\"><span class=\"meta\">    'use strict'</span>; <span class=\"comment\">// just in case</span></div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"keyword\">this</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Retrieve the yielded value via destructuring</span></div><div class=\"line\"><span class=\"keyword\">let</span> [functionThis] = gen1();</div><div class=\"line\"><span class=\"built_in\">console</span>.log(functionThis); <span class=\"comment\">// undefined</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123; <span class=\"attr\">method</span>: gen1 &#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> [methodThis] = obj.method();</div><div class=\"line\"><span class=\"built_in\">console</span>.log(methodThis === obj); <span class=\"comment\">// true</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen2</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">this</span>); <span class=\"comment\">// ReferenceError</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">new</span> gen2();</div></pre></td></tr></table></figure>\n<h3 id=\"一个简单的类似于-tj-co-库的东西\"><a href=\"#一个简单的类似于-tj-co-库的东西\" class=\"headerlink\" title=\"一个简单的类似于 tj co 库的东西\"></a>一个简单的类似于 tj co 库的东西</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 此段代码使用 node --harmony 执行</span></div><div class=\"line\">executeGeneratorFn(<span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> result = <span class=\"keyword\">yield</span> request.bind(<span class=\"literal\">null</span>, <span class=\"string\">'http://www.baidu.com'</span>, &#123;<span class=\"attr\">userId</span>: <span class=\"number\">1</span>&#125;);</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(result);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">executeGeneratorFn(<span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> userList = [];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> param <span class=\"keyword\">of</span> [&#123;<span class=\"attr\">userId</span>: <span class=\"number\">1</span>&#125;, &#123;<span class=\"attr\">userId</span>: <span class=\"number\">2</span>&#125;]) &#123;</div><div class=\"line\">        userList.push(<span class=\"keyword\">yield</span> request.bind(<span class=\"literal\">null</span>, <span class=\"string\">'http://www.baidu.com'</span>, param));</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(userList);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">request</span>(<span class=\"params\">url, params, callback</span>) </span>&#123;</div><div class=\"line\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> callback(<span class=\"string\">'request result: '</span> + <span class=\"built_in\">Math</span>.random()), <span class=\"number\">3000</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">executeGeneratorFn</span>(<span class=\"params\">genFn, callback</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> iterator = genFn();</div><div class=\"line\">    next();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">next</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            execute(iterator.next(<span class=\"built_in\">arguments</span>));</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (e) &#123;</div><div class=\"line\">            callback <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Function</span> &amp;&amp; callback(e);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execute</span>(<span class=\"params\">nextValue</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!nextValue.done) &#123;</div><div class=\"line\">            nextValue.value(next);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            callback <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Function</span> &amp;&amp; callback(<span class=\"literal\">null</span>, nextValue.value);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n","excerpt":"<h3 id=\"什么是-generator-？\"><a href=\"#什么是-generator-？\" class=\"headerlink\" title=\"什么是 generator ？\"></a>什么是 generator ？</h3><p>可以暂停（ pause ）和唤醒（ resume ）的函数。<br>","more":"</p>\n<h3 id=\"实现一个迭代器\"><a href=\"#实现一个迭代器\" class=\"headerlink\" title=\"实现一个迭代器\"></a>实现一个迭代器</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> a <span class=\"keyword\">of</span> [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>]) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> a + <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">5</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 下面的 for 循环输出：</span></div><div class=\"line\"><span class=\"comment\">// 2</span></div><div class=\"line\"><span class=\"comment\">// 3</span></div><div class=\"line\"><span class=\"comment\">// 4</span></div><div class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> b <span class=\"keyword\">of</span> gen()) &#123;</div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(b));</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 2, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 3, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 4, done: false&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next())); <span class=\"comment\">// 输出： &#123;value: 5, done: true&#125;</span></div><div class=\"line\"></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen()])); <span class=\"comment\">// 输出： [2, 3, 4]</span></div></pre></td></tr></table></figure>\n<h3 id=\"创建-generator-的方式\"><a href=\"#创建-generator-的方式\" class=\"headerlink\" title=\"创建 generator 的方式\"></a>创建 generator 的方式</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 第一种</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">genFunc</span>(<span class=\"params\"></span>) </span>&#123; ··· &#125;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = genFunc();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第二种</span></div><div class=\"line\"><span class=\"keyword\">const</span> genFunc = <span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123; ··· &#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = genFunc();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第三种</span></div><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123;</div><div class=\"line\">    * generatorMethod() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = obj.generatorMethod();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 第四种</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyClass</span> </span>&#123;</div><div class=\"line\">    * generatorMethod() &#123;</div><div class=\"line\">        ···</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> myInst = <span class=\"keyword\">new</span> MyClass();</div><div class=\"line\"><span class=\"keyword\">let</span> genObj = myInst.generatorMethod();</div></pre></td></tr></table></figure>\n<h3 id=\"generator-嵌套：-yield\"><a href=\"#generator-嵌套：-yield\" class=\"headerlink\" title=\"generator 嵌套： yield*\"></a>generator 嵌套： yield*</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">2</span>;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">3</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'result of gen1'</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen2</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">// `yield* gen1()` 类似于</span></div><div class=\"line\">    <span class=\"comment\">// for (let x of gen1()) &#123;</span></div><div class=\"line\">    <span class=\"comment\">//      yield x;</span></div><div class=\"line\">    <span class=\"comment\">// &#125;</span></div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">yield</span>* gen1()));</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">4</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// 'result of gen1'</span></div><div class=\"line\"><span class=\"comment\">// [1, 2, 3, 4]</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen2()]));</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen3</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">yield</span>* [<span class=\"number\">2</span>, <span class=\"number\">3</span>];</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">4</span>;</div><div class=\"line\">&#125;</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify([...gen3()])); <span class=\"comment\">// 输出： [1, 2, 3, 4]</span></div></pre></td></tr></table></figure>\n<h3 id=\"next-传值\"><a href=\"#next-传值\" class=\"headerlink\" title=\"next 传值\"></a>next 传值</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    print(<span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">yield</span>));</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> it = gen1();</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// outer value</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: true&#125;</span></div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next(<span class=\"string\">'outer value'</span>)));</div></pre></td></tr></table></figure>\n<h3 id=\"return-外部终止-generator\"><a href=\"#return-外部终止-generator\" class=\"headerlink\" title=\"return() 外部终止 generator\"></a><code>return()</code> 外部终止 generator</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    print(<span class=\"string\">'a'</span>);</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">1</span>;</div><div class=\"line\">    print(<span class=\"string\">'b'</span>);</div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"number\">2</span>;</div><div class=\"line\">    print(<span class=\"string\">'c'</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// a</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 1, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 'result', done: true&#125;</span></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen1();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.return(<span class=\"string\">'result'</span>)));</div></pre></td></tr></table></figure>\n<h3 id=\"throw-抛出异常\"><a href=\"#throw-抛出异常\" class=\"headerlink\" title=\"throw() 抛出异常\"></a><code>throw()</code> 抛出异常</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">        print(<span class=\"string\">'Started'</span>);</div><div class=\"line\">        <span class=\"keyword\">yield</span>;</div><div class=\"line\">    &#125; <span class=\"keyword\">catch</span> (error) &#123;</div><div class=\"line\">        print(<span class=\"string\">'Caught: '</span> + error.message);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">'return result'</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">// 输出：</span></div><div class=\"line\"><span class=\"comment\">// Started</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: undefined, done: false&#125;</span></div><div class=\"line\"><span class=\"comment\">// Caught: error</span></div><div class=\"line\"><span class=\"comment\">// &#123;value: 'return result', done: true&#125;</span></div><div class=\"line\"><span class=\"keyword\">let</span> it = gen();</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.next()));</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(it.throw(<span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(<span class=\"string\">'error'</span>))));</div></pre></td></tr></table></figure>\n<h3 id=\"很有有趣也有用的例子\"><a href=\"#很有有趣也有用的例子\" class=\"headerlink\" title=\"很有有趣也有用的例子\"></a>很有有趣也有用的例子</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// for 循环延迟执行</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn1</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (x === <span class=\"number\">0</span>) &#123;</div><div class=\"line\">            <span class=\"keyword\">continue</span>;</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn2</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x + <span class=\"number\">1</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">fn3</span>(<span class=\"params\">iterable</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> x <span class=\"keyword\">of</span> iterable) &#123;</div><div class=\"line\">        <span class=\"keyword\">yield</span> x / <span class=\"number\">2</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">let</span> newArr = [...fn3(fn2(fn1([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>])))];</div><div class=\"line\">print(<span class=\"built_in\">JSON</span>.stringify(newArr)); <span class=\"comment\">// [1, 1.5, 2]</span></div></pre></td></tr></table></figure>\n<h3 id=\"generator-类图\"><a href=\"#generator-类图\" class=\"headerlink\" title=\"generator 类图\"></a>generator 类图</h3><p>规范里面有一张<a href=\"http://www.ecma-international.org/ecma-262/6.0/#sec-generatorfunction-objects\">很大的图</a>，有点复杂。所以，看一张小图：</p>\n<p><img src=\"./imgs/9.jpg\" alt=\"\"></p>\n<p>说明：</p>\n<ul>\n<li>空心箭头表示两个对象的继承关系。换句话说，从 x 指向 y 的箭头意味着 <code>Object.getPrototypeOf(x) === y</code> 。</li>\n<li>圆括号表示当前被包起来的对象是存在的，但是不能通过全局变量来访问。</li>\n<li>带有 <code>instanceof</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x instanceof y</code> 。<ul>\n<li><code>o instanceof C</code> 实际上就相当于 <code>C.prototype.isPrototypeOf(o)</code></li>\n</ul>\n</li>\n<li>带有 <code>prototype</code> 字眼的箭头如果从 x 指向 y ，就表明 <code>x.prototype === y</code> 。</li>\n</ul>\n<p>此图看完可能没有直观的感受，看两个例子先。</p>\n<p>第一个， generator 函数表现得很像一个构造函数，因为通过 <code>new</code> 调用和直接调用，两者的效果是一样的，都返回 generator 对象，如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; function* g() &#123;&#125;</div><div class=\"line\">&gt; g.prototype.hello = function () &#123; return &apos;hi!&apos;&#125;;</div><div class=\"line\">&gt; let obj = g();</div><div class=\"line\">&gt; obj instanceof g</div><div class=\"line\">true</div><div class=\"line\">&gt; obj.hello()</div><div class=\"line\">&apos;hi!&apos;</div></pre></td></tr></table></figure>\n<p>第二个，如果想给所有的 generator 对象添加一个方法，就可以放在 <code>(Generator).prototype</code> 上面，如下所示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; let Generator_prototype = Object.getPrototypeOf(function* () &#123;&#125;).prototype;</div><div class=\"line\">&gt; Generator_prototype.hello = function () &#123; return &apos;hi!&apos;&#125;;</div><div class=\"line\">&gt; let generatorObject = (function* () &#123;&#125;)();</div><div class=\"line\">&gt; generatorObject.hello()</div><div class=\"line\">&apos;hi!&apos;</div></pre></td></tr></table></figure>\n<p>generator 内部的 <code>this</code> 是有一些猫腻的：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen1</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\"><span class=\"meta\">    'use strict'</span>; <span class=\"comment\">// just in case</span></div><div class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"keyword\">this</span>;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// Retrieve the yielded value via destructuring</span></div><div class=\"line\"><span class=\"keyword\">let</span> [functionThis] = gen1();</div><div class=\"line\"><span class=\"built_in\">console</span>.log(functionThis); <span class=\"comment\">// undefined</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">let</span> obj = &#123; <span class=\"attr\">method</span>: gen1 &#125;;</div><div class=\"line\"><span class=\"keyword\">let</span> [methodThis] = obj.method();</div><div class=\"line\"><span class=\"built_in\">console</span>.log(methodThis === obj); <span class=\"comment\">// true</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span>* <span class=\"title\">gen2</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"keyword\">this</span>); <span class=\"comment\">// ReferenceError</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">new</span> gen2();</div></pre></td></tr></table></figure>\n<h3 id=\"一个简单的类似于-tj-co-库的东西\"><a href=\"#一个简单的类似于-tj-co-库的东西\" class=\"headerlink\" title=\"一个简单的类似于 tj co 库的东西\"></a>一个简单的类似于 tj co 库的东西</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 此段代码使用 node --harmony 执行</span></div><div class=\"line\">executeGeneratorFn(<span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> result = <span class=\"keyword\">yield</span> request.bind(<span class=\"literal\">null</span>, <span class=\"string\">'http://www.baidu.com'</span>, &#123;<span class=\"attr\">userId</span>: <span class=\"number\">1</span>&#125;);</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(result);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\">executeGeneratorFn(<span class=\"function\"><span class=\"keyword\">function</span>* (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> userList = [];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> param <span class=\"keyword\">of</span> [&#123;<span class=\"attr\">userId</span>: <span class=\"number\">1</span>&#125;, &#123;<span class=\"attr\">userId</span>: <span class=\"number\">2</span>&#125;]) &#123;</div><div class=\"line\">        userList.push(<span class=\"keyword\">yield</span> request.bind(<span class=\"literal\">null</span>, <span class=\"string\">'http://www.baidu.com'</span>, param));</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"built_in\">console</span>.log(userList);</div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">request</span>(<span class=\"params\">url, params, callback</span>) </span>&#123;</div><div class=\"line\">    setTimeout(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> callback(<span class=\"string\">'request result: '</span> + <span class=\"built_in\">Math</span>.random()), <span class=\"number\">3000</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">executeGeneratorFn</span>(<span class=\"params\">genFn, callback</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> iterator = genFn();</div><div class=\"line\">    next();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">next</span>(<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">            execute(iterator.next(<span class=\"built_in\">arguments</span>));</div><div class=\"line\">        &#125; <span class=\"keyword\">catch</span> (e) &#123;</div><div class=\"line\">            callback <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Function</span> &amp;&amp; callback(e);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">execute</span>(<span class=\"params\">nextValue</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">if</span> (!nextValue.done) &#123;</div><div class=\"line\">            nextValue.value(next);</div><div class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">            callback <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Function</span> &amp;&amp; callback(<span class=\"literal\">null</span>, nextValue.value);</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"},{"title":"百度（EFE）前端框架学习笔记（ef）","date":"2015-05-31T16:00:00.000Z","_content":"\n官方 EF 学习资料：[ActionPanel](https://github.com/ecomfe/ef/blob/master/doc/ActionPanel.md)、[UIModel](https://github.com/ecomfe/ef/blob/master/doc/UIModel.md)、[UIView](https://github.com/ecomfe/ef/blob/master/doc/UIView.md)。\n<!-- more -->\n\n### UIView.js\n\n与 ESUI 结合的 `View` 基类。该类有一个主入口方法 enterDocument()，该函数在容器渲染完毕后触发，用于控制元素可见性及绑定事件等 DOM 操作。\n\n是 ESUI 中 View 类的子类。\n\n该类对应的实例上会有一个视图上下文对象（ view.viewContext ），此上下文对象会传递给每个子控件，也就是说每个子控件都会有一个 viewContext 属性。此上下文对象的详细信息参看[百度 EFE 前端框架学习笔记（esui）](https://github.com/yibuyisheng/blogs/issues/4)的 `ViewContext.js` 部分。\n\nenterDocument() 方法会调用 ESUI 的 main.init() 方法，初始化当前 UIView 实例所管辖的 container 部分，生成各种各样的控件等等。\n\n此类生成的实例上有一个很重要的事件属性 uiView.uiEvents，该属性有2种方式：\n\n* 以 `id:eventName` 为键，以处理函数为值，比如 `{'someId:click': function() {/* do something */}}`。\n* 以 `id` 为键，值为一个对象，对象中以 `eventName` 为键，处理函数为值，比如 `{someId: {eventName: function() {/* do something */}}}`。\n\n在此处声明的事件，运行时的 `this` 对象均是 `View` 实例，而非控件的实例。同时，在运行期，`UIView` 会克隆该属性，将其中所有的处理函数都进行一次 `bind`，将 `this` 指向自身，因此运行时的 `uiEvents` 与类声明时的不会相同。\n\n此类上的 bindEvents() 方法就会根据 uiEvents 指定的事件配置来给子控件绑定事件。\n\n### UIModel.js\n\n处理 ESUI 场景的 `Model` 实现。 UIModel 继承自 er 的 Model。\n\nUIModel 添加了 formatter 属性，用于对日期进行格式化。同时增加了一些操作数据的方法：set() 、 fill() 、 getPart()。\n\n### ActionPanel.js\n\n用于加载子Action的面板控件。继承自 esui 的 Panel 类，不过没有 setContent() 方法。\n\n### 小技巧\n\n```js\nfunction getControl(node) {\n    var controls = require('er/controller').currentAction.view.viewContext.getControls();\n    for (var k in controls) {\n        var control = controls[k];\n        if (control.main === node) {\n            return control;\n        }\n    }\n}\n```\n\n该函数可以根据节点找到这个节点对应的控件对象，对debug有一定帮助。\n","source":"_posts/百度 EFE 前端框架学习笔记（ef）.md","raw":"---\ntitle: 百度（EFE）前端框架学习笔记（ef）\ndate: 2015-06-01\ntags:\n- JavaScript\n---\n\n官方 EF 学习资料：[ActionPanel](https://github.com/ecomfe/ef/blob/master/doc/ActionPanel.md)、[UIModel](https://github.com/ecomfe/ef/blob/master/doc/UIModel.md)、[UIView](https://github.com/ecomfe/ef/blob/master/doc/UIView.md)。\n<!-- more -->\n\n### UIView.js\n\n与 ESUI 结合的 `View` 基类。该类有一个主入口方法 enterDocument()，该函数在容器渲染完毕后触发，用于控制元素可见性及绑定事件等 DOM 操作。\n\n是 ESUI 中 View 类的子类。\n\n该类对应的实例上会有一个视图上下文对象（ view.viewContext ），此上下文对象会传递给每个子控件，也就是说每个子控件都会有一个 viewContext 属性。此上下文对象的详细信息参看[百度 EFE 前端框架学习笔记（esui）](https://github.com/yibuyisheng/blogs/issues/4)的 `ViewContext.js` 部分。\n\nenterDocument() 方法会调用 ESUI 的 main.init() 方法，初始化当前 UIView 实例所管辖的 container 部分，生成各种各样的控件等等。\n\n此类生成的实例上有一个很重要的事件属性 uiView.uiEvents，该属性有2种方式：\n\n* 以 `id:eventName` 为键，以处理函数为值，比如 `{'someId:click': function() {/* do something */}}`。\n* 以 `id` 为键，值为一个对象，对象中以 `eventName` 为键，处理函数为值，比如 `{someId: {eventName: function() {/* do something */}}}`。\n\n在此处声明的事件，运行时的 `this` 对象均是 `View` 实例，而非控件的实例。同时，在运行期，`UIView` 会克隆该属性，将其中所有的处理函数都进行一次 `bind`，将 `this` 指向自身，因此运行时的 `uiEvents` 与类声明时的不会相同。\n\n此类上的 bindEvents() 方法就会根据 uiEvents 指定的事件配置来给子控件绑定事件。\n\n### UIModel.js\n\n处理 ESUI 场景的 `Model` 实现。 UIModel 继承自 er 的 Model。\n\nUIModel 添加了 formatter 属性，用于对日期进行格式化。同时增加了一些操作数据的方法：set() 、 fill() 、 getPart()。\n\n### ActionPanel.js\n\n用于加载子Action的面板控件。继承自 esui 的 Panel 类，不过没有 setContent() 方法。\n\n### 小技巧\n\n```js\nfunction getControl(node) {\n    var controls = require('er/controller').currentAction.view.viewContext.getControls();\n    for (var k in controls) {\n        var control = controls[k];\n        if (control.main === node) {\n            return control;\n        }\n    }\n}\n```\n\n该函数可以根据节点找到这个节点对应的控件对象，对debug有一定帮助。\n","slug":"百度 EFE 前端框架学习笔记（ef）","published":1,"updated":"2016-06-15T10:47:50.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy03c001m04073kobhrcc","content":"<p>官方 EF 学习资料：<a href=\"https://github.com/ecomfe/ef/blob/master/doc/ActionPanel.md\" target=\"_blank\" rel=\"external\">ActionPanel</a>、<a href=\"https://github.com/ecomfe/ef/blob/master/doc/UIModel.md\" target=\"_blank\" rel=\"external\">UIModel</a>、<a href=\"https://github.com/ecomfe/ef/blob/master/doc/UIView.md\" target=\"_blank\" rel=\"external\">UIView</a>。<br><a id=\"more\"></a></p>\n<h3 id=\"UIView-js\"><a href=\"#UIView-js\" class=\"headerlink\" title=\"UIView.js\"></a>UIView.js</h3><p>与 ESUI 结合的 <code>View</code> 基类。该类有一个主入口方法 enterDocument()，该函数在容器渲染完毕后触发，用于控制元素可见性及绑定事件等 DOM 操作。</p>\n<p>是 ESUI 中 View 类的子类。</p>\n<p>该类对应的实例上会有一个视图上下文对象（ view.viewContext ），此上下文对象会传递给每个子控件，也就是说每个子控件都会有一个 viewContext 属性。此上下文对象的详细信息参看<a href=\"https://github.com/yibuyisheng/blogs/issues/4\" target=\"_blank\" rel=\"external\">百度 EFE 前端框架学习笔记（esui）</a>的 <code>ViewContext.js</code> 部分。</p>\n<p>enterDocument() 方法会调用 ESUI 的 main.init() 方法，初始化当前 UIView 实例所管辖的 container 部分，生成各种各样的控件等等。</p>\n<p>此类生成的实例上有一个很重要的事件属性 uiView.uiEvents，该属性有2种方式：</p>\n<ul>\n<li>以 <code>id:eventName</code> 为键，以处理函数为值，比如 <code>{&#39;someId:click&#39;: function() {/* do something */}}</code>。</li>\n<li>以 <code>id</code> 为键，值为一个对象，对象中以 <code>eventName</code> 为键，处理函数为值，比如 <code>{someId: {eventName: function() {/* do something */}}}</code>。</li>\n</ul>\n<p>在此处声明的事件，运行时的 <code>this</code> 对象均是 <code>View</code> 实例，而非控件的实例。同时，在运行期，<code>UIView</code> 会克隆该属性，将其中所有的处理函数都进行一次 <code>bind</code>，将 <code>this</code> 指向自身，因此运行时的 <code>uiEvents</code> 与类声明时的不会相同。</p>\n<p>此类上的 bindEvents() 方法就会根据 uiEvents 指定的事件配置来给子控件绑定事件。</p>\n<h3 id=\"UIModel-js\"><a href=\"#UIModel-js\" class=\"headerlink\" title=\"UIModel.js\"></a>UIModel.js</h3><p>处理 ESUI 场景的 <code>Model</code> 实现。 UIModel 继承自 er 的 Model。</p>\n<p>UIModel 添加了 formatter 属性，用于对日期进行格式化。同时增加了一些操作数据的方法：set() 、 fill() 、 getPart()。</p>\n<h3 id=\"ActionPanel-js\"><a href=\"#ActionPanel-js\" class=\"headerlink\" title=\"ActionPanel.js\"></a>ActionPanel.js</h3><p>用于加载子Action的面板控件。继承自 esui 的 Panel 类，不过没有 setContent() 方法。</p>\n<h3 id=\"小技巧\"><a href=\"#小技巧\" class=\"headerlink\" title=\"小技巧\"></a>小技巧</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getControl</span>(<span class=\"params\">node</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> controls = <span class=\"built_in\">require</span>(<span class=\"string\">'er/controller'</span>).currentAction.view.viewContext.getControls();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> controls) &#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> control = controls[k];</div><div class=\"line\">        <span class=\"keyword\">if</span> (control.main === node) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> control;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该函数可以根据节点找到这个节点对应的控件对象，对debug有一定帮助。</p>\n","excerpt":"<p>官方 EF 学习资料：<a href=\"https://github.com/ecomfe/ef/blob/master/doc/ActionPanel.md\">ActionPanel</a>、<a href=\"https://github.com/ecomfe/ef/blob/master/doc/UIModel.md\">UIModel</a>、<a href=\"https://github.com/ecomfe/ef/blob/master/doc/UIView.md\">UIView</a>。<br>","more":"</p>\n<h3 id=\"UIView-js\"><a href=\"#UIView-js\" class=\"headerlink\" title=\"UIView.js\"></a>UIView.js</h3><p>与 ESUI 结合的 <code>View</code> 基类。该类有一个主入口方法 enterDocument()，该函数在容器渲染完毕后触发，用于控制元素可见性及绑定事件等 DOM 操作。</p>\n<p>是 ESUI 中 View 类的子类。</p>\n<p>该类对应的实例上会有一个视图上下文对象（ view.viewContext ），此上下文对象会传递给每个子控件，也就是说每个子控件都会有一个 viewContext 属性。此上下文对象的详细信息参看<a href=\"https://github.com/yibuyisheng/blogs/issues/4\">百度 EFE 前端框架学习笔记（esui）</a>的 <code>ViewContext.js</code> 部分。</p>\n<p>enterDocument() 方法会调用 ESUI 的 main.init() 方法，初始化当前 UIView 实例所管辖的 container 部分，生成各种各样的控件等等。</p>\n<p>此类生成的实例上有一个很重要的事件属性 uiView.uiEvents，该属性有2种方式：</p>\n<ul>\n<li>以 <code>id:eventName</code> 为键，以处理函数为值，比如 <code>{&#39;someId:click&#39;: function() {/* do something */}}</code>。</li>\n<li>以 <code>id</code> 为键，值为一个对象，对象中以 <code>eventName</code> 为键，处理函数为值，比如 <code>{someId: {eventName: function() {/* do something */}}}</code>。</li>\n</ul>\n<p>在此处声明的事件，运行时的 <code>this</code> 对象均是 <code>View</code> 实例，而非控件的实例。同时，在运行期，<code>UIView</code> 会克隆该属性，将其中所有的处理函数都进行一次 <code>bind</code>，将 <code>this</code> 指向自身，因此运行时的 <code>uiEvents</code> 与类声明时的不会相同。</p>\n<p>此类上的 bindEvents() 方法就会根据 uiEvents 指定的事件配置来给子控件绑定事件。</p>\n<h3 id=\"UIModel-js\"><a href=\"#UIModel-js\" class=\"headerlink\" title=\"UIModel.js\"></a>UIModel.js</h3><p>处理 ESUI 场景的 <code>Model</code> 实现。 UIModel 继承自 er 的 Model。</p>\n<p>UIModel 添加了 formatter 属性，用于对日期进行格式化。同时增加了一些操作数据的方法：set() 、 fill() 、 getPart()。</p>\n<h3 id=\"ActionPanel-js\"><a href=\"#ActionPanel-js\" class=\"headerlink\" title=\"ActionPanel.js\"></a>ActionPanel.js</h3><p>用于加载子Action的面板控件。继承自 esui 的 Panel 类，不过没有 setContent() 方法。</p>\n<h3 id=\"小技巧\"><a href=\"#小技巧\" class=\"headerlink\" title=\"小技巧\"></a>小技巧</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getControl</span>(<span class=\"params\">node</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> controls = <span class=\"built_in\">require</span>(<span class=\"string\">'er/controller'</span>).currentAction.view.viewContext.getControls();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> controls) &#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> control = controls[k];</div><div class=\"line\">        <span class=\"keyword\">if</span> (control.main === node) &#123;</div><div class=\"line\">            <span class=\"keyword\">return</span> control;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>该函数可以根据节点找到这个节点对应的控件对象，对debug有一定帮助。</p>"},{"title":"百度 EFE 前端框架学习笔记（er）","date":"2015-05-28T16:00:00.000Z","_content":"\n首先上一张图：\n\n![](https://raw.githubusercontent.com/ecomfe/er/master/doc/asset/er-overview.png)\n<!-- more -->\n\n### ajax.js\n\n此模块返回一个 ajax 对象，用于发送 ajax 请求，最主要的就是 request 方法。同时该对象上也会挂载 Ajax 构造函数。\n\n返回的 ajax 对象上会带有一个钩子属性（ hooks ），钩子属性上包含的类容可能有：\n\n* serializeData()： 将数据序列化为适合发送 http 请求的格式\n* serializeArray()：序列化一组数据，以便发送 http 请求\n* beforeExecute()：在请求发送之前调用\n* beforeCreate()：在创建 XMLHttpRequest 对象之前调用，如果该函数返回 true，则会返回一个假的 promise 对象\n* afterReceive()：在接受到响应的时候调用，此时，返回的数据都还未做解析处理\n* afterParse()：响应的数据已经经过解析处理了\n* beforeSend()：在 xhr 对象的 open() 调用之后，send 调用之前调用\n\nrequest() 函数只有一个 options 对象参数，其属性如下：\n\n* url：请求 url\n* method：请求方法，POST 、 GET\n* data：请求附带的数据对象\n* xhrFields：给 xhr 对象上混入的属性\n* dataType：返回的数据类型，比如，如果是 `json` 的话，则会对 xhr.responseText 做 JSON 解析\n* contentType：请求 MIME 类型，默认是 application/x-www-form-urlencoded，仅在 method 为非 GET 方式的时候有效\n\nrequest() 函数的 options 参数上还可能混入其他一些参数，这些参数都是通过 xhr.config 来配置的，是 ajax 对象的全局配置，这些属性包括：\n\n* cache：如果为 false，则会在请求的 url 后面加上时间戳参数\n* timeout：如果 timeout 大于0，则会有请求超时。如果发生了超时，则会触发 ajax 对象的 timeout 事件\n* charset：跟在 http contentType 后面的 charset，例如：application/x-www-form-urlencoded;charset=UTF-8\n\najax 对象上除了 request 方法，还有如下一些方法：\n\n* get()：发送 GET 请求的简短方法\n* getJSON()：用 GET 请求获取 JSON 数据\n* post()：发送 post 请求\n* log()：发送前端日志信息，不保证成功，没有回调\n\n### Action.js\n\nAction 类，用于构造 action 对象。action 代表一种动作，比如页面跳转、鼠标事件、键盘事件等，都可以产生一个 action。\n\naction 上会附着 model 和 view，进入 action 的时候，会先去加载 model 指定的数据，然后根据拿到的数据来渲染 view 指定的视图。\n\n任何一个有 enter() 方法的对象都可作为 action 对象。\n\nenter() 方法开启了 action 的生命周期，在 action 的生命周期中，会触发如下事件：\n\n* enter：action 生命周期开始了\n* beforemodelload：action 上的 model（ action.model ） 加载之前触发\n* modelloaded：model 加载完成\n* beforerender：视图渲染之前\n* rendered：视图渲染完成\n* entercomplete：action 完成启动\n* beforeleave：离开 action 之前\n* leave：离开 action 之后，销毁注册在 action 上所有事件之前触发\n\naction 生命周期相关的一些方法：\n\n* enter()：action 入口函数\n* forwardToView()：转入 view 处理流程\n* leave()：离开 action，销毁 action 上的所有事件\n* reload()：重加载当前 action\n\n### Model.js\n\nMVC 中的 Model，主要用于从后端取数据，然后提供一些方法管理取到的数据。其中 load() 方法用于取数据，该方法会根据当前 model 对象上的数据源对象（ model.datasource ）去后端取数据。\n\n数据源是对数据一系列配置，其中保存了多个数据的获取函数，有以下方式：\n\n* 单一数据源配置\n\n    如果`datasource`是一个函数，则认为该函数是一个数据获取函数，\n    执行该函数，并把返回值按照一个对象放到当前 model 中\n    ```js\n    // 配置从指定的URL获取数据\n    datasource = require('./datasource').remote('/model/list')\n    ```\n\n* 并发请求数据\n\n    通过一个对象配置并发的数据获取。对象中每一个属性对应一个获取函数，\n    当数据获取后，会调用 `this.set(name, result)`，以属性名为键值添加\n    ```js\n    // 并发请求多个URL\n    datasource = {\n        'list': require('./datasource').remote('/model/list'),\n        'config': require('./datasource').constant('listConfig')\n    };\n    ```\n\n* 串行请求数据\n\n    通过一个数组配置并发的数据获取，数组中包含对象。将按照数组的顺序，\n    依次加载每一个对象（对象中的各属性是并发）\n    ```js\n    // 串行请求几个URL\n    datasource = [\n        { 'config': require('./datasource').constant('config') },\n        { 'list': require('./datasource').remote('/model/list') }\n    ];\n    ```\n    注意使用该方案时，各对象中的键**不要相同** ，否则会造成数据的覆盖\n\n* 嵌套配置\n\n    数组和对象可以相互嵌套，但有一个限制：\n\n    > 当一个对象中某个属性的值为普通对象（非数据加载配置项）或数组时，\n    > 该属性名将不起作用，即不会在 model 对象中存在以该属性名为键的值。\n\n    以下为一个串行和并行混杂的数据源配置：\n\n    ```js\n    datasource = {\n        'one': [getX, getY, getZ],\n        'two': getA,\n        'three': [\n            { 'four': getB },\n            { 'five': getC }\n        ]\n    };\n    ```\n\n    以上对象将在最终的 model 对象中生成 `two` 、 `four` 和 `five` 属性，而 `one` 、 `two` 和 `three` 因为属性值为普通对象或数组，将被忽略，其中`one`对应3个函数，将会把函数的返回值展开后添加到当前 model 同样，注意在嵌套的同时，各属性名**不要相同**，除非该属性名称没用，以避免出现数据相互覆盖的情况。\n\n* 通过数据获取配置项\n\n    上面所述的各种方案，均是数据获取配置项的简写，一个数据获取配置项的结构请参考 meta/DatasourceOption.js。因此，可以使用数据获取配置项来处理一些例外情况，比如并行加载2个对象，且2个对象均无对应的键值，需要完整添加到 `Model` 对象：\n\n    ```js\n    // 并行加载对象并完整添加到`Model`对象\n    datasource = [\n        {\n            retrieve: require('./datasource').remote('/model/list'),\n            dump: true\n        },\n        {\n            retrieve: require('./datasource').remote('/user/info'),\n            dump: true\n        }\n    ];\n    ```\n\n    对于不同的简写，其与数据获取配置项的对应关系如下：\n\n    - 普通的函数，映射为 `{ retrieve: {fn}, dump: true }`\n    - 对象中的一个属性，映射为 `{ retrieve: {fn}, name: {name} }`\n\n### View.js\n\n在 aciton 的生命周期中，加载完 model 数据之后，就会渲染视图了，此时调用的是 view.render() 方法，也就是说 view.render() 就是 view 的入口函数。er 的视图默认使用 [etpl](https://github.com/ecomfe/etpl) 模版引擎渲染。\n\n在指定容器内渲染出 html 结构之后，就会调用 view.enterDocument() 方法，用于控制元素可见性及绑定事件等DOM操作。比如利用 [esui](https://github.com/ecomfe/esui) 来初始化各种控件等等。\n\n### controller.js\n\n控制器类，负责 URL 与 Action 的调度，将 URL 映射到具体的一个 action 的执行上。\n\n可以使用 controller.registerAction() 方法来注册 action 配置，配置数据放在 controller.actionPathMapping 属性上（ path 到配置对象的映射 ）。每一个配置对象包含以下属性（ actionConfig ）：\n\n* path：该 action 对应的 url path\n* type：如果是一个字符串，则认为是此 action 的模块路径，否则认为就是一个模块对象，直接使用\n* movedTo：如果此属性存在，则会定向到此属性指定的 URL，类似于302\n* childActionOnly：如果为 true，就说明这个配置仅用于子 action\n* authority：权限配置，参考 meta.ActionConfig#authority 属性的说明\n* title：\n* documentTitle\n\n当路径改变时，会调用 controller.renderAction() 方法，此处渲染的是主 Action。渲染之前，会去 controller.actionPathMapping 上查找相应的 action 配置，如果找不到，则会跳转到404 url（404 url 可以通过 controller.setNotFoundLocation() 来设置）；如果没有找到404对应的 action 配置，则会 reject。判断完 action 配置是否存在之后，会检查是否有权限访问这个 url，如果没有权限，则会跳转到没有权限的页面（此页面可以通过 controller.setNoAuthorityLocation() 设置）。\n\n在 action 的渲染过程中，会伴随一个 actionContext 对象，里面包含如下属性：\n\n* url：此 action 对应的 url，是一个 URL 类的对象\n* container：容器元素的 id\n* isChildAction：是否是子 action\n* originalURL：之前的 url，在重定向、404、未授权的情况下，此属性会被设置，指代原始的那个 url\n* title：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）\n* args：有 actionContext 对象的所有属性（除 args 属性之外）\n* documentTitle：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）。此属性比 title 属性优先级低\n\ncontroller 对象有一个 eventBus 属性，该属性是 mini-event.EventBus 的实例。在此实例上，会有如下一系列事件触发：\n\n* forwardaction：加载 action 之前\n* actionmoved：action 重定向，类似于302过程\n* actionnotfound：没有找到当前 url 对应的 action 配置\n* permissiondenied：没有权限访问当前的 url\n* actionabort\n* actionfail：当前 url 没有对应的 action 模块实现，或者创建 action 失败\n* actionloaded：action 加载完成\n* leaveaction：之前的主 action 销毁\n* enteraction：进入 action 之前触发\n\n对于当前 url 加载到的 action 模块对象，如果是一个函数，则认为是一个 Action 构造函数，直接实例化；如果是一个包含 createRuntimeAction() 的对象，则认为这个 createRuntimeAction() 函数就是一个 Action 工厂函数，调用该工厂函数就可以创建出 action 对象；否则认为这个模块对象就是 action 实例。\n\n找到了当前 url 对应的主 action 之后，就要开始进入这个 action 了。在进入之前，需要销毁之前的主 action（调用 action.leave() 方法）。销毁之后，调用 action.enter()，进入当前 action。\n","source":"_posts/百度 EFE 前端框架学习笔记（er）.md","raw":"---\ntitle: 百度 EFE 前端框架学习笔记（er）\ndate: 2015-05-29\ntags:\n- JavaScript\n---\n\n首先上一张图：\n\n![](https://raw.githubusercontent.com/ecomfe/er/master/doc/asset/er-overview.png)\n<!-- more -->\n\n### ajax.js\n\n此模块返回一个 ajax 对象，用于发送 ajax 请求，最主要的就是 request 方法。同时该对象上也会挂载 Ajax 构造函数。\n\n返回的 ajax 对象上会带有一个钩子属性（ hooks ），钩子属性上包含的类容可能有：\n\n* serializeData()： 将数据序列化为适合发送 http 请求的格式\n* serializeArray()：序列化一组数据，以便发送 http 请求\n* beforeExecute()：在请求发送之前调用\n* beforeCreate()：在创建 XMLHttpRequest 对象之前调用，如果该函数返回 true，则会返回一个假的 promise 对象\n* afterReceive()：在接受到响应的时候调用，此时，返回的数据都还未做解析处理\n* afterParse()：响应的数据已经经过解析处理了\n* beforeSend()：在 xhr 对象的 open() 调用之后，send 调用之前调用\n\nrequest() 函数只有一个 options 对象参数，其属性如下：\n\n* url：请求 url\n* method：请求方法，POST 、 GET\n* data：请求附带的数据对象\n* xhrFields：给 xhr 对象上混入的属性\n* dataType：返回的数据类型，比如，如果是 `json` 的话，则会对 xhr.responseText 做 JSON 解析\n* contentType：请求 MIME 类型，默认是 application/x-www-form-urlencoded，仅在 method 为非 GET 方式的时候有效\n\nrequest() 函数的 options 参数上还可能混入其他一些参数，这些参数都是通过 xhr.config 来配置的，是 ajax 对象的全局配置，这些属性包括：\n\n* cache：如果为 false，则会在请求的 url 后面加上时间戳参数\n* timeout：如果 timeout 大于0，则会有请求超时。如果发生了超时，则会触发 ajax 对象的 timeout 事件\n* charset：跟在 http contentType 后面的 charset，例如：application/x-www-form-urlencoded;charset=UTF-8\n\najax 对象上除了 request 方法，还有如下一些方法：\n\n* get()：发送 GET 请求的简短方法\n* getJSON()：用 GET 请求获取 JSON 数据\n* post()：发送 post 请求\n* log()：发送前端日志信息，不保证成功，没有回调\n\n### Action.js\n\nAction 类，用于构造 action 对象。action 代表一种动作，比如页面跳转、鼠标事件、键盘事件等，都可以产生一个 action。\n\naction 上会附着 model 和 view，进入 action 的时候，会先去加载 model 指定的数据，然后根据拿到的数据来渲染 view 指定的视图。\n\n任何一个有 enter() 方法的对象都可作为 action 对象。\n\nenter() 方法开启了 action 的生命周期，在 action 的生命周期中，会触发如下事件：\n\n* enter：action 生命周期开始了\n* beforemodelload：action 上的 model（ action.model ） 加载之前触发\n* modelloaded：model 加载完成\n* beforerender：视图渲染之前\n* rendered：视图渲染完成\n* entercomplete：action 完成启动\n* beforeleave：离开 action 之前\n* leave：离开 action 之后，销毁注册在 action 上所有事件之前触发\n\naction 生命周期相关的一些方法：\n\n* enter()：action 入口函数\n* forwardToView()：转入 view 处理流程\n* leave()：离开 action，销毁 action 上的所有事件\n* reload()：重加载当前 action\n\n### Model.js\n\nMVC 中的 Model，主要用于从后端取数据，然后提供一些方法管理取到的数据。其中 load() 方法用于取数据，该方法会根据当前 model 对象上的数据源对象（ model.datasource ）去后端取数据。\n\n数据源是对数据一系列配置，其中保存了多个数据的获取函数，有以下方式：\n\n* 单一数据源配置\n\n    如果`datasource`是一个函数，则认为该函数是一个数据获取函数，\n    执行该函数，并把返回值按照一个对象放到当前 model 中\n    ```js\n    // 配置从指定的URL获取数据\n    datasource = require('./datasource').remote('/model/list')\n    ```\n\n* 并发请求数据\n\n    通过一个对象配置并发的数据获取。对象中每一个属性对应一个获取函数，\n    当数据获取后，会调用 `this.set(name, result)`，以属性名为键值添加\n    ```js\n    // 并发请求多个URL\n    datasource = {\n        'list': require('./datasource').remote('/model/list'),\n        'config': require('./datasource').constant('listConfig')\n    };\n    ```\n\n* 串行请求数据\n\n    通过一个数组配置并发的数据获取，数组中包含对象。将按照数组的顺序，\n    依次加载每一个对象（对象中的各属性是并发）\n    ```js\n    // 串行请求几个URL\n    datasource = [\n        { 'config': require('./datasource').constant('config') },\n        { 'list': require('./datasource').remote('/model/list') }\n    ];\n    ```\n    注意使用该方案时，各对象中的键**不要相同** ，否则会造成数据的覆盖\n\n* 嵌套配置\n\n    数组和对象可以相互嵌套，但有一个限制：\n\n    > 当一个对象中某个属性的值为普通对象（非数据加载配置项）或数组时，\n    > 该属性名将不起作用，即不会在 model 对象中存在以该属性名为键的值。\n\n    以下为一个串行和并行混杂的数据源配置：\n\n    ```js\n    datasource = {\n        'one': [getX, getY, getZ],\n        'two': getA,\n        'three': [\n            { 'four': getB },\n            { 'five': getC }\n        ]\n    };\n    ```\n\n    以上对象将在最终的 model 对象中生成 `two` 、 `four` 和 `five` 属性，而 `one` 、 `two` 和 `three` 因为属性值为普通对象或数组，将被忽略，其中`one`对应3个函数，将会把函数的返回值展开后添加到当前 model 同样，注意在嵌套的同时，各属性名**不要相同**，除非该属性名称没用，以避免出现数据相互覆盖的情况。\n\n* 通过数据获取配置项\n\n    上面所述的各种方案，均是数据获取配置项的简写，一个数据获取配置项的结构请参考 meta/DatasourceOption.js。因此，可以使用数据获取配置项来处理一些例外情况，比如并行加载2个对象，且2个对象均无对应的键值，需要完整添加到 `Model` 对象：\n\n    ```js\n    // 并行加载对象并完整添加到`Model`对象\n    datasource = [\n        {\n            retrieve: require('./datasource').remote('/model/list'),\n            dump: true\n        },\n        {\n            retrieve: require('./datasource').remote('/user/info'),\n            dump: true\n        }\n    ];\n    ```\n\n    对于不同的简写，其与数据获取配置项的对应关系如下：\n\n    - 普通的函数，映射为 `{ retrieve: {fn}, dump: true }`\n    - 对象中的一个属性，映射为 `{ retrieve: {fn}, name: {name} }`\n\n### View.js\n\n在 aciton 的生命周期中，加载完 model 数据之后，就会渲染视图了，此时调用的是 view.render() 方法，也就是说 view.render() 就是 view 的入口函数。er 的视图默认使用 [etpl](https://github.com/ecomfe/etpl) 模版引擎渲染。\n\n在指定容器内渲染出 html 结构之后，就会调用 view.enterDocument() 方法，用于控制元素可见性及绑定事件等DOM操作。比如利用 [esui](https://github.com/ecomfe/esui) 来初始化各种控件等等。\n\n### controller.js\n\n控制器类，负责 URL 与 Action 的调度，将 URL 映射到具体的一个 action 的执行上。\n\n可以使用 controller.registerAction() 方法来注册 action 配置，配置数据放在 controller.actionPathMapping 属性上（ path 到配置对象的映射 ）。每一个配置对象包含以下属性（ actionConfig ）：\n\n* path：该 action 对应的 url path\n* type：如果是一个字符串，则认为是此 action 的模块路径，否则认为就是一个模块对象，直接使用\n* movedTo：如果此属性存在，则会定向到此属性指定的 URL，类似于302\n* childActionOnly：如果为 true，就说明这个配置仅用于子 action\n* authority：权限配置，参考 meta.ActionConfig#authority 属性的说明\n* title：\n* documentTitle\n\n当路径改变时，会调用 controller.renderAction() 方法，此处渲染的是主 Action。渲染之前，会去 controller.actionPathMapping 上查找相应的 action 配置，如果找不到，则会跳转到404 url（404 url 可以通过 controller.setNotFoundLocation() 来设置）；如果没有找到404对应的 action 配置，则会 reject。判断完 action 配置是否存在之后，会检查是否有权限访问这个 url，如果没有权限，则会跳转到没有权限的页面（此页面可以通过 controller.setNoAuthorityLocation() 设置）。\n\n在 action 的渲染过程中，会伴随一个 actionContext 对象，里面包含如下属性：\n\n* url：此 action 对应的 url，是一个 URL 类的对象\n* container：容器元素的 id\n* isChildAction：是否是子 action\n* originalURL：之前的 url，在重定向、404、未授权的情况下，此属性会被设置，指代原始的那个 url\n* title：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）\n* args：有 actionContext 对象的所有属性（除 args 属性之外）\n* documentTitle：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）。此属性比 title 属性优先级低\n\ncontroller 对象有一个 eventBus 属性，该属性是 mini-event.EventBus 的实例。在此实例上，会有如下一系列事件触发：\n\n* forwardaction：加载 action 之前\n* actionmoved：action 重定向，类似于302过程\n* actionnotfound：没有找到当前 url 对应的 action 配置\n* permissiondenied：没有权限访问当前的 url\n* actionabort\n* actionfail：当前 url 没有对应的 action 模块实现，或者创建 action 失败\n* actionloaded：action 加载完成\n* leaveaction：之前的主 action 销毁\n* enteraction：进入 action 之前触发\n\n对于当前 url 加载到的 action 模块对象，如果是一个函数，则认为是一个 Action 构造函数，直接实例化；如果是一个包含 createRuntimeAction() 的对象，则认为这个 createRuntimeAction() 函数就是一个 Action 工厂函数，调用该工厂函数就可以创建出 action 对象；否则认为这个模块对象就是 action 实例。\n\n找到了当前 url 对应的主 action 之后，就要开始进入这个 action 了。在进入之前，需要销毁之前的主 action（调用 action.leave() 方法）。销毁之后，调用 action.enter()，进入当前 action。\n","slug":"百度 EFE 前端框架学习笔记（er）","published":1,"updated":"2016-06-15T10:47:57.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy03c001o0407r8j6pimz","content":"<p>首先上一张图：</p>\n<p><img src=\"https://raw.githubusercontent.com/ecomfe/er/master/doc/asset/er-overview.png\" alt=\"\"><br><a id=\"more\"></a></p>\n<h3 id=\"ajax-js\"><a href=\"#ajax-js\" class=\"headerlink\" title=\"ajax.js\"></a>ajax.js</h3><p>此模块返回一个 ajax 对象，用于发送 ajax 请求，最主要的就是 request 方法。同时该对象上也会挂载 Ajax 构造函数。</p>\n<p>返回的 ajax 对象上会带有一个钩子属性（ hooks ），钩子属性上包含的类容可能有：</p>\n<ul>\n<li>serializeData()： 将数据序列化为适合发送 http 请求的格式</li>\n<li>serializeArray()：序列化一组数据，以便发送 http 请求</li>\n<li>beforeExecute()：在请求发送之前调用</li>\n<li>beforeCreate()：在创建 XMLHttpRequest 对象之前调用，如果该函数返回 true，则会返回一个假的 promise 对象</li>\n<li>afterReceive()：在接受到响应的时候调用，此时，返回的数据都还未做解析处理</li>\n<li>afterParse()：响应的数据已经经过解析处理了</li>\n<li>beforeSend()：在 xhr 对象的 open() 调用之后，send 调用之前调用</li>\n</ul>\n<p>request() 函数只有一个 options 对象参数，其属性如下：</p>\n<ul>\n<li>url：请求 url</li>\n<li>method：请求方法，POST 、 GET</li>\n<li>data：请求附带的数据对象</li>\n<li>xhrFields：给 xhr 对象上混入的属性</li>\n<li>dataType：返回的数据类型，比如，如果是 <code>json</code> 的话，则会对 xhr.responseText 做 JSON 解析</li>\n<li>contentType：请求 MIME 类型，默认是 application/x-www-form-urlencoded，仅在 method 为非 GET 方式的时候有效</li>\n</ul>\n<p>request() 函数的 options 参数上还可能混入其他一些参数，这些参数都是通过 xhr.config 来配置的，是 ajax 对象的全局配置，这些属性包括：</p>\n<ul>\n<li>cache：如果为 false，则会在请求的 url 后面加上时间戳参数</li>\n<li>timeout：如果 timeout 大于0，则会有请求超时。如果发生了超时，则会触发 ajax 对象的 timeout 事件</li>\n<li>charset：跟在 http contentType 后面的 charset，例如：application/x-www-form-urlencoded;charset=UTF-8</li>\n</ul>\n<p>ajax 对象上除了 request 方法，还有如下一些方法：</p>\n<ul>\n<li>get()：发送 GET 请求的简短方法</li>\n<li>getJSON()：用 GET 请求获取 JSON 数据</li>\n<li>post()：发送 post 请求</li>\n<li>log()：发送前端日志信息，不保证成功，没有回调</li>\n</ul>\n<h3 id=\"Action-js\"><a href=\"#Action-js\" class=\"headerlink\" title=\"Action.js\"></a>Action.js</h3><p>Action 类，用于构造 action 对象。action 代表一种动作，比如页面跳转、鼠标事件、键盘事件等，都可以产生一个 action。</p>\n<p>action 上会附着 model 和 view，进入 action 的时候，会先去加载 model 指定的数据，然后根据拿到的数据来渲染 view 指定的视图。</p>\n<p>任何一个有 enter() 方法的对象都可作为 action 对象。</p>\n<p>enter() 方法开启了 action 的生命周期，在 action 的生命周期中，会触发如下事件：</p>\n<ul>\n<li>enter：action 生命周期开始了</li>\n<li>beforemodelload：action 上的 model（ action.model ） 加载之前触发</li>\n<li>modelloaded：model 加载完成</li>\n<li>beforerender：视图渲染之前</li>\n<li>rendered：视图渲染完成</li>\n<li>entercomplete：action 完成启动</li>\n<li>beforeleave：离开 action 之前</li>\n<li>leave：离开 action 之后，销毁注册在 action 上所有事件之前触发</li>\n</ul>\n<p>action 生命周期相关的一些方法：</p>\n<ul>\n<li>enter()：action 入口函数</li>\n<li>forwardToView()：转入 view 处理流程</li>\n<li>leave()：离开 action，销毁 action 上的所有事件</li>\n<li>reload()：重加载当前 action</li>\n</ul>\n<h3 id=\"Model-js\"><a href=\"#Model-js\" class=\"headerlink\" title=\"Model.js\"></a>Model.js</h3><p>MVC 中的 Model，主要用于从后端取数据，然后提供一些方法管理取到的数据。其中 load() 方法用于取数据，该方法会根据当前 model 对象上的数据源对象（ model.datasource ）去后端取数据。</p>\n<p>数据源是对数据一系列配置，其中保存了多个数据的获取函数，有以下方式：</p>\n<ul>\n<li><p>单一数据源配置</p>\n<p>  如果<code>datasource</code>是一个函数，则认为该函数是一个数据获取函数，<br>  执行该函数，并把返回值按照一个对象放到当前 model 中</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 配置从指定的URL获取数据</span></div><div class=\"line\">datasource = <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>)</div></pre></td></tr></table></figure>\n</li>\n<li><p>并发请求数据</p>\n<p>  通过一个对象配置并发的数据获取。对象中每一个属性对应一个获取函数，<br>  当数据获取后，会调用 <code>this.set(name, result)</code>，以属性名为键值添加</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 并发请求多个URL</span></div><div class=\"line\">datasource = &#123;</div><div class=\"line\">    <span class=\"string\">'list'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>),</div><div class=\"line\">    <span class=\"string\">'config'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).constant(<span class=\"string\">'listConfig'</span>)</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n</li>\n<li><p>串行请求数据</p>\n<p>  通过一个数组配置并发的数据获取，数组中包含对象。将按照数组的顺序，<br>  依次加载每一个对象（对象中的各属性是并发）</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 串行请求几个URL</span></div><div class=\"line\">datasource = [</div><div class=\"line\">    &#123; <span class=\"string\">'config'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).constant(<span class=\"string\">'config'</span>) &#125;,</div><div class=\"line\">    &#123; <span class=\"string\">'list'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>) &#125;</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>  注意使用该方案时，各对象中的键<strong>不要相同</strong> ，否则会造成数据的覆盖</p>\n</li>\n<li><p>嵌套配置</p>\n<p>  数组和对象可以相互嵌套，但有一个限制：</p>\n<blockquote>\n<p>当一个对象中某个属性的值为普通对象（非数据加载配置项）或数组时，<br>该属性名将不起作用，即不会在 model 对象中存在以该属性名为键的值。</p>\n</blockquote>\n<p>  以下为一个串行和并行混杂的数据源配置：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">datasource = &#123;</div><div class=\"line\">    <span class=\"string\">'one'</span>: [getX, getY, getZ],</div><div class=\"line\">    <span class=\"string\">'two'</span>: getA,</div><div class=\"line\">    <span class=\"string\">'three'</span>: [</div><div class=\"line\">        &#123; <span class=\"string\">'four'</span>: getB &#125;,</div><div class=\"line\">        &#123; <span class=\"string\">'five'</span>: getC &#125;</div><div class=\"line\">    ]</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>  以上对象将在最终的 model 对象中生成 <code>two</code> 、 <code>four</code> 和 <code>five</code> 属性，而 <code>one</code> 、 <code>two</code> 和 <code>three</code> 因为属性值为普通对象或数组，将被忽略，其中<code>one</code>对应3个函数，将会把函数的返回值展开后添加到当前 model 同样，注意在嵌套的同时，各属性名<strong>不要相同</strong>，除非该属性名称没用，以避免出现数据相互覆盖的情况。</p>\n</li>\n<li><p>通过数据获取配置项</p>\n<p>  上面所述的各种方案，均是数据获取配置项的简写，一个数据获取配置项的结构请参考 meta/DatasourceOption.js。因此，可以使用数据获取配置项来处理一些例外情况，比如并行加载2个对象，且2个对象均无对应的键值，需要完整添加到 <code>Model</code> 对象：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 并行加载对象并完整添加到`Model`对象</span></div><div class=\"line\">datasource = [</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">retrieve</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>),</div><div class=\"line\">        <span class=\"attr\">dump</span>: <span class=\"literal\">true</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">retrieve</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/user/info'</span>),</div><div class=\"line\">        <span class=\"attr\">dump</span>: <span class=\"literal\">true</span></div><div class=\"line\">    &#125;</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>  对于不同的简写，其与数据获取配置项的对应关系如下：</p>\n<ul>\n<li>普通的函数，映射为 <code>{ retrieve: {fn}, dump: true }</code></li>\n<li>对象中的一个属性，映射为 <code>{ retrieve: {fn}, name: {name} }</code></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"View-js\"><a href=\"#View-js\" class=\"headerlink\" title=\"View.js\"></a>View.js</h3><p>在 aciton 的生命周期中，加载完 model 数据之后，就会渲染视图了，此时调用的是 view.render() 方法，也就是说 view.render() 就是 view 的入口函数。er 的视图默认使用 <a href=\"https://github.com/ecomfe/etpl\" target=\"_blank\" rel=\"external\">etpl</a> 模版引擎渲染。</p>\n<p>在指定容器内渲染出 html 结构之后，就会调用 view.enterDocument() 方法，用于控制元素可见性及绑定事件等DOM操作。比如利用 <a href=\"https://github.com/ecomfe/esui\" target=\"_blank\" rel=\"external\">esui</a> 来初始化各种控件等等。</p>\n<h3 id=\"controller-js\"><a href=\"#controller-js\" class=\"headerlink\" title=\"controller.js\"></a>controller.js</h3><p>控制器类，负责 URL 与 Action 的调度，将 URL 映射到具体的一个 action 的执行上。</p>\n<p>可以使用 controller.registerAction() 方法来注册 action 配置，配置数据放在 controller.actionPathMapping 属性上（ path 到配置对象的映射 ）。每一个配置对象包含以下属性（ actionConfig ）：</p>\n<ul>\n<li>path：该 action 对应的 url path</li>\n<li>type：如果是一个字符串，则认为是此 action 的模块路径，否则认为就是一个模块对象，直接使用</li>\n<li>movedTo：如果此属性存在，则会定向到此属性指定的 URL，类似于302</li>\n<li>childActionOnly：如果为 true，就说明这个配置仅用于子 action</li>\n<li>authority：权限配置，参考 meta.ActionConfig#authority 属性的说明</li>\n<li>title：</li>\n<li>documentTitle</li>\n</ul>\n<p>当路径改变时，会调用 controller.renderAction() 方法，此处渲染的是主 Action。渲染之前，会去 controller.actionPathMapping 上查找相应的 action 配置，如果找不到，则会跳转到404 url（404 url 可以通过 controller.setNotFoundLocation() 来设置）；如果没有找到404对应的 action 配置，则会 reject。判断完 action 配置是否存在之后，会检查是否有权限访问这个 url，如果没有权限，则会跳转到没有权限的页面（此页面可以通过 controller.setNoAuthorityLocation() 设置）。</p>\n<p>在 action 的渲染过程中，会伴随一个 actionContext 对象，里面包含如下属性：</p>\n<ul>\n<li>url：此 action 对应的 url，是一个 URL 类的对象</li>\n<li>container：容器元素的 id</li>\n<li>isChildAction：是否是子 action</li>\n<li>originalURL：之前的 url，在重定向、404、未授权的情况下，此属性会被设置，指代原始的那个 url</li>\n<li>title：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）</li>\n<li>args：有 actionContext 对象的所有属性（除 args 属性之外）</li>\n<li>documentTitle：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）。此属性比 title 属性优先级低</li>\n</ul>\n<p>controller 对象有一个 eventBus 属性，该属性是 mini-event.EventBus 的实例。在此实例上，会有如下一系列事件触发：</p>\n<ul>\n<li>forwardaction：加载 action 之前</li>\n<li>actionmoved：action 重定向，类似于302过程</li>\n<li>actionnotfound：没有找到当前 url 对应的 action 配置</li>\n<li>permissiondenied：没有权限访问当前的 url</li>\n<li>actionabort</li>\n<li>actionfail：当前 url 没有对应的 action 模块实现，或者创建 action 失败</li>\n<li>actionloaded：action 加载完成</li>\n<li>leaveaction：之前的主 action 销毁</li>\n<li>enteraction：进入 action 之前触发</li>\n</ul>\n<p>对于当前 url 加载到的 action 模块对象，如果是一个函数，则认为是一个 Action 构造函数，直接实例化；如果是一个包含 createRuntimeAction() 的对象，则认为这个 createRuntimeAction() 函数就是一个 Action 工厂函数，调用该工厂函数就可以创建出 action 对象；否则认为这个模块对象就是 action 实例。</p>\n<p>找到了当前 url 对应的主 action 之后，就要开始进入这个 action 了。在进入之前，需要销毁之前的主 action（调用 action.leave() 方法）。销毁之后，调用 action.enter()，进入当前 action。</p>\n","excerpt":"<p>首先上一张图：</p>\n<p><img src=\"https://raw.githubusercontent.com/ecomfe/er/master/doc/asset/er-overview.png\" alt=\"\"><br>","more":"</p>\n<h3 id=\"ajax-js\"><a href=\"#ajax-js\" class=\"headerlink\" title=\"ajax.js\"></a>ajax.js</h3><p>此模块返回一个 ajax 对象，用于发送 ajax 请求，最主要的就是 request 方法。同时该对象上也会挂载 Ajax 构造函数。</p>\n<p>返回的 ajax 对象上会带有一个钩子属性（ hooks ），钩子属性上包含的类容可能有：</p>\n<ul>\n<li>serializeData()： 将数据序列化为适合发送 http 请求的格式</li>\n<li>serializeArray()：序列化一组数据，以便发送 http 请求</li>\n<li>beforeExecute()：在请求发送之前调用</li>\n<li>beforeCreate()：在创建 XMLHttpRequest 对象之前调用，如果该函数返回 true，则会返回一个假的 promise 对象</li>\n<li>afterReceive()：在接受到响应的时候调用，此时，返回的数据都还未做解析处理</li>\n<li>afterParse()：响应的数据已经经过解析处理了</li>\n<li>beforeSend()：在 xhr 对象的 open() 调用之后，send 调用之前调用</li>\n</ul>\n<p>request() 函数只有一个 options 对象参数，其属性如下：</p>\n<ul>\n<li>url：请求 url</li>\n<li>method：请求方法，POST 、 GET</li>\n<li>data：请求附带的数据对象</li>\n<li>xhrFields：给 xhr 对象上混入的属性</li>\n<li>dataType：返回的数据类型，比如，如果是 <code>json</code> 的话，则会对 xhr.responseText 做 JSON 解析</li>\n<li>contentType：请求 MIME 类型，默认是 application/x-www-form-urlencoded，仅在 method 为非 GET 方式的时候有效</li>\n</ul>\n<p>request() 函数的 options 参数上还可能混入其他一些参数，这些参数都是通过 xhr.config 来配置的，是 ajax 对象的全局配置，这些属性包括：</p>\n<ul>\n<li>cache：如果为 false，则会在请求的 url 后面加上时间戳参数</li>\n<li>timeout：如果 timeout 大于0，则会有请求超时。如果发生了超时，则会触发 ajax 对象的 timeout 事件</li>\n<li>charset：跟在 http contentType 后面的 charset，例如：application/x-www-form-urlencoded;charset=UTF-8</li>\n</ul>\n<p>ajax 对象上除了 request 方法，还有如下一些方法：</p>\n<ul>\n<li>get()：发送 GET 请求的简短方法</li>\n<li>getJSON()：用 GET 请求获取 JSON 数据</li>\n<li>post()：发送 post 请求</li>\n<li>log()：发送前端日志信息，不保证成功，没有回调</li>\n</ul>\n<h3 id=\"Action-js\"><a href=\"#Action-js\" class=\"headerlink\" title=\"Action.js\"></a>Action.js</h3><p>Action 类，用于构造 action 对象。action 代表一种动作，比如页面跳转、鼠标事件、键盘事件等，都可以产生一个 action。</p>\n<p>action 上会附着 model 和 view，进入 action 的时候，会先去加载 model 指定的数据，然后根据拿到的数据来渲染 view 指定的视图。</p>\n<p>任何一个有 enter() 方法的对象都可作为 action 对象。</p>\n<p>enter() 方法开启了 action 的生命周期，在 action 的生命周期中，会触发如下事件：</p>\n<ul>\n<li>enter：action 生命周期开始了</li>\n<li>beforemodelload：action 上的 model（ action.model ） 加载之前触发</li>\n<li>modelloaded：model 加载完成</li>\n<li>beforerender：视图渲染之前</li>\n<li>rendered：视图渲染完成</li>\n<li>entercomplete：action 完成启动</li>\n<li>beforeleave：离开 action 之前</li>\n<li>leave：离开 action 之后，销毁注册在 action 上所有事件之前触发</li>\n</ul>\n<p>action 生命周期相关的一些方法：</p>\n<ul>\n<li>enter()：action 入口函数</li>\n<li>forwardToView()：转入 view 处理流程</li>\n<li>leave()：离开 action，销毁 action 上的所有事件</li>\n<li>reload()：重加载当前 action</li>\n</ul>\n<h3 id=\"Model-js\"><a href=\"#Model-js\" class=\"headerlink\" title=\"Model.js\"></a>Model.js</h3><p>MVC 中的 Model，主要用于从后端取数据，然后提供一些方法管理取到的数据。其中 load() 方法用于取数据，该方法会根据当前 model 对象上的数据源对象（ model.datasource ）去后端取数据。</p>\n<p>数据源是对数据一系列配置，其中保存了多个数据的获取函数，有以下方式：</p>\n<ul>\n<li><p>单一数据源配置</p>\n<p>  如果<code>datasource</code>是一个函数，则认为该函数是一个数据获取函数，<br>  执行该函数，并把返回值按照一个对象放到当前 model 中</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 配置从指定的URL获取数据</span></div><div class=\"line\">datasource = <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>)</div></pre></td></tr></table></figure>\n</li>\n<li><p>并发请求数据</p>\n<p>  通过一个对象配置并发的数据获取。对象中每一个属性对应一个获取函数，<br>  当数据获取后，会调用 <code>this.set(name, result)</code>，以属性名为键值添加</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 并发请求多个URL</span></div><div class=\"line\">datasource = &#123;</div><div class=\"line\">    <span class=\"string\">'list'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>),</div><div class=\"line\">    <span class=\"string\">'config'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).constant(<span class=\"string\">'listConfig'</span>)</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n</li>\n<li><p>串行请求数据</p>\n<p>  通过一个数组配置并发的数据获取，数组中包含对象。将按照数组的顺序，<br>  依次加载每一个对象（对象中的各属性是并发）</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 串行请求几个URL</span></div><div class=\"line\">datasource = [</div><div class=\"line\">    &#123; <span class=\"string\">'config'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).constant(<span class=\"string\">'config'</span>) &#125;,</div><div class=\"line\">    &#123; <span class=\"string\">'list'</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>) &#125;</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>  注意使用该方案时，各对象中的键<strong>不要相同</strong> ，否则会造成数据的覆盖</p>\n</li>\n<li><p>嵌套配置</p>\n<p>  数组和对象可以相互嵌套，但有一个限制：</p>\n<blockquote>\n<p>当一个对象中某个属性的值为普通对象（非数据加载配置项）或数组时，<br>该属性名将不起作用，即不会在 model 对象中存在以该属性名为键的值。</p>\n</blockquote>\n<p>  以下为一个串行和并行混杂的数据源配置：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">datasource = &#123;</div><div class=\"line\">    <span class=\"string\">'one'</span>: [getX, getY, getZ],</div><div class=\"line\">    <span class=\"string\">'two'</span>: getA,</div><div class=\"line\">    <span class=\"string\">'three'</span>: [</div><div class=\"line\">        &#123; <span class=\"string\">'four'</span>: getB &#125;,</div><div class=\"line\">        &#123; <span class=\"string\">'five'</span>: getC &#125;</div><div class=\"line\">    ]</div><div class=\"line\">&#125;;</div></pre></td></tr></table></figure>\n<p>  以上对象将在最终的 model 对象中生成 <code>two</code> 、 <code>four</code> 和 <code>five</code> 属性，而 <code>one</code> 、 <code>two</code> 和 <code>three</code> 因为属性值为普通对象或数组，将被忽略，其中<code>one</code>对应3个函数，将会把函数的返回值展开后添加到当前 model 同样，注意在嵌套的同时，各属性名<strong>不要相同</strong>，除非该属性名称没用，以避免出现数据相互覆盖的情况。</p>\n</li>\n<li><p>通过数据获取配置项</p>\n<p>  上面所述的各种方案，均是数据获取配置项的简写，一个数据获取配置项的结构请参考 meta/DatasourceOption.js。因此，可以使用数据获取配置项来处理一些例外情况，比如并行加载2个对象，且2个对象均无对应的键值，需要完整添加到 <code>Model</code> 对象：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 并行加载对象并完整添加到`Model`对象</span></div><div class=\"line\">datasource = [</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">retrieve</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/model/list'</span>),</div><div class=\"line\">        <span class=\"attr\">dump</span>: <span class=\"literal\">true</span></div><div class=\"line\">    &#125;,</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">retrieve</span>: <span class=\"built_in\">require</span>(<span class=\"string\">'./datasource'</span>).remote(<span class=\"string\">'/user/info'</span>),</div><div class=\"line\">        <span class=\"attr\">dump</span>: <span class=\"literal\">true</span></div><div class=\"line\">    &#125;</div><div class=\"line\">];</div></pre></td></tr></table></figure>\n<p>  对于不同的简写，其与数据获取配置项的对应关系如下：</p>\n<ul>\n<li>普通的函数，映射为 <code>{ retrieve: {fn}, dump: true }</code></li>\n<li>对象中的一个属性，映射为 <code>{ retrieve: {fn}, name: {name} }</code></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"View-js\"><a href=\"#View-js\" class=\"headerlink\" title=\"View.js\"></a>View.js</h3><p>在 aciton 的生命周期中，加载完 model 数据之后，就会渲染视图了，此时调用的是 view.render() 方法，也就是说 view.render() 就是 view 的入口函数。er 的视图默认使用 <a href=\"https://github.com/ecomfe/etpl\">etpl</a> 模版引擎渲染。</p>\n<p>在指定容器内渲染出 html 结构之后，就会调用 view.enterDocument() 方法，用于控制元素可见性及绑定事件等DOM操作。比如利用 <a href=\"https://github.com/ecomfe/esui\">esui</a> 来初始化各种控件等等。</p>\n<h3 id=\"controller-js\"><a href=\"#controller-js\" class=\"headerlink\" title=\"controller.js\"></a>controller.js</h3><p>控制器类，负责 URL 与 Action 的调度，将 URL 映射到具体的一个 action 的执行上。</p>\n<p>可以使用 controller.registerAction() 方法来注册 action 配置，配置数据放在 controller.actionPathMapping 属性上（ path 到配置对象的映射 ）。每一个配置对象包含以下属性（ actionConfig ）：</p>\n<ul>\n<li>path：该 action 对应的 url path</li>\n<li>type：如果是一个字符串，则认为是此 action 的模块路径，否则认为就是一个模块对象，直接使用</li>\n<li>movedTo：如果此属性存在，则会定向到此属性指定的 URL，类似于302</li>\n<li>childActionOnly：如果为 true，就说明这个配置仅用于子 action</li>\n<li>authority：权限配置，参考 meta.ActionConfig#authority 属性的说明</li>\n<li>title：</li>\n<li>documentTitle</li>\n</ul>\n<p>当路径改变时，会调用 controller.renderAction() 方法，此处渲染的是主 Action。渲染之前，会去 controller.actionPathMapping 上查找相应的 action 配置，如果找不到，则会跳转到404 url（404 url 可以通过 controller.setNotFoundLocation() 来设置）；如果没有找到404对应的 action 配置，则会 reject。判断完 action 配置是否存在之后，会检查是否有权限访问这个 url，如果没有权限，则会跳转到没有权限的页面（此页面可以通过 controller.setNoAuthorityLocation() 设置）。</p>\n<p>在 action 的渲染过程中，会伴随一个 actionContext 对象，里面包含如下属性：</p>\n<ul>\n<li>url：此 action 对应的 url，是一个 URL 类的对象</li>\n<li>container：容器元素的 id</li>\n<li>isChildAction：是否是子 action</li>\n<li>originalURL：之前的 url，在重定向、404、未授权的情况下，此属性会被设置，指代原始的那个 url</li>\n<li>title：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）</li>\n<li>args：有 actionContext 对象的所有属性（除 args 属性之外）</li>\n<li>documentTitle：如果这个 action 是主 action，那么这个属性可以修改文档标题（ document.title ）。此属性比 title 属性优先级低</li>\n</ul>\n<p>controller 对象有一个 eventBus 属性，该属性是 mini-event.EventBus 的实例。在此实例上，会有如下一系列事件触发：</p>\n<ul>\n<li>forwardaction：加载 action 之前</li>\n<li>actionmoved：action 重定向，类似于302过程</li>\n<li>actionnotfound：没有找到当前 url 对应的 action 配置</li>\n<li>permissiondenied：没有权限访问当前的 url</li>\n<li>actionabort</li>\n<li>actionfail：当前 url 没有对应的 action 模块实现，或者创建 action 失败</li>\n<li>actionloaded：action 加载完成</li>\n<li>leaveaction：之前的主 action 销毁</li>\n<li>enteraction：进入 action 之前触发</li>\n</ul>\n<p>对于当前 url 加载到的 action 模块对象，如果是一个函数，则认为是一个 Action 构造函数，直接实例化；如果是一个包含 createRuntimeAction() 的对象，则认为这个 createRuntimeAction() 函数就是一个 Action 工厂函数，调用该工厂函数就可以创建出 action 对象；否则认为这个模块对象就是 action 实例。</p>\n<p>找到了当前 url 对应的主 action 之后，就要开始进入这个 action 了。在进入之前，需要销毁之前的主 action（调用 action.leave() 方法）。销毁之后，调用 action.enter()，进入当前 action。</p>"},{"title":"百度 EFE 前端框架学习笔记（esui）","date":"2015-05-31T16:00:00.000Z","_content":"\n基础点：\n\n### Control.js\n\n控件基类模块，该类不可以直接使用，经过继承之后，形成更加具体的按钮之类的控件才使用，可以认为就是一个控件抽象基类。\n\n包含如下一些自有属性：\n\n* type ：控件的类型，比如 Button 、 Input 、 Form 、 Calendar 等等\n* skin ：控件的皮肤，仅在初始化时设置有效，运行时不得变更\n* styleType ：控件的样式类型，用于生成各class使用，如无此属性，则使用 Control#type 属性代替\n* id ： 控件的 id\n\n<!-- more -->\n\n这些属性（ property ）均可在 html 代码中设置，比如：\n\n```html\n<div data-ui-type=\"Button\"></div>\n```\n\n还有另外一部分自有属性，这些属性不能用于 html 代码设置：\n\n* helper ：控件常用的一些方法组成的一个对象属性\n* children ：子控件数组\n* childrenIndex\n* currentStates\n* domEvents\n* main ： 控件的主元素， HTMLElement 类型\n\n原型（ Control.prototype ）上面有一些对象属性：\n\n* ignoreStates ： 指定在哪些状态下该元素不处理相关的DOM事件\n\n控件的生命周期中，有如下状态：\n\n* NEW ： 在进入构造函数后，控件的状态就是 NEW 了\n* INITED ： 控件完成 options 初始化（ initOptions() ）、视图环境初始化（ initViewContext() ）、扩展初始化（ initExtensions() ）之后状态就是 INITED 了\n* RENDERED ： 控件第一次调用 render() 方法之后，就转变为 RENDERED 了\n* DISPOSED ： 控件处于非 DISPOSED 状态下，调用 destroy() 方法，就变成了 DISPOSED 状态了\n\nControl 上有一个重要的方法 render() ，用于渲染控件，该方法会去调用 repaint() 方法。\n\n另外，Control 上还有一些 DOM 操作的方法，比如 appendTo() 、 insertBefore() 等。\n\nControl 上的 get() 和 set() 很有猫腻。举个例子，如果这样调用 get() 方法： `get('some-title')` ，首先会去检测当前实例上面有没有 `getSomeTitle()` 方法，如果有，则直接调用这个方法，返回这个方法的返回值；如果没有，则直接返回当前对象的 `some-title` 属性。 `set()` 方法也是类似的。\n\nsetProperties() 方法可以用来批量设置属性，它会对一些特殊属性进行处理、控制，比如：\n\n* 只有在渲染以前（就是 `initOptions()` 调用的那次）才允许设置 id 属性\n* 如果要设置 viewContext ，则直接调用 setViewContext() 设置\n* 有些属性要转换成布尔值，比如 disabled 、 hidden\n\nsetProperties() 也会对批量设置的值进行脏检测，如果发现有属性值发生了改变，则会调用 repaint() 方法。脏检测函数是 isPropertyChanged() ， 默认只会用恒等号去判断是否变化，但是可以在子类中覆盖这个方法，实现自己想要的脏检测功能。\n\n### Button.js\n\n按钮控件。主要有这么几种按钮：普通按钮、添加按钮、下载按钮、链接按钮、右上角关闭按钮。\n\n可以对按钮设置皮肤（ data-ui-skin ），内置的皮肤有： spring 、 spring-add 、 download 、 layerClose 、 link 。\n\n可以禁用掉按钮（ data-ui-disabled=\"diabled\" ）。\n\n按钮上 DOM 相关的事件只有 click 。由于按钮是间接继承自 EventTarget ，所以可以使用 on 、 un 等方法处理事件：\n\n```js\n// 给按钮绑定事件处理函数\nsomeButton.on('click', handler);\n\n// 5s 后取消绑定事件绑定\nsetTimeout(function () {\n    someButton.un('click', handler);\n}, 5000);\n\n// 只执行一次的回调函数\nsomeButton.once('click', function () {\n    // only once\n});\n\nfunction handler(event) {\n    // do something\n}\n```\n\n具体按钮 demo 可参看[此处](http://yibuyisheng.github.io/esui-demo/demo/Button.html)。\n\n### Validator\n\n数据验证模块，主要有三个基础类 Validity 、 ValidityState 、 Rule 。\n\nValidityState 表示某个控件的某一条验证规则的状态（是否验证通过），有两个自有属性：\n\n* state ： 验证状态， `true` 为值合法， `false` 为值非法\n* message ： 验证信息，比如说错误提示语\n\nRule 是验证规则基类，是对 InputControl 的值的验证逻辑的抽象。每一个验证规则都包含一个 `check(value, control)` 方法，该方法返回一个 ValidityState 对象以表示验证结果。验证规则必须通过 main.registerRule() 进行注册后才可生效。每一个验证规则包含 `prototype.type` 属性来确定规则的类型。验证规则并不会显式地附加到控件上，而是通过控件自身的属性决定哪些规则生效，当控件本身具有与规则的`type`属性相同的属性时，此规则即会生效，例如：\n\n```js\nvar textbox = main.create('TextBox', { maxLength: 30 });\ntextbox.validate();\n```\n\n由于 `textbox` 上存在 `maxLength` 属性，因此 `MaxLengthRule` 会对其进行验证，此特性可以从 main.createRulesByControl() 方法中看出。\n\nValidity 主要用于存放一系列验证结果（ ValidityState ），如果验证失败，则会触发 InputControl 的 invalid 事件，该事件会带上一个 Validity 对象作为参数。\n\n### InputControl.js\n\n输入控件基类模块，用于表示需要在表单中包含的控件，主要提供 `getRawValue()` 和 `getValue()` 方法供获取值。该类是一个抽象类，不应该直接使用。\n\n需要注意的是，控件其实并不通过严格的继承关系来判断一个控件是否为输入控件，只要 `getCategory()` 返回为 `\"input\"` 、 `\"check\" 或 `\"extend\"` 就认为是输入控件。\n\n相比普通控件的 **禁用 / 启用** ，输入控件共有3种状态：\n\n- 普通状态：可编辑，值随表单提交\n- `disabled` ：禁用状态，此状态下控件不能编辑，同时值不随表单提交\n- `readOnly` ：只读状态，此状态下控件不能编辑，但其值会随表单提交\n\nsetValue() 和 getValue() 分别用于设置输入控件的值和获取输入控件的值。 getRawValue() 和 setRawValue() 用于处理控件原始值，原始值的格式由控件自身决定。这两对处理输入控件值的方法的主要区别是，setValue() 会先调用控件的 parseValue() （子类可重写此方法）方法转换传入的值，然后再调用 setRawValue() 设置到控件上面去， getValue() 也会调用控件的 stringifyValue() （子类可重写此方法）将 getRawValue() 得到的值转换后返回。\n\ngetValidationResult() 方法用于获取此控件数据验证结果。\n\n### BoxGroup.js\n\n选择框组控件的各种使用可参见[此处](http://yibuyisheng.github.io/esui-demo/demo/BoxGroup.html)。\n\n### CheckBox.js\n\n`CheckBox` 控件在初始化时可以提供 `datasource` 属性，该属性用于控件判断一开始是否选中，且这个属性只在初始化时有效，不会保存下来。`datasource`可以是以下类型：\n\n- 数组：此时只要`rawValue`在`datasource`中（使用`==`比较）则选上\n- 其它：只要`rawValue`与此相等（使用`==`比较）则选上\n\n[示例](http://127.0.0.1:8848/demo/CheckBox.html)。\n\n### ControlCollection.js\n\n控件集合，类似 `jQuery` 对象的功能，提供便携的方法来访问和修改一个或多个控件。\n\n`ControlCollection` 提供 Control 的所有**公有**方法，但*没有*任何**保护或私有**方法。\n\n对于方法， `ControlCollection` 采用 **Write all, Read first** 的策略，需要注意的是，类似 setProperties() 的方法虽然有返回值，但被归类于写操作，因此会对所有内部的控件生效，但只返回第一个控件执行的结果。\n\n`ControlCollection` 仅继承 Control 的方法，并不包含任何子类独有方法，因此无法认为集合是一个 InputControl 而执行如下代码：\n\n```js\ncollection.setValue('foo');\n```\n\n此时可以使用通用的 set() 方法来代替：\n\n```js\ncollection.set('value', 'foo');\n```\n\n根据 set() 方法的规则，如果控件存在 `setValue()` 方法，则会进行调用。\n\n### ViewContext.js\n\n视图环境类，一个视图环境是一组控件的集合，不同视图环境中相同 id 的控件的 DOM id 不会重复。\n\n该类的实例包含的主要属性为：\n\n* controls ：该视图环境下所有的控件\n* groups ：视图环境控件分组集合\n* id ：视图环境 id，只读\n\n当前页面所有的视图环境对象都会以`id->对象`的形式保存在私有的 pool 变量中。\n\n### painters.js\n\n渲染器模块，负责 dom 渲染。\n\n可以生成各种各样的渲染器（ painter ）。例如：\n\n* painters.state()：生成一个将属性与控件状态关联的渲染器\n* painters.attribute()：生成一个将控件属性与控件主元素元素的属性关联的渲染器\n* painters.style()：生成一个将控件属性与控件主元素元素的样式关联的渲染器\n* painters.html()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器\n* painters.text()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器\n* painters.delegate()：生成一个将控件属性的变化代理到指定成员的指定方法上\n\n借助于这些方法，可以为某一个控件生成一组渲染器，当该控件发生了变化（样式属性变化等），相应的渲染器就会被调用，从而保证了数据与界面的一致性，形成了单向数据流，同时也比较细腻度地更新指定界面部分，不会出现全局刷新的情况。\n\n### Extension.js\n\n扩展基类，针对控件的扩展。\n\n`Extension` 类为扩展基类，所有扩展类需要继承于 `Extension` 。扩展类需要通过 main.registerExtension 方法，注册扩展类型。注册扩展类型时将自动根据 `prototype.type` 进行类型关联。\n\n一个控件实例可以组合多个`Extension`实例，但一个控件实例对同种类型（即 `type` 相同）的 `Extension` ，只能拥有一份。\n\n从设计上而言， `Extension` 不同于普通脚本对控件的操作，相比 ESUI 从设计理念上不希望普通脚本操作控件的保护属性及内部DOM元素，扩展则对控件拥有**完全开放**的权限，这包含但不限于：\n\n- 注册事件、修改属性等其它逻辑程序可做的行为。\n- 覆盖控件实例上的相应函数，如 `render()` 或 `addChild()` 等。\n- 读取`核心属性`与`关键属性`，包括 `type` 、 `main` 等。\n- 可接触控件内部的 DOM 对象，即可以访问 `main` 及其子树，并对 DOM 做任何操作。\n\n在控件初始化时，会对扩展进行初始化，其基本流程为：\n\n1、 当控件 `init` 之后，会依次对所有关联 `Extension` ，调用 `attachTo()` 方法。一个类型的 `Extension` 仅能在控件实例上附加一次，如果一个控件已经附加了同类型的 `Extension` 实例，则跳过本次 `attachTo` 操作。\n2、 当控件 `dispose` 之前，会依次对所有关联 `Extension` ，调用其 `dispose()` 方法。\n\n有多种方法可以将扩展绑定到具体的控件实例上：\n\n- 在控件创建时绑定\n\n    通过控件构造函数参数 `options.extensions` 可以为控件绑定扩展。\n\n    ```js\n    new TextBox({\n        extensions: [\n            new MyExtension({ ... }),\n            new OtherExtension({ ... })\n        ]\n    });\n    ```\n\n- 在使用HTML生成时绑定\n\n    在HTML中，使用 `data-ui-extension-xxx` 属性注册一个扩展：\n\n    ```html\n    <div id=\"main-panel\" class=\"wrapper\"\n        data-ui-type=\"Panel\"\n        data-ui-extension-command-type=\"Command\"\n        data-ui-extension-command-events=\"click,keypress,keyup\"\n        data-ui-extension-command-use-capture=\"false\"\n    </div>\n    ```\n\n    在HTML中，使用 `data-ui-extension-*-property` 属性添加扩展，其中`*`作为扩展的分组，可以是任何字符串，相同的`*`将作为对同一扩展的定义，必须包含 `data-ui-extension-*-type` 定义扩展的类型，而其它 `data-ui-extension-*-property=\"value\"` 属性则将作为 `options` 参数的属性传递给扩展的构造函数。\n\n- 在实例创建后动态地绑定\n\n    在控件创建后，可以动态创建扩展并在适当的时候绑定至控件。\n\n    ```js\n    var panel = new Label({ text: 'abc' });\n    var delegateDOMEvents = main.createExtension(\n        'Command',\n        {\n            eventTypes: ['click', 'keypress', 'keyup'],\n            useCapture: false\n        }\n    );\n    // 需主动调用attachTo方法\n    delegateDomEvents.attachTo(panel);\n    panel.appendTo(container);\n    ```\n\n- 全局绑定\n\n    调用{@link main#attachExtension}函数可在全局注册一个扩展：\n\n    ```js\n    main.attachExtension('Command', { events: ['click'] });\n    ```\n\n    全局注册的扩展，将会被附加到**所有**控件的实例上。使用 `options` 参数作为 `Extension` 创建时的选项，创建 `Extension` 实例时会对 `options` 做复制处理。\n\n    具体可以参考 extension.Command 作为示例，来学习扩展的编写。\n\n### src/main.js 中的 main.init() 方法\n\n该方法是整个 esui 的入口方法，可以指定当前要使用 esui 的 dom 节点容器，类似于 angular.bootstrap() 或者 React.render()，都是以指定的 dom 元素为根，然后开始渲染这块地盘。具体参数传递可参看文档。\n\n该方法会返回一个这个块地盘初始化的控件对象集合，例如：\n\n```html\n<div id=\"container\">\n    <button data-ui=\"type:Button;id:defaultBtn;\">默认按钮</button>\n    <span data-ui=\"type:Button;id:springBtn;skin:spring\">创建</span>\n    <div data-ui=\"type:Button;id:springAddBtn;skin:spring-add\">添加</div>\n    <div data-ui=\"type:Button;id:downloadBtn;skin:download\">下载</div>\n    <div data-ui=\"type:Button;id:actBtn;\">改变文字</div>\n</div>\n```\n\n此 container 初始化后就会返回五个控件对象控件的集合。\n\n### 类关系\n\n* ControlCollection\n    * ControlGroup\n* Extension\n* EventTarget\n    * Control\n        * Button\n        * CommandMenu\n        * Crumb\n        * InputControl\n            * BoxGroup\n            * Calendar\n            * CheckBox\n            * RangeCalendar\n            * Region\n            * RichCalendar\n            * Schedule\n            * Select\n            * TextBox\n            * TextLine\n        * Dialog\n        * Label\n        * Frame\n        * Pager\n        * Panel\n            * Form\n            * Overlay\n        * SearchBox\n        * Sidebar\n        * Tab\n        * Table\n        * Tip\n        * TipLayer\n        * Toast\n        * Tree\n        * Validity\n        * Wizard\n    * Layer\n    * Link\n    * MonthView\n* SafeWrapper\n* TreeStrategy\n* ViewContext\n\n### 一些总结\n\n绝大多数控件在源码中其实都有比较详尽的说明了，只要仔细看看注释，再结合相关代码，很快就会用了。不过，在看代码的时候，以下几处务必留意：\n\n* 1、 initOption() 函数，该函数会初始化一些参数，很多都可以通过 `data-ui-xxx` 来设置，也可以通过 set() 方法来设置；\n* 2、 repaint 属性，该属性中存放了重绘相关的配置，留意会造成重绘的属性，这些属性往往也可以用上条所述方式设置；\n* 3、留意控件会触发什么事件，直接在源代码中搜索 `fire(` ，即可快速知道该控件会触发什么事件。\n","source":"_posts/百度 EFE 前端框架学习笔记（esui）.md","raw":"---\ntitle: 百度 EFE 前端框架学习笔记（esui）\ndate: 2015-06-01\ntags:\n- JavaScript\n---\n\n基础点：\n\n### Control.js\n\n控件基类模块，该类不可以直接使用，经过继承之后，形成更加具体的按钮之类的控件才使用，可以认为就是一个控件抽象基类。\n\n包含如下一些自有属性：\n\n* type ：控件的类型，比如 Button 、 Input 、 Form 、 Calendar 等等\n* skin ：控件的皮肤，仅在初始化时设置有效，运行时不得变更\n* styleType ：控件的样式类型，用于生成各class使用，如无此属性，则使用 Control#type 属性代替\n* id ： 控件的 id\n\n<!-- more -->\n\n这些属性（ property ）均可在 html 代码中设置，比如：\n\n```html\n<div data-ui-type=\"Button\"></div>\n```\n\n还有另外一部分自有属性，这些属性不能用于 html 代码设置：\n\n* helper ：控件常用的一些方法组成的一个对象属性\n* children ：子控件数组\n* childrenIndex\n* currentStates\n* domEvents\n* main ： 控件的主元素， HTMLElement 类型\n\n原型（ Control.prototype ）上面有一些对象属性：\n\n* ignoreStates ： 指定在哪些状态下该元素不处理相关的DOM事件\n\n控件的生命周期中，有如下状态：\n\n* NEW ： 在进入构造函数后，控件的状态就是 NEW 了\n* INITED ： 控件完成 options 初始化（ initOptions() ）、视图环境初始化（ initViewContext() ）、扩展初始化（ initExtensions() ）之后状态就是 INITED 了\n* RENDERED ： 控件第一次调用 render() 方法之后，就转变为 RENDERED 了\n* DISPOSED ： 控件处于非 DISPOSED 状态下，调用 destroy() 方法，就变成了 DISPOSED 状态了\n\nControl 上有一个重要的方法 render() ，用于渲染控件，该方法会去调用 repaint() 方法。\n\n另外，Control 上还有一些 DOM 操作的方法，比如 appendTo() 、 insertBefore() 等。\n\nControl 上的 get() 和 set() 很有猫腻。举个例子，如果这样调用 get() 方法： `get('some-title')` ，首先会去检测当前实例上面有没有 `getSomeTitle()` 方法，如果有，则直接调用这个方法，返回这个方法的返回值；如果没有，则直接返回当前对象的 `some-title` 属性。 `set()` 方法也是类似的。\n\nsetProperties() 方法可以用来批量设置属性，它会对一些特殊属性进行处理、控制，比如：\n\n* 只有在渲染以前（就是 `initOptions()` 调用的那次）才允许设置 id 属性\n* 如果要设置 viewContext ，则直接调用 setViewContext() 设置\n* 有些属性要转换成布尔值，比如 disabled 、 hidden\n\nsetProperties() 也会对批量设置的值进行脏检测，如果发现有属性值发生了改变，则会调用 repaint() 方法。脏检测函数是 isPropertyChanged() ， 默认只会用恒等号去判断是否变化，但是可以在子类中覆盖这个方法，实现自己想要的脏检测功能。\n\n### Button.js\n\n按钮控件。主要有这么几种按钮：普通按钮、添加按钮、下载按钮、链接按钮、右上角关闭按钮。\n\n可以对按钮设置皮肤（ data-ui-skin ），内置的皮肤有： spring 、 spring-add 、 download 、 layerClose 、 link 。\n\n可以禁用掉按钮（ data-ui-disabled=\"diabled\" ）。\n\n按钮上 DOM 相关的事件只有 click 。由于按钮是间接继承自 EventTarget ，所以可以使用 on 、 un 等方法处理事件：\n\n```js\n// 给按钮绑定事件处理函数\nsomeButton.on('click', handler);\n\n// 5s 后取消绑定事件绑定\nsetTimeout(function () {\n    someButton.un('click', handler);\n}, 5000);\n\n// 只执行一次的回调函数\nsomeButton.once('click', function () {\n    // only once\n});\n\nfunction handler(event) {\n    // do something\n}\n```\n\n具体按钮 demo 可参看[此处](http://yibuyisheng.github.io/esui-demo/demo/Button.html)。\n\n### Validator\n\n数据验证模块，主要有三个基础类 Validity 、 ValidityState 、 Rule 。\n\nValidityState 表示某个控件的某一条验证规则的状态（是否验证通过），有两个自有属性：\n\n* state ： 验证状态， `true` 为值合法， `false` 为值非法\n* message ： 验证信息，比如说错误提示语\n\nRule 是验证规则基类，是对 InputControl 的值的验证逻辑的抽象。每一个验证规则都包含一个 `check(value, control)` 方法，该方法返回一个 ValidityState 对象以表示验证结果。验证规则必须通过 main.registerRule() 进行注册后才可生效。每一个验证规则包含 `prototype.type` 属性来确定规则的类型。验证规则并不会显式地附加到控件上，而是通过控件自身的属性决定哪些规则生效，当控件本身具有与规则的`type`属性相同的属性时，此规则即会生效，例如：\n\n```js\nvar textbox = main.create('TextBox', { maxLength: 30 });\ntextbox.validate();\n```\n\n由于 `textbox` 上存在 `maxLength` 属性，因此 `MaxLengthRule` 会对其进行验证，此特性可以从 main.createRulesByControl() 方法中看出。\n\nValidity 主要用于存放一系列验证结果（ ValidityState ），如果验证失败，则会触发 InputControl 的 invalid 事件，该事件会带上一个 Validity 对象作为参数。\n\n### InputControl.js\n\n输入控件基类模块，用于表示需要在表单中包含的控件，主要提供 `getRawValue()` 和 `getValue()` 方法供获取值。该类是一个抽象类，不应该直接使用。\n\n需要注意的是，控件其实并不通过严格的继承关系来判断一个控件是否为输入控件，只要 `getCategory()` 返回为 `\"input\"` 、 `\"check\" 或 `\"extend\"` 就认为是输入控件。\n\n相比普通控件的 **禁用 / 启用** ，输入控件共有3种状态：\n\n- 普通状态：可编辑，值随表单提交\n- `disabled` ：禁用状态，此状态下控件不能编辑，同时值不随表单提交\n- `readOnly` ：只读状态，此状态下控件不能编辑，但其值会随表单提交\n\nsetValue() 和 getValue() 分别用于设置输入控件的值和获取输入控件的值。 getRawValue() 和 setRawValue() 用于处理控件原始值，原始值的格式由控件自身决定。这两对处理输入控件值的方法的主要区别是，setValue() 会先调用控件的 parseValue() （子类可重写此方法）方法转换传入的值，然后再调用 setRawValue() 设置到控件上面去， getValue() 也会调用控件的 stringifyValue() （子类可重写此方法）将 getRawValue() 得到的值转换后返回。\n\ngetValidationResult() 方法用于获取此控件数据验证结果。\n\n### BoxGroup.js\n\n选择框组控件的各种使用可参见[此处](http://yibuyisheng.github.io/esui-demo/demo/BoxGroup.html)。\n\n### CheckBox.js\n\n`CheckBox` 控件在初始化时可以提供 `datasource` 属性，该属性用于控件判断一开始是否选中，且这个属性只在初始化时有效，不会保存下来。`datasource`可以是以下类型：\n\n- 数组：此时只要`rawValue`在`datasource`中（使用`==`比较）则选上\n- 其它：只要`rawValue`与此相等（使用`==`比较）则选上\n\n[示例](http://127.0.0.1:8848/demo/CheckBox.html)。\n\n### ControlCollection.js\n\n控件集合，类似 `jQuery` 对象的功能，提供便携的方法来访问和修改一个或多个控件。\n\n`ControlCollection` 提供 Control 的所有**公有**方法，但*没有*任何**保护或私有**方法。\n\n对于方法， `ControlCollection` 采用 **Write all, Read first** 的策略，需要注意的是，类似 setProperties() 的方法虽然有返回值，但被归类于写操作，因此会对所有内部的控件生效，但只返回第一个控件执行的结果。\n\n`ControlCollection` 仅继承 Control 的方法，并不包含任何子类独有方法，因此无法认为集合是一个 InputControl 而执行如下代码：\n\n```js\ncollection.setValue('foo');\n```\n\n此时可以使用通用的 set() 方法来代替：\n\n```js\ncollection.set('value', 'foo');\n```\n\n根据 set() 方法的规则，如果控件存在 `setValue()` 方法，则会进行调用。\n\n### ViewContext.js\n\n视图环境类，一个视图环境是一组控件的集合，不同视图环境中相同 id 的控件的 DOM id 不会重复。\n\n该类的实例包含的主要属性为：\n\n* controls ：该视图环境下所有的控件\n* groups ：视图环境控件分组集合\n* id ：视图环境 id，只读\n\n当前页面所有的视图环境对象都会以`id->对象`的形式保存在私有的 pool 变量中。\n\n### painters.js\n\n渲染器模块，负责 dom 渲染。\n\n可以生成各种各样的渲染器（ painter ）。例如：\n\n* painters.state()：生成一个将属性与控件状态关联的渲染器\n* painters.attribute()：生成一个将控件属性与控件主元素元素的属性关联的渲染器\n* painters.style()：生成一个将控件属性与控件主元素元素的样式关联的渲染器\n* painters.html()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器\n* painters.text()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器\n* painters.delegate()：生成一个将控件属性的变化代理到指定成员的指定方法上\n\n借助于这些方法，可以为某一个控件生成一组渲染器，当该控件发生了变化（样式属性变化等），相应的渲染器就会被调用，从而保证了数据与界面的一致性，形成了单向数据流，同时也比较细腻度地更新指定界面部分，不会出现全局刷新的情况。\n\n### Extension.js\n\n扩展基类，针对控件的扩展。\n\n`Extension` 类为扩展基类，所有扩展类需要继承于 `Extension` 。扩展类需要通过 main.registerExtension 方法，注册扩展类型。注册扩展类型时将自动根据 `prototype.type` 进行类型关联。\n\n一个控件实例可以组合多个`Extension`实例，但一个控件实例对同种类型（即 `type` 相同）的 `Extension` ，只能拥有一份。\n\n从设计上而言， `Extension` 不同于普通脚本对控件的操作，相比 ESUI 从设计理念上不希望普通脚本操作控件的保护属性及内部DOM元素，扩展则对控件拥有**完全开放**的权限，这包含但不限于：\n\n- 注册事件、修改属性等其它逻辑程序可做的行为。\n- 覆盖控件实例上的相应函数，如 `render()` 或 `addChild()` 等。\n- 读取`核心属性`与`关键属性`，包括 `type` 、 `main` 等。\n- 可接触控件内部的 DOM 对象，即可以访问 `main` 及其子树，并对 DOM 做任何操作。\n\n在控件初始化时，会对扩展进行初始化，其基本流程为：\n\n1、 当控件 `init` 之后，会依次对所有关联 `Extension` ，调用 `attachTo()` 方法。一个类型的 `Extension` 仅能在控件实例上附加一次，如果一个控件已经附加了同类型的 `Extension` 实例，则跳过本次 `attachTo` 操作。\n2、 当控件 `dispose` 之前，会依次对所有关联 `Extension` ，调用其 `dispose()` 方法。\n\n有多种方法可以将扩展绑定到具体的控件实例上：\n\n- 在控件创建时绑定\n\n    通过控件构造函数参数 `options.extensions` 可以为控件绑定扩展。\n\n    ```js\n    new TextBox({\n        extensions: [\n            new MyExtension({ ... }),\n            new OtherExtension({ ... })\n        ]\n    });\n    ```\n\n- 在使用HTML生成时绑定\n\n    在HTML中，使用 `data-ui-extension-xxx` 属性注册一个扩展：\n\n    ```html\n    <div id=\"main-panel\" class=\"wrapper\"\n        data-ui-type=\"Panel\"\n        data-ui-extension-command-type=\"Command\"\n        data-ui-extension-command-events=\"click,keypress,keyup\"\n        data-ui-extension-command-use-capture=\"false\"\n    </div>\n    ```\n\n    在HTML中，使用 `data-ui-extension-*-property` 属性添加扩展，其中`*`作为扩展的分组，可以是任何字符串，相同的`*`将作为对同一扩展的定义，必须包含 `data-ui-extension-*-type` 定义扩展的类型，而其它 `data-ui-extension-*-property=\"value\"` 属性则将作为 `options` 参数的属性传递给扩展的构造函数。\n\n- 在实例创建后动态地绑定\n\n    在控件创建后，可以动态创建扩展并在适当的时候绑定至控件。\n\n    ```js\n    var panel = new Label({ text: 'abc' });\n    var delegateDOMEvents = main.createExtension(\n        'Command',\n        {\n            eventTypes: ['click', 'keypress', 'keyup'],\n            useCapture: false\n        }\n    );\n    // 需主动调用attachTo方法\n    delegateDomEvents.attachTo(panel);\n    panel.appendTo(container);\n    ```\n\n- 全局绑定\n\n    调用{@link main#attachExtension}函数可在全局注册一个扩展：\n\n    ```js\n    main.attachExtension('Command', { events: ['click'] });\n    ```\n\n    全局注册的扩展，将会被附加到**所有**控件的实例上。使用 `options` 参数作为 `Extension` 创建时的选项，创建 `Extension` 实例时会对 `options` 做复制处理。\n\n    具体可以参考 extension.Command 作为示例，来学习扩展的编写。\n\n### src/main.js 中的 main.init() 方法\n\n该方法是整个 esui 的入口方法，可以指定当前要使用 esui 的 dom 节点容器，类似于 angular.bootstrap() 或者 React.render()，都是以指定的 dom 元素为根，然后开始渲染这块地盘。具体参数传递可参看文档。\n\n该方法会返回一个这个块地盘初始化的控件对象集合，例如：\n\n```html\n<div id=\"container\">\n    <button data-ui=\"type:Button;id:defaultBtn;\">默认按钮</button>\n    <span data-ui=\"type:Button;id:springBtn;skin:spring\">创建</span>\n    <div data-ui=\"type:Button;id:springAddBtn;skin:spring-add\">添加</div>\n    <div data-ui=\"type:Button;id:downloadBtn;skin:download\">下载</div>\n    <div data-ui=\"type:Button;id:actBtn;\">改变文字</div>\n</div>\n```\n\n此 container 初始化后就会返回五个控件对象控件的集合。\n\n### 类关系\n\n* ControlCollection\n    * ControlGroup\n* Extension\n* EventTarget\n    * Control\n        * Button\n        * CommandMenu\n        * Crumb\n        * InputControl\n            * BoxGroup\n            * Calendar\n            * CheckBox\n            * RangeCalendar\n            * Region\n            * RichCalendar\n            * Schedule\n            * Select\n            * TextBox\n            * TextLine\n        * Dialog\n        * Label\n        * Frame\n        * Pager\n        * Panel\n            * Form\n            * Overlay\n        * SearchBox\n        * Sidebar\n        * Tab\n        * Table\n        * Tip\n        * TipLayer\n        * Toast\n        * Tree\n        * Validity\n        * Wizard\n    * Layer\n    * Link\n    * MonthView\n* SafeWrapper\n* TreeStrategy\n* ViewContext\n\n### 一些总结\n\n绝大多数控件在源码中其实都有比较详尽的说明了，只要仔细看看注释，再结合相关代码，很快就会用了。不过，在看代码的时候，以下几处务必留意：\n\n* 1、 initOption() 函数，该函数会初始化一些参数，很多都可以通过 `data-ui-xxx` 来设置，也可以通过 set() 方法来设置；\n* 2、 repaint 属性，该属性中存放了重绘相关的配置，留意会造成重绘的属性，这些属性往往也可以用上条所述方式设置；\n* 3、留意控件会触发什么事件，直接在源代码中搜索 `fire(` ，即可快速知道该控件会触发什么事件。\n","slug":"百度 EFE 前端框架学习笔记（esui）","published":1,"updated":"2016-06-15T10:48:04.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy03d001r040707k6q7mt","content":"<p>基础点：</p>\n<h3 id=\"Control-js\"><a href=\"#Control-js\" class=\"headerlink\" title=\"Control.js\"></a>Control.js</h3><p>控件基类模块，该类不可以直接使用，经过继承之后，形成更加具体的按钮之类的控件才使用，可以认为就是一个控件抽象基类。</p>\n<p>包含如下一些自有属性：</p>\n<ul>\n<li>type ：控件的类型，比如 Button 、 Input 、 Form 、 Calendar 等等</li>\n<li>skin ：控件的皮肤，仅在初始化时设置有效，运行时不得变更</li>\n<li>styleType ：控件的样式类型，用于生成各class使用，如无此属性，则使用 Control#type 属性代替</li>\n<li>id ： 控件的 id</li>\n</ul>\n<a id=\"more\"></a>\n<p>这些属性（ property ）均可在 html 代码中设置，比如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui-type</span>=<span class=\"string\">\"Button\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>还有另外一部分自有属性，这些属性不能用于 html 代码设置：</p>\n<ul>\n<li>helper ：控件常用的一些方法组成的一个对象属性</li>\n<li>children ：子控件数组</li>\n<li>childrenIndex</li>\n<li>currentStates</li>\n<li>domEvents</li>\n<li>main ： 控件的主元素， HTMLElement 类型</li>\n</ul>\n<p>原型（ Control.prototype ）上面有一些对象属性：</p>\n<ul>\n<li>ignoreStates ： 指定在哪些状态下该元素不处理相关的DOM事件</li>\n</ul>\n<p>控件的生命周期中，有如下状态：</p>\n<ul>\n<li>NEW ： 在进入构造函数后，控件的状态就是 NEW 了</li>\n<li>INITED ： 控件完成 options 初始化（ initOptions() ）、视图环境初始化（ initViewContext() ）、扩展初始化（ initExtensions() ）之后状态就是 INITED 了</li>\n<li>RENDERED ： 控件第一次调用 render() 方法之后，就转变为 RENDERED 了</li>\n<li>DISPOSED ： 控件处于非 DISPOSED 状态下，调用 destroy() 方法，就变成了 DISPOSED 状态了</li>\n</ul>\n<p>Control 上有一个重要的方法 render() ，用于渲染控件，该方法会去调用 repaint() 方法。</p>\n<p>另外，Control 上还有一些 DOM 操作的方法，比如 appendTo() 、 insertBefore() 等。</p>\n<p>Control 上的 get() 和 set() 很有猫腻。举个例子，如果这样调用 get() 方法： <code>get(&#39;some-title&#39;)</code> ，首先会去检测当前实例上面有没有 <code>getSomeTitle()</code> 方法，如果有，则直接调用这个方法，返回这个方法的返回值；如果没有，则直接返回当前对象的 <code>some-title</code> 属性。 <code>set()</code> 方法也是类似的。</p>\n<p>setProperties() 方法可以用来批量设置属性，它会对一些特殊属性进行处理、控制，比如：</p>\n<ul>\n<li>只有在渲染以前（就是 <code>initOptions()</code> 调用的那次）才允许设置 id 属性</li>\n<li>如果要设置 viewContext ，则直接调用 setViewContext() 设置</li>\n<li>有些属性要转换成布尔值，比如 disabled 、 hidden</li>\n</ul>\n<p>setProperties() 也会对批量设置的值进行脏检测，如果发现有属性值发生了改变，则会调用 repaint() 方法。脏检测函数是 isPropertyChanged() ， 默认只会用恒等号去判断是否变化，但是可以在子类中覆盖这个方法，实现自己想要的脏检测功能。</p>\n<h3 id=\"Button-js\"><a href=\"#Button-js\" class=\"headerlink\" title=\"Button.js\"></a>Button.js</h3><p>按钮控件。主要有这么几种按钮：普通按钮、添加按钮、下载按钮、链接按钮、右上角关闭按钮。</p>\n<p>可以对按钮设置皮肤（ data-ui-skin ），内置的皮肤有： spring 、 spring-add 、 download 、 layerClose 、 link 。</p>\n<p>可以禁用掉按钮（ data-ui-disabled=”diabled” ）。</p>\n<p>按钮上 DOM 相关的事件只有 click 。由于按钮是间接继承自 EventTarget ，所以可以使用 on 、 un 等方法处理事件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 给按钮绑定事件处理函数</span></div><div class=\"line\">someButton.on(<span class=\"string\">'click'</span>, handler);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 5s 后取消绑定事件绑定</span></div><div class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    someButton.un(<span class=\"string\">'click'</span>, handler);</div><div class=\"line\">&#125;, <span class=\"number\">5000</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 只执行一次的回调函数</span></div><div class=\"line\">someButton.once(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// only once</span></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handler</span>(<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// do something</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>具体按钮 demo 可参看<a href=\"http://yibuyisheng.github.io/esui-demo/demo/Button.html\">此处</a>。</p>\n<h3 id=\"Validator\"><a href=\"#Validator\" class=\"headerlink\" title=\"Validator\"></a>Validator</h3><p>数据验证模块，主要有三个基础类 Validity 、 ValidityState 、 Rule 。</p>\n<p>ValidityState 表示某个控件的某一条验证规则的状态（是否验证通过），有两个自有属性：</p>\n<ul>\n<li>state ： 验证状态， <code>true</code> 为值合法， <code>false</code> 为值非法</li>\n<li>message ： 验证信息，比如说错误提示语</li>\n</ul>\n<p>Rule 是验证规则基类，是对 InputControl 的值的验证逻辑的抽象。每一个验证规则都包含一个 <code>check(value, control)</code> 方法，该方法返回一个 ValidityState 对象以表示验证结果。验证规则必须通过 main.registerRule() 进行注册后才可生效。每一个验证规则包含 <code>prototype.type</code> 属性来确定规则的类型。验证规则并不会显式地附加到控件上，而是通过控件自身的属性决定哪些规则生效，当控件本身具有与规则的<code>type</code>属性相同的属性时，此规则即会生效，例如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> textbox = main.create(<span class=\"string\">'TextBox'</span>, &#123; <span class=\"attr\">maxLength</span>: <span class=\"number\">30</span> &#125;);</div><div class=\"line\">textbox.validate();</div></pre></td></tr></table></figure>\n<p>由于 <code>textbox</code> 上存在 <code>maxLength</code> 属性，因此 <code>MaxLengthRule</code> 会对其进行验证，此特性可以从 main.createRulesByControl() 方法中看出。</p>\n<p>Validity 主要用于存放一系列验证结果（ ValidityState ），如果验证失败，则会触发 InputControl 的 invalid 事件，该事件会带上一个 Validity 对象作为参数。</p>\n<h3 id=\"InputControl-js\"><a href=\"#InputControl-js\" class=\"headerlink\" title=\"InputControl.js\"></a>InputControl.js</h3><p>输入控件基类模块，用于表示需要在表单中包含的控件，主要提供 <code>getRawValue()</code> 和 <code>getValue()</code> 方法供获取值。该类是一个抽象类，不应该直接使用。</p>\n<p>需要注意的是，控件其实并不通过严格的继承关系来判断一个控件是否为输入控件，只要 <code>getCategory()</code> 返回为 <code>&quot;input&quot;</code> 、 <code>&quot;check&quot; 或</code>“extend”` 就认为是输入控件。</p>\n<p>相比普通控件的 <strong>禁用 / 启用</strong> ，输入控件共有3种状态：</p>\n<ul>\n<li>普通状态：可编辑，值随表单提交</li>\n<li><code>disabled</code> ：禁用状态，此状态下控件不能编辑，同时值不随表单提交</li>\n<li><code>readOnly</code> ：只读状态，此状态下控件不能编辑，但其值会随表单提交</li>\n</ul>\n<p>setValue() 和 getValue() 分别用于设置输入控件的值和获取输入控件的值。 getRawValue() 和 setRawValue() 用于处理控件原始值，原始值的格式由控件自身决定。这两对处理输入控件值的方法的主要区别是，setValue() 会先调用控件的 parseValue() （子类可重写此方法）方法转换传入的值，然后再调用 setRawValue() 设置到控件上面去， getValue() 也会调用控件的 stringifyValue() （子类可重写此方法）将 getRawValue() 得到的值转换后返回。</p>\n<p>getValidationResult() 方法用于获取此控件数据验证结果。</p>\n<h3 id=\"BoxGroup-js\"><a href=\"#BoxGroup-js\" class=\"headerlink\" title=\"BoxGroup.js\"></a>BoxGroup.js</h3><p>选择框组控件的各种使用可参见<a href=\"http://yibuyisheng.github.io/esui-demo/demo/BoxGroup.html\">此处</a>。</p>\n<h3 id=\"CheckBox-js\"><a href=\"#CheckBox-js\" class=\"headerlink\" title=\"CheckBox.js\"></a>CheckBox.js</h3><p><code>CheckBox</code> 控件在初始化时可以提供 <code>datasource</code> 属性，该属性用于控件判断一开始是否选中，且这个属性只在初始化时有效，不会保存下来。<code>datasource</code>可以是以下类型：</p>\n<ul>\n<li>数组：此时只要<code>rawValue</code>在<code>datasource</code>中（使用<code>==</code>比较）则选上</li>\n<li>其它：只要<code>rawValue</code>与此相等（使用<code>==</code>比较）则选上</li>\n</ul>\n<p><a href=\"http://127.0.0.1:8848/demo/CheckBox.html\" target=\"_blank\" rel=\"external\">示例</a>。</p>\n<h3 id=\"ControlCollection-js\"><a href=\"#ControlCollection-js\" class=\"headerlink\" title=\"ControlCollection.js\"></a>ControlCollection.js</h3><p>控件集合，类似 <code>jQuery</code> 对象的功能，提供便携的方法来访问和修改一个或多个控件。</p>\n<p><code>ControlCollection</code> 提供 Control 的所有<strong>公有</strong>方法，但<em>没有</em>任何<strong>保护或私有</strong>方法。</p>\n<p>对于方法， <code>ControlCollection</code> 采用 <strong>Write all, Read first</strong> 的策略，需要注意的是，类似 setProperties() 的方法虽然有返回值，但被归类于写操作，因此会对所有内部的控件生效，但只返回第一个控件执行的结果。</p>\n<p><code>ControlCollection</code> 仅继承 Control 的方法，并不包含任何子类独有方法，因此无法认为集合是一个 InputControl 而执行如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">collection.setValue(<span class=\"string\">'foo'</span>);</div></pre></td></tr></table></figure>\n<p>此时可以使用通用的 set() 方法来代替：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">collection.set(<span class=\"string\">'value'</span>, <span class=\"string\">'foo'</span>);</div></pre></td></tr></table></figure>\n<p>根据 set() 方法的规则，如果控件存在 <code>setValue()</code> 方法，则会进行调用。</p>\n<h3 id=\"ViewContext-js\"><a href=\"#ViewContext-js\" class=\"headerlink\" title=\"ViewContext.js\"></a>ViewContext.js</h3><p>视图环境类，一个视图环境是一组控件的集合，不同视图环境中相同 id 的控件的 DOM id 不会重复。</p>\n<p>该类的实例包含的主要属性为：</p>\n<ul>\n<li>controls ：该视图环境下所有的控件</li>\n<li>groups ：视图环境控件分组集合</li>\n<li>id ：视图环境 id，只读</li>\n</ul>\n<p>当前页面所有的视图环境对象都会以<code>id-&gt;对象</code>的形式保存在私有的 pool 变量中。</p>\n<h3 id=\"painters-js\"><a href=\"#painters-js\" class=\"headerlink\" title=\"painters.js\"></a>painters.js</h3><p>渲染器模块，负责 dom 渲染。</p>\n<p>可以生成各种各样的渲染器（ painter ）。例如：</p>\n<ul>\n<li>painters.state()：生成一个将属性与控件状态关联的渲染器</li>\n<li>painters.attribute()：生成一个将控件属性与控件主元素元素的属性关联的渲染器</li>\n<li>painters.style()：生成一个将控件属性与控件主元素元素的样式关联的渲染器</li>\n<li>painters.html()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器</li>\n<li>painters.text()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器</li>\n<li>painters.delegate()：生成一个将控件属性的变化代理到指定成员的指定方法上</li>\n</ul>\n<p>借助于这些方法，可以为某一个控件生成一组渲染器，当该控件发生了变化（样式属性变化等），相应的渲染器就会被调用，从而保证了数据与界面的一致性，形成了单向数据流，同时也比较细腻度地更新指定界面部分，不会出现全局刷新的情况。</p>\n<h3 id=\"Extension-js\"><a href=\"#Extension-js\" class=\"headerlink\" title=\"Extension.js\"></a>Extension.js</h3><p>扩展基类，针对控件的扩展。</p>\n<p><code>Extension</code> 类为扩展基类，所有扩展类需要继承于 <code>Extension</code> 。扩展类需要通过 main.registerExtension 方法，注册扩展类型。注册扩展类型时将自动根据 <code>prototype.type</code> 进行类型关联。</p>\n<p>一个控件实例可以组合多个<code>Extension</code>实例，但一个控件实例对同种类型（即 <code>type</code> 相同）的 <code>Extension</code> ，只能拥有一份。</p>\n<p>从设计上而言， <code>Extension</code> 不同于普通脚本对控件的操作，相比 ESUI 从设计理念上不希望普通脚本操作控件的保护属性及内部DOM元素，扩展则对控件拥有<strong>完全开放</strong>的权限，这包含但不限于：</p>\n<ul>\n<li>注册事件、修改属性等其它逻辑程序可做的行为。</li>\n<li>覆盖控件实例上的相应函数，如 <code>render()</code> 或 <code>addChild()</code> 等。</li>\n<li>读取<code>核心属性</code>与<code>关键属性</code>，包括 <code>type</code> 、 <code>main</code> 等。</li>\n<li>可接触控件内部的 DOM 对象，即可以访问 <code>main</code> 及其子树，并对 DOM 做任何操作。</li>\n</ul>\n<p>在控件初始化时，会对扩展进行初始化，其基本流程为：</p>\n<p>1、 当控件 <code>init</code> 之后，会依次对所有关联 <code>Extension</code> ，调用 <code>attachTo()</code> 方法。一个类型的 <code>Extension</code> 仅能在控件实例上附加一次，如果一个控件已经附加了同类型的 <code>Extension</code> 实例，则跳过本次 <code>attachTo</code> 操作。<br>2、 当控件 <code>dispose</code> 之前，会依次对所有关联 <code>Extension</code> ，调用其 <code>dispose()</code> 方法。</p>\n<p>有多种方法可以将扩展绑定到具体的控件实例上：</p>\n<ul>\n<li><p>在控件创建时绑定</p>\n<p>  通过控件构造函数参数 <code>options.extensions</code> 可以为控件绑定扩展。</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">new</span> TextBox(&#123;</div><div class=\"line\">    <span class=\"attr\">extensions</span>: [</div><div class=\"line\">        <span class=\"keyword\">new</span> MyExtension(&#123; ... &#125;),</div><div class=\"line\">        <span class=\"keyword\">new</span> OtherExtension(&#123; ... &#125;)</div><div class=\"line\">    ]</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n</li>\n<li><p>在使用HTML生成时绑定</p>\n<p>  在HTML中，使用 <code>data-ui-extension-xxx</code> 属性注册一个扩展：</p>\n  <figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div id=\"main-panel\" class=\"wrapper\"</div><div class=\"line\">    data-ui-type=\"Panel\"</div><div class=\"line\">    data-ui-extension-command-type=\"Command\"</div><div class=\"line\">    data-ui-extension-command-events=\"click,keypress,keyup\"</div><div class=\"line\">    data-ui-extension-command-use-capture=\"false\"</div><div class=\"line\">&lt;/div&gt;</div></pre></td></tr></table></figure>\n<p>  在HTML中，使用 <code>data-ui-extension-*-property</code> 属性添加扩展，其中<code>*</code>作为扩展的分组，可以是任何字符串，相同的<code>*</code>将作为对同一扩展的定义，必须包含 <code>data-ui-extension-*-type</code> 定义扩展的类型，而其它 <code>data-ui-extension-*-property=&quot;value&quot;</code> 属性则将作为 <code>options</code> 参数的属性传递给扩展的构造函数。</p>\n</li>\n<li><p>在实例创建后动态地绑定</p>\n<p>  在控件创建后，可以动态创建扩展并在适当的时候绑定至控件。</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> panel = <span class=\"keyword\">new</span> Label(&#123; <span class=\"attr\">text</span>: <span class=\"string\">'abc'</span> &#125;);</div><div class=\"line\"><span class=\"keyword\">var</span> delegateDOMEvents = main.createExtension(</div><div class=\"line\">    <span class=\"string\">'Command'</span>,</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">eventTypes</span>: [<span class=\"string\">'click'</span>, <span class=\"string\">'keypress'</span>, <span class=\"string\">'keyup'</span>],</div><div class=\"line\">        <span class=\"attr\">useCapture</span>: <span class=\"literal\">false</span></div><div class=\"line\">    &#125;</div><div class=\"line\">);</div><div class=\"line\"><span class=\"comment\">// 需主动调用attachTo方法</span></div><div class=\"line\">delegateDomEvents.attachTo(panel);</div><div class=\"line\">panel.appendTo(container);</div></pre></td></tr></table></figure>\n</li>\n<li><p>全局绑定</p>\n<p>  调用{@link main#attachExtension}函数可在全局注册一个扩展：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">main.attachExtension(<span class=\"string\">'Command'</span>, &#123; <span class=\"attr\">events</span>: [<span class=\"string\">'click'</span>] &#125;);</div></pre></td></tr></table></figure>\n<p>  全局注册的扩展，将会被附加到<strong>所有</strong>控件的实例上。使用 <code>options</code> 参数作为 <code>Extension</code> 创建时的选项，创建 <code>Extension</code> 实例时会对 <code>options</code> 做复制处理。</p>\n<p>  具体可以参考 extension.Command 作为示例，来学习扩展的编写。</p>\n</li>\n</ul>\n<h3 id=\"src-main-js-中的-main-init-方法\"><a href=\"#src-main-js-中的-main-init-方法\" class=\"headerlink\" title=\"src/main.js 中的 main.init() 方法\"></a>src/main.js 中的 main.init() 方法</h3><p>该方法是整个 esui 的入口方法，可以指定当前要使用 esui 的 dom 节点容器，类似于 angular.bootstrap() 或者 React.render()，都是以指定的 dom 元素为根，然后开始渲染这块地盘。具体参数传递可参看文档。</p>\n<p>该方法会返回一个这个块地盘初始化的控件对象集合，例如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"container\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:defaultBtn;\"</span>&gt;</span>默认按钮<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:springBtn;skin:spring\"</span>&gt;</span>创建<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:springAddBtn;skin:spring-add\"</span>&gt;</span>添加<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:downloadBtn;skin:download\"</span>&gt;</span>下载<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:actBtn;\"</span>&gt;</span>改变文字<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>此 container 初始化后就会返回五个控件对象控件的集合。</p>\n<h3 id=\"类关系\"><a href=\"#类关系\" class=\"headerlink\" title=\"类关系\"></a>类关系</h3><ul>\n<li>ControlCollection<ul>\n<li>ControlGroup</li>\n</ul>\n</li>\n<li>Extension</li>\n<li>EventTarget<ul>\n<li>Control<ul>\n<li>Button</li>\n<li>CommandMenu</li>\n<li>Crumb</li>\n<li>InputControl<ul>\n<li>BoxGroup</li>\n<li>Calendar</li>\n<li>CheckBox</li>\n<li>RangeCalendar</li>\n<li>Region</li>\n<li>RichCalendar</li>\n<li>Schedule</li>\n<li>Select</li>\n<li>TextBox</li>\n<li>TextLine</li>\n</ul>\n</li>\n<li>Dialog</li>\n<li>Label</li>\n<li>Frame</li>\n<li>Pager</li>\n<li>Panel<ul>\n<li>Form</li>\n<li>Overlay</li>\n</ul>\n</li>\n<li>SearchBox</li>\n<li>Sidebar</li>\n<li>Tab</li>\n<li>Table</li>\n<li>Tip</li>\n<li>TipLayer</li>\n<li>Toast</li>\n<li>Tree</li>\n<li>Validity</li>\n<li>Wizard</li>\n</ul>\n</li>\n<li>Layer</li>\n<li>Link</li>\n<li>MonthView</li>\n</ul>\n</li>\n<li>SafeWrapper</li>\n<li>TreeStrategy</li>\n<li>ViewContext</li>\n</ul>\n<h3 id=\"一些总结\"><a href=\"#一些总结\" class=\"headerlink\" title=\"一些总结\"></a>一些总结</h3><p>绝大多数控件在源码中其实都有比较详尽的说明了，只要仔细看看注释，再结合相关代码，很快就会用了。不过，在看代码的时候，以下几处务必留意：</p>\n<ul>\n<li>1、 initOption() 函数，该函数会初始化一些参数，很多都可以通过 <code>data-ui-xxx</code> 来设置，也可以通过 set() 方法来设置；</li>\n<li>2、 repaint 属性，该属性中存放了重绘相关的配置，留意会造成重绘的属性，这些属性往往也可以用上条所述方式设置；</li>\n<li>3、留意控件会触发什么事件，直接在源代码中搜索 <code>fire(</code> ，即可快速知道该控件会触发什么事件。</li>\n</ul>\n","excerpt":"<p>基础点：</p>\n<h3 id=\"Control-js\"><a href=\"#Control-js\" class=\"headerlink\" title=\"Control.js\"></a>Control.js</h3><p>控件基类模块，该类不可以直接使用，经过继承之后，形成更加具体的按钮之类的控件才使用，可以认为就是一个控件抽象基类。</p>\n<p>包含如下一些自有属性：</p>\n<ul>\n<li>type ：控件的类型，比如 Button 、 Input 、 Form 、 Calendar 等等</li>\n<li>skin ：控件的皮肤，仅在初始化时设置有效，运行时不得变更</li>\n<li>styleType ：控件的样式类型，用于生成各class使用，如无此属性，则使用 Control#type 属性代替</li>\n<li>id ： 控件的 id</li>\n</ul>","more":"<p>这些属性（ property ）均可在 html 代码中设置，比如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui-type</span>=<span class=\"string\">\"Button\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>还有另外一部分自有属性，这些属性不能用于 html 代码设置：</p>\n<ul>\n<li>helper ：控件常用的一些方法组成的一个对象属性</li>\n<li>children ：子控件数组</li>\n<li>childrenIndex</li>\n<li>currentStates</li>\n<li>domEvents</li>\n<li>main ： 控件的主元素， HTMLElement 类型</li>\n</ul>\n<p>原型（ Control.prototype ）上面有一些对象属性：</p>\n<ul>\n<li>ignoreStates ： 指定在哪些状态下该元素不处理相关的DOM事件</li>\n</ul>\n<p>控件的生命周期中，有如下状态：</p>\n<ul>\n<li>NEW ： 在进入构造函数后，控件的状态就是 NEW 了</li>\n<li>INITED ： 控件完成 options 初始化（ initOptions() ）、视图环境初始化（ initViewContext() ）、扩展初始化（ initExtensions() ）之后状态就是 INITED 了</li>\n<li>RENDERED ： 控件第一次调用 render() 方法之后，就转变为 RENDERED 了</li>\n<li>DISPOSED ： 控件处于非 DISPOSED 状态下，调用 destroy() 方法，就变成了 DISPOSED 状态了</li>\n</ul>\n<p>Control 上有一个重要的方法 render() ，用于渲染控件，该方法会去调用 repaint() 方法。</p>\n<p>另外，Control 上还有一些 DOM 操作的方法，比如 appendTo() 、 insertBefore() 等。</p>\n<p>Control 上的 get() 和 set() 很有猫腻。举个例子，如果这样调用 get() 方法： <code>get(&#39;some-title&#39;)</code> ，首先会去检测当前实例上面有没有 <code>getSomeTitle()</code> 方法，如果有，则直接调用这个方法，返回这个方法的返回值；如果没有，则直接返回当前对象的 <code>some-title</code> 属性。 <code>set()</code> 方法也是类似的。</p>\n<p>setProperties() 方法可以用来批量设置属性，它会对一些特殊属性进行处理、控制，比如：</p>\n<ul>\n<li>只有在渲染以前（就是 <code>initOptions()</code> 调用的那次）才允许设置 id 属性</li>\n<li>如果要设置 viewContext ，则直接调用 setViewContext() 设置</li>\n<li>有些属性要转换成布尔值，比如 disabled 、 hidden</li>\n</ul>\n<p>setProperties() 也会对批量设置的值进行脏检测，如果发现有属性值发生了改变，则会调用 repaint() 方法。脏检测函数是 isPropertyChanged() ， 默认只会用恒等号去判断是否变化，但是可以在子类中覆盖这个方法，实现自己想要的脏检测功能。</p>\n<h3 id=\"Button-js\"><a href=\"#Button-js\" class=\"headerlink\" title=\"Button.js\"></a>Button.js</h3><p>按钮控件。主要有这么几种按钮：普通按钮、添加按钮、下载按钮、链接按钮、右上角关闭按钮。</p>\n<p>可以对按钮设置皮肤（ data-ui-skin ），内置的皮肤有： spring 、 spring-add 、 download 、 layerClose 、 link 。</p>\n<p>可以禁用掉按钮（ data-ui-disabled=”diabled” ）。</p>\n<p>按钮上 DOM 相关的事件只有 click 。由于按钮是间接继承自 EventTarget ，所以可以使用 on 、 un 等方法处理事件：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">// 给按钮绑定事件处理函数</span></div><div class=\"line\">someButton.on(<span class=\"string\">'click'</span>, handler);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 5s 后取消绑定事件绑定</span></div><div class=\"line\">setTimeout(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    someButton.un(<span class=\"string\">'click'</span>, handler);</div><div class=\"line\">&#125;, <span class=\"number\">5000</span>);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// 只执行一次的回调函数</span></div><div class=\"line\">someButton.once(<span class=\"string\">'click'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// only once</span></div><div class=\"line\">&#125;);</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handler</span>(<span class=\"params\">event</span>) </span>&#123;</div><div class=\"line\">    <span class=\"comment\">// do something</span></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>具体按钮 demo 可参看<a href=\"http://yibuyisheng.github.io/esui-demo/demo/Button.html\">此处</a>。</p>\n<h3 id=\"Validator\"><a href=\"#Validator\" class=\"headerlink\" title=\"Validator\"></a>Validator</h3><p>数据验证模块，主要有三个基础类 Validity 、 ValidityState 、 Rule 。</p>\n<p>ValidityState 表示某个控件的某一条验证规则的状态（是否验证通过），有两个自有属性：</p>\n<ul>\n<li>state ： 验证状态， <code>true</code> 为值合法， <code>false</code> 为值非法</li>\n<li>message ： 验证信息，比如说错误提示语</li>\n</ul>\n<p>Rule 是验证规则基类，是对 InputControl 的值的验证逻辑的抽象。每一个验证规则都包含一个 <code>check(value, control)</code> 方法，该方法返回一个 ValidityState 对象以表示验证结果。验证规则必须通过 main.registerRule() 进行注册后才可生效。每一个验证规则包含 <code>prototype.type</code> 属性来确定规则的类型。验证规则并不会显式地附加到控件上，而是通过控件自身的属性决定哪些规则生效，当控件本身具有与规则的<code>type</code>属性相同的属性时，此规则即会生效，例如：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> textbox = main.create(<span class=\"string\">'TextBox'</span>, &#123; <span class=\"attr\">maxLength</span>: <span class=\"number\">30</span> &#125;);</div><div class=\"line\">textbox.validate();</div></pre></td></tr></table></figure>\n<p>由于 <code>textbox</code> 上存在 <code>maxLength</code> 属性，因此 <code>MaxLengthRule</code> 会对其进行验证，此特性可以从 main.createRulesByControl() 方法中看出。</p>\n<p>Validity 主要用于存放一系列验证结果（ ValidityState ），如果验证失败，则会触发 InputControl 的 invalid 事件，该事件会带上一个 Validity 对象作为参数。</p>\n<h3 id=\"InputControl-js\"><a href=\"#InputControl-js\" class=\"headerlink\" title=\"InputControl.js\"></a>InputControl.js</h3><p>输入控件基类模块，用于表示需要在表单中包含的控件，主要提供 <code>getRawValue()</code> 和 <code>getValue()</code> 方法供获取值。该类是一个抽象类，不应该直接使用。</p>\n<p>需要注意的是，控件其实并不通过严格的继承关系来判断一个控件是否为输入控件，只要 <code>getCategory()</code> 返回为 <code>&quot;input&quot;</code> 、 <code>&quot;check&quot; 或</code>“extend”` 就认为是输入控件。</p>\n<p>相比普通控件的 <strong>禁用 / 启用</strong> ，输入控件共有3种状态：</p>\n<ul>\n<li>普通状态：可编辑，值随表单提交</li>\n<li><code>disabled</code> ：禁用状态，此状态下控件不能编辑，同时值不随表单提交</li>\n<li><code>readOnly</code> ：只读状态，此状态下控件不能编辑，但其值会随表单提交</li>\n</ul>\n<p>setValue() 和 getValue() 分别用于设置输入控件的值和获取输入控件的值。 getRawValue() 和 setRawValue() 用于处理控件原始值，原始值的格式由控件自身决定。这两对处理输入控件值的方法的主要区别是，setValue() 会先调用控件的 parseValue() （子类可重写此方法）方法转换传入的值，然后再调用 setRawValue() 设置到控件上面去， getValue() 也会调用控件的 stringifyValue() （子类可重写此方法）将 getRawValue() 得到的值转换后返回。</p>\n<p>getValidationResult() 方法用于获取此控件数据验证结果。</p>\n<h3 id=\"BoxGroup-js\"><a href=\"#BoxGroup-js\" class=\"headerlink\" title=\"BoxGroup.js\"></a>BoxGroup.js</h3><p>选择框组控件的各种使用可参见<a href=\"http://yibuyisheng.github.io/esui-demo/demo/BoxGroup.html\">此处</a>。</p>\n<h3 id=\"CheckBox-js\"><a href=\"#CheckBox-js\" class=\"headerlink\" title=\"CheckBox.js\"></a>CheckBox.js</h3><p><code>CheckBox</code> 控件在初始化时可以提供 <code>datasource</code> 属性，该属性用于控件判断一开始是否选中，且这个属性只在初始化时有效，不会保存下来。<code>datasource</code>可以是以下类型：</p>\n<ul>\n<li>数组：此时只要<code>rawValue</code>在<code>datasource</code>中（使用<code>==</code>比较）则选上</li>\n<li>其它：只要<code>rawValue</code>与此相等（使用<code>==</code>比较）则选上</li>\n</ul>\n<p><a href=\"http://127.0.0.1:8848/demo/CheckBox.html\">示例</a>。</p>\n<h3 id=\"ControlCollection-js\"><a href=\"#ControlCollection-js\" class=\"headerlink\" title=\"ControlCollection.js\"></a>ControlCollection.js</h3><p>控件集合，类似 <code>jQuery</code> 对象的功能，提供便携的方法来访问和修改一个或多个控件。</p>\n<p><code>ControlCollection</code> 提供 Control 的所有<strong>公有</strong>方法，但<em>没有</em>任何<strong>保护或私有</strong>方法。</p>\n<p>对于方法， <code>ControlCollection</code> 采用 <strong>Write all, Read first</strong> 的策略，需要注意的是，类似 setProperties() 的方法虽然有返回值，但被归类于写操作，因此会对所有内部的控件生效，但只返回第一个控件执行的结果。</p>\n<p><code>ControlCollection</code> 仅继承 Control 的方法，并不包含任何子类独有方法，因此无法认为集合是一个 InputControl 而执行如下代码：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">collection.setValue(<span class=\"string\">'foo'</span>);</div></pre></td></tr></table></figure>\n<p>此时可以使用通用的 set() 方法来代替：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">collection.set(<span class=\"string\">'value'</span>, <span class=\"string\">'foo'</span>);</div></pre></td></tr></table></figure>\n<p>根据 set() 方法的规则，如果控件存在 <code>setValue()</code> 方法，则会进行调用。</p>\n<h3 id=\"ViewContext-js\"><a href=\"#ViewContext-js\" class=\"headerlink\" title=\"ViewContext.js\"></a>ViewContext.js</h3><p>视图环境类，一个视图环境是一组控件的集合，不同视图环境中相同 id 的控件的 DOM id 不会重复。</p>\n<p>该类的实例包含的主要属性为：</p>\n<ul>\n<li>controls ：该视图环境下所有的控件</li>\n<li>groups ：视图环境控件分组集合</li>\n<li>id ：视图环境 id，只读</li>\n</ul>\n<p>当前页面所有的视图环境对象都会以<code>id-&gt;对象</code>的形式保存在私有的 pool 变量中。</p>\n<h3 id=\"painters-js\"><a href=\"#painters-js\" class=\"headerlink\" title=\"painters.js\"></a>painters.js</h3><p>渲染器模块，负责 dom 渲染。</p>\n<p>可以生成各种各样的渲染器（ painter ）。例如：</p>\n<ul>\n<li>painters.state()：生成一个将属性与控件状态关联的渲染器</li>\n<li>painters.attribute()：生成一个将控件属性与控件主元素元素的属性关联的渲染器</li>\n<li>painters.style()：生成一个将控件属性与控件主元素元素的样式关联的渲染器</li>\n<li>painters.html()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器</li>\n<li>painters.text()：生成一个将控件属性与某个DOM元素的HTML内容关联的渲染器</li>\n<li>painters.delegate()：生成一个将控件属性的变化代理到指定成员的指定方法上</li>\n</ul>\n<p>借助于这些方法，可以为某一个控件生成一组渲染器，当该控件发生了变化（样式属性变化等），相应的渲染器就会被调用，从而保证了数据与界面的一致性，形成了单向数据流，同时也比较细腻度地更新指定界面部分，不会出现全局刷新的情况。</p>\n<h3 id=\"Extension-js\"><a href=\"#Extension-js\" class=\"headerlink\" title=\"Extension.js\"></a>Extension.js</h3><p>扩展基类，针对控件的扩展。</p>\n<p><code>Extension</code> 类为扩展基类，所有扩展类需要继承于 <code>Extension</code> 。扩展类需要通过 main.registerExtension 方法，注册扩展类型。注册扩展类型时将自动根据 <code>prototype.type</code> 进行类型关联。</p>\n<p>一个控件实例可以组合多个<code>Extension</code>实例，但一个控件实例对同种类型（即 <code>type</code> 相同）的 <code>Extension</code> ，只能拥有一份。</p>\n<p>从设计上而言， <code>Extension</code> 不同于普通脚本对控件的操作，相比 ESUI 从设计理念上不希望普通脚本操作控件的保护属性及内部DOM元素，扩展则对控件拥有<strong>完全开放</strong>的权限，这包含但不限于：</p>\n<ul>\n<li>注册事件、修改属性等其它逻辑程序可做的行为。</li>\n<li>覆盖控件实例上的相应函数，如 <code>render()</code> 或 <code>addChild()</code> 等。</li>\n<li>读取<code>核心属性</code>与<code>关键属性</code>，包括 <code>type</code> 、 <code>main</code> 等。</li>\n<li>可接触控件内部的 DOM 对象，即可以访问 <code>main</code> 及其子树，并对 DOM 做任何操作。</li>\n</ul>\n<p>在控件初始化时，会对扩展进行初始化，其基本流程为：</p>\n<p>1、 当控件 <code>init</code> 之后，会依次对所有关联 <code>Extension</code> ，调用 <code>attachTo()</code> 方法。一个类型的 <code>Extension</code> 仅能在控件实例上附加一次，如果一个控件已经附加了同类型的 <code>Extension</code> 实例，则跳过本次 <code>attachTo</code> 操作。<br>2、 当控件 <code>dispose</code> 之前，会依次对所有关联 <code>Extension</code> ，调用其 <code>dispose()</code> 方法。</p>\n<p>有多种方法可以将扩展绑定到具体的控件实例上：</p>\n<ul>\n<li><p>在控件创建时绑定</p>\n<p>  通过控件构造函数参数 <code>options.extensions</code> 可以为控件绑定扩展。</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">new</span> TextBox(&#123;</div><div class=\"line\">    <span class=\"attr\">extensions</span>: [</div><div class=\"line\">        <span class=\"keyword\">new</span> MyExtension(&#123; ... &#125;),</div><div class=\"line\">        <span class=\"keyword\">new</span> OtherExtension(&#123; ... &#125;)</div><div class=\"line\">    ]</div><div class=\"line\">&#125;);</div></pre></td></tr></table></figure>\n</li>\n<li><p>在使用HTML生成时绑定</p>\n<p>  在HTML中，使用 <code>data-ui-extension-xxx</code> 属性注册一个扩展：</p>\n  <figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;div id=\"main-panel\" class=\"wrapper\"</div><div class=\"line\">    data-ui-type=\"Panel\"</div><div class=\"line\">    data-ui-extension-command-type=\"Command\"</div><div class=\"line\">    data-ui-extension-command-events=\"click,keypress,keyup\"</div><div class=\"line\">    data-ui-extension-command-use-capture=\"false\"</div><div class=\"line\">&lt;/div&gt;</div></pre></td></tr></table></figure>\n<p>  在HTML中，使用 <code>data-ui-extension-*-property</code> 属性添加扩展，其中<code>*</code>作为扩展的分组，可以是任何字符串，相同的<code>*</code>将作为对同一扩展的定义，必须包含 <code>data-ui-extension-*-type</code> 定义扩展的类型，而其它 <code>data-ui-extension-*-property=&quot;value&quot;</code> 属性则将作为 <code>options</code> 参数的属性传递给扩展的构造函数。</p>\n</li>\n<li><p>在实例创建后动态地绑定</p>\n<p>  在控件创建后，可以动态创建扩展并在适当的时候绑定至控件。</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">var</span> panel = <span class=\"keyword\">new</span> Label(&#123; <span class=\"attr\">text</span>: <span class=\"string\">'abc'</span> &#125;);</div><div class=\"line\"><span class=\"keyword\">var</span> delegateDOMEvents = main.createExtension(</div><div class=\"line\">    <span class=\"string\">'Command'</span>,</div><div class=\"line\">    &#123;</div><div class=\"line\">        <span class=\"attr\">eventTypes</span>: [<span class=\"string\">'click'</span>, <span class=\"string\">'keypress'</span>, <span class=\"string\">'keyup'</span>],</div><div class=\"line\">        <span class=\"attr\">useCapture</span>: <span class=\"literal\">false</span></div><div class=\"line\">    &#125;</div><div class=\"line\">);</div><div class=\"line\"><span class=\"comment\">// 需主动调用attachTo方法</span></div><div class=\"line\">delegateDomEvents.attachTo(panel);</div><div class=\"line\">panel.appendTo(container);</div></pre></td></tr></table></figure>\n</li>\n<li><p>全局绑定</p>\n<p>  调用{@link main#attachExtension}函数可在全局注册一个扩展：</p>\n  <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">main.attachExtension(<span class=\"string\">'Command'</span>, &#123; <span class=\"attr\">events</span>: [<span class=\"string\">'click'</span>] &#125;);</div></pre></td></tr></table></figure>\n<p>  全局注册的扩展，将会被附加到<strong>所有</strong>控件的实例上。使用 <code>options</code> 参数作为 <code>Extension</code> 创建时的选项，创建 <code>Extension</code> 实例时会对 <code>options</code> 做复制处理。</p>\n<p>  具体可以参考 extension.Command 作为示例，来学习扩展的编写。</p>\n</li>\n</ul>\n<h3 id=\"src-main-js-中的-main-init-方法\"><a href=\"#src-main-js-中的-main-init-方法\" class=\"headerlink\" title=\"src/main.js 中的 main.init() 方法\"></a>src/main.js 中的 main.init() 方法</h3><p>该方法是整个 esui 的入口方法，可以指定当前要使用 esui 的 dom 节点容器，类似于 angular.bootstrap() 或者 React.render()，都是以指定的 dom 元素为根，然后开始渲染这块地盘。具体参数传递可参看文档。</p>\n<p>该方法会返回一个这个块地盘初始化的控件对象集合，例如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"container\"</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:defaultBtn;\"</span>&gt;</span>默认按钮<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:springBtn;skin:spring\"</span>&gt;</span>创建<span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:springAddBtn;skin:spring-add\"</span>&gt;</span>添加<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:downloadBtn;skin:download\"</span>&gt;</span>下载<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">data-ui</span>=<span class=\"string\">\"type:Button;id:actBtn;\"</span>&gt;</span>改变文字<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>此 container 初始化后就会返回五个控件对象控件的集合。</p>\n<h3 id=\"类关系\"><a href=\"#类关系\" class=\"headerlink\" title=\"类关系\"></a>类关系</h3><ul>\n<li>ControlCollection<ul>\n<li>ControlGroup</li>\n</ul>\n</li>\n<li>Extension</li>\n<li>EventTarget<ul>\n<li>Control<ul>\n<li>Button</li>\n<li>CommandMenu</li>\n<li>Crumb</li>\n<li>InputControl<ul>\n<li>BoxGroup</li>\n<li>Calendar</li>\n<li>CheckBox</li>\n<li>RangeCalendar</li>\n<li>Region</li>\n<li>RichCalendar</li>\n<li>Schedule</li>\n<li>Select</li>\n<li>TextBox</li>\n<li>TextLine</li>\n</ul>\n</li>\n<li>Dialog</li>\n<li>Label</li>\n<li>Frame</li>\n<li>Pager</li>\n<li>Panel<ul>\n<li>Form</li>\n<li>Overlay</li>\n</ul>\n</li>\n<li>SearchBox</li>\n<li>Sidebar</li>\n<li>Tab</li>\n<li>Table</li>\n<li>Tip</li>\n<li>TipLayer</li>\n<li>Toast</li>\n<li>Tree</li>\n<li>Validity</li>\n<li>Wizard</li>\n</ul>\n</li>\n<li>Layer</li>\n<li>Link</li>\n<li>MonthView</li>\n</ul>\n</li>\n<li>SafeWrapper</li>\n<li>TreeStrategy</li>\n<li>ViewContext</li>\n</ul>\n<h3 id=\"一些总结\"><a href=\"#一些总结\" class=\"headerlink\" title=\"一些总结\"></a>一些总结</h3><p>绝大多数控件在源码中其实都有比较详尽的说明了，只要仔细看看注释，再结合相关代码，很快就会用了。不过，在看代码的时候，以下几处务必留意：</p>\n<ul>\n<li>1、 initOption() 函数，该函数会初始化一些参数，很多都可以通过 <code>data-ui-xxx</code> 来设置，也可以通过 set() 方法来设置；</li>\n<li>2、 repaint 属性，该属性中存放了重绘相关的配置，留意会造成重绘的属性，这些属性往往也可以用上条所述方式设置；</li>\n<li>3、留意控件会触发什么事件，直接在源代码中搜索 <code>fire(</code> ，即可快速知道该控件会触发什么事件。</li>\n</ul>"},{"title":"记一次坑爹的对接经历","date":"2015-05-06T16:00:00.000Z","_content":"\n事情是这样的：\n\n后端提供了一个数据接口 `/account/my/address/` 。咱是有追求的程序员，自然接口要采用 RESTful 的思想，于是服务器端非成功的处理，都会返回 http code 非200的状态码，坑由此而生。\n<!-- more -->\n\n在前端请求这个地方，由于做的是移动端应用，果断采用了手写 xhr 请求，大致接口请求代码如下：\n\n```js\nfunction encodeParams(params) {\n    var paramsStr = [];\n    for (var k in params) {\n        paramsStr.push(k + '=' + params[k]);\n    }\n    return paramsStr.join('&');\n}\n\nfunction post(url, params) {\n    return new Promise(function(resolve, reject) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('POST', url);\n        xhr.onload = function() { resolve(xhr.response); };\n        xhr.onerror = function() { reject(xhr.response); };\n        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        xhr.send(encodeParams(params));\n    });\n}\n\npost('/account/my/address/', {/*参数*/})\n    .then(function(response) {\n        // some code\n    });\n```\n\n\n代码写好，拿到 chrome 中一测，出现一个似乎像是请求没发出去的错误：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/1.jpg?raw=true)\n\n对于当时不知道 chrome://net-internals/ 这个强大工具的我来说，这种错误简直就是一个莫名其妙的东西，很难搞。\n\n于是仔细看一眼 request header ，发现没有 `Content-Length` ！这是怎么回事？为什么浏览器没计算出来 `Content-Length` ？很不可思议！\n\n于是，尝试改变一下请求 body 的编码方式，将上述 post 函数改成这样：\n\n```js\nfunction createFormData(params) {\n    var fd = new FormData();\n    for (var k in params) {\n        fd.append(k, params[k]);\n    }\n    return fd;\n}\n\nfunction post(url, params) {\n    return new Promise(function(resolve, reject) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('POST', url);\n        xhr.onload = function() { resolve(xhr.response); };\n        xhr.onerror = function() { reject(xhr.response); };\n        xhr.setRequestHeader('Content-Type', 'multipart/form-data');\n        xhr.send(createFormData(params));\n    });\n}\n```\n\n再测，出现这样的错：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/2.jpg?raw=true)\n\n仍然没有 `Content-Length` ，错误依旧，简直令人发指！\n\n于是重新审视当前的开发模式，整个结构是这样的：我在本地开发前端静态部分，需要数据的时候通过 xhr 请求到后端去请求，为了避免我本地开发的时候还要启动一个后端服务器程序，于是让后端的同学将后端代码部署在一个公网的服务器上，这样我就可以通过代理或者 CORS 的方式来请求相应的接口了。\n\n所以此时此刻，有点怀疑是不是这种模式引发的问题，但是再一想，其它很多获取数据提交数据都是这种模式啊，为啥就正常呢！所以这种怀疑被打消。\n\nchrome 的开发者工具提供的信息太有限，实在想不出来是什么问题，于是到 QQ 群求助网友，其中一位网页给出了这个： chrome://net-internals/ ，抱着试一试的心态，打开，观察，哇咔咔，好牛逼，请求的各个过程尽收眼底！其中我找到了我的 POST 请求：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/3.jpg?raw=true)\n\n嗯，看来请求还是被正常发送出去了的。再往下看，发现了这个：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/4.jpg?raw=true)\n\n`ERR_UNEXPECTED_PROXY_AUTH` 映入眼帘，代理需要认证？啥玩意儿？然后再看到一个 `Server: nginx/1.4.6 (Ubuntu)` ，仔细想想，为毛 nginx 会说代理认证错误！抓狂，去找后端人员，后端人员果断说不可能是 nginx 有问题！\n\n于是，再次崩溃， google 吧！于是尝试各种关键字搜索： `ERR_UNEXPECTED_PROXY_AUTH` 、 `net_error = -323` ...\n\n搜索的时候，出现了一条关于 http code 407 的记录，点进去一看，惊呆了， 407 的含义如下：\n\n> Proxy Authentication Required\n\n需要代理授权！再看看上面的那张图，后端返回的 http code 果然是407，于是找到后端人员，问他可能会返回407吗？答案是 yes ！（我“怒发冲冠”，于是后端同学，卒）\n\n#### 总结\n\n这次问题解决总结下来有这么几个点，以后要注意：\n\n* 1、在 RESTful 开发中，一定要对状态码足够敏感；\n* 2、好好使用 chrome://net-internals/ ，确实挺强大；\n* 3、chrome 出现上述类似错误的时候（407、请求未成功发送出去等等），很可能不显示完整的请求头，不显示响应信息（因为按照语义，此时根本无响应信息可显示）。\n","source":"_posts/记一次坑爹的对接经历.md","raw":"---\ntitle: 记一次坑爹的对接经历\ndate: 2015-05-07\ntags:\n- HTTP\n---\n\n事情是这样的：\n\n后端提供了一个数据接口 `/account/my/address/` 。咱是有追求的程序员，自然接口要采用 RESTful 的思想，于是服务器端非成功的处理，都会返回 http code 非200的状态码，坑由此而生。\n<!-- more -->\n\n在前端请求这个地方，由于做的是移动端应用，果断采用了手写 xhr 请求，大致接口请求代码如下：\n\n```js\nfunction encodeParams(params) {\n    var paramsStr = [];\n    for (var k in params) {\n        paramsStr.push(k + '=' + params[k]);\n    }\n    return paramsStr.join('&');\n}\n\nfunction post(url, params) {\n    return new Promise(function(resolve, reject) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('POST', url);\n        xhr.onload = function() { resolve(xhr.response); };\n        xhr.onerror = function() { reject(xhr.response); };\n        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        xhr.send(encodeParams(params));\n    });\n}\n\npost('/account/my/address/', {/*参数*/})\n    .then(function(response) {\n        // some code\n    });\n```\n\n\n代码写好，拿到 chrome 中一测，出现一个似乎像是请求没发出去的错误：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/1.jpg?raw=true)\n\n对于当时不知道 chrome://net-internals/ 这个强大工具的我来说，这种错误简直就是一个莫名其妙的东西，很难搞。\n\n于是仔细看一眼 request header ，发现没有 `Content-Length` ！这是怎么回事？为什么浏览器没计算出来 `Content-Length` ？很不可思议！\n\n于是，尝试改变一下请求 body 的编码方式，将上述 post 函数改成这样：\n\n```js\nfunction createFormData(params) {\n    var fd = new FormData();\n    for (var k in params) {\n        fd.append(k, params[k]);\n    }\n    return fd;\n}\n\nfunction post(url, params) {\n    return new Promise(function(resolve, reject) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('POST', url);\n        xhr.onload = function() { resolve(xhr.response); };\n        xhr.onerror = function() { reject(xhr.response); };\n        xhr.setRequestHeader('Content-Type', 'multipart/form-data');\n        xhr.send(createFormData(params));\n    });\n}\n```\n\n再测，出现这样的错：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/2.jpg?raw=true)\n\n仍然没有 `Content-Length` ，错误依旧，简直令人发指！\n\n于是重新审视当前的开发模式，整个结构是这样的：我在本地开发前端静态部分，需要数据的时候通过 xhr 请求到后端去请求，为了避免我本地开发的时候还要启动一个后端服务器程序，于是让后端的同学将后端代码部署在一个公网的服务器上，这样我就可以通过代理或者 CORS 的方式来请求相应的接口了。\n\n所以此时此刻，有点怀疑是不是这种模式引发的问题，但是再一想，其它很多获取数据提交数据都是这种模式啊，为啥就正常呢！所以这种怀疑被打消。\n\nchrome 的开发者工具提供的信息太有限，实在想不出来是什么问题，于是到 QQ 群求助网友，其中一位网页给出了这个： chrome://net-internals/ ，抱着试一试的心态，打开，观察，哇咔咔，好牛逼，请求的各个过程尽收眼底！其中我找到了我的 POST 请求：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/3.jpg?raw=true)\n\n嗯，看来请求还是被正常发送出去了的。再往下看，发现了这个：\n\n![](https://github.com/yibuyisheng/blogs/blob/master/imgs/4.jpg?raw=true)\n\n`ERR_UNEXPECTED_PROXY_AUTH` 映入眼帘，代理需要认证？啥玩意儿？然后再看到一个 `Server: nginx/1.4.6 (Ubuntu)` ，仔细想想，为毛 nginx 会说代理认证错误！抓狂，去找后端人员，后端人员果断说不可能是 nginx 有问题！\n\n于是，再次崩溃， google 吧！于是尝试各种关键字搜索： `ERR_UNEXPECTED_PROXY_AUTH` 、 `net_error = -323` ...\n\n搜索的时候，出现了一条关于 http code 407 的记录，点进去一看，惊呆了， 407 的含义如下：\n\n> Proxy Authentication Required\n\n需要代理授权！再看看上面的那张图，后端返回的 http code 果然是407，于是找到后端人员，问他可能会返回407吗？答案是 yes ！（我“怒发冲冠”，于是后端同学，卒）\n\n#### 总结\n\n这次问题解决总结下来有这么几个点，以后要注意：\n\n* 1、在 RESTful 开发中，一定要对状态码足够敏感；\n* 2、好好使用 chrome://net-internals/ ，确实挺强大；\n* 3、chrome 出现上述类似错误的时候（407、请求未成功发送出去等等），很可能不显示完整的请求头，不显示响应信息（因为按照语义，此时根本无响应信息可显示）。\n","slug":"记一次坑爹的对接经历","published":1,"updated":"2016-06-15T10:48:12.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciwqiy03e001t0407mr0k9lbw","content":"<p>事情是这样的：</p>\n<p>后端提供了一个数据接口 <code>/account/my/address/</code> 。咱是有追求的程序员，自然接口要采用 RESTful 的思想，于是服务器端非成功的处理，都会返回 http code 非200的状态码，坑由此而生。<br><a id=\"more\"></a></p>\n<p>在前端请求这个地方，由于做的是移动端应用，果断采用了手写 xhr 请求，大致接口请求代码如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encodeParams</span>(<span class=\"params\">params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> paramsStr = [];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> params) &#123;</div><div class=\"line\">        paramsStr.push(k + <span class=\"string\">'='</span> + params[k]);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> paramsStr.join(<span class=\"string\">'&amp;'</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">post</span>(<span class=\"params\">url, params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</div><div class=\"line\">        xhr.open(<span class=\"string\">'POST'</span>, url);</div><div class=\"line\">        xhr.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; resolve(xhr.response); &#125;;</div><div class=\"line\">        xhr.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; reject(xhr.response); &#125;;</div><div class=\"line\">        xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'application/x-www-form-urlencoded'</span>);</div><div class=\"line\">        xhr.send(encodeParams(params));</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">post(<span class=\"string\">'/account/my/address/'</span>, &#123;<span class=\"comment\">/*参数*/</span>&#125;)</div><div class=\"line\">    .then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">response</span>) </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// some code</span></div><div class=\"line\">    &#125;);</div></pre></td></tr></table></figure>\n<p>代码写好，拿到 chrome 中一测，出现一个似乎像是请求没发出去的错误：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/1.jpg?raw=true\" alt=\"\"></p>\n<p>对于当时不知道 chrome://net-internals/ 这个强大工具的我来说，这种错误简直就是一个莫名其妙的东西，很难搞。</p>\n<p>于是仔细看一眼 request header ，发现没有 <code>Content-Length</code> ！这是怎么回事？为什么浏览器没计算出来 <code>Content-Length</code> ？很不可思议！</p>\n<p>于是，尝试改变一下请求 body 的编码方式，将上述 post 函数改成这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createFormData</span>(<span class=\"params\">params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> fd = <span class=\"keyword\">new</span> FormData();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> params) &#123;</div><div class=\"line\">        fd.append(k, params[k]);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> fd;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">post</span>(<span class=\"params\">url, params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</div><div class=\"line\">        xhr.open(<span class=\"string\">'POST'</span>, url);</div><div class=\"line\">        xhr.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; resolve(xhr.response); &#125;;</div><div class=\"line\">        xhr.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; reject(xhr.response); &#125;;</div><div class=\"line\">        xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'multipart/form-data'</span>);</div><div class=\"line\">        xhr.send(createFormData(params));</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>再测，出现这样的错：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/2.jpg?raw=true\" alt=\"\"></p>\n<p>仍然没有 <code>Content-Length</code> ，错误依旧，简直令人发指！</p>\n<p>于是重新审视当前的开发模式，整个结构是这样的：我在本地开发前端静态部分，需要数据的时候通过 xhr 请求到后端去请求，为了避免我本地开发的时候还要启动一个后端服务器程序，于是让后端的同学将后端代码部署在一个公网的服务器上，这样我就可以通过代理或者 CORS 的方式来请求相应的接口了。</p>\n<p>所以此时此刻，有点怀疑是不是这种模式引发的问题，但是再一想，其它很多获取数据提交数据都是这种模式啊，为啥就正常呢！所以这种怀疑被打消。</p>\n<p>chrome 的开发者工具提供的信息太有限，实在想不出来是什么问题，于是到 QQ 群求助网友，其中一位网页给出了这个： chrome://net-internals/ ，抱着试一试的心态，打开，观察，哇咔咔，好牛逼，请求的各个过程尽收眼底！其中我找到了我的 POST 请求：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/3.jpg?raw=true\" alt=\"\"></p>\n<p>嗯，看来请求还是被正常发送出去了的。再往下看，发现了这个：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/4.jpg?raw=true\" alt=\"\"></p>\n<p><code>ERR_UNEXPECTED_PROXY_AUTH</code> 映入眼帘，代理需要认证？啥玩意儿？然后再看到一个 <code>Server: nginx/1.4.6 (Ubuntu)</code> ，仔细想想，为毛 nginx 会说代理认证错误！抓狂，去找后端人员，后端人员果断说不可能是 nginx 有问题！</p>\n<p>于是，再次崩溃， google 吧！于是尝试各种关键字搜索： <code>ERR_UNEXPECTED_PROXY_AUTH</code> 、 <code>net_error = -323</code> …</p>\n<p>搜索的时候，出现了一条关于 http code 407 的记录，点进去一看，惊呆了， 407 的含义如下：</p>\n<blockquote>\n<p>Proxy Authentication Required</p>\n</blockquote>\n<p>需要代理授权！再看看上面的那张图，后端返回的 http code 果然是407，于是找到后端人员，问他可能会返回407吗？答案是 yes ！（我“怒发冲冠”，于是后端同学，卒）</p>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p>这次问题解决总结下来有这么几个点，以后要注意：</p>\n<ul>\n<li>1、在 RESTful 开发中，一定要对状态码足够敏感；</li>\n<li>2、好好使用 chrome://net-internals/ ，确实挺强大；</li>\n<li>3、chrome 出现上述类似错误的时候（407、请求未成功发送出去等等），很可能不显示完整的请求头，不显示响应信息（因为按照语义，此时根本无响应信息可显示）。</li>\n</ul>\n","excerpt":"<p>事情是这样的：</p>\n<p>后端提供了一个数据接口 <code>/account/my/address/</code> 。咱是有追求的程序员，自然接口要采用 RESTful 的思想，于是服务器端非成功的处理，都会返回 http code 非200的状态码，坑由此而生。<br>","more":"</p>\n<p>在前端请求这个地方，由于做的是移动端应用，果断采用了手写 xhr 请求，大致接口请求代码如下：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encodeParams</span>(<span class=\"params\">params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> paramsStr = [];</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> params) &#123;</div><div class=\"line\">        paramsStr.push(k + <span class=\"string\">'='</span> + params[k]);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> paramsStr.join(<span class=\"string\">'&amp;'</span>);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">post</span>(<span class=\"params\">url, params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</div><div class=\"line\">        xhr.open(<span class=\"string\">'POST'</span>, url);</div><div class=\"line\">        xhr.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; resolve(xhr.response); &#125;;</div><div class=\"line\">        xhr.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; reject(xhr.response); &#125;;</div><div class=\"line\">        xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'application/x-www-form-urlencoded'</span>);</div><div class=\"line\">        xhr.send(encodeParams(params));</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">post(<span class=\"string\">'/account/my/address/'</span>, &#123;<span class=\"comment\">/*参数*/</span>&#125;)</div><div class=\"line\">    .then(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">response</span>) </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// some code</span></div><div class=\"line\">    &#125;);</div></pre></td></tr></table></figure>\n<p>代码写好，拿到 chrome 中一测，出现一个似乎像是请求没发出去的错误：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/1.jpg?raw=true\" alt=\"\"></p>\n<p>对于当时不知道 chrome://net-internals/ 这个强大工具的我来说，这种错误简直就是一个莫名其妙的东西，很难搞。</p>\n<p>于是仔细看一眼 request header ，发现没有 <code>Content-Length</code> ！这是怎么回事？为什么浏览器没计算出来 <code>Content-Length</code> ？很不可思议！</p>\n<p>于是，尝试改变一下请求 body 的编码方式，将上述 post 函数改成这样：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createFormData</span>(<span class=\"params\">params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">var</span> fd = <span class=\"keyword\">new</span> FormData();</div><div class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> k <span class=\"keyword\">in</span> params) &#123;</div><div class=\"line\">        fd.append(k, params[k]);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> fd;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">post</span>(<span class=\"params\">url, params</span>) </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resolve, reject</span>) </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</div><div class=\"line\">        xhr.open(<span class=\"string\">'POST'</span>, url);</div><div class=\"line\">        xhr.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; resolve(xhr.response); &#125;;</div><div class=\"line\">        xhr.onerror = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123; reject(xhr.response); &#125;;</div><div class=\"line\">        xhr.setRequestHeader(<span class=\"string\">'Content-Type'</span>, <span class=\"string\">'multipart/form-data'</span>);</div><div class=\"line\">        xhr.send(createFormData(params));</div><div class=\"line\">    &#125;);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>再测，出现这样的错：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/2.jpg?raw=true\" alt=\"\"></p>\n<p>仍然没有 <code>Content-Length</code> ，错误依旧，简直令人发指！</p>\n<p>于是重新审视当前的开发模式，整个结构是这样的：我在本地开发前端静态部分，需要数据的时候通过 xhr 请求到后端去请求，为了避免我本地开发的时候还要启动一个后端服务器程序，于是让后端的同学将后端代码部署在一个公网的服务器上，这样我就可以通过代理或者 CORS 的方式来请求相应的接口了。</p>\n<p>所以此时此刻，有点怀疑是不是这种模式引发的问题，但是再一想，其它很多获取数据提交数据都是这种模式啊，为啥就正常呢！所以这种怀疑被打消。</p>\n<p>chrome 的开发者工具提供的信息太有限，实在想不出来是什么问题，于是到 QQ 群求助网友，其中一位网页给出了这个： chrome://net-internals/ ，抱着试一试的心态，打开，观察，哇咔咔，好牛逼，请求的各个过程尽收眼底！其中我找到了我的 POST 请求：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/3.jpg?raw=true\" alt=\"\"></p>\n<p>嗯，看来请求还是被正常发送出去了的。再往下看，发现了这个：</p>\n<p><img src=\"https://github.com/yibuyisheng/blogs/blob/master/imgs/4.jpg?raw=true\" alt=\"\"></p>\n<p><code>ERR_UNEXPECTED_PROXY_AUTH</code> 映入眼帘，代理需要认证？啥玩意儿？然后再看到一个 <code>Server: nginx/1.4.6 (Ubuntu)</code> ，仔细想想，为毛 nginx 会说代理认证错误！抓狂，去找后端人员，后端人员果断说不可能是 nginx 有问题！</p>\n<p>于是，再次崩溃， google 吧！于是尝试各种关键字搜索： <code>ERR_UNEXPECTED_PROXY_AUTH</code> 、 <code>net_error = -323</code> …</p>\n<p>搜索的时候，出现了一条关于 http code 407 的记录，点进去一看，惊呆了， 407 的含义如下：</p>\n<blockquote>\n<p>Proxy Authentication Required</p>\n</blockquote>\n<p>需要代理授权！再看看上面的那张图，后端返回的 http code 果然是407，于是找到后端人员，问他可能会返回407吗？答案是 yes ！（我“怒发冲冠”，于是后端同学，卒）</p>\n<h4 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h4><p>这次问题解决总结下来有这么几个点，以后要注意：</p>\n<ul>\n<li>1、在 RESTful 开发中，一定要对状态码足够敏感；</li>\n<li>2、好好使用 chrome://net-internals/ ，确实挺强大；</li>\n<li>3、chrome 出现上述类似错误的时候（407、请求未成功发送出去等等），很可能不显示完整的请求头，不显示响应信息（因为按照语义，此时根本无响应信息可显示）。</li>\n</ul>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"ciwqiy02100070407f5w3fvq6","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy028000c0407enuhijms"},{"post_id":"ciwqiy01l00000407rl6tpj11","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy029000f0407xm8neas2"},{"post_id":"ciwqiy0260009040760800xol","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy02c000j04078btqcb1x"},{"post_id":"ciwqiy01r00020407cuv7lk8e","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy02f000m0407qt9ya50t"},{"post_id":"ciwqiy01x0005040755fbsejx","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy02h000q0407src2ve8y"},{"post_id":"ciwqiy02m000w0407wjmbut0x","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy02p00100407zgp5nn2q"},{"post_id":"ciwqiy028000d0407dfucb4tp","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy02r00120407n3nzqshj"},{"post_id":"ciwqiy028000d0407dfucb4tp","tag_id":"ciwqiy02l000v04074di1aj29","_id":"ciwqiy02u00140407ytjsj73y"},{"post_id":"ciwqiy02o000y04077eicfm6h","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy02w00170407dz66jddk"},{"post_id":"ciwqiy02o000y04077eicfm6h","tag_id":"ciwqiy02l000v04074di1aj29","_id":"ciwqiy02x00190407c22o6jkw"},{"post_id":"ciwqiy02p00110407q993j0ry","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy030001c0407gqcx38q0"},{"post_id":"ciwqiy02a000g0407t0vu1qb8","tag_id":"ciwqiy02p000z04073xd20lo4","_id":"ciwqiy031001e0407zhy56llm"},{"post_id":"ciwqiy02r00130407xylfo7ox","tag_id":"ciwqiy01u000404070b4erbjj","_id":"ciwqiy034001h04070rggvql9"},{"post_id":"ciwqiy02y001b04078dbh3uzq","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy035001j040779lk3fy7"},{"post_id":"ciwqiy02c000k0407jn2j41ee","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy03c001n0407s3exq94m"},{"post_id":"ciwqiy02c000k0407jn2j41ee","tag_id":"ciwqiy02x001a04076b96p4v5","_id":"ciwqiy03c001p0407vjee396a"},{"post_id":"ciwqiy02c000k0407jn2j41ee","tag_id":"ciwqiy034001g0407fi6v25yb","_id":"ciwqiy03e001s0407q8v86qna"},{"post_id":"ciwqiy035001k0407tt55vvpg","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy03f001u04078dc67p3g"},{"post_id":"ciwqiy035001k0407tt55vvpg","tag_id":"ciwqiy02l000v04074di1aj29","_id":"ciwqiy03f001w0407xfqqj5vd"},{"post_id":"ciwqiy03c001m04073kobhrcc","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy03f001x0407aubl2384"},{"post_id":"ciwqiy02f000n04070dwxw697","tag_id":"ciwqiy02p000z04073xd20lo4","_id":"ciwqiy03f001z0407636de438"},{"post_id":"ciwqiy03c001o0407r8j6pimz","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy03g002004076f5clmd2"},{"post_id":"ciwqiy03d001r040707k6q7mt","tag_id":"ciwqiy02g000o0407kn7z3767","_id":"ciwqiy03g002204074cpn4q80"},{"post_id":"ciwqiy03e001t0407mr0k9lbw","tag_id":"ciwqiy02p000z04073xd20lo4","_id":"ciwqiy03g00230407w7m4we2i"},{"post_id":"ciwqiy02k000t0407ia66y7tc","tag_id":"ciwqiy03d001q0407lzecuq2r","_id":"ciwqiy03g002404075tzfplin"},{"post_id":"ciwqiy02k000t0407ia66y7tc","tag_id":"ciwqiy03f001v0407zyk3j0lz","_id":"ciwqiy03g00260407opmgubol"},{"post_id":"ciwqiy02u00160407nyowugdu","tag_id":"ciwqiy03f001y0407wufonrrm","_id":"ciwqiy03g00270407okwc55yd"},{"post_id":"ciwqiy02u00160407nyowugdu","tag_id":"ciwqiy03g002104079x9vwgih","_id":"ciwqiy03i00290407g1g4hrpg"},{"post_id":"ciwqiy02w00180407hicg4bc1","tag_id":"ciwqiy03f001y0407wufonrrm","_id":"ciwqiy03i002b040701czcr6w"},{"post_id":"ciwqiy02w00180407hicg4bc1","tag_id":"ciwqiy03g002104079x9vwgih","_id":"ciwqiy03i002c0407tbrxn95o"},{"post_id":"ciwqiy031001f0407pzygeecs","tag_id":"ciwqiy03i002a0407ulv52g1a","_id":"ciwqiy03i002d0407jkri59h4"}],"Tag":[{"name":"CSS","_id":"ciwqiy01u000404070b4erbjj"},{"name":"JavaScript","_id":"ciwqiy02g000o0407kn7z3767"},{"name":"ECMAScript 6","_id":"ciwqiy02l000v04074di1aj29"},{"name":"HTTP","_id":"ciwqiy02p000z04073xd20lo4"},{"name":"Reflux","_id":"ciwqiy02x001a04076b96p4v5"},{"name":"React","_id":"ciwqiy034001g0407fi6v25yb"},{"name":"Oracle","_id":"ciwqiy03d001q0407lzecuq2r"},{"name":"数据库","_id":"ciwqiy03f001v0407zyk3j0lz"},{"name":"markdown","_id":"ciwqiy03f001y0407wufonrrm"},{"name":"ETPL","_id":"ciwqiy03g002104079x9vwgih"},{"name":"vscode","_id":"ciwqiy03i002a0407ulv52g1a"}]}}